<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Invoice</title>
<!--<meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
<meta name="apple-mobile-web-app-capable" content="yes">-->
<script type="text/javascript" src="<?=ROOT_URL;?>/app/webroot/js/jquery-1.5.1.min.js"></script>
<script type="text/javascript" src="<?=ROOT_URL;?>/app/webroot/js/jquery-ui-1.8.21.custom.min.js"></script>
<script type="text/javascript" src="<?=ROOT_URL;?>/app/webroot/js/invoice_tablet_feedback.js"></script>
<script type="text/javascript" src="<?=ROOT_URL;?>/app/webroot/js/eff_calculator.js"></script>
<link rel="stylesheet" type="text/css" media="all" href="<?=ROOT_URL;?>/app/webroot/css/ui-smooth/jquery-ui-1.8.21.custom.css" />
<link rel="stylesheet" type="text/css" media="all" href="<?=ROOT_URL;?>/app/webroot/css/invoice_tablet.css" />
<style type="text/css">
[class^="pre-image_"] {
    display: none;
} 
</style>
<script language="JavaScript">
$(document).ready(function(){
    $(".disply_preview").live("change",function(e){
        var img_ct = $(this).attr("data-ct").trim();
        var cur = $(this);
       upload_photo_preview(cur[0],img_ct);
    }); 
});
$(function () {
        $(".invoice-img-enlarge").dialog({
            modal: true,
            autoOpen: false,
            title: "Photo",
            autoOpen: false,
            width: 1024,
            height: 786,
        });
        $(".invoice-openImg").live("click",function () {
            var imgPath = $(this).attr('src');
            $('.invoice-img-enlarge img').attr('src', imgPath);
            $('.invoice-img-enlarge').dialog('open');
        });
    }); 
$(function(){
    $("#sortpicture1").change(function(){
        upload_photo(1);
    });
    $("#sortpicture2").change(function(){
        upload_photo(2);
    });
});
function upload_photo_preview(cur,i) {  
    //var file = $('input[id="sortpicture'+i+'"]')[0];
    if (cur.files && cur.files[0]) {
    var reader = new FileReader();
    reader.onload = function (e) {
      $('.pre-image_'+i+'')
        .attr('src', e.target.result)
        .height(100);
        $('.pre-image_'+i+'').css("display","block");
    };
    reader.readAsDataURL(cur.files[0]);
  }
}

function upload_photo(i) {
	if($('input[id="sortpicture'+i+'"]').val().length == 0) {
		return;
	}
	var formData = new FormData();
	formData.append('section', 'general');
	formData.append('action', 'previewImg');
	// Main magic with files here
	formData.append('image', $('input[id="sortpicture'+i+'"]')[0].files[0]);

	$.ajax({
		url: '<?=BASE_URL?>/orders/uploadPhoto/<?=$order['Order']['id'] ?>/'+i,
		dataType: 'text',
		cache: false,
		contentType: false,
		processData: false,
		data: formData,
		type: 'post',
		success: function(data) {
			$('#photo_' + i).attr('src', data);
			$('#big_photo_' + i).attr('src', data);
		}
	});
}
</script>
</head>

<body>
<ul id="nav">
    <li><a id="jobs_link" class="buttons"><div>Jobs</div></a></li>
    <li><a href="<?php echo BASE_URL;?>/pages/main" id="home_link" class="buttons"><div>ACESYS</div></a></li>
    <li><a id="calc_link" class="buttons"><div>Eff Calculator</div></a></li>
</ul>

<div id="invoice">
	<ul id="job_list">
    	<?php foreach($jobs as $job) { ?>
        <?php if($job['Order']['order_status_id'] == 5) $url = BASE_URL."/orders/invoiceTabletPrint?order_id=".$job['Order']['id'] ?>
        <?php if($job['Order']['order_status_id'] == 3) $url = "#" ?>
        <?php if($job['Order']['order_status_id'] == 1) $url = BASE_URL."/orders/invoiceTabletOverview?order_id=".$job['Order']['id'] ?>
    	<li>
        <a href="<?php echo $url;?>" class="job status<?php echo $job['Order']['order_status_id'] ?>">
        	<span><?php echo $job['Customer']['first_name'] ?> <?php echo $job['Customer']['last_name'] ?> <?php echo $job['Order']['job_time_beg'] ?> <?php echo $job['Order']['job_time_end'] ?></span>
            <div><?php echo $job['Order']['order_number'] ?></div>
        </a>
        </li>
        <?php } ?>
    </ul>

    <?php $job = $this_job ?>
    <?php if($job['Order']['id'] == $order_id) { ?>
    <div class="header">
    <h1>#<?php echo $job['Order']['order_number'] ?> - <?php echo $job['Type']['name'] ?></h1>
   <table>
        <tr>
            <td>Firs name:</td>
            <td><?php echo $job['Customer']['first_name'] ?></td>
        </tr>
        <tr>
            <td>Last name:</td>
            <td><?php echo $job['Customer']['last_name'] ?></td>
        </tr>
        <tr>
            <td>Email:</td>
            <td><?php echo $job['Customer']['email'] ?></td>
        </tr>
        <tr>
            <td>Unit number:</td>
            <td><?php echo $job['Customer']['address_unit'] ?></td>
        </tr>
        <tr>
            <td>Street number:</td>
            <td><?php echo $job['Customer']['address_street_number'] ?></td>
        </tr>
        <tr>
            <td>Street name:</td>
            <td><?php echo $job['Customer']['address_street'] ?></td>
        </tr>
        <tr>
            <td>City:</td>
            <td><?php echo $job['Customer']['city'] ?></td>
        </tr>
        <tr>
            <td>Postal code:</td>
            <td><?php echo $job['Customer']['postal_code'] ?></td>
        </tr>
        <tr>
            <td>Phone number:</td>
            <td><?php echo $job['Customer']['phone'] ?></td>
        </tr>
    </table>
    <p><a href="<?php echo $HtmlAssist->getOrderGoogleMap($job['Customer'])?>" target="_blank">
		<?php echo $job['Customer']['address'] ?> <?php echo $job['Customer']['city'] ?> <?php echo $job['Customer']['postal_code'] ?>
        </a>
    </p>
    </div>
    <div id="items_div">
    <form id="feedback_form" action="<?php echo BASE_URL ?>/orders/saveInvoiceTabletFeedback" method="post">
        <?php echo $html->input('Invoice/order_id', array('type'=>'hidden', 'value'=>$job['Order']['id'])); ?>
        <?php echo $html->input('Invoice/order_type_id', array('type'=>'hidden', 'value'=>$job['Order']['order_type_id'])); ?>
        <?php echo $html->input('Invoice/email', array('type'=>'hidden', 'value'=>$job['Customer']['email'])); ?>
        <?php echo $html->input('Invoice/fname', array('type'=>'hidden', 'value'=>$job['Customer']['first_name'])); ?>
        <?php echo $html->input('Invoice/customer_id', array('type'=>'hidden', 'value'=>$job['Order']['customer_id'])); ?>
        <?php echo $html->input('Invoice/phone', array('type'=>'hidden', 'value'=>$job['Customer']['phone'])); ?>
        <?php echo $html->input('Invoice/has_booking', array('type'=>'hidden', 'id'=>'has_booking', 'value'=>0)); ?>
        <?php echo $html->input('Invoice/city_id', array('type'=>'hidden', 'id'=>'city_id', 'value'=>$city_id)); ?>
        <div class="order_div">
        <h3>#<?php echo $job['Order']['order_number'] ?> - <?php echo $job['Type']['name'] ?></h3>
        <table class="item_table office">
        	<tr>
            	<th class="item_name"></th>
                <th>Discount</th>
                <th>Payable</th>
            </tr>

        	<?php foreach($job['BookingItem'] as $item) { ?>
            <tbody>
            <?php if($item['class'] == 0) { ?>
        	<tr>
            	<td class="left"><?php echo $item['name'] ?></td>
                <td class="right"><?php echo $item['discount'] ?></td>
                <td class="right"><?php echo number_format(round(($item['price'] * $item['quantity']) - $item['discount'] + $item['addition'],2), 2, '.', '') ?></td>
            </tr>
            <?php } ?>
            </tbody>
            <?php } ?>
        </table>

        <h3>New Requirements</h3>
        <table class="item_table tech">
        	<tr>
            	<th class="item_name"></th>
                <th>Installed/Done</th>
                <th>Discount</th>
                <th>Quantity</th>
                <th>Payable</th>
            </tr>
            <tbody id="item_details">
        	<?php foreach($job['BookingItem'] as $item) { ?>
            <?php if($item['class'] == 1) { ?>
        	<tr class="item_detail">
            	<td class="left"><?php echo $item['name'] ?></td>
                <td class="center"><?php echo $item['installed']==1?"Yes":"No"; ?></td>
                <td class="right"><?php echo number_format(round($item['discount'],2), 2, '.', '') ?></td>
                <td class="center"><?php echo $item['quantity'] ?></td>
                <td class="right"><?php echo number_format(round(($item['price'] * $item['quantity']) - $item['discount'] + $item['addition'],2), 2, '.', '') ?>                </td>
            </tr>
            <?php } ?>
            <?php } ?>
            </tbody>
        </table>

        <h3>Additional Job Notes</h3>
        <?php echo $html->textarea('Feedback/job_notes_tech', array('style' => "width:50%; height: 50px;")); ?>

        <h3>Upload Pictures</h3>
        <div>
            
            <div style="display:inline-block;padding-right:50px;">
                <?php if ($order['Order']['photo_1']) { ?>
                    <img id="photo_1" onclick="$('#dialog1').dialog({height:'auto', width:'auto'});$('#dialog2').dialog('close');" src="<?php echo ROOT_URL.'/upload_photos/'.$order['Order']['photo_1'];?>" style="max-height:100px;height:auto;cursor:pointer;padding:10px">
                    <div id="dialog1" title="Photo" style="display:none;">
                        <img id="big_photo_1" src="<?php echo ROOT_URL.'/upload_photos/'.$order['Order']['photo_1'];?>" style="max-height:600px;max-width:600px">
                    </div>
                <?php } else{?>
                    <img id="pre-image_photo1" class="pre-image_photo1 invoice-openImg" src="#" alt="your image" />
                    <?php }?>
                <div style="padding:10px;">
                    <label for="sortpicture1" class="ui-button ui-widget ui-corner-all" style="cursor:pointer;padding:5px;background:#c5c5c5">Upload</label>
                    <input id="sortpicture1" type="file" name="sortpic1" style="visibility:hidden;"/ class="disply_preview" data-ct="photo1">
            <!--        <button onclick="upload_photo(1);return false;">Upload</button> -->
                </div>
            </div>
            
            <div style="display:inline-block">
                <?php if ($order['Order']['photo_2']) { ?>

                    <img id="photo_2" onclick="$('#dialog2').dialog({height:'auto', width:'auto'});$('#dialog1').dialog('close');" src="<?php echo ROOT_URL.'/upload_photos/'.$order['Order']['photo_2'];?>" style="max-height:100px;height:auto;cursor:pointer;padding:10px">
                    <div id="dialog2" title="Photo" style="display:none;">
                        <img id="big_photo_2" src="<?php echo ROOT_URL.'/upload_photos/'.$order['Order']['photo_2'];?>" style="max-height:600px;max-width:600px">
                    </div>
                <?php } else {?>
                        <img id="pre-image_photo2" class="pre-image_photo2 invoice-openImg" src="#" alt="your image" />
                    <?php }?>
                <div style="padding:10px;">
                    <label for="sortpicture2" class="ui-button ui-widget ui-corner-all" style="cursor:pointer;padding:5px;background:#c5c5c5">Upload</label>
                    <input id="sortpicture2" type="file" name="sortpic2" style="visibility:hidden;"/ class="disply_preview" data-ct="photo2">
            <!--        <button onclick="upload_photo(2);return false;">Upload</button> -->
                </div>
            </div>
        </div>

        </div><!--END of order_div-->
        <div class="order_div">
        <?php if($last_order['Order']['order_number'] != "") { ?>
        <?php echo $html->input('Order2/id', array('type'=>'hidden', 'value'=>$last_order['Order']['id'])); ?>
        <input type="hidden" id="saved_booking" name="saved_booking" value="1" />
        <h3>#<?php echo $last_order['Order']['order_number'] ?> - <?php echo $last_order['Type']['name'] ?></h3>
        <h4>Schedule:
        	<span class="route" id="schedule_display">Not set</span>
        </h4>
        <div id="timeslot_div"></div>
        <div id="slot_confirmations"></div>
        <?php echo $html->input('Order2/job_date', array('type'=>'hidden', 'value'=>$last_order['Order']['job_date'])); ?>
        <?php echo $html->input('Order2/job_time_beg', array('type'=>'hidden', 'value'=>$last_order['Order']['job_time_beg'])); ?>
        <?php echo $html->input('Order2/job_time_end', array('type'=>'hidden', 'value'=>$last_order['Order']['job_time_end'])); ?>
        <?php echo $html->input('Order2/job_truck', array('type'=>'hidden', 'value'=>$last_order['Order']['job_truck'])); ?>
        <?php echo $html->input('Order2/job_technician1_id', array('type'=>'hidden', 'value'=>$last_order['Order']['job_technician1_id'])); ?>
        <?php echo $html->input('Order2/job_technician2_id', array('type'=>'hidden', 'value'=>$last_order['Order']['job_technician2_id'])); ?>

        <table class="item_table technew">
        	<tr>
        		<th class="item_name"></th>
                <th>Installed/Done</th>
                <th>Discount</th>
                <th>Quantity</th>
                <th>Payable</th>
                <th></th>
            </tr>
            <tbody id="booking_item_details">
            <tr class="item_detail">
            	<?php foreach($last_order['BookingItem'] as $item) { ?>
            	<?php if($item['class'] == 0) { ?>
            	<td class="left"><?php echo $item['name'] ?></td>
                <td class="center"><?php $item['installed']==1?"Yes":"No"; ?></td>
                <td class="right"><?php echo number_format(round($item['discount'],2), 2, '.', '') ?></td>
                <td class="center"><?php echo $item['quantity'] ?></td>
                <td class="center"><?php echo number_format(round(($item['price'] * $item['quantity']) - $item['discount'] + $item['addition'],2), 2, '.', '') ?>
                </td>
            </tr>
                <?php } ?>
            	<?php } ?>
            </tbody>
        </table>
        <?php } ?>
        </div><!--END of order_div-->


        <div id="feedback_div">
        <!--<h3>How would you rate our service?
        	<select name="data[Feedback][office_rating]">
            	<?php for($j=1;$j<11;$j++) { ?>
            	<option value="<?php echo $j ?>"><?php echo $j ?></option>
                <?php } ?>
            </select> out of 10
        </h3>
        <h3>How would you rate our technicians?
        	<select name="data[Feedback][tech_rating]">
            	<?php for($j=1;$j<11;$j++) { ?>
            	<option value="<?php echo $j ?>"><?php echo $j ?></option>
                <?php } ?>
            </select> out of 10
        </h3>
        <h3>Would you like the office to call you and follow up on the job?
        	<select name="data[Feedback][follow_up]">
            	<option value="0">No</option>
                <option value="1">Yes</option>
            </select>
        </h3>-->
        <input type="hidden" value="1" name="data[Feedback][office_rating]" />
        <input type="hidden" value="1" name="data[Feedback][tech_rating]" />
        <input type="hidden" value="0" name="data[Feedback][follow_up]" />
        </div>
        <!--<h3>I understand and agree on the above information and hereby affix my initials <input type="text" name="data[Feedback][customer_initial]" id="customer_initial" /></h3>-->


        <div class="next_div">
        	<input type="button" class="next_submit" id="test_required" value="Save" />
        </div>
    </form>
    </div>
    <?php } ?>

    <!--<pre><?php //print_r($jobs) ?></pre>-->
</div>

<div id="calc_dialog">
<table>
	<tr>
    	<td>
        	<h3>Yearly Cost</h3>
        	<table>
            	<tr>
                	<td colspan="3"><div class="number_display" id="cost">0</div></td>
                </tr>
                <tr>
                	<td><input type="button" value="7" class="calc_digits"></td>
                    <td><input type="button" value="8" class="calc_digits"></td>
                    <td><input type="button" value="9" class="calc_digits"></td>
                </tr>
                <tr>
                	<td><input type="button" value="4" class="calc_digits"></td>
                    <td><input type="button" value="5" class="calc_digits"></td>
                    <td><input type="button" value="6" class="calc_digits"></td>
                </tr>
                <tr>
                	<td><input type="button" value="1" class="calc_digits"></td>
                    <td><input type="button" value="2" class="calc_digits"></td>
                    <td><input type="button" value="3" class="calc_digits"></td>
                </tr>
                <tr>
                	<td><input type="button" value="0" class="calc_digits"></td>
                    <!--<td><input type="button" value="." class="calc_dot"></td>-->
                    <td colspan="2" class="right"><input type="button" value="clear" class="calc_clear"></td>
                </tr>
            </table>
            <h3>Old Furnace %</h3>
        	<table>
            	<tr>
                	<td><div class="number_display" id="old_eff">0</div></td>
                </tr>
                <tr>
                	<td><input type="button" value="60" class="calc_percent"></td>
                </tr>
                <tr>
                    <td><input type="button" value="70" class="calc_percent"></td>
                </tr>
                <tr>
                    <td><input type="button" value="80" class="calc_percent"></td>
                </tr>

            </table>
        </td>
        <td style="position:relative">
        	<div id="old_scale">Old:<span id="old_cost"></span></div>
            <div id="new1_scale">92:<span id="new1_cost"></span></div>
            <div id="new2_scale">95:<span id="new2_cost"></span></div>
        </td>
    </tr>
</table>
</div>
<div class="invoice-img-enlarge" title="Photo">
    <img src="<?=$imgPath?>" style="width:100%;">
</div>
</body>
</html>
