<?php
// any valid date in the past
header("Expires: Mon, 26 Jul 1997 05:00:00 GMT");
// always modified right now
header("Last-Modified: " . gmdate("D, d M Y H:i:s") . " GMT");
// HTTP/1.1
header("Cache-Control: private, no-store, max-age=0, no-cache, must-revalidate, post-check=0, pre-check=0");
// HTTP/1.0
header("Pragma: no-cache");
if($_GET['estimate']==1 || $_GET['fromEstimate']==1 ){
    if($_GET['from_booking']!=1){
	$url = "&estimate=1";
	$class="estimate_booking";
    }
}
else {
	$url="";
	$class="";
}
if(isset($_GET['job_truck'])){
$truck = "&job_truck=".$_GET['job_truck'];
}
if(isset($this->data['Order']['job_truck'])){
    $jobTruck = $this->data['Order']['job_truck'];
}
if(isset($this->data['Order']['job_time_beg'])){
    $jobTimeBeg = $this->data['Order']['job_time_beg'];
}
if(isset($this->data['Order']['job_time_end'])){
    $jobTimeEnd = $this->data['Order']['job_time_end'];
}
if(isset($this->data['Order']['estimate_page'])){
    $estimate_page = $this->data['Order']['estimate_page'];
}
if(isset($_GET['job_time_beg'])){
	$job_time_beg= "&job_time_beg=".$_GET['job_time_beg'];
}
if(isset($_GET['job_time_end'])){
	$job_time_end= "&job_time_end=".$_GET['job_time_end'];
}
if(isset($_GET['job_date'])){
	$job_date= "&job_date=".$_GET['job_date'];
}
else {
	$job_date = urlencode(date('d M Y'));
}

if($check_tele==1){
	$from_tele="&from_tele=1";
}
else {
	$from_tele="";
}

?>
    <?php
if($_GET['estimate']==1 || $_GET['fromEstimate']==1){ ?>
        <style>
            #OrderJobTimeBegHour,
            #OrderJobTimeEndHour {
                display: none;
            }
        </style>

        <?php } ?>
        <script language="javascript" type="text/javascript">
            window.onbeforeunload = function() {
                window.location.reload();
            }
            window.addEventListener('keydown', function(e) {
                if (e.keyIdentifier == 'U+000A' || e.keyIdentifier == 'Enter' || e.keyCode == 13) {
                    if (e.target.nodeName == 'INPUT' && e.target.type == 'text') {
                        e.preventDefault();
                        return false;
                    }
                }
            }, true);
        </script>
        <style>
            select.responses {
                width: 50%;
            }
            
            select.suggestions {
                width: 90%;
            }
            
            select.decisions {
                width: 90%;
            }
            
            select.reminders {
                width: 90%;
            }
            
            input.reminders {
                width: 90%;
            }
            /* Rating Star Widgets Style */
            
            .rating-stars ul {
                list-style-type: none;
                padding: 0;
                -moz-user-select: none;
                -webkit-user-select: none;
            }
            
            .rating-stars ul>li.star {
                display: inline-block;
            }
            /* Idle State of the stars */
            
            .rating-stars ul>li.star>i.fa {
                font-size: 1.7em;
                /* Change the size of the stars */
                color: #ccc;
                /* Color on idle state */
            }
            /* Hover state of the stars */
            
            .rating-stars ul>li.star.hover>i.fa {
                color: #FFCC36;
            }
            /* Selected state of the stars */
            
            .rating-stars ul>li.star.selected11>i.fa {
                color: #FF912C;
            }
            
            .estimate_booking {
                display: none;
            }
            
            .modal2 {
                display: none;
                /* Hidden by default */
                position: fixed;
                /* Stay in place */
                z-index: 1;
                /* Sit on top */
                left: 0;
                top: 0;
                width: 100%;
                /* Full width */
                height: 100%;
                /* Full height */
                overflow: auto;
                /* Enable scroll if needed */
                background-color: rgb(0, 0, 0);
                /* Fallback color */
                background-color: rgba(0, 0, 0, 0.4);
                /* Black w/ opacity */
            }
            /* Modal Content/Box */
            
            .modal-content2 {
                background-color: #fefefe;
                margin: 15% auto;
                /* 15% from the top and centered */
                padding: 20px;
                border: 1px solid #888;
                width: 80%;
                /* Could be more or less, depending on screen size */
            }
            /* The Close Button */
            
            .close {
                color: #aaa;
                float: right;
                font-size: 28px;
                font-weight: bold;
            }
            
            .close:hover,
            .close:focus {
                color: black;
                text-decoration: none;
                cursor: pointer;
            }
        </style>
        <?php
if(($_GET['estimate']==1 || $_GET['fromEstimate']==1) &&
($_GET['from_booking']!=1)
  ){

     ?>
            <style>
                #OrderJobTimeBegHour,
                #OrderJobTimeEndHour {
                    display: none;
                }
            </style>

            <?php } ?>

            <style>
                .images_div {
                    padding: 5px;
                    max-width: 800px;
                    border-bottom: 2px solid black;
                }
                
                .images_div img {
                    padding: 5px;
                }
                
                .dis_result {
                    padding: 10px;
                }
                
                .dis_result span {
                    padding: 10px;
                }
                
                table.recording {
                    font-family: arial, sans-serif;
                    border-collapse: collapse;
                    width: 100%;
                }
                
                table.recording td,
                th {
                    border: 1px solid #dddddd;
                    text-align: left;
                    padding: 8px;
                }
                
                div.call_book_div {
                    width: 28%;
                    float: left;
                    padding: 15px;
                }
                
                div.call_book_div textarea {
                    width: 90%;
                }
                
                table.imagesTable {
                    font-family: arial, sans-serif;
                    border-collapse: collapse;
                    width: 100%;
                }
                
                .imagesTable td,
                th {
                    border: 1px solid #dddddd;
                    text-align: left;
                    padding: 8px;
                }
                
                .modal1 {
                    display: none;
                    /* Hidden by default */
                    position: fixed;
                    /* Stay in place */
                    z-index: 1;
                    /* Sit on top */
                    padding-top: 100px;
                    /* Location of the box */
                    left: 36%;
                    top: 0;
                    width: 72%;
                    /* Full width */
                    height: 100%;
                    /* Full height */
                    overflow: auto;
                    /* Enable scroll if needed */
                }
                
                .dis_result {
                    padding: 10px;
                    border: 2px solid black;
                    margin-top: 5px;
                }
                /* Modal Content */
                
                .modal-content1 {
                    position: relative;
                    background-color: #fefefe;
                    margin: auto;
                    padding: 0;
                    border: 1px solid #888;
                    width: 80%;
                    box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
                    -webkit-animation-name: animatetop;
                    -webkit-animation-duration: 0.4s;
                    animation-name: animatetop;
                    animation-duration: 0.4s
                }
                /* Add Animation */
                
                @-webkit-keyframes animatetop {
                    from {
                        top: -300px;
                        opacity: 0
                    }
                    to {
                        top: 0;
                        opacity: 1
                    }
                }
                
                @keyframes animatetop {
                    from {
                        top: -300px;
                        opacity: 0
                    }
                    to {
                        top: 0;
                        opacity: 1
                    }
                }
                /* The Close Button */
                
                .close {
                    color: white;
                    float: right;
                    font-size: 28px;
                    font-weight: bold;
                    margin-top: -10px;
                }
                
                .close:hover,
                .close:focus {
                    color: #000;
                    text-decoration: none;
                    cursor: pointer;
                }
                
                .modal-header1 {
                    padding: 8px 6px;
                    background-color: #5cb85c;
                    color: white;
                }
                
                .modal-body1 span {
                    padding: 10px;
                }
                
                .modal-body {
                    padding: 10px 16px;
                }
                
                .modal-footer {
                    padding: 2px 16px;
                    background-color: #5cb85c;
                    color: white;
                }
                
                span.back_sche a {
                    font-size: 12px;
                    margin-left: 20%;
                    color: #007bff;
                }
                
                <?php if($_SESSION['user']['role_id']==1 && $estimate_page==1) {
                    ?>@media screen and (max-width: 767px) {
                        table#MainTable {
                            display: block !important;
                            height: auto !important;
                        }
                        table#MainTable>tbody {
                            display: block !important;
                            width: 100% !important;
                        }
                        table#MainTable>tbody>tr {
                            display: block !important;
                            width: 100% !important;
                        }
                        table#MainTable>tbody>tr>td {
                            display: block !important;
                            width: 100% !important;
                        }
                        .frame-wrap {
                            margin: 0 !important;
                            width: 100% !important;
                            display: block !important;
                        }
                        .frame-body {
                            display: block !important;
                            width: 100% !important;
                        }
                        .customerAddresses {
                            width: 100% !important;
                            margin-top: 0 !important;
                        }
                        table#tabA1 {
                            overflow: auto !important;
                        }
                        .buttons {
                            margin: 18px 0px;
                        }
                        table#MainTable * {
                            box-sizing: border-box;
                        }
                        table#MainTable .edit_info {
                            margin: 10px 0px !important;
                        }
                    }
                    <?php
                }
                
                ?>
            </style>


            <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />

            <script language="JavaScript" src="<?=ROOT_URL;?>/app/webroot/js/edit_help.js"></script>
            <script language="JavaScript" src="<?=ROOT_URL;?>/app/webroot/js/showhint.js"></script>
            <script type="text/javascript" src="<?=ROOT_URL;?>/app/webroot/js/jquery-ui-1.8.4.custom.min.js"></script>
            <script type="text/javascript" src="<?=ROOT_URL;?>/app/webroot/js/meio.js"></script>
            <script type="text/javascript" src="<?=ROOT_URL;?>/app/webroot/js/jquery-1.5.1.min.js"></script>
            <script language="JavaScript" src="<?=ROOT_URL;?>/app/webroot/js/tinymce/tinymce.min.js"></script>
            <script type="text/javascript" src="<?=ROOT_URL;?>/app/webroot/js/jquery-ui-1.8.21.custom.min.js"></script>
            <script type="text/javascript" src="<?=ROOT_URL;?>/app/webroot/js/jquery.quicksearch.js"></script>
            <script type="text/javascript" src="<?=ROOT_URL;?>/app/webroot/js/store_tree.js?time=<?= time()?>"></script>
            <script type="text/javascript" src="<?=ROOT_URL;?>/app/webroot/js/bria_api_constants.js"></script>
            <script type="text/javascript" src="<?=ROOT_URL;?>/app/webroot/js/bria_api_js_sample.js"></script>
            <script language="JavaScript" src="<?=ROOT_URL;?>/app/webroot/js/tinymce/tinymce.min.js"></script>
            <link rel="stylesheet" type="text/css" media="all" href="<?=ROOT_URL;?>/app/webroot/css/store_tree.css?time=<?= time()?>" />
            <link rel="stylesheet" type="text/css" media="all" href="<?=ROOT_URL;?>/app/webroot/css/ui-smooth/jquery-ui-1.8.13.custom.css" />
            <link href="<?=ROOT_URL;?>/app/webroot/new-dialler-css/font-awesome.css" rel="stylesheet" type="text/css">
            <link href="<?=ROOT_URL;?>/app/webroot/new-dialler-css/layout.css" rel="stylesheet" type="text/css">
            <link href="<?=ROOT_URL;?>/app/webroot/new-dialler-css/media-queries.css" rel="stylesheet" type="text/css">
            <link type="text/css" href="<?=ROOT_URL;?>/app/webroot/css/overcast/jquery-ui-1.8.4.custom.css" rel="stylesheet" />
            <script>
                //*** SET PAGE TITLE ***
                document.title += " :: Edit Booking";
                //**********************
            </script>
            <script language="JavaScript">
                function addTinyMCE(ele) {
                    tinyMCE.init({
                        selector: ele,
                        // mode: 'textareas',
                        file_picker_types: 'file image media',
                        theme: "modern",
                        browser_spellcheck: true,
                        plugins: "code,safari,pagebreak,style,layer,table,save,advhr,advimage,advlink,emotions,iespell,inlinepopups,insertdatetime,preview,media,searchreplace,print,contextmenu,paste,directionality,fullscreen,visualchars,nonbreaking,xhtmlxtras,template,imagemanager,filemanager, nanospell, link unlink, anchor, image, media,textcolor",
                        toolbar: "forecolor backcolor link image code bold italic formatselect numlist bullist indent outdent underline alignleft aligncenter alignright table ",
                        external_plugins: {
                            "nanospell": "plugins/nanospell/plugin.js"
                        },
                        nanospell_server: "php", // choose "php" "asp" "asp.net" or "java"
                        // Theme options
                        theme_advanced_buttons1: "save,newdocument,|,bold,italic,underline,strikethrough,|,justifyleft,justifycenter,justifyright,justifyfull,|,styleselect,formatselect,fontselect,fontsizeselect,|nanospell",
                        theme_advanced_buttons2: "cut,copy,paste,pastetext,pasteword,|,search,replace,|,bullist,numlist,|,outdent,indent,blockquote,|,undo,redo,|,link,unlink,anchor,image,cleanup,help,code,|,insertdate,inserttime,preview,|,forecolor,backcolor",
                        theme_advanced_buttons3: "tablecontrols,|,hr,removeformat,visualaid,|,sub,sup,|,charmap,emotions,iespell,media,advhr,|,print,|,ltr,rtl,|,fullscreen",
                        theme_advanced_buttons4: "insertlayer,moveforward,movebackward,absolute,|,styleprops,spellchecker,|,cite,abbr,acronym,del,ins,attribs,|,visualchars,nonbreaking,template,blockquote,pagebreak,|,insertfile,insertimage",
                        theme_advanced_toolbar_location: "top",
                        theme_advanced_toolbar_align: "right",
                        theme_advanced_statusbar_location: "bottom",
                        theme_advanced_resizing: true,

                        // Example content CSS (should be your site CSS)
                        content_css: "css/example.css",
                        toolbar_drawer: 'sliding',
                        convert_urls: true,
                        width: 800,
                        height: 600,
                        template_external_list_url: "js/template_list.js",
                        external_link_list_url: "js/link_list.js",
                        external_image_list_url: "js/image_list.js",
                        media_external_list_url: "js/media_list.js",
                        gecko_spellcheck: true,
                        browser_spellcheck: true
                    });
                }

                // function showEstimateReminder(e, oId) {
                //     var bodyRect = document.body.getBoundingClientRect(),
                //         elemRect = e.getBoundingClientRect(),
                //         offset = elemRect.top - bodyRect.top;

                //     console.log('Element is ' + offset + ' vertical pixels from <body>');
                //     var rect = e.getBoundingClientRect();
                //     console.log(rect.top, rect.right, rect.bottom, rect.left);
                //     var top = rect.top;
                //     if (offset > 800) {
                //         var offset1 = offset * .75;
                //     } else {
                //         var offset1 = offset * .95;
                //     }

                //     document.getElementById("orderId").value = oId;
                //     document.getElementById("reminderEmail").style.display = "block";
                //     $('#reminderEmail').css('marginTop', offset1 + 'px');
                // }

                function hideInvoiceReview() {
                    document.getElementById("reminderEmail").style.display = "none";
                }
                /*Loki: Open the purchase invoice page for editing*/
                function openInvoice(invoiceId = 0) {
                    if (invoiceId > 0) {
                        var url = "<?=BASE_URL?>/inventories/editDoc?invoice_id=" + invoiceId + "&doc_id=" + invoiceId + "& fromBooking=2&rurl=supplies";
                        var option = "width=1050,height=650,left=300,top=200,status=off,scroll=off,resizable=off";
                        var win = window.open(url, '', option);
                        var timer = setInterval(function() {
                            if (win.closed) {
                                clearInterval(timer);
                                var returnItem = win.returnPurchaseItem;
                                $('#MainItemsTable #CurrentItemsTable').children('tbody').children('.booked').each(function(i, el) {
                                    var itemId = $(el).children('td').children('.book_item_id').val();
                                    var curItem = $(el).attr('id');
                                    $.each(returnItem, function(key, value) {
                                        if (value.item_id == itemId) {
                                            $(el).children('.purchase').children('input').val(value.price);
                                            $(el).children('.part_number').children('input').val(value.sku);
                                            $(el).children('.quantity').children('input').val(value.quantity);
                                            $(el).children('td').children('.item_name').val(value.name);
                                            $(el).children('td').children('.org_item_name').html(value.name);

                                        }
                                    });
                                });

                                $('#CurrentItemsTableTech').children('tbody').children('tr').each(function(i, el) {
                                    var itemId = $(el).children('td').children('.book_item_id').val();
                                    var curItem = $(el).attr('id');
                                    $.each(returnItem, function(key, value) {
                                        if (value.item_id == itemId) {
                                            $(el).children('.purchase').children('input').val(value.price);
                                            $(el).children('.part_number').children('input').val(value.sku);
                                            $(el).children('.quantity').children('input').val(value.quantity);
                                            $(el).children('td').children('.item_name').val(value.name);
                                            $(el).children('td').children('.org_item_name').html(value.name);

                                        }
                                    });
                                });
                                TotalCalculation();
                                //$.each(returnItem, function( key, value ) {
                                //   addItem(value.item_id, value.name,'', tableNo,value.cat_id, value.price, "","1", '','',value.sku, value.quantity, "","", "", value.sub_cat_id);
                                // });
                            }
                        }, 500);
                    }
                }
                /* Loki: show/ hide email history data.
                   type: 1 = show
                   		 2 = hide
                */

                function showHideEmail(type) {
                    var cus_id = $('#CustomerId').val();
                    $.ajax({
                        url: '<?=BASE_URL?>/orders/showHideEmailHistory',
                        dataType: 'html',
                        type: 'POST',
                        cache: false,
                        data: {
                            type: type,
                            cus_id: cus_id
                        },
                        success: function(data) {
                            $("#sent_email").html(data);
                        }
                    });
                }
                // Loki: Send Email
                function sendSeparateEmail() {
                    var email = $('#editEmail').val();
                    var phone = $('#editphone').val();
                    var customerId = $('#CustomerId').val();
                    // var message = $('#emailVal').val();
                    var message = tinyMCE.activeEditor.getContent();
                    $.ajax({
                        url: '<?=BASE_URL?>/orders/sendSeparateEmail',
                        dataType: 'html',
                        type: 'POST',
                        cache: false,
                        data: {
                            email: email,
                            cusId: customerId,
                            message: message
                        },
                        success: function(data) {
                            res = JSON.parse(data);
                            if (res.res == "OK") {
                                window.location.reload();
                            }
                        }
                    });
                }
                //Loki check password for source chage
                function checkSourcePassword() {
                    var password = $("#sourcePassword").val();
                    if (password == '' || password == null || password == 'undefined') {
                        alert("Please insert password")
                    }
                    $.ajax({
                        url: '<?=BASE_URL?>/orders/checkSourcePassword',
                        dataType: 'JSON',
                        type: 'GET',
                        cache: false,
                        data: {
                            password: password
                        },
                        success: function(data) {
                            res = JSON.parse(data);
                            if (res.res == "1") {
                                $("#open_source_password").dialog("close");
                            } else {
                                alert("Please Insert correct password");
                            }
                        }
                    });
                }

                function closeSourcePassword() {
                    $('#open_source_password').dialog('close');
                }
                //Loki check password creditcard details
                function checkCCPassword() {
                    var password = $("#ccPassword").val();
                    var cusId = $("#CustomerId").val();
                    var ordId = $('#OrderId').val();
                    if (password == '' || password == null || password == 'undefined') {
                        alert("Please insert password")
                    }
                    $.ajax({
                        url: '<?=BASE_URL?>/orders/checkCCPassword',
                        dataType: 'JSON',
                        type: 'GET',
                        cache: false,
                        data: {
                            password: password,
                            cusId: cusId,
                            ordId: ordId
                        },
                        success: function(data) {
                            res = JSON.parse(data);
                            if (res.res == "1") {
                                // $(".creditCardDiv").show();
                                // $("#cardTransaction").show();
                                $("#creditCardNum").val(res.cardNum);
                                $("#cc_pass_box").dialog("close");
                            } else {
                                alert("Please Insert correct password");
                            }
                        }
                    });
                }

                function newCheckCCPassword() {
                    var password = $("#newccPassword").val();
                    var cusId = $("#CustomerId").val();
                    if (password == '' || password == null || password == 'undefined') {
                        alert("Please insert password")
                    }
                    $.ajax({
                        url: '<?=BASE_URL?>/orders/checkCCPassword',
                        dataType: 'JSON',
                        type: 'GET',
                        cache: false,
                        data: {
                            password: password,
                            cusId: cusId
                        },
                        success: function(data) {
                            res = JSON.parse(data);
                            if (res.res == "1") {
                                $("#creditCardNum1").val(res.cardNum);
                                $("#new_cc_pass_box").dialog("close");
                            } else {
                                alert("Please Insert correct password");
                            }
                        }
                    });
                }

                //Loki: Send review email
                function sendReviewEmail() {
                    var email = $('#editEmail').val();
                    var phone = $('#CustomerCellPhone').val();
                    var customerId = $('#CustomerId').val();
                    // var message = $('#emailVal').val();
                    var message = tinyMCE.activeEditor.getContent();
                    $.ajax({
                        url: '<?=BASE_URL?>/orders/sendReviewEmail',
                        dataType: 'html',
                        type: 'POST',
                        cache: false,
                        data: {
                            email: email,
                            cusId: customerId,
                            message: message,
                            phone: phone
                        },
                        success: function(data) {
                            res = JSON.parse(data);
                            if (res.res == "OK") {
                                hideReviewEmailBox();
                            }
                        }
                    });
                }



                //Loki: Send SMS
                function SendSms() {
                    var phone_number = $('#CustomerCellPhone').val();
                    var customerId = $('#CustomerId').val();
                    var message = $('#messageVal').val();
                    $.ajax({
                        url: '<?=BASE_URL?>/orders/SendSms',
                        dataType: 'html',
                        type: 'POST',
                        cache: false,
                        data: {
                            phone: phone_number,
                            cusId: customerId,
                            message: message
                        },
                        success: function(data) {
                            res = JSON.parse(data);
                            if (res.res == "OK") {
                                hideSmsBox();
                                //window.location.reload();
                            }
                        }
                    });
                }

                //Loki: Send Review SMS
                function SendReviewText() {
                    var phone_number = $('#CustomerCellPhone').val();
                    var customerId = $('#CustomerId').val();
                    var message = tinyMCE.activeEditor.getContent();
                    var email = $('#editEmail').val();
                    $.ajax({
                        url: '<?=BASE_URL?>/orders/sendReviewText',
                        dataType: 'html',
                        type: 'POST',
                        cache: false,
                        data: {
                            phone: phone_number,
                            cusId: customerId,
                            message: message,
                            email: email
                        },
                        success: function(data) {
                            res = JSON.parse(data);
                            if (res.res == "OK") {
                                hideReviewTextBox();
                            }
                        }
                    });
                }

                function editUserInfo() {
                    var firstName = $('#editFirstName').val();
                    var lastName = $('#editLastName').val();
                    var email = $('#editEmail').val();
                    var phone = $('#editphone').val();
                    var customerId = $('#CustomerId').val();
                    var cellPhone = $('#edit_cell_phone').val();
                    var street_no = $('#street_no').val();
                    var street_name = $('#street_name').val();
                    var city = $('#city123').val();
                    var postal_code = $('#postal_code123456').val();
                    if (postal_code.length < 6) {
                        alert("Please select postal code length should be 6");
                    } else {
                        $.ajax({
                            url: '<?=BASE_URL?>/users/editCustomerInfo',
                            dataType: 'html',
                            type: 'POST',
                            cache: false,
                            data: {
                                cellPhone: cellPhone,
                                phone: phone,
                                firstName: firstName,
                                lastName: lastName,
                                email: email,
                                cusId: customerId,
                                street_no: street_no,
                                street_name: street_name,
                                city: city,
                                postal_code: postal_code
                            },
                            success: function(data) {
                                res = JSON.parse(data);
                                if (res.res == "OK") {
                                    window.location.reload();
                                }
                            }
                        });
                    }
                }

                function call_cell_phone() {
                    var phone_number = $('#CustomerCellPhone').val();
                    window.parent.frame_browser.document.getElementById("first_call").value = 1;
                    window.parent.frame_browser.document.getElementById("currentUserId").value = $('#CustomerId').val();
                    window.parent.frame_browser.document.getElementById("currentUserPhoneNo")
                        .value = phone_number;
                    //$('#CustomerCellPhone').val();604-8415774

                    // $("#currentCallNum").val(phone_number);
                    bringToFront();
                    placeCall(phone_number);
                }

                function directPlaceCall() {
                    var phone_number = document.getElementById("direct-call").value;
                    placeCall(phone_number);
                }

                function call_phone() {
                    //var phone_number = '1 800 394 1980';
                    var phone_number = $('#CustomerPhone').val();
                    window.parent.frame_browser.document.getElementById("first_call")
                        .value = 1;
                    window.parent.frame_browser.document.getElementById("currentUserId").value = $('#CustomerId').val();
                    window.parent.frame_browser.document.getElementById("currentUserPhoneNo")
                        .value = phone_number;
                    // $("#currentCallNum").val(phone_number);
                    bringToFront();
                    placeCall(phone_number);
                }
                // function playRecording(recName)
                // {
                // 	console.log(recName);
                // }
                function DiallerJobsHistory() {
                    $.get("<?=BASE_URL;?>/orders/showCustomerJobs", {
                            customer_id: $('#CustomerId').val(),
                            fromDialer: 1,
                            order_id: '<?=$html->tagValue("Order/id")?>',
                            phone: '<?=$html->tagValue("Customer/phone")?>'
                        },
                        function(data) {
                            $("#Dialler-Job-History").html(data);
                            $('#Dialler-Job-History').show();
                        });
                }

                function showCallBack(followup = 0) {
                    $("#fromFollowup").val(followup);
                    $("#dialer_callback").dialog("open");
                }

                function showEditUserInfo() {
                    var postalCode = $('#CustomerPostalCode').val();
                    $('#postal_code123456').val(postalCode);
                    $("#editUserInfo").dialog("open");
                }

                function showSmsBox() {
                    $("#reminderSms").dialog("open");
                }

                function hideSmsBox() {
                    $("#reminderSms").dialog("close");
                }

                function showReviewTextBox() {
                    $("#reviewText").dialog("open");
                }

                function hideReviewTextBox() {
                    $("#reviewText").dialog("close");
                }

                function hidePermitBox() {
                    $("#permitTemp").dialog("close");
                }

                function showReviewEmailBox() {
                    $("#reviewEmail").dialog("open");
                }

                function hideReviewEmailBox() {
                    $("#reviewEmail").dialog("close");
                }


                function hideItemBox() {
                    $("#item_box").dialog("close");
                }

                function hideEmailBox() {
                    $("#sendSeparateEmail").dialog("close");
                }

                function hidePasswordBox() {
                    $("#open_source_password").dialog("close");
                }

                function emailInvoice(order_id, i = 0) {
                    var email = $('#emailinput').val();
                    var mainOrderId = $('#mainOrderId').val();
                    window.open('<?=BASE_URL?>/orders/invoiceTabletEprint?order_id=' + mainOrderId + '&email=' + email + '&type=office' + '&fromBooking=1', '_self');
                    return false;
                }

                function invoiceprint(order_id) {
                    var mainOrderId = $('#mainOrderId').val();
                    var print = document.getElementById("print_r").value;
                    if (print == "invoiceprint") {
                        window.open('<?=BASE_URL?>/calls/invoiceprint?order_id=' + mainOrderId, '_new');
                    }
                    if (print == "invoiceprintnototal") {
                        window.open('<?=BASE_URL?>/calls/invoiceprint?order_id=' + mainOrderId + '&total=no', '_new');
                    }
                    if (print == "invoiceprintblank") {
                        window.open('<?=BASE_URL?>/calls/invoiceprintblank?order_id=' + mainOrderId, '_new');
                    }
                    if (print == "invoiceTabletPrint") {
                        window.open('<?=BASE_URL?>/orders/invoiceTabletPrint?order_id=' + mainOrderId + '&type=office', '_new');
                    }
                }

                function showestimate(order_id) {
                    var mainOrderId = $('#mainOrderId').val();
                    var email = $('#emailinput').val();
                    window.open('<?=BASE_URL?>/orders/showEstimateForOrder?order_id=' + mainOrderId + '&email=' + email);
                }

                function saveorgniser() {
                    if (confirm('are you sure')) {
                        var order_id = "<?= $_REQUEST['booking_id'] ?>";
                        var href = window.location.href;

                        $.ajax({
                            url: "<?=BASE_URL;?>/settings/saveOrgniser",
                            type: "GET",
                            data: {
                                order_id: order_id,
                                href: href
                            },
                            success: function(data) {

                                alert('saved succesfully');

                            }
                        });
                    }
                }

                function showestimateSubmit() {
                    document.getElementById('preViewEstimate').value = 0;
                    document.getElementById('sendMailOnEstimate').value = 0;
                    var status = ValidateFields(1);
                    if (status) {
                        document.forms['editBookingform'].submit();
                    }

                }

                function onSubstatusChange(el) {
                    if ($(el).val() == 4) $('#notifiedBy').show();
                    else $('#notifiedBy').hide();
                }

                function CheckPaymentMethod(elem) {
                    if (elem.value == 9) {
                        $(".fin_fields").show();
                    } else {
                        $(".fin_fields").hide();
                    }
                }

                function GetCalc() {
                    var prc = $("#calc_price").val();
                    var per = $("#calc_period").val();
                    $.post("<?=BASE_URL?>/orders/calc", {
                            calc_price: prc,
                            calc_period: per
                        },
                        function(data) {
                            val = jQuery.parseJSON(data);
                            $("#calc_monthly").html('$' + val['calc_monthly']);
                            //				$("#calc_total").html('$'+val['calc_total']);
                        });
                }
                var CheckPrcCount = 0;
                var nopen = <?=$tab_num?>;
                var item_type = 0;
                var items_opend = -1;

                function openTab(n) {

                    $('#tabA' + nopen).hide();
                    $('#trigger' + nopen).addClass('tabOff');
                    $('#trigger' + nopen).removeClass('tabOver');
                    $('#tabA' + n).show();
                    $('#trigger' + n).removeClass('tabOff');
                    $('#trigger' + n).addClass('tabOver');

                    if (1 == n) {

                        // location.href='./editBooking?order_id=<?=$this->data['Order']['id']?>';
                        //Loki commented
                        //$("#show-new-booking").trigger("click");
                    }
                    nopen = n;
                }

                function ShowAN(el) {
                    //  if (($(el).val()>2)&&($(el).val()<6))	$("#auth_number").parent().show();
                    // else $("#auth_number").parent().hide();
                }

                function ChangeSupplier(element) {
                    if (element.value)
                        $.get("<?=BASE_URL;?>/orders/getSupplierInfo", {
                                id: element.value
                            },
                            function(data) {
                                val = jQuery.parseJSON(data);
                                txt = '';
                                dev = '';
                                if (val['phone']) {
                                    txt += "phone: " + val['phone'];
                                    dev = ', ';
                                }
                                if (val['address']) txt += dev + "addr: " + val['address'];
                                if (val['city']) txt += dev + ", " + val['city'];
                                $("#SupplierInfo").html(txt);
                                $("#purchase_supplier_info").val(txt);
                                $("#purchase_supplier_name").val(val['name']);
                            });
                }

                function createMessage() {
                    var answer = window.open("<?=BASE_URL?>/messages/EditMessage?order_id=<?php echo $this->data["
                        Order "]["
                        id "];?>&customer_id=<?php echo $this->data["
                        Customer "]["
                        id "];?>", '',
                        "width=450, height=300, left=300,top=200");

                }

                function showFeedback() {
                    var answer = window.open("<?=BASE_URL?>/orders/feedbacks_add?id=<?php echo $this->data["
                        Order "]["
                        id "];?>", '',
                        "width=850, height=600, left=300,top=200");

                }

                function SaveCustomerData() {
                    $.get("<?=BASE_URL;?>/orders/saveCustomerData", {
                            customer_id: $('#CustomerId').val(),
                            customer_first_name: $('#CustomerFirstName').val(),
                            customer_last_name: $('#CustomerLastName').val(),
                            customer_email: $('#emailinput').val(),
                            customer_city: $('#CustomerCity').val(),
                            customer_postcode: $('#CustomerPostalCode').val(),
                            customer_address_unit: $('#CustomerAddressUnit').val(),
                            customer_address_street_number: $('#CustomerAddressStreetNumber').val(),
                            customer_address_street: $('#CustomerAddressStreet').val(),
                            customer_phone: $('#CustomerPhone').val(),
                            customer_cell_phone: $('#CustomerCellPhone').val(),
                            customer_card_number: $('#CustomerCardNumber').val(),
                            customer_card_exp: $('#data[Customer][card_exp]').val(),
                            customer_next_service: $('#data[Customer][next_service]').val()
                        },
                        function(data) {
                            $('#CustomerId').val(data);
                            AddCustomerNote();
                        }
                    );
                }

                function showToalJobHistory() {
                    $.get("<?=BASE_URL;?>/orders/showCustomerJobs", {
                            customer_id: $('#CustomerId').val(),
                            order_id: '<?=$html->tagValue("Order/id")?>',
                            phone: '<?=$html->tagValue("Customer/phone")?>'
                        },
                        function(data) {
                            $("#TotalJobHistory").html(data);
                        });
                }

                function OpenJobsHistory() {
                    $("#JobHistoryWorking").show();
                    $("#JobHistoryWorking11").show();
                    $.get("<?=BASE_URL;?>/orders/showCustomerJobs", {
                            customer_id: $('#CustomerId').val(),
                            order_id: '<?=$html->tagValue("Order/id")?>',
                            phone: '<?=$html->tagValue("Customer/phone")?>'
                        },
                        function(data) {
                            $("#JobHistory").html(data);
                            $('#JobHistory').show();
                            $('#OpenHistoryText').hide();
                            $('#CloseHistoryText').show();
                            $("#JobHistoryWorking").hide();
                            $("#JobHistoryWorking11").hide();
                            $("#Dialler-Job-History123456").html(data);
                            $('#Dialler-Job-History123456').show();
                        });
                }

                function CloseJobsHistory() {
                    $('#JobHistory').hide();
                    $('#OpenHistoryText').show();
                    $('#CloseHistoryText').hide();
                }

                function JobTypeChange(fromTech) {
                    jt = $('#OrderOrderTypeId').val();
                    $('#OrderOrderTypeId').removeAttr('size');
                    // if(fromTech != 1){
                    // }
                    // for Local
                    // if ((jt==10)||(jt==31) || (jt==70)) $('#ApplianceOrder').show();  else $('#ApplianceOrder').hide();
                    $.get("<?=BASE_URL;?>/jobs/getPackage", {
                            job_type: jt
                        },
                        function(data) {
                            $("#installation_item_val").val(parseInt(data));
                        });

                    if ((jt == 10) || (jt == 31) || (jt == 81)) $('#ApplianceOrder').show();
                    else $('#ApplianceOrder').hide();
                    if ((jt == 9) || (jt == 10)) {
                        $("#PreviousSection").show();
                        if (!$("#OrderJobEstimateId").val()) {
                            customer_id = $("#CustomerId").val();
                            phone = $("#CustomerPhone").val();
                            $.get("<?=BASE_URL;?>/orders/getLastJob", {
                                    customer_id: customer_id,
                                    phone: phone
                                },
                                function(data) {
                                    val = jQuery.parseJSON(data);
                                    $("#OrderJobEstimateId").val(val.job_id);
                                    $("#OrderBookingSourceId").val(val.source1_id);
                                    $("#OrderBookingSource2Id").val(val.source2_id);
                                    $("#OrderJobEstimateText").html(val.job_text);
                                });
                        }
                    } else {
                        $("#PreviousSection").hide();
                        $.get("<?=BASE_URL;?>/jobs/getCategory", {
                                job_type: jt
                            },
                            function(data) {
                                //for installation jobs show the appliance order

                                if (parseInt(data) == 2 || parseInt(data) == 5) {
                                    $('#ApplianceOrder').show();
                                }
                                //for all jobs show the questions section
                                OpenQuestions(0);
                            });
                    }



                }

                function OpenQuestions(tt) {
                    $('#QuestionsWorking' + tt).show();
                    jt = $('#OrderOrderTypeId').val();
                    //$.get("<?=BASE_URL;?>/orders/showQuestions",
                    <?php if($use_template_questions == 1) { ?>
                    $.get("<?=BASE_URL;?>/orders/showTemplateQuestions",
                        <?php } else { ?>
                        $.get("<?=BASE_URL;?>/orders/showTabletQuestions",
                            <?php } ?> {
                                order_id: '<?=$html->tagValue("Order/id")?>',
                                job_type: jt,
                                question_type: tt,
                                customer_id: document.getElementById('CustomerId').value
                            },
                            function(data) {
                                $('#OpenQuestionsText').hide();
                                $('#CloseQuestionsText').show();
                                $('#JobDetails' + tt).html(data);
                                $('#JobDetails' + tt).show();
                                last_jt = jt;
                                $('#QuestionsWorking' + tt).hide();
                                checkText();
                            });
                    }

                    function CloseQuestions() {
                        $('#JobDetails0').hide();
                        $('#JobDetails1').hide();
                        $('#JobDetails2').hide();
                        $('#OpenQuestionsText').show();
                        $('#CloseQuestionsText').hide();
                    }

                    function addItem(item_id, item_name, item_prc, new_type, new_category, new_pp, part_number, show_purchase = '', model_number, item_brand = '', sku = '', quantity = 0, purchase_invoice = '', supplier_invoice = '', supplier_name = '', sub_category = '', invoiceId = 0, markupPercent = 52, techPercent = 30) {
                        $("#item_selector0").html("").hide();
                        $("#item_selector1").html("").hide();
                        var index = 1 * document.getElementById("NumberOfItems").value;
                        if (new_type == 0) tbl = document.getElementById("CurrentItemsTable");
                        else tbl = document.getElementById("CurrentItemsTableTech");
                        var lastRow = tbl.rows.length - 1;
                        var row = tbl.insertRow(lastRow);
                        if (new_type == 0) row.setAttribute("class", "booked");
                        else row.setAttribute("class", "extra");
                        row.setAttribute("id", "order_" + index);
                        if (quantity > 0) {
                            quantity = quantity;
                        } else {
                            quantity = 1;
                        }
                        var itemTech = $("#OrderJobTechnician1Id ").val();
                        bodyContent = $.ajax({
                            url: "<?=BASE_URL?>/orders/newItemHTML",
                            type: "GET",
                            data: ({
                                index: index,
                                actions: true,
                                item_id: item_id,
                                name: item_name,
                                price: item_prc,
                                quantity: quantity,
                                category: new_category,
                                price_purchase: new_pp,
                                part_number: part_number,
                                item_class: new_type,
                                show_purchase: show_purchase,
                                model_number: model_number,
                                brand: item_brand,
                                invoice_image: purchase_invoice,
                                supplier_name: supplier_name,
                                supplier_invoice: supplier_invoice,
                                sku: sku,
                                sub_category_id: sub_category,
                                invoiceId: invoiceId,
                                itemTech: itemTech,
                                markupPercent: parseFloat(markupPercent),
                                techPercent: parseFloat(techPercent)
                            }),
                            dataType: "html",
                            async: false
                        }).responseText;
                        $("#order_" + index).html(bodyContent);
                        index++;
                        /*Loki: if choose labour item set commision as installer fixed.
                            live catid = 37, local=38
                        */
                        if (new_category == 37) {
                            $("#OrderT1Method").val(2);
                            $("#OrderT2Method").val(2);
                        }
                        if (new_category == 1) {
                            //$("#OrderT1Method").val(1);
                            //$("#OrderT2Method").val(1);
                        }
                        TotalCalculation();
                        document.getElementById("NumberOfItems").value = index;
                    }

                    function removeItem(item_num, item_id = 0) {
                        document.getElementById("data[Order][BookingItem][" + item_num + "][quantity]").value = "0";
                        $("#order_" + item_num).remove();
                        TotalCalculation();
                        var orderNum = $("#po_number").val();
                        if (item_id != 0) {
                            $.get("<?=BASE_URL;?>/orders/deleteInventoryItem", {
                                    order_num: orderNum,
                                    item_id: item_id
                                },
                                function(data) {});
                        }
                        //		var index=1*document.getElementById("NumberOfItems").value;
                        //    document.getElementById("NumberOfItems").value=index-1;
                    }

                    function AddCustomerNote() {
                        var customer_id = document.getElementById("CustomerId");
                        var customer_note = document.getElementById("txt_customer_note");
                        if (customer_note == null || customer_note.value == "") {
                            //		alert("Please enter note!");
                            //		customer_note.focus();
                            return;
                        }
                        //1. Add note
                        if (!customer_id.value) SaveCustomerData();
                        else
                            $.get("<?=BASE_URL;?>/orders/customer_notes_add_ajax", {
                                    customer_id: customer_id.value,
                                    note: customer_note.value
                                },
                                function(data) {
                                    val = jQuery.parseJSON(data);
                                    addRowToTable(val['date'], val['note'], val['created_by']);
                                    customer_note.value = "";
                                });
                    }

                    function showPayments() {
                        var id = $('#OrderId').val();
                        $.get("<?=BASE_URL;?>/payments/techPaymentsForJob", {
                                order_id: id
                            },
                            function(data) {
                                $('#PaymentsDetails').html(data);
                            });
                    }

                    function SavePayment() {
                        var id = $('#OrderId').val();
                        var method = $("#method").val();
                        var amount = $("#amount").val();
                        var auth_number = 123;
                        if (!method) {
                            alert('A payment method should be selected!');
                            return;
                        }
                        if ((method > 2) && (method < 6) && (!auth_number)) {
                            alert('An authorization number is required!');
                            return;
                        }
                        $.post("<?=BASE_URL;?>/payments/savePayment", {
                            order_id: id,
                            method: method,
                            amount: amount,
                            payment_type: 1,
                            auth_number: auth_number
                        }, function(data) {
                            $('#cancel_payment_link').click();
                            showPayments();
                        });
                    }

                    function ErasePayment(payment_id) {
                        $.post("<?=BASE_URL;?>/payments/deletePayment", {
                            payment_id: payment_id
                        }, function(data) {
                            showPayments();
                        });
                    }

                    function addRowToTable(date, note, created_by) {
                        var tbl = document.getElementById('note_table');
                        var lastRow = tbl.rows.length;
                        //2- header, 1-separator
                        //alert((lastRow/2)- 1);
                        var row = tbl.insertRow(lastRow);
                        row.setAttribute("style", "height: 20px;background-color:#F8F7F9;");
                        var cellDate = row.insertCell(0);
                        var textNodeDate = document.createTextNode(date);
                        cellDate.appendChild(textNodeDate);
                        var cellCreatedBy = row.insertCell(1);
                        var textNodeCreatedBy = document.createTextNode(created_by);
                        cellCreatedBy.appendChild(textNodeCreatedBy);
                        var row2 = tbl.insertRow(lastRow + 1);
                        row2.setAttribute("style", "height: 20px;");
                        var cellNote = row2.insertCell(0);
                        var textNodeNote = document.createTextNode(note);
                        cellNote.appendChild(textNodeNote);
                        //Add Separator
                        var row1 = tbl.insertRow(lastRow + 2);
                        var cellSeparator = row1.insertCell(0);
                        cellSeparator.setAttribute("colSpan", 3);
                        cellSeparator.setAttribute("style", "background: #AAAAAA; height: 2px;");
                    }

                    function isValidEmail(email) {
                        var re = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
                        return re.test(email);
                    }

                    function ValidateFields(jobstatus, show_box = 0) {

                        var check_estimate = "<?php echo $class; ?>";
                        if (jobstatus == 5) {

                            showInvoiceReview();
                            return false;
                        }
                        var submitForm = true;
                        var errorMsg = "";
                        var CurState = $('#radiostatus:checked').val();
                        if (jobstatus) document.getElementById('OrderOrderStatusId').value = jobstatus;
                        if (CurState == 6 || (CurState == 3) || (CurState == 2)) {
                            $("#OrderJobTruck").val(0);
                            document.forms['editBookingform'].submit();
                            return;
                        }
                        var apptNo = $("#CustomerAddressUnit").val();
                        var buzz = $("#CustomerBuzz").val();
                        if (apptNo != '') {
                            if (buzz == '' || buzz == null) {
                                errorMsg += "Please fill buzz number.\n";
                            }
                        }

                        // Job type
                        var jobType = $("#OrderOrderTypeId").val();
                        if (jobType <= 0) {
                            submitForm = false;
                            errorMsg += "Please select a job type.\n";
                        }
                        // Customer's phone
                        var cell_phone = $("#CustomerCellPhone").val();
                        if ((cell_phone == null) || trim(cell_phone) == '') {
                            submitForm = false;
                            errorMsg += "Please enter a cell phone for this customer.\n";
                        } else
                            $("#CustomerCellPhone").val(trim(cell_phone));
                        // Customer landline Number
                        var phone = $("#CustomerPhone").val();
                        $("#CustomerPhone").val(trim(phone));
                        // Customer's Email
                        var email = $("#emailinput").val();
                        if ((email == null) || trim(email) == '') {
                            submitForm = false;
                            errorMsg += "Please enter an email for this customer.\n";
                            $("#emailinput").focus();
                        } else {
                            //check if email is valid
                            if (!isValidEmail(email)) {
                                submitForm = false;
                                errorMsg += "Please enter in a valid email for this customer.\n";
                                $("#emailinput").focus();
                            } else
                                $("#emailinput").val(trim(email));
                        }

                        // question validation for text type
                        $(".text_response").each(function() {
                            if ($(this).val() == '') {
                                submitForm = false;
                                var respons = $(this).parent().prev().html();
                                errorMsg += "Please enter a Response text for this Questions\n" + respons + "\n";
                            }
                        });

                        // question validation for drop down
                        $(".responses").each(function() {
                            if ($(this).children("option:selected").val() == '') {
                                submitForm = false;
                                var respons = $(this).parent().prev().html();
                                errorMsg += "Please enter a Response text for this Questions\n" + respons + "\n";
                            }
                        });
                        // LOKI: check Customer payment method
                        var val = $("#PaymentPaymentMethodId").val();
                        if (val == 0 || val == '') {
                            submitForm = false;
                            errorMsg += "Please set the payment method.\n";
                        }
                        // Customer's postal code
                        var val = $("#CustomerPostalCode").val();
                        if (val == '') {
                            submitForm = false;
                            errorMsg += "Please enter a postal code for the customer\n";
                        }
                        var val3 = $("#CustomerPostalCode").val().length;
                        if (val3 < 6) {
                            submitForm = false;
                            errorMsg += "postal code should be exactly six digits.\n";
                        }
                        if (jobstatus != 8) {

                            // Check truck number
                            var truck = $("#OrderJobTruck").val();
                            if (truck <= 0) {
                                submitForm = false;
                                errorMsg += "Please select a route (truck) number.\n";
                            }
                            // Check job date
                            var date = $("#OrderJobDate").val();
                            if (date <= 0) {
                                submitForm = false;
                                errorMsg += "Please set the date for this job.\n";
                            }
                            // Check job time
                            var valb = $("#OrderJobTimeBegHour").val();
                            if (valb <= 0 && check_estimate != 'estimate_booking') {
                                submitForm = false;
                                errorMsg += "Please set the job start time.\n";
                            }
                            var vale = $("#OrderJobTimeEndHour").val();
                            if (vale <= 0 && check_estimate != 'estimate_booking') {
                                submitForm = false;
                                errorMsg += "Please set the job end time.\n";
                            }
                            if (vale == valb && check_estimate != 'estimate_booking') {
                                submitForm = false;
                                errorMsg += "Job start and job end hours must not be equal!\n";
                            }

                        }
                        //Check if spoken to is empty
                        // var valf = $("#OrderSSpokeTo").val();
                        // if (valf == '') {
                        // 	submitForm = false;
                        // 	errorMsg += "Spoke to must be filled in\n";
                        // }
                        if (jobstatus == 3) {
                            var valg = $("#NoteMessage").val();
                            $("#send_cancalled_email").val(1);
                            if (valg == '') {
                                submitForm = false;
                                errorMsg += "Put a reason for cancellation on the notes\n";
                            }
                        }
                        // Check questions
                        /*   NumOfItems=(document.getElementById('DetailsTable').rows.length-1)/2;
    for(j=0; j<NumOfItems; j++)
    {
				aaa = document.getElementById('data[Order][OrdersQuestions]['+(1*j)+'][local_answer]').value;
				if (aaa=="") {
				  submitForm = false;
			    errorMsg += "Please, answer ALL the questions before saving.\n";
				  break;
				}
    }*/
                        // Check items
                        var index = 1 * document.getElementById("NumberOfItems").value;
                        if (index == 0) {
                            submitForm = false;
                            errorMsg += "Please add at least one item.\n";
                        }
                        //****************
                        var is_installed = true;
                        $('.is_installed').each(function() {
                            if ($(this).val() == 0) {
                                is_installed = false;
                                return;
                            }
                        });
                        if (!is_installed) {
                            alert("Please indicate if the part was installed/not installed");
                            return;
                        }
                        var selectObj = document.getElementById('CustomerCity');
                        var customerCity = selectObj.value;


                        var OrderID = '<?=$html->tagValue("Order/id")?>';
                        //alert(OrderID);
                        if (submitForm) {

                            if (((submitForm == true) && (OrderID != '')) && jobstatus != 1) {

                                var orderTypeId = $("#OrderOrderTypeId").val();
                                var supplierId = $("#OrderAppOrderedSupplierId").val();
                                // Local = 70 live= 81
                                if (orderTypeId == 81) {
                                    if (supplierId == "" || supplierId == null) {
                                        alert("Please fill supplier details.");
                                        return false;
                                    }
                                }
                                $.get("<?=BASE_URL;?>/orders/conflictCheckExistingJob", {
                                        jobstatus: jobstatus,
                                        customer_city: customerCity,
                                        job_date: date,
                                        job_truck: truck,
                                        job_from: valb,
                                        job_to: vale,
                                        estimate: check_estimate,
                                        user_role_id: '<?php echo $common->getLoggedUserRoleID() ?>',
                                        order_id: '<?=$html->tagValue("Order/id")?>'
                                    },

                                    function(data) {
                                        var res = data.trim();
                                        if (data.indexOf('OK') > 0) {
                                            if (document.getElementById('OrderOrderStatusId').value == 5) {
                                                $("#msgbx1").html("<strong>Do you want to send the Invoice?</strong>");
                                                showInvoiceMessage();
                                            } else {
                                                if (document.getElementById('sendMailOnEstimate').value == 1) {
                                                    CheckMailSent(OrderID);
                                                    return false;
                                                }
                                            }

                                        } else {
                                            alert(res);
                                            return false;
                                        }
                                    });
                            } else if (jobstatus != 8) {
                                var is_zero = 0;
                                $('.check_item_prize').each(function(index, value) {
                                    var purchasePrize = $(this).val();
                                    if (purchasePrize == 0 || purchasePrize == '0') {
                                        $(this).css("border", "1px solid red");
                                        is_zero++;
                                    } else {
                                        $(this).css("border", "1px solid black");
                                    }
                                });
                                if (is_zero > 0) {
                                    alert("Please add purchase price for custom part.");
                                    return false;
                                }
                                var orderTypeId = $("#OrderOrderTypeId").val();
                                var supplierId = $("#OrderAppOrderedSupplierId").val();
                                // Local = 70 live= 81
                                if (orderTypeId == 81) {
                                    if (supplierId == "" || supplierId == null) {
                                        alert("Please fill supplier details.");
                                        return false;
                                    }
                                }
                                $.get("<?=BASE_URL;?>/orders/conflictCheck", {
                                        jobstatus: jobstatus,
                                        customer_city: customerCity,
                                        job_date: date,
                                        job_truck: truck,
                                        job_from: valb,
                                        job_to: vale,
                                        estimate: "<?php echo $class ?>",
                                        user_role_id: '<?php echo $common->getLoggedUserRoleID() ?>',
                                        order_id: '<?=$html->tagValue("Order/id")?>'
                                    },
                                    function(data) {
                                        var res = data.trim();
                                        if (data.indexOf('OK') > 0) {
                                            var check_es = $('#OrderJobTruck').val();
                                            if (show_box == 1 && check_es != 40) {
                                                var post_code = $("#CustomerPostalCode").val();
                                                $.get("<?=BASE_URL;?>/orders/getPostalDistance", {
                                                        job_truck: truck,
                                                        postal_code: post_code,
                                                        start_time: valb
                                                    },
                                                    function(data) {
                                                        res = JSON.parse(data);
                                                        if (res.res == 1) {
                                                            $("#msgbx").html("Do you want to send the email/text?");
                                                            showme();
                                                        } else if (res.res == 0) {
                                                            $("#msgbx").html("Distance from the last job is " + res.distance + ". Do you still want to book a job and send Email/Text ?");
                                                            showme(1);
                                                        }

                                                    });
                                            } else {
                                                if (check_es == 40) {
                                                    $("#SendMailAgain").val(0);

                                                }
                                                document.forms['editBookingform'].submit();
                                            }

                                        } else {
                                            alert(res);
                                        }

                                    });
                            } else {
                                //alert('submitForm');
                                document.forms['editBookingform'].submit();
                            }
                        } else alert(errorMsg);

                        if (jobstatus == 5) {

                            // Prompt user to send a thank you email when the "Done by Tech"
                            // button is pressed from the editBooking page.
                            if (!confirm("Send email to client?")) {
                                return;
                            }
                            var x = screen.width / 2 - 800 / 2; // width of popup window
                            var y = screen.height / 2 - 540 / 2; // height of popup window
                            window.open(
                                '../orders/thank_you?id=<?php echo $this->data["Order"]["id"]; ?>&email=' +
                                $('#emailinput').val(),
                                '_blank',
                                'scrollbars=1,height=540,width=800,left=' + x + ',top=' + y,
                                false
                            );
                        }

                    }

                    //loki: function to modify the tech and mark percentage.
                    function techMarkupChanges(techPercent) {
                        var percentVal = $(techPercent).val();
                        var newPrchAmount = 0;
                        var newMarkupAmount = 0;
                        var calType = $(techPercent).attr('cal-type');
                        var itemId = $("#percentageItem").val();
                        $("#" + itemId).children('td').children('.item_updated').val(1);
                        if (calType == 'tech') {
                            var percentType = $(techPercent).attr('purchaseType');
                            var purch = $("#" + itemId).children('.purchase').children('input').val();
                            var itemPrice = $("#" + itemId).children('.price').children('input').val();
                            var itemTechPice = $("#" + itemId).children('.tech_purchase').children('input').val();
                            var markupPrice = (parseFloat(itemPrice) - (parseFloat(purch) + parseFloat(itemTechPice)));
                            if (percentType == 1) {
                                var newPrchAmount = (parseFloat(purch) * parseInt(percentVal)) / 100;
                            } else if (percentType == 2) {
                                var newPrchAmount = parseFloat(percentVal);
                            }
                            var newMarkupAmount = parseFloat(markupPrice) + parseFloat(newPrchAmount);
                            $("#" + itemId).children('.tech_purchase').children('input').val(parseFloat(newPrchAmount));
                            $("#" + itemId).children('.price').children('input').val(parseFloat(purch) + parseFloat(newMarkupAmount));
                            $("#" + itemId).children('td').children('.item_tech_percent').val(percentVal);

                            $("#" + itemId).children('td').children('.item_tech_percent_type').val(percentType);
                        } else {
                            var percentType = $(techPercent).attr('markupType');
                            var purch = $("#" + itemId).children('.purchase').children('input').val();
                            var newPrchAmount = $("#" + itemId).children('.tech_purchase').children('input').val();
                            if (percentType == 1) {
                                var newMarkupAmount = parseFloat(newPrchAmount) + (parseFloat(purch) * parseInt(percentVal)) / 100;
                            } else if (percentType == 2) {
                                var newMarkupAmount = parseFloat(newPrchAmount) + parseFloat(percentVal);
                            }
                            var totalNewAmount = parseFloat(purch) + parseFloat(newMarkupAmount);
                            $("#" + itemId).children('.price').children('input').val(totalNewAmount);
                            $("#" + itemId).children('td').children('.item_markup_percent').val(percentVal);
                            $("#" + itemId).children('td').children('.item_markup_percent_type').val(percentType);
                        }
                    }

                    function TotalCalculation(techPercent) {
                        subtotal = 0;
                        CheckPrcCount = 0;
                        invoiceSubTotal = 0;
                        amount = 0;
                        newSubtotal = 0;
                        $('#MainItemsTable #CurrentItemsTable').children('tbody').children('.booked').each(function(i, el) {
                            qty = $(el).children('.quantity').children('input').val();
                            if (qty != null && qty != undefined) {
                                var curItem = $(el).attr('id');
                                prc = $(el).children('.price').children('input').val();
                                var purch = $(el).children('.purchase').children('input').val();
                                var catId = $(el).children('td').children('.item_cat_id').val();
                                var itemUpdated = $(el).children('td').children('.item_updated').val();
                                disc = $(el).children('.discount').children('input').val();
                                add = $(el).children('.addition').children('input').val();
                                if (prc == "") prc = 0;
                                if (disc == "") disc = 0;
                                if (add == "") add = 0;
                                if (purch == "") purch = 0;
                                if (catId != 59) {
                                    amount = parseFloat(prc) * qty - (1 * disc) + (1 * add);
                                    subtotal += amount;
                                }
                                $(el).children('.amount').html('$' + amount);
                                var purchase = (purch * qty);
                                var orgPrc = (prc * qty);
                                if ($(el).children('.order_status_val ').children('input').is(":checked")) {
                                    invoiceSubTotal += parseFloat(purch) * qty;
                                }
                                // Local caiId = 37 live=
                                if ((catId == 59) && itemUpdated == 0) {
                                    var percentVal = $(el).children('td').children('.item_tech_percent').val();
                                    var percentType = $(el).children('td').children('.item_tech_percent_type').val();
                                    var markupPercentVal = $(el).children('td').children('.item_markup_percent').val();
                                    var markupPercentType = $(el).children('td').children('.item_markup_percent_type').val();

                                    var newMarkupAmount = 0;
                                    var newPrchAmount = 0;
                                    if (percentType == 1) {
                                        if ((percentVal > 0) && (percentVal != '')) {
                                            var newPrchAmount = (parseFloat(purch) * parseInt(percentVal)) / 100;
                                        }
                                    } else if (percentType == 2) {
                                        if ((percentVal > 0) && (percentVal != '')) {
                                            var newPrchAmount = parseFloat(percentVal);
                                        }
                                    }
                                    if (markupPercentType == 1) {
                                        if ((markupPercentVal > 0) && (markupPercentVal != '')) {
                                            var newMarkupAmount = (parseFloat(purch) * parseInt(markupPercentVal)) / 100;
                                        }
                                    } else if (markupPercentType == 2) {
                                        if ((markupPercentVal > 0) && (markupPercentVal != '')) {
                                            var newMarkupAmount = parseFloat(markupPercentVal);
                                        }
                                    }
                                    var totalMarkupAmount = (parseFloat(purch) + parseFloat(newMarkupAmount) + parseFloat(newPrchAmount)).toFixed(2);
                                    amount = parseFloat(totalMarkupAmount) * qty - (1 * disc) + (1 * add);
                                    subtotal += amount;
                                    $(el).children('.amount').html('$' + amount);
                                    // $(el).children('.tech_purchase').children('input').val('');
                                    $(el).children('.tech_purchase').children('input').val(parseFloat(newPrchAmount.toFixed(2)) * qty);
                                    $(el).children('.price').children('input').val(totalMarkupAmount);

                                }
                                if ((catId == 59) && itemUpdated == 1) {
                                    var percentVal = $(el).children('td').children('.item_tech_percent').val();
                                    var percentType = $(el).children('td').children('.item_tech_percent_type').val();
                                    var markupPercentVal = $(el).children('td').children('.item_markup_percent').val();
                                    var markupPercentType = $(el).children('td').children('.item_markup_percent_type').val();
                                    var newMarkupAmount = 0;
                                    var newPrchAmount = 0;
                                    if (percentType == 1) {
                                        if ((percentVal > 0) && (percentVal != '')) {
                                            var newPrchAmount = (parseFloat(purch) * parseInt(percentVal)) / 100;
                                        }
                                    } else if (percentType == 2) {
                                        if ((percentVal > 0) && (percentVal != '')) {
                                            var newPrchAmount = parseFloat(percentVal);
                                        }
                                    }
                                    if (markupPercentType == 1) {
                                        if ((markupPercentVal > 0) && (markupPercentVal != '')) {
                                            var newMarkupAmount = (parseFloat(purch) * parseInt(markupPercentVal)) / 100;
                                        }

                                    } else if (markupPercentType == 2) {
                                        if ((markupPercentVal > 0) && (markupPercentVal != '')) {
                                            var newMarkupAmount = parseFloat(markupPercentVal);
                                        }
                                    }
                                    var totalMarkupAmount = (parseFloat(purch) + parseFloat(newMarkupAmount) + parseFloat(newPrchAmount)).toFixed(2);
                                    $(el).children('.tech_purchase').children('input').val(parseFloat(newPrchAmount.toFixed(2)) * qty);
                                    $(el).children('.price').children('input').val(totalMarkupAmount);
                                    amount = parseFloat(totalMarkupAmount) * qty - (1 * disc) + (1 * add);
                                    subtotal += amount;
                                    $(el).children('.amount').html('$' + amount);

                                }
                            }
                            hst1 = 0;
                            if (subtotal > 0) hst1 = subtotal * 0.05;
                            total1 = subtotal + hst1;
                            h1 = '<table class="total" cellspacing=0>';
                            h1 += '<tr><td align="right" style="border-right:none;">Subtotal:</td><td align="right">' + subtotal.toFixed(2) + '</td></tr>';
                            h1 += '<tr><td align="right" style="border-right:none;">GST:</td><td align="right">' + hst1.toFixed(2) + '</td></tr>';
                            h1 += '<tr><td align="right" style="border-right:none;">Total:</td><td align="right">' + total1.toFixed(2) + '</td></tr>';
                            h1 += '</table>';
                            // $("#CurrentItemsTotal1").html(h1);
                        });
                        <?php
    //Telemarketers can not see technicians part
    if (($common->getLoggedUserRoleID() != "3")
    	&&($common->getLoggedUserRoleID() != "9"))
    {
    ?>
                        $('#CurrentItemsTableTech').children('tbody').children('tr').each(function(i, el) {
                            qty = $(el).children('.quantity').children('input').val();
                            if (qty != null) {
                                prc = $(el).children('.price').children('input').val();
                                disc = $(el).children('.discount').children('input').val();
                                var purch = $(el).children('.purchase').children('input').val();
                                var catId = $(el).children('td').children('.item_cat_id').val();
                                var itemUpdated = $(el).children('td').children('.item_updated').val();
                                add = $(el).children('.addition').children('input').val();
                                if (prc == "") prc = 0;
                                if (disc == "") disc = 0;
                                if (add == "") add = 0;
                                if (purch == "") purch = 0;
                                var purchase = (purch * qty);
                                var orgPrc = (prc * qty);
                                // amount = parseFloat(prc) * qty - (1*disc) + (1*add);
                                // subtotal += amount;
                                if (catId != 59) {
                                    amount = parseFloat(prc) * qty - (1 * disc) + (1 * add);
                                    subtotal += amount;
                                    newSubtotal += amount;
                                }
                                $(el).children('.amount').html('$' + amount);
                                if ($(el).children('.order_status_val ').children('input').is(":checked")) {
                                    invoiceSubTotal += parseFloat(purch) * qty;
                                }

                                if ((catId == 59) && itemUpdated == 0) {
                                    // var percentVal = $("#tech_percentage").val();
                                    //    var percentType = $("#tech_percentage_type").val();
                                    //    var markupPercentVal = $("#markup_percentage").val();
                                    //    var markupPercentType = $("#markup_percentage_type").val();
                                    var percentVal = $(el).children('td').children('.item_tech_percent').val();
                                    var percentType = $(el).children('td').children('.item_tech_percent_type').val();
                                    var markupPercentVal = $(el).children('td').children('.item_markup_percent').val();
                                    var markupPercentType = $(el).children('td').children('.item_markup_percent_type').val();
                                    var newMarkupAmount = 0;
                                    var newPrchAmount = 0;
                                    if (percentType == 1) {
                                        if ((percentVal > 0) && (percentVal != '')) {
                                            var newPrchAmount = (parseFloat(purch) * parseInt(percentVal)) / 100;
                                        }
                                    } else if (percentType == 2) {
                                        if ((percentVal > 0) && (percentVal != '')) {
                                            var newPrchAmount = parseFloat(percentVal);
                                        }
                                    }
                                    if (markupPercentType == 1) {
                                        if ((markupPercentVal > 0) && (markupPercentVal != '')) {
                                            var newMarkupAmount = (parseFloat(purch) * parseInt(markupPercentVal)) / 100;
                                        }
                                    } else if (markupPercentType == 2) {
                                        if ((markupPercentVal > 0) && (markupPercentVal != '')) {
                                            var newMarkupAmount = parseFloat(markupPercentVal);
                                        }
                                    }
                                    var totalMarkupAmount = (parseFloat(purch) + parseFloat(newMarkupAmount) + parseFloat(newPrchAmount)).toFixed(2);
                                    amount = parseFloat(totalMarkupAmount) * qty - (1 * disc) + (1 * add);
                                    subtotal += amount;
                                    newSubtotal += amount;
                                    $(el).children('.amount').html('$' + amount);
                                    // $(el).children('.tech_purchase').children('input').val('');
                                    $(el).children('.tech_purchase').children('input').val(parseFloat(newPrchAmount.toFixed(2)) * qty);
                                    $(el).children('.price').children('input').val(totalMarkupAmount);

                                }
                                if ((catId == 59) && itemUpdated == 1) {
                                    var percentVal = $(el).children('td').children('.item_tech_percent').val();
                                    var percentType = $(el).children('td').children('.item_tech_percent_type').val();
                                    var markupPercentVal = $(el).children('td').children('.item_markup_percent').val();
                                    var markupPercentType = $(el).children('td').children('.item_markup_percent_type').val();
                                    var newMarkupAmount = 0;
                                    var newPrchAmount = 0;
                                    if (percentType == 1) {
                                        if ((percentVal > 0) && (percentVal != '')) {
                                            var newPrchAmount = (parseFloat(purch) * parseInt(percentVal)) / 100;
                                        }
                                    } else if (percentType == 2) {
                                        if ((percentVal > 0) && (percentVal != '')) {
                                            var newPrchAmount = parseFloat(percentVal);
                                        }
                                    }
                                    if (markupPercentType == 1) {
                                        if ((markupPercentVal > 0) && (markupPercentVal != '')) {
                                            var newMarkupAmount = (parseFloat(purch) * parseInt(markupPercentVal)) / 100;
                                        }
                                    } else if (markupPercentType == 2) {
                                        if ((markupPercentVal > 0) && (markupPercentVal != '')) {
                                            var newMarkupAmount = parseFloat(markupPercentVal);
                                        }
                                    }
                                    var totalMarkupAmount = (parseFloat(purch) + parseFloat(newMarkupAmount) + parseFloat(newPrchAmount)).toFixed(2);
                                    $(el).children('.tech_purchase').children('input').val(parseFloat(newPrchAmount.toFixed(2)) * qty);
                                    $(el).children('.price').children('input').val(totalMarkupAmount);
                                    amount = parseFloat(totalMarkupAmount) * qty - (1 * disc) + (1 * add);
                                    subtotal += amount;
                                    newSubtotal += amount;
                                    $(el).children('.amount').html('$' + amount);

                                }
                            }
                            hst2 = 0;
                            if (newSubtotal > 0) hst2 = newSubtotal * 0.05;
                            total2 = newSubtotal + hst2;
                            h2 = '<table class="total" cellspacing=0>';
                            h2 += '<tr><td align="right" style="border-right:none;">Subtotal:</td><td align="right">' + newSubtotal.toFixed(2) + '</td></tr>';
                            h2 += '<tr><td align="right" style="border-right:none;">GST:</td><td align="right">' + hst2.toFixed(2) + '</td></tr>';
                            h2 += '<tr><td align="right" style="border-right:none;">Total:</td><td align="right">' + total2.toFixed(2) + '</td></tr>';
                            h2 += '</table>';
                            // $("#CurrentItemsTotal2").html(h2);
                        });
                        if (total2 > 0) {
                            $(".techTable").show();
                        }
                        <?php
    }
    ?>
                        hst = 0;
                        if (subtotal > 0) hst = subtotal * 0.05;
                        total = subtotal + hst;
                        h = '<table class="total" cellspacing=0>';
                        h += '<tr><td align="right" style="border-right:none;">Subtotal:</td><td align="right">' + subtotal.toFixed(2) + '</td></tr>';
                        h += '<tr><td align="right" style="border-right:none;">GST:</td><td align="right">' + hst.toFixed(2) + '</td></tr>';
                        h += '<tr><td align="right" style="border-right:none;">Total:</td><td align="right">' + total.toFixed(2) + '</td></tr>';
                        <?php
    //Telemarketers can not see technicians part
    if (($common->getLoggedUserRoleID() != "3")
    	&&($common->getLoggedUserRoleID() != "9")
    	&&($this->data['Type']['category_id']==2))
    {
    ?>
                        var deposit = $("#OrderCustomerDeposit").val();
                        if (!deposit) deposit = "<?=$this->data['Order']['customer_deposit']?>";
                        var balance = total - deposit;
                        h += '<tr><td align="right" style="border-right:none;">Deposit:</td><td align="right">' +
                            '<input name="data[Order][customer_deposit]" id="OrderCustomerDeposit" style="width: 45px;" value="' + deposit + '" onchange="TotalCalculation()"/></td></tr>';
                        if (deposit)
                            h += '<tr><td align="right" style="border-right:none;">Balance:</td><td align="right">' + balance.toFixed(2) + '</td></tr></table>';
                        <?php
    }
    ?>
                        h += '</table>';
                        $("#current_item_total").val(total.toFixed(2));
                        $("#CurrentItemsTotal").html(h);
                        $("#invoiceSubTotal").val(invoiceSubTotal.toFixed(2));
                        $("#invoiceGst").val((invoiceSubTotal * 0.05).toFixed(2));
                        $("#invoicePst").val((invoiceSubTotal * 0.07).toFixed(2));
                        $("#invoiceTotal").val((invoiceSubTotal + (invoiceSubTotal * 0.12)).toFixed(2));
                        $("#saleAmount").val(total.toFixed(2));
                    }

                    function InstallationCalculation() {
                        subtotal = 0;
                        CheckPrcCount = 0;
                        invoiceSubTotal = 0;
                        amount = 0;
                        $('#installation_item_table').children('tbody').children('.booked').each(function(i, el) {
                            qty = $(el).children('.tech_quantity').children('input').val();
                            if (qty != null && qty != undefined) {
                                prc = $(el).children('.price').children('input').val();
                                amount = parseFloat(prc) * qty;
                                subtotal += amount;
                                $(el).children('.total').children('input').val(amount);
                            }
                        });
                        $(".installationTotal").html('Total = $ ' + subtotal);
                    }

                    function NewTotalCalculation() {
                        subtotal = 0;
                        CheckPrcCount = 0;

                        $('#request_items #CurrentItemsTable').children('tbody').children('.booked').each(function(i, el) {
                            qty = $(el).children('.quantity').children('input').val();
                            if (qty != null && qty != undefined) {
                                prc = $(el).children('.price').children('input').val();
                                var purch = $(el).children('.purchase').children('input').val();
                                disc = $(el).children('.discount').children('input').val();
                                add = $(el).children('.addition').children('input').val();
                                if (prc == "") prc = 0;
                                if (disc == "") disc = 0;
                                if (add == "") add = 0;
                                if (purch == "") purch = 0;
                                amount = parseFloat(prc) * qty - (1 * disc) + (1 * add);
                                subtotal += amount;
                                var purchase = (purch * qty);
                                var orgPrc = (prc * qty);
                                $(el).children('.amount').html('$' + amount);
                                //$(el).children('.price').find("span").text(orgPrc);
                                //$(el).children('.purchase').find("span").text(purchase);
                            }
                        });
                        <?php
    //Telemarketers can not see technicians part
    if (($common->getLoggedUserRoleID() != "3")
        &&($common->getLoggedUserRoleID() != "9"))
    {
    ?>
                        $('#CurrentItemsTableTech').children('tbody').children('tr').each(function(i, el) {
                            qty = $(el).children('.quantity').children('input').val();
                            if (qty != null) {
                                prc = $(el).children('.price').children('input').val();
                                disc = $(el).children('.discount').children('input').val();
                                var purch = $(el).children('.purchase').children('input').val();
                                add = $(el).children('.addition').children('input').val();
                                if (prc == "") prc = 0;
                                if (disc == "") disc = 0;
                                if (add == "") add = 0;
                                if (purch == "") purch = 0;
                                var purchase = (purch * qty);
                                var orgPrc = (prc * qty);
                                amount = parseFloat(prc) * qty - (1 * disc) + (1 * add);
                                subtotal += amount;
                                $(el).children('.amount').html('$' + amount);
                                //$(el).children('.price').find("span").text(orgPrc);
                                //$(el).children('.purchase').find("span").text(purchase);
                            }
                        });
                        <?php
    }
    ?>
                        hst = 0;
                        if (subtotal > 0) hst = subtotal * 0.05;
                        total = subtotal + hst;
                        h = '<table class="total" cellspacing=0>';
                        h += '<tr><td align="right" style="border-right:none;">Subtotal:</td><td align="right">' + subtotal.toFixed(2) + '</td></tr>';
                        h += '<tr><td align="right" style="border-right:none;">GST:</td><td align="right">' + hst.toFixed(2) + '</td></tr>';
                        h += '<tr><td align="right" style="border-right:none;">Total:</td><td align="right">' + total.toFixed(2) + '</td></tr>';
                        <?php
    //Telemarketers can not see technicians part
    if (($common->getLoggedUserRoleID() != "3")
        &&($common->getLoggedUserRoleID() != "9")
        &&($this->data['Type']['category_id']==2))
    {
    ?>
                        var deposit = $("#OrderCustomerDeposit").val();
                        if (!deposit) deposit = "<?=$this->data['Order']['customer_deposit']?>";
                        var balance = total - deposit;
                        h += '<tr><td align="right" style="border-right:none;">Deposit:</td><td align="right">' +
                            '<input name="data[Order][customer_deposit]" id="OrderCustomerDeposit" style="width: 45px;" value="' + deposit + '" onchange="TotalCalculation()"/></td></tr>';
                        if (deposit)
                            h += '<tr><td align="right" style="border-right:none;">Balance:</td><td align="right">' + balance.toFixed(2) + '</td></tr></table>';
                        <?php
    }
    ?>
                        h += '</table>';
                        $("#current_item_total").val(total.toFixed(2));
                        $("#CurrentItemsTotal").html(h);
                    }
                    var ChangeDetailsShow = 0;
                    var last_jt = 0;

                    function ShowChangeDetails(row_id, cust_id, ord_id, user_id, change_date, change_time) {
                        $(".change_details").hide();
                        if (ChangeDetailsShow == 0) {
                            $.get("<?=BASE_URL;?>/orders/getChangesDetails", {
                                    customer_id: cust_id,
                                    order_id: ord_id,
                                    change_date: change_date,
                                    change_time: change_time,
                                    change_user_id: user_id
                                },
                                function(data) {
                                    $("#" + row_id).html(data);
                                    $("#" + row_id).show();
                                });
                            ChangeDetailsShow = 1;
                        } else ChangeDetailsShow = 0;
                    }

                    function ShowCallHistory() {
                        $.get("<?=BASE_URL;?>/orders/getCallHistory", {
                                // phone:$('#CustomerPhone').val(),
                                phone: $('#CustomerCellPhone').val(),
                                is_dialer: 0
                            },
                            function(data) {
                                $("#CallHistory").html(data);
                            });
                    }

                    function DiallerCallHistory() {
                        $.get("<?=BASE_URL;?>/orders/getCallHistory", {
                                // phone:$('#CustomerPhone').val(),
                                phone: $('#CustomerCellPhone').val(),
                                is_dialer: 1
                            },
                            function(data) {

                                $("#Dialler-Call-History").html(data);
                            });
                    }

                    function ShowLastCallHistory() {

                        // $.get("<?=BASE_URL;?>/orders/getLastCallHistory", {
                        //         phone: $('#CustomerPhone').val()
                        //     },
                        //     function(data) {
                        //         $("#LastCallHistory").html(data);
                        //     });
                    }

                    function GetUserHotList() {
                        var currentDate = new Date().toISOString().slice(0, 10);
                        $.get("<?=BASE_URL;?>/orders/searchList", {
                                sq_crit: 'callback_date',
                                sq_str: currentDate
                            },
                            function(data) {});
                    }

                    function SaveDialerCallRecord() {
                        var selectedButton = window.parent.frame_browser.document.getElementById("current-seleted-button").value;

                        if (selectedButton == '') {
                            var showDefault = 1;
                        }
                        var orderNo = $("#orderNo").val();
                        var callId = $('#end_current_call').attr("call_id");
                        var callResultId = $("#answer_reply").val();
                        var callbackDate = '';
                        var recordingName = callId + '.wav';
                        var lastCall = new Date().toISOString().slice(0, 10);
                        if (callResultId != 3) {
                            var phoneNumber = window.parent.frame_browser.document.getElementById("currentUserPhoneNo").value;
                            var callmode = window.parent.frame_browser.document.getElementById("call_mode").value;
                        }
                        var CurrentDate = new Date();

                        if (callResultId == 6) {
                            current = CurrentDate.setDate(CurrentDate.getDate() + 2);
                            callbackDate = new Date(current).toISOString().slice(0, 10);
                        }
                        if (callResultId == 4) {
                            current = CurrentDate.setMonth(CurrentDate.getMonth() + 3);
                            callbackDate = new Date(current).toISOString().slice(0, 10);
                        }
                        if (callResultId == 8) {
                            current = CurrentDate.setMonth(CurrentDate.getMonth() + 6);
                            callbackDate = new Date(current).toISOString().slice(0, 10);
                        }
                        if (callResultId == 9) {
                            current = CurrentDate.setMonth(CurrentDate.getMonth() + 9);
                            callbackDate = new Date(current).toISOString().slice(0, 10);
                        }
                        if (callResultId == 2) {
                            $("#end_current_call").trigger("click");
                            if (callmode == "" || callmode == 3) {
                                $(".call_next_user").trigger("click");
                            }
                            return false;
                        }
                        if (callResultId == 1) {
                            $("#end_current_call").trigger("click");
                            if (callmode == "" || callmode == 3) {
                                $(".call_next_user").trigger("click");
                            }

                            return false;
                        }
                        $.get("<?=BASE_URL;?>/orders/saveCallRecord", {
                            customer_id: $('#CustomerId').val(),
                            customer_first_name: $('#CustomerFirstName').val(),
                            customer_last_name: $('#CustomerLastName').val(),
                            customer_email: $('#emailinput').val(),
                            customer_city: $('#CustomerCity').val(),
                            customer_postcode: $('#CustomerPostalCode').val(),
                            customer_address_unit: $('#CustomerAddressUnit').val(),
                            customer_address_street_number: $('#CustomerAddressStreetNumber').val(),
                            customer_address_street: $('#CustomerAddressStreet').val(),
                            customer_phone: $('#CustomerPhone').val(),
                            customer_cell_phone: $('#CustomerCellPhone').val(),
                            customer_card_number: $('#CustomerCardNumber').val(),
                            customer_card_exp: $('#data[Customer][card_exp]').val(),
                            customer_next_service: $('#data[Customer][next_service]').val(),
                            customer_campaing_id: $('#CuscampaingId').val(),
                            callresult: callResultId,
                            callback_reason: '',
                            callback_date: callbackDate,
                            callback_time: '',
                            callback_user: '',
                            call_id: 0,
                            call_date: lastCall,
                            dialer_id: 'web',
                            selected_button: showDefault
                        }, function(data) {
                            AddCustomerNote();
                            if (callResultId == 3 || callResultId == 7) {
                                $.post("<?=BASE_URL;?>/orders/deleteUserFromCampaign", {
                                        customer_id: $('#CustomerId').val()
                                    },
                                    function(data) {});
                            }

                            $("#end_current_call").trigger("click");
                            //apiStopCallRecord(callId);
                            if (callmode == "" || callmode == 3) {
                                $(".call_next_user").trigger("click");
                            }
                        });
                    }

                    function callTransfer() {
                        var callId = $('#end_current_call').attr("call_id");
                        doCallTransfer(callId);
                    }

                    function callRecord() {
                        var callId = $('#end_current_call').attr("call_id");
                        var userConNum = callId;
                        var fileLocation = "<?= WWW_ROOT ;?>call-recording/" + userConNum;
                        // var fileLocation = "<?= WWW_JS_ROOT_PATH ;?>call-recording/"+userConNum;
                        apiCallRecord(callId, fileLocation);
                    }

                    function SaveCallRecord() {
                        var fromFollowup = $("#fromFollowup").val();
                        var selectedButton = window.parent.frame_browser.document.getElementById("current-seleted-button").value;
                        if (selectedButton == '') {
                            var showDefault = 1;
                        }
                        // Check if all the fields are filld up
                        if ($('#CallRecordCallResultId').val() == '') {
                            alert('Please select a CALL RESULT');
                            return;
                        }
                        if ($('#CallRecordCallNote').val() == '') {
                            alert('Please add a CALL NOTE');
                            return;
                        }

                        if ($('#CallRecordCallResultId').val() == 2) {
                            if ($('#CallRecordCallbackDate').val() == '') {
                                alert('Please select a CALLBACK DATE');
                                return;
                            }
                            if ($('#CallRecordCallbackUserId').val() == '') {
                                alert('Please select a CALLBACK USER');
                                return;
                            }
                        }
                        $.get("<?=BASE_URL;?>/orders/saveCallRecord", {
                            customer_id: $('#CustomerId').val(),
                            customer_first_name: $('#CustomerFirstName').val(),
                            customer_last_name: $('#CustomerLastName').val(),
                            customer_email: $('#emailinput').val(),
                            customer_city: $('#CustomerCity').val(),
                            customer_postcode: $('#CustomerPostalCode').val(),
                            customer_address_unit: $('#CustomerAddressUnit').val(),
                            customer_address_street_number: $('#CustomerAddressStreetNumber').val(),
                            customer_address_street: $('#CustomerAddressStreet').val(),
                            customer_phone: $('#CustomerPhone').val(),
                            customer_cell_phone: $('#CustomerCellPhone').val(),
                            customer_card_number: $('#CustomerCardNumber').val(),
                            customer_card_exp: $('#data[Customer][card_exp]').val(),
                            customer_next_service: $('#data[Customer][next_service]').val(),
                            callresult: $('#CallRecordCallResultId').val(),
                            callback_reason: $('#CallRecordCallNote').val(),
                            callback_date: $('#CallRecordCallbackDate').val(),
                            callback_time: $('#CallRecordCallbackTimeHour').val() + ':' + $('#CallRecordCallbackTimeMin').val(),
                            callback_user: $('#CallRecordCallbackUserId').val(),
                            customer_campaing_id: $('#CuscampaingId').val(),
                            call_id: 0,
                            dialer_id: 'web',
                            fromFollowup: fromFollowup,
                            selected_button: showDefault
                        }, function(data) {

                            AddCustomerNote();
                            $("#dialer_callback").dialog("destroy");
                        });
                    }
                    var PrevState = <?=$this->data['Order']['order_status_id']?>;
                    var CurState = <?=$this->data['Order']['order_status_id']?>;

                    function StatusChange(element) {
                        CurState = element.value;
                        if ((element.value == 2) || (element.value == 3)) document.getElementById('divReason').style.display = 'block';
                        else document.getElementById('divReason').style.display = 'none';
                        if ((element.value == 5) && ('<?=$this->data['
                                OrderType ']['
                                category_id ']?>' == 2)) {
                            $("#PermitsSection").show();
                        } else {
                            $("#PermitsSection").hide();
                        }
                    }
                    <?php
	if( $this->params['url']['reschedule'] == 1 )
		echo 'alert("Your order has been marked as rescheduled. On this screen you can confirm or change any details for the new order.");';
?>

                    function createMessage() {
                        var answer = window.open("<?=BASE_URL?>/messages/EditMessage?order_id=<?php echo $this->data["
                            Order "]["
                            id "];?>&customer_id=<?php echo $this->data["
                            Customer "]["
                            id "];?>", '',
                            "width=450,height=300,left=300,top=200");
                    }

                    function ShowSelectSupply() {
                        var newwindow = window.open("<?=BASE_URL?>/suppliers/index?mode=select", '',
                            "width=800,height=600,left=100,top=50");
                        newwindow.onbeforeunload = function() {
                            ChangeSupplier(document.getElementById("OrderAppOrderedSupplierId"));
                        }

                    }

                    function showAddItems(item_type) {
                        $("#item_selector0").html('').hide();
                        $("#item_selector1").html('').hide();
                        jt = $('#OrderOrderTypeId').val();
                        $("#item_selector" + item_type).html('<img src="<?=ROOT_URL?>/app/webroot/img/wait30trans.gif"/>').show();
                        $.get("<?=BASE_URL?>/items/showPrices?item_type=" + item_type + "&job_type=" + jt, {}, function(data) {
                            $("#item_selector" + item_type).html("<button type='button' style='cursor:pointer;' onclick='$(\"#item_selector" + item_type + "\").html(\"\").hide();'>Close Section</button>" + data);
                        });
                    }

                    function showChangePrevious() {
                        phone = $('#CustomerPhone').val();
                        var new_item = window.open("<?=BASE_URL?>/orders/getPreviousJobs?phone=" + phone, '',
                            "width=400,height=400,left=100,top=100");
                        if (new_item[0]) {
                            $("#OrderJobEstimateId").val(new_item[0]);
                            $("#OrderBookingSourceId").val(new_item[1]);
                            $("#OrderBookingSource2Id").val(new_item[2]);
                            $("#OrderJobEstimateText").html(new_item[3]);
                        }
                    }

                    function showClients() {
                        var customerId = $('#CustomerId').val();
                        var firstName = $('#CustomerFirstName').val();
                        var lastName = $('#CustomerLastName').val();
                        var email = $('#emailinput').val();
                        var phone = $('#CustomerPhone').val();
                        var currentUrl = $('#currentUrl').val();

                        var new_item = window.open("<?=BASE_URL?>/users/showClients?cusId=" + customerId + "&cusPhone=" + phone + "&cusFirstName=" + firstName + "&cusLastName=" + lastName + "&cusEmail=" + email + "&currentUrl=" + currentUrl, '', "width=400,height=400,left=200,top=100", "_self");

                        $('#OrderCustomerId').val(new_item[0]);
                        $('#CustomerId').val(new_item[0]);
                        $('#CustomerFirstName').val(new_item[1]);
                        $('#CustomerLastName').val(new_item[2]);
                        $('#CustomerAddressUnit').val(new_item[3]);
                        $('#CustomerAddressStreetNumber').val(new_item[4]);
                        $('#CustomerAddressStreet').val(new_item[5]);
                        $('#CustomerCity').val(new_item[6]);
                        $('#CustomerPostalCode').val(new_item[9]);
                        $('#CustomerPhone').val(new_item[7]);
                        $('#CustomerEmail').val(new_item[10]);
                        $('#CustomerCellPhone').val(new_item[8]);
                    }

                    function CheckWithSchedule() {
                        var job_date = $('#OrderJobDate').val();
                        var new_item = window.open("<?=BASE_URL?>/orders/scheduleView?schedule_mode=inside&ffromdate=" + job_date,
                            '', "width=1000,height=600,left=100,top=100");
                        $('#OrderJobTruck').val(new_item[0]);
                        $('#OrderJobDate').val(new_item[1]);
                        $('#OrderJobTimeBegHour').val(new_item[2]);
                        $('#OrderJobTimeEndHour').val("");
                        $('#OrderJobTechnician1Id').val(new_item[3]);
                        $('#OrderJobTechnician2Id').val(new_item[4]);
                    }

                    function CheckWithScheduleAdmin() {
                        var job_date = $('#OrderJobDate').val();
                        /*<?=BASE_URL?>/orders/scheduleView?schedule_mode=inside*/
                        var new_item = window.open("<?=BASE_URL?>/orders/scheduleView?schedule_mode=<?php echo $from_tele ?>&ffromdate=<?php echo urlencode(date("
                            d M Y "));?>&daily=1",
                            '', "width=1000,height=600,left=100,top=100");
                        $('#OrderJobTruck').val(new_item[0]);
                        $('#OrderJobDate').val(new_item[1]);
                        $('#OrderJobTimeBegHour').val(new_item[2]);
                        $('#OrderJobTimeEndHour').val("");
                        $('#OrderJobTechnician1Id').val(new_item[3]);
                        $('#OrderJobTechnician2Id').val(new_item[4]);
                    }

                    function openAdminSchedule() {
                        var job_date = $('#OrderJobDate').val();
                        var new_item = window.open("<?=BASE_URL?>/orders/scheduleView?schedule_mode=inside&ffromdate=" + job_date,
                            '', "width=1000,height=600,left=100,top=100");
                        $('#OrderJobTruck').val(new_item[0]);
                        $('#OrderJobDate').val(new_item[1]);
                        $('#OrderJobTimeBegHour').val(new_item[2]);
                        $('#OrderJobTimeEndHour').val("");
                        $('#OrderJobTechnician1Id').val(new_item[3]);
                        $('#OrderJobTechnician2Id').val(new_item[4]);
                    }

                    function CheckWithTimeslot() {
                        $('#myModal2').show();
                        //var postal_code = $('#CustomerPostalCode').val();
                        //	var st_no = $('#CustomerAddressStreetNumber').val();
                        //	var st_name = $('#CustomerAddressStreet').val();
                        //	var address = st_no+" "+st_name;
                        //	var booking_cus_id= "<?= $this->data['Customer']['id'] ?>";
                        //	var get_url = "&sc_from="+sc_from+"&sc_to="+sc_to+"&map_services="+service+"&postal_code="+postal_code+"&choose_time="+choose_time+"&choose_km="+choose_km+"&customer_id="+booking_cus_id+"&first_page=1";
                        //	var get_url = "&address="+address+"&postal_code="+postal_code+"&customer="+booking_cus_id;
                        //	url = "<?=ROOT_URL;?>/index.php/reports/timeslot/?currentOrdId="+get_url;
                        //newwindow=window.open(url,'name','height=350,width=800,top=250, left=600');


                        //if (window.focus) {newwindow.focus();}

                        // 	var city = $('#CustomerCity').val();
                        //	if(city != "") {
                        //		city = city.replace(' ', '_');
                        //		var city_id = $('#' + city).val()
                        //		var new_item = window.open("<?=BASE_URL?>/orders/timeSlots?city_id="+city_id+"&user_id="+<?php echo $common->getLoggedUserID() ?>, '', "width=870,height=350,center=yes");
                        //
                        //		$('#OrderJobTruck').val(new_item[0]);
                        //		$('#OrderJobDate').val(new_item[1]);
                        //		$('#OrderJobTimeBegHour').val(new_item[2]);
                        //		$('#OrderJobTimeEndHour').val(new_item[5]);
                        //		$('#OrderJobTechnician1Id').val(new_item[3]);
                        //		$('#OrderJobTechnician2Id').val(new_item[4]);
                        //	} else {
                        //		alert("City must not be blank");
                        //	}
                    }

                    function maintenancePackage() {
                        var customer_id = "<?php echo $this->data['Customer']['id']?>";
                        if (customer_id != "") {
                            $.post("<?=BASE_URL;?>/orders/maintenancePackage", {
                                    customer_id: customer_id
                                },
                                function(data) {
                                    $("#maintenancePackage").html(data);
                                }
                            );
                        }
                    }

                    function checkText() {
                        $(".text_response").each(function() {
                            if ($(this).val() == '') return;
                            var question_id = $(this).prev(".question_id").val();
                            var text_response = $(this).val();
                            var response_id = 0;
                            $(".q" + question_id).addClass("hide");
                            $(".q" + question_id).attr("disabled", "disabled");
                            $(this).next(".response_codes").children(".code").each(function() {
                                var id = $(this).children(".id").val();
                                var operation_id = $(this).children(".operation_id").val();
                                var which_id = $(this).children(".which_id").val();
                                var value;
                                if (which_id == 1) {
                                    value = $(this).children(".value").val();
                                } else if (which_id == 2) {
                                    var input = $(".rank" + $(this).children(".value").val());
                                    if (input.is("select")) value = input.find('option:selected').text();
                                    else value = input.val();
                                }
                                if (!isNaN(value)) value = parseInt(value);
                                switch (operation_id) {
                                    case '1':
                                        if (text_response == value) {
                                            response_id = id;
                                            return false;
                                        }
                                        break;
                                    case '2':
                                        if (text_response > value) {
                                            response_id = id;
                                            return false;
                                        }
                                        break;
                                    case '3':
                                        if (text_response >= value) {
                                            response_id = id;
                                            return false;
                                        }
                                        break;
                                    case '4':
                                        if (text_response < value) {
                                            response_id = id;
                                            return false;
                                        }
                                        break;
                                    case '5':
                                        if (text_response <= value) {
                                            response_id = id;
                                            return false;
                                        }
                                        break;
                                    case '6':
                                        if (text_response != value) {
                                            response_id = id;
                                            return false;
                                        }
                                        break;
                                }
                                response_id = 0;
                            });
                            $("#r" + response_id).removeClass("hide");
                            $("#r" + response_id).removeAttr("disabled", "disabled");
                        });
                        $(".suggestions").each(function() {
                            var response_id = $(this).prev(".response_id").val();
                            var suggestion_id = $(this).val();
                            $(".r" + response_id).addClass("hide");
                            $(".r" + response_id).attr("disabled", "disabled");
                            $("#s" + suggestion_id).removeClass("hide");
                            $("#s" + suggestion_id).removeAttr("disabled", "disabled");
                        });
                    }


                    function upload_photo(cur, i) {
                        //var file = $('input[id="sortpicture'+i+'"]')[0];
                        if (cur.files && cur.files[0]) {
                            var reader = new FileReader();
                            reader.onload = function(e) {
                                $('.pre-image_' + i + '')
                                    .attr('src', e.target.result)
                                    .width(86)
                                    .height(50);
                                $('.pre-image_' + i + '').css("display", "block");
                            };
                            reader.readAsDataURL(cur.files[0]);
                        }
                    }

                    function upload_photo_pdf(cur, cur1) {
                        //var file = $('input[id="sortpicture'+i+'"]')[0];
                        if (cur.files && cur.files[0]) {
                            var reader = new FileReader();
                            reader.onload = function(e) {
                                var base64Value = e.target.result;
                                var newBase64Value = base64Value.replace('data:application/wps-office.pdf', 'data:application/pdf');
                                $("#pre-image-pdf", cur1.parent().parent()).attr('data-doc_lnk', newBase64Value).width(86)
                                    .height(50);
                                $("#pre-image-pdf", cur1.parent().parent()).css("display", "block");
                            };
                            reader.readAsDataURL(cur.files[0]);
                        }
                    }

                    function ajax(event) {
                        $('.delete_items').attr('checked', false);
                        var val = $(event).val().trim();
                        var data_class = $(event).attr("data-class");
                        // Return all items if:
                        // 1) allItems is not passed as an argument.
                        // 2) allItems is not false
                        // Return only active items.
                        if (val != '' && val != null && val.length >= 3) {
                            $.ajax({
                                // url: "<?=BASE_URL;?>/inventories/ajaxItems",
                                url: "<?=BASE_URL;?>/inventories/searchItems",
                                type: "GET",
                                dataType: 'json',
                                // data: {query:val,active:true},
                                data: {
                                    query: val,
                                    classId: data_class
                                },
                                success: function(data) {
                                    ajax_finished(data, data_class)
                                }
                            });
                        } else {
                            table = $('#ajax_item_results_' + data_class + ' tbody');
                            table.empty();
                            $("#ajax_item_results_" + data_class).hide();
                            $("#addBookedItems").attr("disabled", false);
                            $("#addTechnicianSales").attr("disabled", false);

                        }
                    }

                    function add_unknown_item(classId) {
                        var url = "../iv_items/edit?seed=" + Math.random();
                        var option = "width=400px,height=500px,left=300px,top=200px,status=no,scroll=no,resizable=no";
                        var win = window.open(url, "MyDialog", option);
                        var timer = setInterval(function() {
                            if (win.closed) {
                                clearInterval(timer);
                                var returnId = win.returnValueId;
                                var itemArr = returnId.split(';');
                                addItem(itemArr[0], itemArr[1], itemArr[5], classId, itemArr[4], itemArr[2], "", "1", "", "");
                                $("#add_item_" + classId).hide();
                            }
                        }, 500);
                    }

                    function ajax_failed(why, data_class) {
                        template = $('#ajax_item_result_template_' + data_class);
                        table = $('#ajax_item_results_' + data_class + ' tbody');
                        table.empty();
                        $('#ajax_item_results_' + data_class + ' thead').hide();
                        result = template.clone();
                        if (why == "no supplier") {
                            result.children(".name_" + data_class).html("Please choose a supplier.");
                        }
                        if (why == "no results") {
                            $("#add_item_" + data_class).show();
                        }
                        //     result.children(".name_"+data_class).html("<a href='javascript:add_unknown_item("+data_class+");'>Add it?</a>"); }
                        // result.show();
                        // result.appendTo(table);
                        // table.show();
                    }

                    function ajax_finished(data, data_class) {
                        accessData = data;
                        if (data.length === 0) {
                            ajax_failed("no results", data_class);
                            $("#addBookedItems").attr("disabled", false);
                            return false;
                        }
                        $("#addBookedItems").attr("disabled", true);
                        $("#addTechnicianSales").attr("disabled", true);
                        template = $('#ajax_item_result_template_' + data_class);
                        table = $('#ajax_item_results_' + data_class + ' tbody');
                        table.empty();
                        $('#ajax_item_results_' + data_class + ' thead').show();
                        table.append(data);
                        table.append('<tr><td colspan="12"></td><td><input type="button" class="clearSearch" name="clearSearch" value="Clear"></td></tr>');
                        $('#ajax_item_results_' + data_class + ' thead').show();
                        table.parent().show();
                        $("#add_item_" + data_class).hide();
                    }

                    function searchSupplier(eve) {
                        var supplierName = $(eve).val().trim();
                        // var index = $(eve).attr("data-item-index");
                        if (supplierName != '') {
                            $.ajax({
                                url: '<?=BASE_URL?>/inventories/searchSuppliers',
                                dataType: 'json',
                                type: 'GET',
                                cache: false,
                                data: {
                                    query: supplierName
                                },
                                success: function(data) {
                                    ajaxFinishedSupplier(data);
                                }
                            });
                        } else {
                            $('#ajax_supplier_results').hide();
                        }
                    }

                    function ajaxFinishedSupplier(data) {

                        if (data.length === 0) {
                            $('#ajax_supplier_results').hide();
                            return false;
                        }
                        template = $('#ajax_supplier_result_template');
                        table = $('#ajax_supplier_results');
                        // $('tbody',table).html('');
                        table.empty();
                        for (i in data) {
                            result = template.clone();
                            result.children(".id").html(data[i]["id"]);
                            result.children(".name").html(data[i]["name"]);
                            result.children(".phone").html(data[i]["phone"]);
                            result.children(".city").html(data[i]["city"]);
                            result.show();
                            result.bind("click", function() {
                                result_supplier_clicked(this);
                            });
                            result.appendTo(table);
                        }
                        table.show();
                    }

                    function result_supplier_clicked(clicked_item) {
                        dat = $(clicked_item);
                        table = $('#ajax_supplier_results');
                        table.hide();
                        supId = dat.children(".id").text();
                        supName = dat.children(".name").text();
                        $("#supplierName").val(supName);
                        $("#supplierId").val(supId);
                    }

                    $(function() {
                        $("#save_one_time_item").live("click", function(e) {
                            e.preventDefault();
                            var formdata = new FormData($("#editBookingform_new")[0]);
                            var xhr = new XMLHttpRequest();
                            xhr.open('POST', "<?=BASE_URL;?>/orders/saveOrderPurchase", true);
                            xhr.onload = function() {
                                var response = JSON.parse(xhr.response);
                                if (response.res == 1) {
                                    $("#orderInvoiceImage").val(response.image_name);
                                } else {
                                    alert("Please create order first.");
                                }
                            };
                            xhr.send(formdata);
                        });
                    });

                    function sortTable(n) {
                        var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
                        table = document.getElementById("installation_item_table");
                        switching = true;
                        //Set the sorting direction to ascending:
                        dir = "asc";
                        /*Make a loop that will continue until
                        no switching has been done:*/
                        while (switching) {
                            //start by saying: no switching is done:
                            switching = false;
                            rows = table.rows;
                            /*Loop through all table rows (except the
                            first, which contains table headers):*/
                            for (i = 1; i < (rows.length - 1); i++) {
                                //start by saying there should be no switching:
                                shouldSwitch = false;
                                /*Get the two elements you want to compare,
                                one from current row and one from the next:*/
                                x = rows[i].getElementsByTagName("TD")[n];
                                y = rows[i + 1].getElementsByTagName("TD")[n];
                                /*check if the two rows should switch place,
                                based on the direction, asc or desc:*/
                                if (dir == "asc") {
                                    if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
                                        //if so, mark as a switch and break the loop:
                                        shouldSwitch = true;
                                        break;
                                    }
                                } else if (dir == "desc") {
                                    if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
                                        //if so, mark as a switch and break the loop:
                                        shouldSwitch = true;
                                        break;
                                    }
                                }
                            }
                            if (shouldSwitch) {
                                /*If a switch has been marked, make the switch
                                and mark that a switch has been done:*/
                                rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                                switching = true;
                                //Each time a switch is done, increase this count by 1:
                                switchcount++;
                            } else {
                                /*If no switching has been done AND the direction is "asc",
                                set the direction to "desc" and run the while loop again.*/
                                if (switchcount == 0 && dir == "asc") {
                                    dir = "desc";
                                    switching = true;
                                }
                            }
                        }
                    }

                    // This isn't magic.

                    // $(".",cur).text();
                    $(document).ready(function() {
                        $('input[type=radio]').click(function() {
                            if (this.previous) {
                                this.checked = false;
                            }
                            this.previous = this.checked;
                        });
                        // window.onclick = function(event) {
                        //      if (!event.target.matches('.change_service')){
                        //         $("#OrderOrderTypeId").hide();

                        //      }
                        // }

                        var ordId = $('#OrderId').val();
                        var custmId = $('#CustomerId').val();

                        var payMethod = $('#OrderPaidBy').val();

                        if (payMethod == 3 || payMethod == 4 || payMethod == 5) {

                        } else {
                            var trailingCharsIntactCount = 4;
                            var str = $("#creditCardNum1").val();
                            if (typeof str != "undefined" && str != '') {
                                str = str.trim();
                                str = new Array(str.length - trailingCharsIntactCount + 1).join('x') +
                                    str.slice(-trailingCharsIntactCount);
                                $("#creditCardNum1").val(str);
                            }
                        }
                        if (custmId == '') {
                            $("#OrderShowCard").val(1);
                        }

                        if (ordId == '') {
                            var trailingCharsIntactCount = 4;
                            var str = $("#creditCardNum1").val().trim();
                            if (str != '') {
                                str = new Array(str.length - trailingCharsIntactCount + 1).join('x') +
                                    str.slice(-trailingCharsIntactCount);
                                $("#creditCardNum1").val(str);

                                $("#cardTransaction").attr("disabled", true);
                                $("#preAuthTrans").attr("disabled", true);
                            }
                        }

                        var orderStatus = $("#OrderOrderStatusId").val();
                        var paymentStatus = $("#payment_status").val();
                        if (paymentStatus == 1) {
                            var trailingCharsIntactCount1 = 4;
                            var str = $("#creditCardNum1").val().trim();
                            if (str != '') {
                                str = new Array(str.length - trailingCharsIntactCount1 + 1).join('x') +
                                    str.slice(-trailingCharsIntactCount1);
                                $("#creditCardNum1").val(str);
                            }
                        } else if (paymentStatus == 3) {
                            $("#preAuthTrans").attr("disabled", true);
                        }

                        $('#CustomerPostalCode').change(function() {
                            if (this.value.length < 6) {
                                alert("Postal code length should be 6");
                            }
                        });

                        $("#showCreditcardInfo").live("click", function() {
                            $("#cc_pass_box").dialog("open");
                        });
                        <?php
				$job_time_beg11 = $_REQUEST['job_time_beg'];

				$job_time_beg22 = explode(':',$_REQUEST['job_time_beg']);

				$job_time_beg33 = $job_time_beg22[0];


				$job_time_end11 = $_REQUEST['job_time_end'];

				$job_time_end22 = explode(':',$_REQUEST['job_time_end']);

				$job_time_end33 = $job_time_end22[0];
				?>


                        $("#PaymentPaymentMethodId").live("change", function() {
                            var id = $(this).val();
                            $('#OrderJobTruck').show();
                            $("#OrderPaidBy").val(id);
                            var get_val = "<?php echo $_GET['job_truck']; ?>";
                            var jobTruck = $('#OrderJobTruck').val();
                            var job_start_new = "<?= $job_time_beg33 ?>";


                            var job_end_new = "<?= $job_time_end33 ?>";

                            if (get_val == '') {
                                <?php if($jobTruck != '') {?>
                                get_val = <?php echo $jobTruck; ?>;
                                <?php }?>
                            }
                            if (job_start_new == '') {
                                <?php
				if($jobTimeBeg != '') {
					$startTime = explode(':',$jobTimeBeg);
					?>
                                job_start_new = <?php echo $startTime[0]; ?>;
                                if (job_start_new < 10)
                                    job_start_new = '0' + job_start_new;
                                <?php }?>
                            }
                            if (job_end_new == '') {
                                job_end_new = $("#OrderJobTimeEndHour").val();
                            }
                            if (job_end_new == '') {
                                <?php
				if($jobTimeEnd != '') {
					$endTime = explode(':',$jobTimeEnd);
					?>
                                job_end_new = <?php echo $endTime[0]; ?>;
                                if (job_end_new < 10)
                                    job_end_new = '0' + job_end_new;
                                <?php }?>
                            }
                            if (id == 11) {
                                $('#OrderJobTruck').val(40);
                                // $('#OrderJobTimeBegHour').hide();
                                // $('#OrderJobTimeEndHour').hide();
                                $('#OrderJobTimeBegHour').val('08');
                                $('#OrderJobTimeEndHour').val('09');
                            } else {
                                $('#OrderJobTruck').show();
                                if (jobTruck !== '' && jobTruck != 40) {
                                    $('#OrderJobTruck').val(jobTruck);
                                } else {
                                    $('#OrderJobTruck').val('');
                                }
                                $('#OrderJobTimeBegHour').show();
                                $('#OrderJobTimeEndHour').show();
                                if (job_start_new !== '') {
                                    $('#OrderJobTimeBegHour').val(job_start_new);
                                }
                                if (job_end_new !== '') {
                                    $('#OrderJobTimeEndHour').val(job_end_new);
                                }

                            }

                            // if(id == 3 || id == 4 || id == 5){
                            //    $("#customerCreditInfo").show();
                            // } else {
                            //    $("#customerCreditInfo").hide();
                            // }
                        });

                        // $("#OrderPaidBy").live("change", function(){
                        //     <?php if($common->getLoggedUserRoleID() == "6") {?>
                        //          var id = $(this).val();
                        //          if(id == 3 || id == 4 || id == 5){
                        //             $("#customerCreditInfo").show();
                        //          } else {
                        //             $("#customerCreditInfo").hide();
                        //          }
                        //      <?php } ?>
                        // });

                        $('.review_answer').live("change", function() {
                            var $cur = $(this);
                            var $val = $(this).val();
                            if ($cur.is(":checked")) {
                                $('.review_answer').attr('checked', false);
                                $cur.attr('checked', true);
                                $("#reviewAnsVal").val(1);
                            } else {
                                $("#reviewAnsVal").val(0);
                            }
                        });

                        $('.leave_sticker').live("change", function() {
                            var $cur = $(this);
                            var $val = $(this).val();
                            if ($cur.is(":checked")) {
                                $('.leave_sticker').attr('checked', false);
                                $cur.attr('checked', true);
                                $("#stickerAnsVal").val(1);
                            } else {
                                $("#stickerAnsVal").val(0);
                            }
                        });

                        $('.invoice_answer').live("change", function() {
                            var $cur = $(this);
                            var $val = $(this).val();
                            if ($cur.is(":checked")) {
                                $('.invoice_answer').attr('checked', false);
                                $cur.attr('checked', true);
                                $("#invoiceAnsVal").val(1);
                            } else {
                                $("#invoiceAnsVal").val(0);
                            }
                        });
                        var inputpas = document.getElementById("ccPassword");
                        inputpas.addEventListener("keyup", function(event) {
                            if (event.keyCode === 13) {
                                event.preventDefault();
                                checkCCPassword();
                            }
                        });

                        var inputpas1 = document.getElementById("newccPassword");
                        inputpas1.addEventListener("keyup", function(event) {
                            if (event.keyCode === 13) {
                                event.preventDefault();
                                newCheckCCPassword();
                            }
                        });


                        //Loki payment API
                        $("#cardTransaction").live("click", function() {
                            var cardName = $("#creditCardName1").val().trim();
                            var cardNum = $("#creditCardNum1").val().trim();
                            // var cardNum = $("#creditCardNum").val().trim();
                            var ExpMonth = $("#cardExpMonth1").val();
                            var ExpYear = $("#cardExpYear1").val();
                            var cvv = $("#creditCardCvv1").val().trim();
                            var amount = $("#saleAmount").val();
                            var orderId = $('#OrderId').val();
                            var cusId = $("#CustomerId").val();
                            var to_email = $("#editEmail").val();
                            var ordNum = $("#po_number").val();
                            var payMethod = $("#OrderPaidBy").val();
                            var status = $("#payment_status").val();
                            if (cardNum.indexOf('x') != -1) {
                                alert("Please show the card number.");
                                return false;
                            }
                            if (cardName.length <= 0) {
                                alert("Please enter Card Name");
                                return false;
                            }

                            if (cardNum.length < 13) {
                                alert("Please enter valid Card Number");
                                return false;
                            }

                            if (cvv.length < 3) {
                                alert("Please enter valid CVV");
                                return false;
                            }

                            if (amount <= 0) {
                                alert("Please enter Amount");
                                return false;
                            }
                            $("#cardTransaction").val("In Progress");
                            $("#cardTransaction").attr("disabled", true);
                            $.ajax({
                                url: G_URL + 'orders/bamboraPay',
                                dataType: 'JSON',
                                type: 'POST',
                                cache: false,
                                data: {
                                    order_id: orderId,
                                    cus_id: cusId,
                                    cardName: cardName,
                                    cardNum: cardNum,
                                    ExpMonth: ExpMonth,
                                    cvv: cvv,
                                    amount: amount,
                                    ExpYear: ExpYear,
                                    to_emial: to_email,
                                    order_num: ordNum,
                                    payMethod: payMethod,
                                    fromAdmin: 1,
                                    status: status
                                },
                                success: function(data) {
                                    $("#cardTransaction").val("Charge");
                                    $("#cardTransaction").attr("disabled", false);
                                    var res = JSON.parse(data);
                                    if (res.res == 1) {
                                        var check_first = parseInt((cardNum + '').charAt(0));
                                        if (check_first == 4) {
                                            $('#PaymentPaymentMethodId').val(3);
                                            $('#OrderPaidBy').val(3);

                                        } else if (check_first == 5) {
                                            $('#PaymentPaymentMethodId').val(4);
                                            $('#OrderPaidBy').val(4);
                                        } else {
                                            $('#PaymentPaymentMethodId').val(3);
                                            $('#OrderPaidBy').val(3);

                                        }
                                        $("#transaction_status").text("Approved");
                                        $("#transaction_status").css('color', 'green');
                                        $("#transaction_amount").text(res.amount);
                                        $("#transaction_auth").text(res.auth_code);
                                        $("#transaction_date").text(res.date);
                                        $("#cardTransaction").attr("disabled", true);
                                        $("#payment_status").val(1);
                                        var trailingCharsIntactCount = 4;
                                        var str = $("#creditCardNum1").val().trim();
                                        if (str != '') {
                                            str = new Array(str.length - trailingCharsIntactCount + 1).join('x') +
                                                str.slice(-trailingCharsIntactCount);
                                            $("#creditCardNum1").val(str);
                                        }
                                        alert("Payment Done Successfully.");

                                    } else {
                                        $("#payment_status").val(2);
                                        $("#transaction_status").text("Declined");
                                        $("#transaction_status").css('color', 'red');
                                        $("#transaction_auth").text('');
                                        $("#transaction_amount").text(res.amount);
                                        $("#transaction_date").text(res.date);
                                        alert(res.msg);
                                    }
                                }
                            });
                        });

                        //Loki PreAuthorized API

                        $("#preAuthTrans").live("click", function() {
                            var cardName = $("#creditCardName1").val().trim();
                            var cardNum = $("#creditCardNum1").val().trim();
                            var ExpMonth = $("#cardExpMonth1").val();
                            var ExpYear = $("#cardExpYear1").val();
                            var cvv = $("#creditCardCvv1").val().trim();
                            var amount = $("#saleAmount").val();
                            var orderId = $('#OrderId').val();
                            var cusId = $("#CustomerId").val();
                            var to_email = $("#editEmail").val();
                            var ordNum = $("#po_number").val();
                            var payMethod = $("#OrderPaidBy").val();

                            if (cardNum.indexOf('x') != -1) {
                                alert("Please show the card number.");
                                return false;
                            }
                            if (cardName.length <= 0) {
                                alert("Please enter Card Name");
                                return false;
                            }

                            if (cardNum.length < 13) {
                                alert("Please enter valid Card Number");
                                return false;
                            }

                            if (cvv.length < 3) {
                                alert("Please enter valid CVV");
                                return false;
                            }

                            if (amount <= 0) {
                                alert("Please enter Amount");
                                return false;
                            }

                            $.ajax({
                                url: G_URL + 'orders/bamboraPreAuth',
                                dataType: 'JSON',
                                type: 'POST',
                                cache: false,
                                data: {
                                    order_id: orderId,
                                    cus_id: cusId,
                                    cardName: cardName,
                                    cardNum: cardNum,
                                    ExpMonth: ExpMonth,
                                    cvv: cvv,
                                    amount: amount,
                                    ExpYear: ExpYear,
                                    to_emial: to_email,
                                    order_num: ordNum,
                                    payMethod: payMethod,
                                    fromAdmin: 1
                                },
                                success: function(data) {
                                    var res = JSON.parse(data);
                                    if (res.res == 1) {
                                        var check_first = parseInt((cardNum + '').charAt(0));
                                        if (check_first == 4) {
                                            $('#PaymentPaymentMethodId').val(3);
                                            $('#OrderPaidBy').val(3);

                                        } else if (check_first == 5) {
                                            $('#PaymentPaymentMethodId').val(4);
                                            $('#OrderPaidBy').val(4);
                                        } else {
                                            $('#PaymentPaymentMethodId').val(3);
                                            $('#OrderPaidBy').val(3);

                                        }
                                        $("#payment_status").val(3);
                                        $("#transaction_status").text("Authorization");
                                        $("#transaction_status").css('color', 'green');
                                        $("#transaction_amount").text(res.amount);
                                        $("#transaction_auth").text(res.auth_code);
                                        $("#transaction_date").text(res.date);
                                        $("#preAuthTrans").attr("disabled", true);
                                        alert("Authorization Done Successfully.");

                                    } else {
                                        $("#payment_status").val(4);
                                        $("#transaction_status").text("Not Authorized");
                                        $("#transaction_status").css('color', 'red');
                                        $("#transaction_auth").text('');
                                        $("#transaction_amount").text(res.amount);
                                        $("#transaction_date").text(res.date);
                                        alert("Authorization Failed.");
                                    }
                                }
                            });
                        });

                        //Loki payment API
                        $("#saveCardInfo").live("click", function() {
                            var cardName = $("#creditName").val().trim();
                            var cardNum = $("#creditCardNum").val().trim();
                            var ExpMonth = $("#cardExpMonth").val();
                            var ExpYear = $("#cardExpYear").val();
                            var cvv = $("#creditCvv").val().trim();
                            var amount = $("#saleAmount").val();
                            var orderId = $('#OrderId').val();
                            var cusId = $("#CustomerId").val();

                            if (cardName.length <= 0) {
                                alert("Please enter Card Name");
                                return false;
                            }

                            if (cardNum.length < 13) {
                                alert("Please enter valid Card Number");
                                return false;
                            }

                            if (cvv.length < 3) {
                                alert("Please enter valid CVV");
                                return false;
                            }

                            $.ajax({
                                url: G_URL + 'orders/saveCardInfo',
                                dataType: 'JSON',
                                type: 'POST',
                                cache: false,
                                data: {
                                    order_id: orderId,
                                    cus_id: cusId,
                                    cardName: cardName,
                                    cardNum: cardNum,
                                    ExpMonth: ExpMonth,
                                    cvv: cvv,
                                    amount: amount,
                                    ExpYear: ExpYear
                                },
                                success: function(data) {
                                    var res = JSON.parse(data);
                                    if (res.res == 1) {
                                        alert("Card Information Saved Successfully.");
                                    } else {
                                        alert("Card Information Not Saved.");
                                    }
                                }
                            });
                        });

                        //Loki: save card for existing client

                        $("#saveCard").live("click", function() {
                            var cardName = $("#creditCardName1").val().trim();
                            var cardNum = $("#creditCardNum1").val().trim();
                            if (cardNum.indexOf('x') != -1) {
                                alert("Please show the card number.");
                                return false;
                            }
                            var ExpMonth = $("#cardExpMonth1").val();
                            var ExpYear = $("#cardExpYear1").val();
                            var cvv = $("#creditCardCvv1").val().trim();
                            var orderId = $('#OrderId').val();
                            var cusId = $("#CustomerId").val();

                            if (cardName.length <= 0) {
                                alert("Please enter Card Name");
                                return false;
                            }

                            if (cardNum.length < 13) {
                                alert("Please enter valid Card Number");
                                return false;
                            }

                            if (cvv.length < 3) {
                                alert("Please enter valid CVV");
                                return false;
                            }

                            if (cusId != '') {
                                $.ajax({
                                    url: G_URL + 'orders/saveCardInfo',
                                    dataType: 'JSON',
                                    type: 'POST',
                                    cache: false,
                                    data: {
                                        order_id: orderId,
                                        cus_id: cusId,
                                        cardName: cardName,
                                        cardNum: cardNum,
                                        ExpMonth: ExpMonth,
                                        cvv: cvv,
                                        ExpYear: ExpYear
                                    },
                                    success: function(data) {
                                        var res = JSON.parse(data);
                                        if (res.res == 1) {
                                            $("#OrderShowCard").val(1);
                                            alert("Card Information Saved Successfully.");
                                        } else {
                                            alert("Card Information Not Saved.");
                                        }
                                    }
                                });
                            } else {
                                var r = confirm("Do you want to save this new customer");
                                if (r == true) {

                                    // alert("Customer not exist.");
                                    var cellPhone = $('#CustomerCellPhone').val();
                                    var phone = $('#CustomerPhone').val();
                                    var firstName = $('#CustomerFirstName').val();
                                    var lastName = $('#CustomerLastName').val();
                                    var email = $('#emailinput').val();
                                    var addressUnit = $('#CustomerAddressUnit').val();
                                    var buzz = $('#CustomerBuzz').val();
                                    var newAddress = $('#add_new_address').val();
                                    var streetNumber = $('#CustomerAddressStreetNumber').val();
                                    var street = $('#CustomerAddressStreet').val();
                                    var city = $('#CustomerCity').val();
                                    var postalCode = $('#CustomerPostalCode').val();
                                    var businessPhone = $('#CustomerBusinessPhone').val();
                                    var cardNumber = $('#CustomerCardNumber').val();
                                    var cardExp = $('#data[Customer][card_exp]').val();
                                    var nextService = $('#data[Customer][next_service]').val();
                                    var reminderDate = $('#data[Order][reminder_date]').val();
                                    var callBack = $('#data[Order][callback]').val();
                                    var customerNote = $('#txt_customer_note').val();
                                    var buzz = $('#CustomerBuzz').val();

                                    $.ajax({
                                        url: G_URL + 'orders/saveNewCustomers',
                                        dataType: 'JSON',
                                        type: 'POST',
                                        cache: false,
                                        data: {
                                            card_number: cardNumber,
                                            card_exp: cardExp,
                                            next_service: nextService,
                                            first_name: firstName,
                                            last_name: lastName,
                                            postal_code: postalCode,
                                            email: email,
                                            address_unit: addressUnit,
                                            address_street_number: streetNumber,
                                            address_street: street,
                                            city: city,
                                            phone: phone,
                                            cell_phone: cellPhone,
                                            callback_date: callBack,
                                            callback_notes: customerNote,
                                            buzz: buzz,
                                            campaign_id: $('#CuscampaingId').val(),
                                            order_id: orderId,
                                            cardName: cardName,
                                            cardNum: cardNum,
                                            ExpMonth: ExpMonth,
                                            cvv: cvv,
                                            ExpYear: ExpYear
                                        },
                                        success: function(data) {
                                            var res = JSON.parse(data);
                                            $("#CustomerId").val(res);
                                            if (res != '') {
                                                $("#CustomerId").val(res);
                                                $("#OrderShowCard").val(1);
                                                alert("Customer & Card Informations are Saved.");
                                            } else {
                                                alert("Customer Information Not Saved.");
                                            }
                                        }
                                    });
                                }
                            }
                        });

                        $("#useNewCard").live("click", function() {
                            var cardName = $("#creditCardName1").val('');
                            var cardNum = $("#creditCardNum1").val('');
                            var ExpMonth = $("#cardExpMonth1").val('');
                            var ExpYear = $("#cardExpYear1").val('');
                            var cvv = $("#creditCardCvv1").val('');
                            $("#useOldCard").attr("disabled", true);
                            $("#OrderShowCard").val(1);
                        });


                        $("#useOldCard").live("click", function() {
                            $("#OrderShowCard").val(1);
                            $("#new_cc_pass_box").dialog("open");
                        });

                        //Loki: Save payment receipt
                        $("#saveCreditImage").live("click", function(e) {
                            e.preventDefault();
                            var formdata = new FormData($("#editBookingform_new")[0]);

                            var xhr = new XMLHttpRequest();
                            xhr.open('POST', "<?=BASE_URL;?>/orders/savePaymentReceipt", true);
                            xhr.onload = function(data) {
                                var response = JSON.parse(xhr.response);
                                if (response.res == 1) {
                                    alert('Image uploaded successfully.');
                                } else {
                                    alert('Something went wrong in uploading file.');
                                }
                            };

                            xhr.send(formdata);
                        });
                        //Loki: Save payment receipt
                        $("#savePayImage").live("click", function(e) {
                            e.preventDefault();
                            var formdata = new FormData($("#editBookingform_new")[0]);

                            var xhr = new XMLHttpRequest();
                            xhr.open('POST', "<?=BASE_URL;?>/orders/savePayImage", true);
                            xhr.onload = function(data) {
                                var response = JSON.parse(xhr.response);
                                if (response.res == 1) {
                                    alert('Image uploaded successfully.');
                                } else {
                                    alert('Something went wrong in uploading file.');
                                }
                            };

                            xhr.send(formdata);
                        });
                        //Loki: Save payment receipt
                        $("#sendPermit").live("click", function(e) {
                            e.preventDefault();
                            var message = tinyMCE.activeEditor.getContent();
                            var officerEmail = $('#officerEmail').val();
                            if (officerEmail == '') {
                                alert("Please add Officer email address.");
                                return false;
                            }
                            var formdata = new FormData($("#editBookingform_new")[0]);
                            formdata.append('message', message);
                            formdata.append('officerEmail', officerEmail);
                            var xhr = new XMLHttpRequest();
                            xhr.open('POST', "<?=BASE_URL;?>/orders/sendImageToOfficer", true);
                            xhr.onload = function(data) {
                                var response = JSON.parse(xhr.response);
                                if (response.res == 1) {
                                    $("#permitTemp").dialog("close");
                                    alert('Images sent successfully.');
                                } else {
                                    alert('Something went wrong in uploading file.');
                                }
                            };

                            xhr.send(formdata);
                        });

                        $("#showMailPreview").live("click", function() {
                            $("#sendImageBox").dialog('close');
                            $("#previewPermit").trigger("click");
                        });
                        //  $("#sendImageToOfficer").live("click", function(e){
                        //      e.preventDefault();
                        //      var officerEmail = $('#officerEmail').val();
                        //      var permitNum = $('#permitNum').val();
                        //      var formdata = new FormData($("#editBookingform_new")[0]);
                        //      formdata.append('officerEmail', officerEmail);
                        //      formdata.append('permitNum', permitNum);
                        //      var xhr = new XMLHttpRequest();
                        //      xhr.open('POST', "<?=BASE_URL;?>/orders/sendImageToOfficer", true);
                        //      xhr.onload = function (data) {
                        //           var response = JSON.parse(xhr.response);
                        //        if (response.res == 1) {

                        //              alert('Images sent successfully.');
                        //        } else {
                        //          alert('Something went wrong in uploading file.');
                        //        }
                        //      };

                        //      xhr.send(formdata);
                        // });

                        $("#savePermitInfo").live("click", function(e) {
                            e.preventDefault();
                            var permitNum = $('#permitNum').val();
                            var formdata = new FormData($("#editBookingform_new")[0]);
                            formdata.append('permitNum', permitNum);
                            var xhr = new XMLHttpRequest();
                            xhr.open('POST', "<?=BASE_URL;?>/orders/savePermitInfo", true);
                            xhr.onload = function(data) {
                                var response = JSON.parse(xhr.response);
                                if (response.res == 1) {

                                    alert('Permit Info Saved Successfully.');
                                } else {
                                    alert('Permit Info Not Saved.');
                                }
                            };

                            xhr.send(formdata);
                        });

                        var orderIdExist = $('#OrderId').val();
                        $("#sendReviewEmail").click(function() {
                            var email = $("#editEmail").val();
                            var cellPhone = $("#CustomerCellPhone").val();
                            var orderId = $('#OrderId').val();
                            var cusId = $("#CustomerId").val();
                            $.ajax({
                                url: G_URL + 'orders/sendInvoiceWithReviewLink',
                                dataType: 'html',
                                type: 'POST',
                                cache: false,
                                data: {
                                    order_id: orderId,
                                    cus_id: cusId,
                                    cell_phone: cellPhone,
                                    email: email
                                },
                                success: function(data) {
                                    res = JSON.parse(data);
                                    if (res.res == "OK") {
                                        alert("Invoice Sent Successfully.");
                                    }
                                }
                            });
                        });

                        if (orderIdExist == '') {
                            $("#OrderOrderTypeId").hide();
                        }
                        $(".change_service").live("click", function() {
                            var typeId = $(this).attr("btn-val");
                            if (typeId == 2) {
                                $("#OrderT1Method").val(2);
                            } else {
                                $("#OrderT1Method").val('');
                            }
                            $("#OrderOrderTypeId").show();
                            $("#OrderOrderTypeId").empty();
                            $.ajax({
                                url: "<?=BASE_URL;?>/orders/getOrderJobTypes",
                                type: "POST",
                                data: {
                                    typeId: typeId
                                },
                                dataType: 'html',
                                success: function(data) {
                                    $("#OrderOrderTypeId").append(data);
                                    // $("#OrderOrderTypeId").trigger('click');
                                    $("#OrderOrderTypeId").attr('size', 12);
                                    $("#OrderOrderTypeId").css('position', 'absolute');
                                    // JobTypeChange(1);
                                }
                            });
                        });

                        var jobTypeId = $("#OrderOrderTypeId").val();
                        var orderId = $('#OrderId').val();
                        if ((jobTypeId == 81) && (orderId == '')) {
                            JobTypeChange();
                        }
                        // $("#OrderJobTruck").live("change",function(){
                        $("#OrderJobShift").live("change", function() {
                            var orderdate = $("#OrderJobDate").val();
                            var truck = $("#OrderJobTruck").val();
                            var shift = $(this).val();
                            if (shift != 0) {
                                $.ajax({
                                    url: "<?=BASE_URL;?>/orders/chekcTruckTime",
                                    type: "POST",
                                    // data : {order_date:orderdate,truck:truck},
                                    data: {
                                        order_date: orderdate,
                                        truck: truck,
                                        shift: shift
                                    },
                                    dataType: 'json',
                                    success: function(data) {
                                        if (data.res == "1") {
                                            $("#job_timing_box").html(data.timing);
                                            $("#job_timing_box").dialog("open");
                                            // $("#OrderJobTimeEndHour option[value="+data.timing.end_time+"]").attr('selected', 'selected');
                                            // $("#OrderJobTimeBegHour option[value="+data.timing.start_time+"]").attr('selected', 'selected');

                                        }
                                    }
                                });
                            }

                        });

                        //loki: Save percentage data
                        $("#savePercentage").live("click", function() {
                            $(".percentageBox").dialog("close");
                            TotalCalculation();
                        });
                        //Loki: hide the search item table.
                        $(".clearSearch").live("click", function() {
                            $("#ajax_item_results_0").hide();
                            $("#ajax_item_results_1").hide();
                            $("#addBookedItems").attr("disabled", false);
                            $("#addTechnicianSales").attr("disabled", false);
                        });
                        //Loki: set address fields blank for new address.
                        $("#add_new_address").live("click", function() {
                            $("#address_id").val('');
                            $("#CustomerAddressUnit").val('');
                            $("#CustomerAddressStreetNumber").val('');
                            $("#CustomerAddressStreet").val('');
                            $("#CustomerCity").val('');
                            $("#CustomerPostalCode").val('');
                        });

                        //Loki
                        $(".delete_selected_items").live("click", function() {
                            var Id = '';
                            $(".delete_items:checkbox:checked").each(function() {
                                Id += (Id != "") ? "," : "";
                                Id += $(this).attr("item-id");
                            });
                            $.ajax({
                                url: "<?=BASE_URL;?>/inventories/deleteItems",
                                type: "POST",
                                data: {
                                    Id: Id
                                },
                                dataType: 'json',
                                success: function(data) {
                                    if (data.res == "1") {
                                        $(".delete_items:checkbox:checked").each(function() {
                                            $(this).parent().parent().remove();
                                        });
                                    }
                                }
                            });
                        });
                        //Loki
                        $(".add_selected_items").live("click", function() {
                            var Id = '';
                            var itemClass = $(this).attr("item-class");
                            table = $('#ajax_item_results_' + itemClass);
                            table.hide();
                            // $('#ajax_item_name').val('');
                            $("#addBookedItems").attr("disabled", false);
                            $("#addTechnicianSales").attr("disabled", false);

                            $(".delete_items:checkbox:checked").each(function() {
                                var cur = $(this).parent().parent();
                                var itemId = $('.item_id_' + itemClass, cur).text();
                                var name = $('.name_' + itemClass, cur).text();
                                var price = $('.price_' + itemClass, cur).text();
                                var sku = $('.sku_' + itemClass, cur).text();
                                var purchasePrice = $('.purchase_price_' + itemClass, cur).text();
                                var catId = $('.category_id_' + itemClass, cur).text();
                                var modelId = $('.model_' + itemClass, cur).text();
                                var brandId = $('.brand_' + itemClass, cur).text();
                                var subCatId = $('.sub_category_id_' + itemClass, cur).text();
                                var markupPercent = $('.markup_percent_' + itemClass, cur).text();
                                var techPercent = $('.tech_percent_' + itemClass, cur).text();

                                // addItem(dat.children(".item_id_"+data_class).text(), dat.children(".name_"+data_class).text(), dat.children(".price_"+data_class).text(),data_class, dat.children(".category_id_"+data_class).text(), dat.children(".purchase_price_"+data_class).text(),"" ,"1",dat.children(".model_"+data_class).text(), dat.children(".brand_"+data_class).text(), dat.children(".sku_"+data_class).text(),'','','','',dat.children(".sub_category_id_"+data_class).text());

                                addItem(itemId, name, price, itemClass, catId, purchasePrice, "", "1", modelId, brandId, sku, "", "", "", "", subCatId, '', markupPercent, techPercent);
                            });
                        });

                        // Get technician default percentage.
                        $("#OrderJobTechnician1Id").live("change", function() {
                            var techId = $("#OrderJobTechnician1Id").val();
                            $.ajax({
                                url: "<?=BASE_URL;?>/users/getTechPercentage",
                                type: "POST",
                                data: {
                                    techId: techId
                                },
                                dataType: 'json',
                                success: function(data) {
                                    $("#tech_percentage").val(data.tech);
                                    $("#tech_percentage_type").val(1);
                                    $("#markup_percentage").val(data.parts);
                                    $("#markup_percentage_type").val(1);
                                    TotalCalculation();
                                }
                            });
                        });

                        $(".addPurchaseItem").live("click", function() {
                            var tableNo = $(this).attr('table-no');
                            var formData = new FormData($("#editBookingform_new")[0]);
                            var techId = $("#OrderJobTechnician1Id").val();
                            formData.append("techId", techId);
                            var xhr = new XMLHttpRequest();
                            xhr.open('POST', "<?=BASE_URL;?>/inventories/addNewPurchaseItem", true);
                            xhr.onload = function() {
                                var response = JSON.parse(xhr.response);

                                if (response.res == 1) {
                                    var items = JSON.stringify(response.itemArray);
                                    var url = "<?=BASE_URL?>/inventories/editDoc";
                                    url += "?type=1";
                                    url += "&doc_date=" + response.poData.data.Order.app_ordered_date;
                                    url += "&supplierId=" + response.poData.data.Order.app_ordered_supplier_id;
                                    url += "&invoiceId=" + response.poData.data.Order.invoice_id;
                                    url += "&techId=" + response.poData.techId;
                                    url += "&orderId=" + response.poData.poNumber;
                                    url += "&orderNum=" + response.poData.poNumber;
                                    url += "&fromBooking=1";
                                    url += "&supplierInfo=" + response.poData.data.Order.purchase_supplier_info;
                                    var option = "width=1050,height=650,left=300,top=200,status=off,scroll=off,resizable=off";
                                    var win = window.open(url, '', option);
                                    var timer = setInterval(function() {
                                        if (win.closed) {
                                            clearInterval(timer);
                                            var returnItem = win.returnPurchaseItem;
                                            var purchase = win.purchase;
                                            var purArr = purchase.split(',');
                                            $("#OrderAppOrderedSupplierId").val(purArr[0]);
                                            $("#invoiceId").val(purArr[1]);
                                            ChangeSupplier(document.getElementById("OrderAppOrderedSupplierId"));
                                            $.each(returnItem, function(key, value) {
                                                addItem(value.item_id, value.name, '', tableNo, value.cat_id, value.price, "", "1", '', '', value.sku, value.quantity, "", "", "", value.sub_cat_id, value.invoiceId);
                                            });
                                        }
                                    }, 500);
                                } else if (response.res == 0) {
                                    $("#invoiceMsgbx").html("Invoice already created. Do you want to create again?");
                                    showInvoice();
                                }
                            };

                            xhr.send(formData);
                        });

                        $("#transfer_order_item").live("click", function() {

                            var tableNo = $(this).attr('table-no');
                            var formData = new FormData($("#editBookingform_new")[0]);
                            var techId = $("#OrderJobTechnician1Id").val();
                            formData.append("techId", techId);
                            var xhr = new XMLHttpRequest();
                            xhr.open('POST', "<?=BASE_URL;?>/inventories/addTransferItem", true);
                            xhr.onload = function() {
                                var response = JSON.parse(xhr.response);

                                if (response.res == 1) {
                                    var items = JSON.stringify(response.itemArray);
                                    var url = "<?=BASE_URL?>/inventories/moveTechItem";

                                    url += "?techId=" + response.poData.techId;
                                    url += "&fromBooking=1";
                                    url += "&bookingItems=" + response.itemArray;
                                    var option = "width=1050,height=650,left=300,top=200,status=off,scroll=off,resizable=off";
                                    var win = window.open(url, '', option);

                                    var timer = setInterval(function() {
                                        if (win.closed) {
                                            clearInterval(timer);
                                            $(".purchaseItems").attr("checked", false);

                                        }
                                    }, 500);
                                }
                                // else if(response.res == 0) {
                                // 	$("#invoiceMsgbx").html("Invoice already created. Do you want to create again?");
                                // 	showInvoice();
                                // }
                            };

                            xhr.send(formData);
                        });

                        $("#generate_purchase_order").live("click", function() {
                            var countItem = 0;
                            var orderBy = $("#OrderAppOrderedBy").val();
                            var invoiceNo = $("#invoiceId").val();
                            // if(orderBy == '' || orderBy == undefined)
                            // {
                            //     alert("Please select ordered by user.");
                            //     return false;
                            // }
                            // if(invoiceNo == '' || invoiceNo == undefined)
                            // {
                            //     alert("Please add invoice number.");
                            //     return false;
                            // }

                            $('#MainItemsTable #CurrentItemsTable').children('tbody').children('.booked').each(function(i, el) {
                                if ($(el).children('.order_status_val ').children('input').is(":checked")) {
                                    countItem++;
                                }
                            });
                            $('#CurrentItemsTableTech').children('tbody').children('.extra').each(function(i, el) {
                                if ($(el).children('.order_status_val ').children('input').is(":checked")) {
                                    countItem++;
                                }
                            });
                            if (countItem > 0) {
                                var formData = new FormData($("#editBookingform_new")[0]);
                                var techId = $("#OrderJobTechnician1Id ").val();
                                formData.append("techId", techId);
                                var xhr = new XMLHttpRequest();
                                xhr.open('POST', "<?=BASE_URL;?>/inventories/createPurchaseInvoice", true);
                                xhr.onload = function() {
                                    var response = JSON.parse(xhr.response);

                                    if (response.res == 1) {
                                        var items = JSON.stringify(response.itemArray);
                                        var url = "<?=BASE_URL?>/inventories/editDoc";
                                        url += "?type=1";
                                        url += "&doc_date=" + response.poData.data.Order.app_ordered_date;
                                        url += "&supplierId=" + response.poData.data.Order.app_ordered_supplier_id;
                                        url += "&invoiceId=" + response.poData.data.Order.invoice_id;
                                        url += "&techId=" + response.poData.techId;
                                        url += "&orderId=" + response.poData.poNumber;
                                        url += "&orderNum=" + response.poData.poNumber;
                                        url += "&orderItems=" + items;
                                        url += "&fromBooking=2";
                                        url += "&supplierInfo=" + response.poData.data.Order.purchase_supplier_info;
                                        var option = "width=1250,height=650,left=300,top=200,status=off,scroll=off,resizable=off";
                                        var win = window.open(url, '', option);

                                        var timer = setInterval(function() {
                                            if (win.closed) {
                                                clearInterval(timer);
                                                var returnItem = win.returnPurchaseItem;
                                                var purchase = win.purchase;
                                                var purArr = purchase.split(',');
                                                $("#OrderAppOrderedSupplierId").val(purArr[0]);
                                                $("#invoiceId").val(purArr[1]);
                                                ChangeSupplier(document.getElementById("OrderAppOrderedSupplierId"));
                                                $(".purchaseItems:checkbox:checked").each(function() {
                                                    Id = $(this).attr('itemIndex');
                                                    removeItem(Id);
                                                });
                                                $.each(returnItem, function(key, value) {
                                                    addItem(value.item_id, value.name, value.org_price, value.class, value.cat_id, value.price, "", "1", '', '', value.sku, value.quantity, "", "", "", value.sub_cat_id, value.invoiceId, value.markup_percent, value.tech_percent);
                                                });
                                            }
                                        }, 500);
                                    } else if (response.res == 0) {
                                        $("#invoiceMsgbx").html("Invoice already created. Do you want to create again?");
                                        showInvoice();
                                    }
                                };

                                xhr.send(formData);
                            } else {
                                alert("Please select atleast one item.");
                                return false;
                            }
                        });
                        //Loki: get order items
                        $("#saveImages").live("click", function(e) {
                            e.preventDefault();
                            var formdata = new FormData($("#editBookingform_new")[0]);

                            var xhr = new XMLHttpRequest();
                            xhr.open('POST', "<?=BASE_URL;?>/customers/saveImages", true);
                            xhr.onload = function() {
                                if (xhr.status === 200) {
                                    localStorage.setItem('from_image', '1');
                                    window.location.reload(true);
                                    // $("#trigger1").click();
                                } else {
                                    alert('Something went wrong uploading the file.');
                                }
                            };

                            xhr.send(formdata);
                        });
                        if (localStorage.getItem('from_image') == 1) {
                            localStorage.setItem('from_image', '0');
                            openTab(13);
                        }
                        $("#save_answer").live("click", function(e) {
                            e.preventDefault();
                            var formdata = new FormData($("#editBookingform_new")[0]);

                            var xhr = new XMLHttpRequest();
                            xhr.open('POST', "<?=BASE_URL;?>/orders/saveAdminAnswer", true);
                            xhr.onload = function() {
                                if (xhr.status === 200) {
                                    window.location.reload();
                                    // $("#trigger1").click();
                                } else {
                                    alert('Something went wrong.');
                                }
                            };

                            xhr.send(formdata);
                        });
                        //Loki: choose address from addresses
                        $(".customerAddresses").live("click", function() {
                            var cur = $(this);
                            $(".customerAddresses").css("background-color", "#989696");
                            $(cur).css("background-color", "#00ff00");
                            var id = cur.attr("address-id");
                            var unit = $(".address_unit", cur).text();
                            var streetNum = $(".address_street_number", cur).text();
                            var street = $(".address_street", cur).text();
                            var city = $(".city", cur).text().trim();
                            var postal_code = $(".postal_code", cur).text();

                            $("#CustomerPostalCode").val(postal_code);
                            $("#CustomerAddressStreetNumber").val(streetNum);
                            $("#CustomerAddressStreet").val(street);
                            //$("#CustomerCity").val(city);
                            $("#CustomerAddressUnit").val(unit);
                            $("#address_id").val(id);
                            $('#CustomerCity option[value="' + city + '"]').attr('selected', 'selected');
                            $("#campaing-select option[data-camp-city='" + city + "']").attr("selected", true);
                        });
                        //Loki: check customer exist or not using phone number
                        $("#CustomerCellPhone").live("change", function() {
                            var phoneNum = $("#CustomerCellPhone").val();
                            var showPreview = $("#showPreview").val();
                            var numType = $(this).attr('num_type');
                            var strlength = phoneNum.length;
                            var partRequest = $("#partRequest").val();;
                            if (strlength >= 10) {
                                $.ajax({
                                    url: "<?=BASE_URL;?>/customers/checkCustomerExist",
                                    type: "POST",
                                    data: {
                                        phoneNum: phoneNum,
                                        numType: numType
                                    },
                                    dataType: 'json',
                                    success: function(data) {
                                        if (data.res > 0) {
                                            var msg = "User already exist for booking <a href='<?=BASE_URL;?>/orders/editBooking?customer_id=" + data.res + " &order_id=0&show_preview=" + showPreview + "&part_request=" + partRequest + "&job_date=<?php echo $job_date ;?><?php echo $url.$truck.$job_time_beg.$job_time_end ?>' style='color: blue;'>Click Here</a>";
                                            $("#user_message_box").html(msg);
                                            $("#user_message_box").dialog("open");
                                        }
                                    }
                                });
                            }
                        });

                        $("#CustomerPhone").live("change", function() {
                            var phoneNum = $("#CustomerPhone").val();
                            var numType = $(this).attr('num_type');
                            var strlength = phoneNum.length;
                            if (strlength >= 10) {
                                $.ajax({
                                    url: "<?=BASE_URL;?>/customers/checkCustomerExist",
                                    type: "POST",
                                    data: {
                                        phoneNum: phoneNum,
                                        numType: numType
                                    },
                                    dataType: 'json',
                                    success: function(data) {
                                        if (data.res > 0) {
                                            var msg = "User already exist <a href='<?=BASE_URL;?>/orders/editBooking?customer_id=" + data.res + " &order_id=0' style='color: blue;'>Click Here</a>";
                                            $("#user_message_box").html(msg);
                                            $("#user_message_box").dialog("open");
                                        }
                                    }
                                });
                            }
                        });


                        // Loki: Remove onr time purchase item from item_box
                        $(".removeOnetimeItem").live("click", function() {
                            $(this).closest('tr').remove();
                        });

                        // Loki add one time purchase items in the table .
                        // $("#add_one_time_item").live("click", function(){
                        //     template = $("#one_time_row");
                        //     tableTemp = $('#new_item_table');
                        //     result = template.clone();
                        //     $(result).removeAttr("id").addClass("remove_tr").show().appendTo(tableTemp);;
                        // });
                        // $(".search_supplier").live("keyup",searchSupplier);
                        $(".search_supplier").live("keyup", function() {
                            searchSupplier(this);
                        }); // Get items and show
                        $(".ajax_item_name").live("keyup", function(event) {

                            if (event.which != "17") {
                                ajax(this);
                            }


                        });

                        $("#payment_receipt").live("click", function() {
                            var orderId = $('#OrderId').val();
                            var email = $('#emailinput').val();
                            var CustomerId = $('#CustomerId').val();
                            $.ajax({
                                url: "<?=BASE_URL;?>/orders/sendOrderPaymentReceipt",
                                type: "POST",
                                data: {
                                    orderId: orderId,
                                    email: email,
                                    CustomerId: CustomerId
                                },
                                success: function(data) {
                                    res = JSON.parse(data);
                                    if (res.res == "OK") {
                                        alert("Payment Receipt sent successfully.")
                                            // window.location.reload();
                                    }
                                }
                            });
                        });
                        $("#resendEmail").live("change", function() {
                            if ($(this).is(":checked")) {
                                $("#resendEmailVal").val(1);
                            } else {
                                $("#resendEmailVal").val(0);
                            }
                        });
                        $("#resendText").live("change", function() {
                            if ($(this).is(":checked")) {
                                $("#resendTextVal").val(1);
                            } else {
                                $("#resendTextVal").val(0);
                            }
                        });

                        $('#markAll').live('click', function() {
                            $(".delete_email").attr('checked', this.checked);
                        });

                        $('#deleteAll').live('click', function() {
                            var Id = '';
                            $(".delete_email:checkbox:checked").each(function() {
                                Id += (Id != "") ? "," : "";
                                Id += $(this).val();
                            });
                            Updateflag(Id);
                        });

                        $("#close_timing_box").live("click", function() {
                            $("#job_timing_box").dialog("close");
                        });

                        function Updateflag(Id) {
                            var button_type = $("#button_type").val();
                            $.ajax({
                                url: "<?=BASE_URL;?>/orders/updateEmailStatus",
                                type: "POST",
                                data: {
                                    id: Id,
                                    button_type: button_type
                                },
                                success: function(data) {
                                    res = JSON.parse(data);
                                    if (res.res == "OK") {
                                        window.location.reload();
                                    }
                                }
                            });
                        }
                        //Loki: credit card info password box.
                        $(function() {
                            $("#cc_pass_box").dialog({
                                modal: false,
                                autoOpen: false,
                                title: "Password",
                                autoOpen: false,
                                width: 300,
                                height: 250,
                                cache: false,
                                position: {
                                    my: "center top",
                                    at: "center top"
                                }
                            });
                        });

                        $(function() {
                            $("#new_cc_pass_box").dialog({
                                modal: false,
                                autoOpen: false,
                                title: "Password",
                                autoOpen: false,
                                width: 300,
                                height: 250,
                                cache: false,
                                position: {
                                    my: "center top",
                                    at: "center top"
                                }
                            });
                        });

                        //Loki: open box to show the availble timing for booking
                        $(function() {
                            $("#job_timing_box").dialog({
                                modal: false,
                                autoOpen: false,
                                title: "Timing",
                                autoOpen: false,
                                width: 300,
                                height: 250,
                                cache: false,
                                position: {
                                    my: "center top",
                                    at: "center top"
                                }
                            });
                        });
                        //Loki: open box for user exist message
                        $(function() {
                            $("#user_message_box").dialog({
                                modal: true,
                                autoOpen: false,
                                title: "Error",
                                autoOpen: false,
                                width: 700,
                                height: 200,
                                cache: false
                            });
                        });
                        //Loki Ask password for changing source1.
                        $(function() {
                            $("#open_source_password").dialog({
                                modal: true,
                                autoOpen: false,
                                title: "Message",
                                autoOpen: false,
                                width: 500,
                                height: 400,
                                closeOnEscape: false,
                                open: function(event, ui) {
                                    $(".ui-dialog-titlebar-close").hide();
                                }
                            });
                            $("#OrderBookingSourceId").live("change", function() {
                                var source1Val = $("#is_source1_val").val();
                                if (source1Val == 1) {
                                    $('#open_source_password').dialog('open');
                                }
                            });
                        });
                        //Loki Ask password for changing source2.
                        $(function() {
                            $("#open_source_password").dialog({
                                modal: true,
                                autoOpen: false,
                                title: "Message",
                                autoOpen: false,
                                width: 500,
                                height: 400,
                                closeOnEscape: false,
                                open: function(event, ui) {
                                    $(".ui-dialog-titlebar-close").hide();
                                }
                            });
                            $("#OrderBookingSource2Id").live("change", function() {
                                var source1Val = $("#is_source1_val").val();
                                if (source1Val == 1) {
                                    $('#open_source_password').dialog('open');
                                }
                            });
                        });
                        //Loki- Show email log content
                        $(function() {
                            $(".show_email_content").dialog({
                                modal: true,
                                autoOpen: false,
                                title: "Message",
                                autoOpen: false,
                                width: 900,
                                height: 700,
                            });
                            $(".viewContents").live("click", function() {
                                var id = $(this).attr("content_id");
                                var message = $("#log_content_" + id).val();
                                $('.show_email_content').html(message);
                                $('.show_email_content').dialog('open');
                            });
                        });

                        $(function() {
                            $(".show_email_content").dialog({
                                modal: true,
                                autoOpen: false,
                                title: "Message",
                                autoOpen: false,
                                width: 900,
                                height: 786,
                            });
                            $(".receiveViewContents").live("click", function() {
                                var id = $(this).attr("content_id");
                                var message = $("#received_log_content_" + id).val();
                                $('.show_email_content').html(message);
                                $('.show_email_content').dialog('open');
                            });
                        });


                        //Loki- Show sms log content
                        $(function() {
                            $(".show_sms_content").dialog({
                                modal: true,
                                autoOpen: false,
                                title: "Message",
                                autoOpen: false,
                                width: 1024,
                                height: 786,
                            });
                            $(".viewSmsContents").live("click", function() {
                                var id = $(this).attr("content_id");
                                var message = $("#sms_log_content_" + id).val();
                                $('.show_sms_content').html(message);
                                $('.show_sms_content').dialog('open');
                            });
                        });

                        $(function() {
                            $(".show_sms_content").dialog({
                                modal: true,
                                autoOpen: false,
                                title: "Message",
                                autoOpen: false,
                                width: 1024,
                                height: 786,
                            });
                            $(".receiveViewSmsContents").live("click", function() {
                                var id = $(this).attr("content_id");
                                var message = $("#received_sms_log_content_" + id).val();
                                $('.show_sms_content').html(message);
                                $('.show_sms_content').dialog('open');
                            });
                        });
                        //Loki- Delete payment image
                        $("#delete-image").live("click", function() {
                            var id = $('#OrderId').val();
                            var imgPath = $(this).attr("image-name");

                            $.ajax({
                                url: '<?=BASE_URL?>/orders/removePaymentImage',
                                dataType: 'html',
                                type: 'POST',
                                cache: false,
                                data: {
                                    oid: id,
                                    imgPath: imgPath
                                },
                                success: function(data) {
                                    res = JSON.parse(data);
                                    if (res.res == "OK") {
                                        $("#order_paymnet_picture").hide();
                                        $("#upload_payment_picture").show();
                                        //location.reload(true);
                                    }
                                }
                            });

                        });

                        //Loki- Delete payment image
                        $("#delete-credit-image").live("click", function() {
                            var id = $('#OrderId').val();
                            var imgPath = $(this).attr("image-name");

                            $.ajax({
                                url: '<?=BASE_URL?>/orders/removeCreditPaymentImage',
                                dataType: 'html',
                                type: 'POST',
                                cache: false,
                                data: {
                                    oid: id,
                                    imgPath: imgPath
                                },
                                success: function(data) {
                                    res = JSON.parse(data);
                                    if (res.res == "OK") {
                                        $("#credit_image_box").hide();
                                        $("#credit_image_upload").show();
                                        //location.reload(true);
                                    }
                                }
                            });

                        });
                        // Delete purchase images
                        $(".delete-purchase-image").live("click", function() {
                            var current = $(this);
                            var id = $(this).attr("image-id");
                            var imgPath = $(this).attr("image-name");
                            $.ajax({
                                url: '<?=BASE_URL?>/orders/removePurchaseImage',
                                dataType: 'html',
                                type: 'POST',
                                cache: false,
                                data: {
                                    id: id,
                                    imgPath: imgPath
                                },
                                success: function(data) {
                                    res = JSON.parse(data);
                                    if (res.res == "OK") {
                                        current.parent().hide();
                                        current.parent().next('img').hide();
                                        current.parent().next('img').next('.installImages').hide();
                                    }
                                }
                            });

                        });

                        $(".delete-invoice-image").live("click", function() {
                            var id = $('#OrderId').val();
                            var imgPath = $(this).attr("image-name");
                            $.ajax({
                                url: '<?=BASE_URL?>/orders/removeInvoiceImage',
                                dataType: 'html',
                                type: 'POST',
                                cache: false,
                                data: {
                                    oid: id,
                                    imgPath: imgPath
                                },
                                success: function(data) {
                                    res = JSON.parse(data);
                                    if (res.res == "OK") {
                                        $("#invoice_order_image").hide();
                                        $("#invoice_order_upload").show();
                                        $("#orderInvoiceImage").val('');
                                        //location.reload(true);
                                    }
                                }
                            });

                        });

                        $(function() {
                            $(".invoice-img-enlarge").dialog({
                                modal: true,
                                autoOpen: false,
                                title: "Photo",
                                autoOpen: false,
                                width: 1024,
                                height: 786,
                            });
                            $(".invoice-openImg").live("click", function() {
                                var imgPath = $(this).attr('src');
                                $('.invoice-img-enlarge img').attr('src', imgPath);
                                $('.invoice-img-enlarge a').attr('href', imgPath);
                                $('.invoice-img-enlarge').dialog('open');
                            });
                        });

                        $(function() {
                            $(".installation_item_box").dialog({
                                modal: true,
                                autoOpen: false,
                                title: "Items",
                                autoOpen: false,
                                width: 800,
                                height: 786,
                            });
                            $(".installation_item").live("click", function() {
                                var packageId = $("#installation_item_val").val();

                                if (packageId == '' || packageId <= 0) {
                                    alert("No package available for this job type.");
                                    return false;
                                }
                                var orderId = $('#OrderId').val();
                                var url = "<?=BASE_URL?>/orders/orderPackageItems";
                                $.ajax({
                                    url: url,
                                    type: "POST",
                                    data: {
                                        orderId: orderId,
                                        packageId: packageId
                                    },
                                    success: function(data) {
                                        $("#installation_item_table tbody").html('');
                                        $("#installation_item_table tbody").append(data);
                                        InstallationCalculation();
                                        $("#installation_open").val(1);
                                        $('.installation_item_box').dialog('open');
                                    }
                                });
                            });
                        });

                        $("#saveInstallationItem").live("click", function() {
                            // document.forms['editBookingform'].submit();
                            var $el = $('#installation_item_table').clone();
                            var notes = $('#installation_notes').val();
                            $('#installation_notes_copy').val(notes);
                            $('#installation_item_append').html('');
                            $('#installation_item_append').append($el);
                            //$("#editBookingform_new").submit();
                            $('.installation_item_box').dialog('close');
                        });

                        var sendEstmt = $("#mailbut").attr('send-estmt');
                        var fromEstmt = $("#mailbut").attr('frm-estmt');
                        if (sendEstmt == 1 && fromEstmt == 0) {
                            $("#mailbut").val("Estimate Sent");
                        }
                        $("#show-purchase").live("change", function() {
                            if ($(this).is(":checked")) {
                                $("#show-purchase").val(0);
                            } else if ($(this).is(":not(:checked)")) {
                                $("#show-purchase").val(1);
                            }
                        });

                        $('#save-reminder-email').live("click", function() {
                            var hide_modal = $("#hide_modal").val();
                            var reminderMonths = $("#reminder-months").val();
                            var reminderDate = $("#reminder-date").val();
                            var reminderType = $("#reminder-type-val").val();
                            var remiderNote = $("#reminder-message").val();
                            var emailId = $("#reminder_email_id").val();
                            var smsNum = $("#reminder_text_num").val();
                            var callbackNum = $("#reminder_callback_num").val();
                            var reminderEmailSend = 0;
                            var reminderSmsSend = 0;
                            var reminderCallback = 0;
                            var mainOrderId = $('#mainOrderId').val();
                            var customerId = $('#CustomerId').val();
                            if ($('#reminder-type-email').is(":checked")) {
                                reminderEmailSend = 1;
                            }
                            if ($('#reminder-type-sms').is(":checked")) {
                                reminderSmsSend = 1;
                            }
                            if ($('#reminder-callback').is(":checked")) {
                                reminderCallback = 1;
                            }
                            $.ajax({
                                url: '<?=BASE_URL?>/orders/setReminderEmail/?ordid=' + mainOrderId,
                                dataType: 'html',
                                type: 'POST',
                                cache: false,
                                data: {
                                    reminderMonths: reminderMonths,
                                    reminderDate: reminderDate,
                                    reminderType: reminderType,
                                    remiderNote: remiderNote,
                                    reminderSmsSend: reminderSmsSend,
                                    reminderEmailSend: reminderEmailSend,
                                    emailId: emailId,
                                    smsNum: smsNum,
                                    callbackNum: callbackNum,
                                    reminderCallback: reminderCallback,
                                    customerId: customerId
                                },
                                success: function(data) {
                                    res = JSON.parse(data);
                                    if (res.res == "OK") {
                                        hideInvoiceReview();
                                        if (hide_modal != 1) {
                                            showMyModal();
                                        }

                                    }
                                }
                            });
                        });

                        $('#save-reminder-callback').live("click", function() {
                            var orderId = $("#po_number").val();
                            var reminderDate = $("#reminder-date1").val();
                            var remiderNote = $("#reminder-message1").val();
                            var isChecked = $('#isCallback');

                            if (isChecked.is(":checked")) {
                                $.ajax({
                                    url: '<?=BASE_URL?>/reports/setReminderCallback',
                                    dataType: 'html',
                                    type: 'POST',
                                    cache: false,
                                    data: {
                                        reminderDate: reminderDate,
                                        remiderNote: remiderNote,
                                        orderId: orderId
                                    },
                                    success: function(data) {
                                        res = JSON.parse(data);
                                        if (res.res == "OK") {
                                            hideEstimateCallback();
                                        }
                                    }
                                });
                            } else {
                                hideEstimateCallback();
                            }
                        });

                        $('.reminder-email-type').live("change", function() {
                            var $cur = $(this);
                            var $val = $(this).val();
                            if ($cur.is(":checked")) {
                                $('.reminder-email-type').attr('checked', false);
                                $cur.attr('checked', true);
                            }
                            $('#reminder-type-val').val($val);
                        });

                        // $('#save-reminder-email').live("click", function(){
                        // 	var remindeeDate = $('#reminder-date').val();
                        // });
                        $('#reminderMail').live("change", function(e) {
                            if ($(this).is(":checked")) {
                                $("#reminderMail").val(1);
                            } else if ($(this).is(":not(:checked)")) {
                                $("#reminderMail").val(0);
                            }
                        });

                        <?php if($common->getLoggedUserRoleID() == 6) { ?>
                        var selectedButtonVal = window.parent.frame_browser.document.getElementById("current-seleted-button").value;
                        if (selectedButtonVal == '') {
                            $("#show-default").val(1);
                            //var showDefault = 1;
                        }
                        <?php } ?>
                        $(".disply_preview").live("change", function(e) {
                            var img_ct = $(this).attr("data-ct").trim();
                            var cur = $(this);
                            upload_photo(cur[0], img_ct);
                        });

                        $(".disply_preview_image").live("change", function(e) {
                            var cur = $(this);
                            upload_photo_pdf(cur[0], cur);
                        });

                        //$('input:text').setMask();
                        $("#dialer_callback").dialog({
                            autoOpen: false,
                            modal: true,
                            width: 420,
                            height: 300
                        });
                        autoSelectCamp();
                        GetUserHotList();
                        DiallerJobsHistory();
                        DiallerCallHistory();
                        showToalJobHistory();
                        var callResultId = $("#answer_reply").val();
                        if (callResultId == 1) {
                            $("#new_booking").addClass("current-selected-button");
                        }
                        $(window).load(function() {
                            var callcount = window.parent.frame_browser.document.getElementById("first_call").value;
                            var callUser = window.parent.frame_browser.document.getElementById("currentUserId").value;
                            var currentUser = $('#CustomerId').val();
                            var callmode = window.parent.frame_browser.document.getElementById("call_mode").value;
                            var currentTab = $(".tabOver").attr("id").trim();
                            if (1 == callcount && ("" == callmode || 3 == callmode) && (callUser != currentUser) && ('trigger7' == currentTab)) {
                                var initcall = setInterval(function() {
                                    var constatus = $("#ConnectionStatus").val();
                                    if (constatus == "CONNECTED") {
                                        //call_cell_phone();
                                        //call_phone();
                                        clearInterval(initcall);
                                    }
                                }, 500);
                            } else if (callcount == 1 && callmode == 2) {
                                var initcall = setInterval(function() {
                                    var constatus = $("#ConnectionStatus").val();
                                    if (constatus == "CONNECTED") {
                                        //call_cell_phone();
                                        //call_phone();
                                        clearInterval(initcall);
                                    }
                                }, 500);
                            }
                        });
                        $(window).load(function() {
                            var callMode = window.parent.frame_browser.document.getElementById("call_mode").value;
                            if (3 == callMode) {
                                $('.select-call-mode-button:eq(2)').addClass("current-call-mode-selected-button");
                            } else if (2 == callMode) {
                                $('.select-call-mode-button:eq(1)').addClass("current-call-mode-selected-button");
                            } else if (1 == callMode) {
                                $('.select-call-mode-button:eq(0)').addClass("current-call-mode-selected-button");
                            }
                        });
                        $(".call_icon").click(function() {
                            $(".call_icon").removeClass("call_current");
                            $(this).addClass("call_current");
                        });
                        $(".select-button").click(function() {
                            $(".select-button").removeClass("current-selected-button");
                            $(this).addClass("current-selected-button");
                        });
                        $(".select-call-mode-button").click(function() {
                            $(".select-call-mode-button").removeClass("current-call-mode-selected-button");
                            $(this).addClass("current-call-mode-selected-button");
                        });
                        last_jt = '<?=$this->data['
                        Order ']['
                        order_type_id ']?>';
                        ShowCallHistory();
                        showPayments();
                        ShowLastCallHistory();
                        <?php if ((!isset($_GET['order_id']))&&(!isset($_GET['job_truck']))) {?>
                        //OpenJobsHistory();
                        <?php }else{?>
                        TotalCalculation();
                        jt = $('#OrderOrderTypeId').val();
                        if ((jt == 9) || (jt == 10))
                            $("#PreviousSection").show();
                        else
                            $("#PreviousSection").hide();
                        //ChangeSupplier(document.getElementById("OrderAppOrderedSupplierId"));
                        <?php
	}
  if ($common->getLoggedUserRoleID() == 6||$_SESSION['user']['role_id'] == 13) {?>
                        $.get("<?=BASE_URL;?>/orders/getChangesHistory", {
                                order_id: '<?=$html->tagValue("Order/id")?>',
                                customer_id: $('#CustomerId').val()
                            },
                            function(data) {
                                $("#ChangesHistory").html(data);
                            });
                        <?php }?>
                        //
                        var test_server = "http://69.31.184.162:81/acesys/acesys/acesys-2.0/index.php/";
                        //var live_server = "http://69.31.184.162:81/acesys/index.php/";
                        var live_server = "/acesys/index.php";
                        var l = $(location).attr('href');
                        if (l.indexOf("acesys-2.0") != -1) G_URL = test_server;
                        else G_URL = live_server;
                        var G_URL = '/acesys/index.php/';
                        //tree view for the items
                        storeTreeInitialize();
                        $("#CustomerCity").change(function() {
                            var val = $(this).val().trim();
                            var streetNum = $("#CustomerAddressStreetNumber").val();
                            var streetName = $("#CustomerAddressStreet").val();
                            var cityId = $("#" + val).val();
                            // $.get("<?=BASE_URL;?>/orders/getCityPostal",
                            if (val != '') {
                                $.get("<?=BASE_URL;?>/orders/getPostalCode", {
                                        city: val,
                                        streetNum: streetNum,
                                        streetName: streetName
                                    },
                                    function(data) {
                                        res = data.trim();
                                        $("#CustomerPostalCode").val(res);
                                    });
                            }
                            $("#campaing-select option[data-camp-city='" + val + "']").attr("selected", true);
                        });

                        $('#closeBookedItems').hide();
                        $('#closeTechnicianSales').hide();
                        $('.loading_indicator').hide();
                        $('#addBookedItems').click(function() {
                            $('#addBookedItemsTree').click();
                        });
                        $('#addBookedItemsTree').click(function() {
                            var ROOT_URL = '/acesys/index.php/';
                            var url = ROOT_URL + "iv_items/storeTree?mode=0";
                            $('#addBookedItems').hide();
                            $('#book_loading').show();
                            $('#closeBookedItems').hide();
                            $('#closeTechnicianSales').click();
                            $.get(url, {},
                                function(data) {
                                    $('#book_loading').hide();
                                    $('#closeBookedItems').show();
                                    $('#item_selector0').show();
                                    $('#item_selector1').html('');
                                    $('#item_selector1').hide();
                                    $('#item_selector0').html(data);
                                    $('#tabs').tabs();
                                    $(".all_node").click();
                                });
                        });
                        $('#addBookedItemsList').click(function() {
                            var url = G_URL + "iv_items/storeList?mode=0";
                            $('#addBookedItems').hide();
                            $('#book_loading').show();
                            $('#closeBookedItems').hide();
                            $('#closeTechnicianSales').click();
                            $.get(url, {},
                                function(data) {
                                    $('#book_loading').hide();
                                    $('#closeBookedItems').show();
                                    $('#item_selector0').show();
                                    $('#item_selector1').html('');
                                    $('#item_selector1').hide();
                                    $('#item_selector0').html(data);
                                    $('#tabs').tabs();
                                    $(".all_node").click();
                                });
                        });
                        $('#closeBookedItems').click(function() {
                            $('#item_selector0').hide();
                            $('#item_selector0').html('');
                            $('#closeBookedItems').hide();
                            $('#addBookedItems').show();
                        });
                        $('#addTechnicianSales').click(function() {
                            $('#addTechnicianSalesTree').click();
                        });
                        $('#addTechnicianSalesTree').click(function() {
                            var url = G_URL + "iv_items/storeTree?mode=1";
                            $('#addTechnicianSales').hide();
                            $('#tech_loading').show();
                            $('#closeTechnicianSales').hide();
                            $('#closeBookedItems').click();
                            $.get(url, {},
                                function(data) {
                                    $('#tech_loading').hide();
                                    $('#closeTechnicianSales').show();
                                    $('#item_selector1').show();
                                    $('#item_selector0').html('');
                                    $('#item_selector0').hide();
                                    $('#item_selector1').html(data);
                                    $('#tabs').tabs();
                                    $(".all_node").click();
                                });
                        });
                        $('#addTechnicianSalesList').click(function() {
                            var url = G_URL + "iv_items/storeList?mode=1";
                            $('#addTechnicianSales').hide();
                            $('#tech_loading').show();
                            $('#closeTechnicianSales').hide();
                            $('#closeBookedItems').click();
                            $.get(url, {},
                                function(data) {
                                    $('#tech_loading').hide();
                                    $('#closeTechnicianSales').show();
                                    $('#item_selector1').show();
                                    $('#item_selector0').html('');
                                    $('#item_selector0').hide();
                                    $('#item_selector1').html(data);
                                    $('#tabs').tabs();
                                    $(".all_node").click();
                                });
                        });
                        $('#closeTechnicianSales').click(function() {
                            $('#item_selector1').hide();
                            $('#item_selector1').html('');
                            $('#closeTechnicianSales').hide();
                            $('#addTechnicianSales').show();
                        });
                        maintenancePackage();
                        initializeQuestions();
                        $(".answer_reply").live("click", function() {
                            var clr = $(this).attr("clr");
                            $("#answer_reply").val(clr);
                        });

                        $("#dnc_callback_btn").live("click", function() {
                            var clr = $(this).attr("str");
                            $("#answer_reply").val(clr);
                            SaveDialerCallRecord();
                        });

                        $("#dialer-call-result").live("change", function() {
                            var clr = $(this).val();
                            $("#answer_reply").val(clr);
                        });
                        $("#dns_reminder_btn").live("click", function() {
                            var oid = $(this).attr("oid");
                            $.ajax({
                                url: '<?=BASE_URL?>/orders/updateOrderReminderType',
                                type: 'POST',
                                dataType: 'json',
                                data: {
                                    oid: oid
                                },
                                success: function(data) {
                                    if (data.res == 1) {
                                        alert("DNS set for reminder.");
                                    }
                                }
                            });
                        });
                    });

                    function autoSelectCamp() {
                        var val = $("#CustomerCity").val().trim();
                        $("#campaing-select option[data-camp-city='" + val + "']").attr("selected", true);
                    }

                    function noInvoiceReviewLink(order_id) {
                        var email = $('#emailinput').val();
                        //if(email == "") {alert("Fill in email"); return false;}
                        $.ajax({
                            url: '<?=BASE_URL?>/orders/noInvoiceReviewLinks?order_id=' + order_id + '&email=' + email + '&type=office',
                            success: function(result) {
                                //$("#div1").html(result);
                            }
                        });
                        //window.open('<?=BASE_URL?>/orders/noInvoiceReviewLinks?order_id='+ order_id +'&email='+ email +'&type=office', '_new');
                        window.location.href = "<?=BASE_URL?>/orders/scheduleView";
                    }

                    function emailCallsInvoice(order_id) {
                        var email = $('#emailinput').val();
                        if (email == "") {
                            alert("Fill in email");
                            return false;
                        }
                        window.open('<?=BASE_URL?>/calls/invoiceemail?order_id=' + order_id + '&email=' + email, '_new');
                        history.go(-1);
                        alert("Email sent");
                    }

                    function showPlayer(order_id, agent_id, date, phone) {
                        var url = "<?=BASE_URL?>/messages/player";
                        url += "?order_id=" + order_id;
                        url += "&agent_id=" + agent_id;
                        url += "&phone=" + phone;
                        url += "&date=" + date;
                        var option = "width=450,height=300,left=300,top=200,status=off,scroll=off,resizable=off";
                        var answer = window.open(url, '', option);
                    }

                    function carryAnswers(customer_id) {}

                    function initializeQuestions() {
                        $(".responses").live("change", function() {
                            var question_id = $(this).prev(".question_id").val();
                            var response_id = $(this).val();
                            $(".q" + question_id).addClass("hide");
                            $(".q" + question_id).attr("disabled", "disabled");
                            $("#r" + response_id).removeClass("hide");
                            $("#r" + response_id).removeAttr("disabled", "disabled");
                        });
                        $(".suggestions").live("change", function() {
                            var response_id = $(this).prev(".response_id").val();
                            var suggestion_id = $(this).val();
                            $(".r" + response_id).addClass("hide");
                            $(".r" + response_id).attr("disabled", "disabled");
                            $("#s" + suggestion_id).removeClass("hide");
                            $("#s" + suggestion_id).removeAttr("disabled", "disabled");
                        });
                        //--------text response-----------
                        $(".text_response").live("change", function() {
                            var question_id = $(this).prev(".question_id").val();
                            var text_response = $(this).val();
                            var response_id = 0;
                            $(".q" + question_id).addClass("hide");
                            $(".q" + question_id).attr("disabled", "disabled");
                            $(this).next(".response_codes").children(".code").each(function() {
                                var id = $(this).children(".id").val();
                                var operation_id = $(this).children(".operation_id").val();
                                var which_id = $(this).children(".which_id").val();
                                var value;
                                if (which_id == 1) {
                                    value = $(this).children(".value").val();
                                } else if (which_id == 2) {
                                    var input = $(".rank" + $(this).children(".value").val());
                                    if (input.is("select")) value = input.find('option:selected').text();
                                    else value = input.val();
                                }
                                if (!isNaN(value)) value = parseInt(value);
                                switch (operation_id) {
                                    case '1':
                                        if (text_response == value) {
                                            response_id = id;
                                            return false;
                                        }
                                        break;
                                    case '2':
                                        if (text_response > value) {
                                            response_id = id;
                                            return false;
                                        }
                                        break;
                                    case '3':
                                        if (text_response >= value) {
                                            response_id = id;
                                            return false;
                                        }
                                        break;
                                    case '4':
                                        if (text_response < value) {
                                            response_id = id;
                                            return false;
                                        }
                                        break;
                                    case '5':
                                        if (text_response <= value) {
                                            response_id = id;
                                            return false;
                                        }
                                        break;
                                    case '6':
                                        if (text_response != value) {
                                            response_id = id;
                                            return false;
                                        }
                                        break;
                                }
                                response_id = 0;
                            });
                            $("#r" + response_id).removeClass("hide");
                            $("#r" + response_id).removeAttr("disabled", "disabled");
                        });
                    }

                    function CheckMailSent(OrderID) {
                        var mainOrderId = $('#mainOrderId').val();
                        var check_es = $('#OrderJobTruck').val();
                        var formData = '&Oid=' + OrderID;
                        $.ajax({
                            url: '<?=BASE_URL?>/orders/checkMailSend/?ordid=' + mainOrderId,
                            dataType: 'text',
                            cache: false,
                            contentType: false,
                            processData: false,
                            data: formData,
                            type: 'post',
                            success: function(data) {
                                var res = data.split("@@");
                                if (res[0] == 1 && check_es != 40) {
                                    $("#msgbx").html("You have already sent an email and text to this client on (" + res[1] + ") would like to send another email/text  with all changes?");
                                    showme();

                                    /*if (window.confirm("You have already sent an email to this client on ("+res[1]+") would like to send another email with all changes?")) {
                                    	$("#SendMailAgain").val(1);
                                      	return true;
                                    }else{
                                    	$("#SendMailAgain").val(0);
                                    	return false;
                                    }*/
                                } else {

                                    if (check_es == 40) {
                                        $("#SendMailAgain").val(0);
                                    } else {
                                        $("#msgbx").html("You have already sent an email and text to this client on (" + res[1] + ") would like to send another email/text  with all changes?");
                                        showme();
                                    }
                                    document.forms['editBookingform'].submit();

                                }
                            }
                        });
                    }


                    /* OPEN MODAL BOX */
                    // Get the modal
                    //var modal = document.getElementById('myModal');

                    // Get the button that opens the modal
                    //var btn = document.getElementById("myBtn");

                    // Get the <span> element that closes the modal
                    //var span = document.getElementsByClassName("close")[0];

                    // When the user clicks the button, open the modal
                    //btn.onclick = function() {
                    //    modal.style.display = "block";
                    //}

                    // When the user clicks on <span> (x), close the modal
                    //span.onclick = function() {
                    //    modal.style.display = "none";
                    //}

                    // When the user clicks anywhere outside of the modal, close it
                    //window.onclick = function(event) {
                    //    if (event.target == modal) {
                    //        modal.style.display = "none";
                    //    }
                    //}
                    function hideme() {
                        document.getElementById("resendEmail").checked = true;
                        document.getElementById("resendText").checked = true;
                        document.getElementById("resendEmailVal").value = 1;
                        document.getElementById("resendTextVal").value = 1;
                        document.getElementById("myModal").style.display = "none";
                    }

                    function showme(isMaxDistance = 0) {
                        if (isMaxDistance == 1) {
                            $("#is_max_distance").val(1);
                        }
                        document.getElementById("myModal").style.display = "block";
                    }

                    function showInvoiceMessage() {
                        document.getElementById("invoiceMessageModal").style.display = "block";
                    }

                    function showInvoice() {
                        document.getElementById("invoiceModal").style.display = "block";
                    }

                    function hideInvoice() {
                        document.getElementById("invoiceModal").style.display = "none";
                    }

                    function showInvoiceReview(hideModal = 0) {
                        $("#hide_modal").val(hideModal);
                        // document.getElementById("myModalNew").style.display = "block";
                        document.getElementById("reminderEmail").style.display = "block";
                    }

                    function showEstimateReminder(hideModal = 0) {
                        $('#isCallback').attr('checked', false);
                        document.getElementById("reminderEstimate").style.display = "block";
                    }

                    function hideInvoiceReview() {
                        // document.getElementById("myModalNew").style.display = "none";
                        document.getElementById("reminderEmail").style.display = "none";
                    }

                    function hideEstimateCallback() {
                        // document.getElementById("myModalNew").style.display = "none";
                        document.getElementById("reminderEstimate").style.display = "none";
                    }

                    function showMyModal() {
                        document.getElementById("myModalNew").style.display = "block";
                        // document.getElementById("reminderEmail").style.display = "block";
                    }

                    function hideMyModal() {
                        document.getElementById("myModalNew").style.display = "none";
                        // document.getElementById("reminderEmail").style.display = "none";
                    }

                    function hideInvoiceBox() {
                        document.getElementById("invoiceMessageModal").style.display = "none";
                        // document.getElementById("reminderEmail").style.display = "none";
                    }

                    function clickYes() {
                        //document.getElementById("conffinal").style.display = "block";
                        //document.getElementById("confbtn").style.display = "none";
                        $("#SendMailAgain").val(1);
                        document.forms['editBookingform'].submit();
                    }

                    function invoiceYes() {
                        $("#SendInvoiceAgain").val(1);
                        document.forms['editBookingform'].submit();
                    }

                    function invoiceNo() {
                        $("#SendInvoiceAgain").val(0);
                        document.forms['editBookingform'].submit();
                    }

                    function clickNo() {

                        var is_max_distance = $("#is_max_distance").val();
                        if (is_max_distance == 1) {
                            document.getElementById("myModal").style.display = "none";
                        } else {
                            document.getElementById("myModal").style.display = "none";
                            $("#SendMailAgain").val(0);
                            document.forms['editBookingform'].submit();
                        }
                    }

                    /*Loki: call the purch order button*/
                    function invoiceClickYes() {
                        // $("#orderInvoiceExist").val(1);
                        $(".addPurchaseItem").trigger("click");
                        // $( "#generate_purchase_order" ).trigger( "click" );
                        document.getElementById("invoiceModal").style.display = "none";
                    }

                    function invoiceClickNo() {
                        document.getElementById("invoiceModal").style.display = "none";
                    }
                    //function clickOk(){
                    //	document.forms['editBookingform'].submit();
                    //}

                    function verification_type(Order) {
                        var mainOrderId = $('#mainOrderId').val();
                        var card_type = $("input[type='radio'].radioBtnClass:checked").val();
                        if (card_type == 1) {
                            emailInvoice(mainOrderId, 1);

                            hideMyModal();
                        } else if (card_type == 2) {
                            emailInvoice(mainOrderId, 2);
                            hideMyModal();
                        } else if (card_type == 3) {
                            noInvoiceReviewLink(mainOrderId);
                            hideMyModal();
                        } else {
                            var date_order = $('#current_order_date').val();
                            var month = ["Jan", "Feb", "Mar", "Apr", "May", "Jun",
                                "jul", "Aug", "Sep", "Oct", "Nov", "Dec"
                            ];

                            var get_date = date_order.split('-');
                            var get_index = get_date[1] - 1;
                            var month_job = month[get_index];
                            var url_date = get_date[2] + "+" + month_job + "+" + get_date[0];
                            var job_date = $('#OrderJobDate').val();
                            $.ajax({
                                url: '<?=BASE_URL?>/Tableeditor/saveDonebytech',
                                data: {
                                    orderId: mainOrderId
                                },
                                dataType: 'json',
                                type: 'GET',
                                success: function(data) {
                                    window.location.href = "<?=BASE_URL?>/orders/scheduleView?ffromdate=" + job_date;
                                }
                            });
                        }
                    }

                    /********************Jack Hutson ***********/
                    $(document).ready(function() {
                        <?php if(isset($_POST['first_name'])) {?>
                        $('#CustomerFirstName').val("<?=$_POST['first_name'];?>");
                        <?php } ?>
                        <?php if(isset($_POST['last_name'])) {?>
                        $('#CustomerLastName').val("<?=$_POST['last_name'];?>");
                        <?php } ?>
                        <?php if(isset($_POST['email'])) {?>
                        $('#emailinput').val("<?=$_POST['email'];?>");
                        <?php } ?>
                        <?php if(isset($_POST['city'])) {?>
                        $('#CustomerCity option').each(function() {
                            if ($(this).val() == "<?=$_POST['city'];?>") $(this).attr('selected', true);
                        });
                        <?php } ?>
                        <?php if(isset($_POST['phone'])) {?>
                        $('#CustomerPhone').val("<?=$_POST['phone'];?>");
                        <?php } ?>
                        <?php if(isset($_POST['referred_by_name'])) {?>
                        $('#referred_by_name').val("<?=$_POST['referred_by_name'];?>");
                        $('#referred_by_existing_userid').val("<?=$_POST['referred_by_existing_userid'];?>");
                        <?php }else { ?>
                        $('#referred_by_name').hide();
                        <?php } ?>
                        <?php if(isset($_POST['ref_card_number'])) {?>
                        $('#ref_card_number').val("<?=$_POST['ref_card_number'];?>");
                        <?php } ?>
                        <?php if($estimate_page == 1) {?>
                        $("#OrderEstimatePage").attr("checked", true);
                        <?php }?>

                    });
            </script>
            <style>
                /*#sendSeparateEmail #emailVal_ifr body {
	display: block !important;
}*/
                
                #saleAmount {
                    width: 60px;
                }
                
                #creditCardCvv1 {
                    width: 60px;
                }
                
                .time_table {
                    width: 100%, text-align: center;
                }
                
                .input-box {
                    width: 200px;
                }
                
                #ajax_item_results_0 {
                    display: none;
                    border-collapse: collapse;
                    background: #FFFF99;
                    color: #000000;
                }
                
                #ajax_supplier_results {
                    border-collapse: collapse;
                    background: #FFFF99;
                    color: #000000;
                }
                
                #ajax_supplier_results td,
                #ajax_supplier_results th {
                    border: 1px solid #ddd;
                }
                
                #installation_item_table th {
                    text-align: left;
                }
                
                #installation_item_table td {
                    padding-top: 10px;
                }
                
                #ajax_item_results_1 {
                    display: none;
                    border-collapse: collapse;
                    background: #FFFF99;
                    color: #000000;
                }
                
                #ajax_item_results_0 td,
                #ajax_item_results_0 th {
                    border: 1px solid #ddd;
                    text-align: center;
                }
                
                #ajax_item_results_1 td,
                #ajax_item_results_1 th {
                    border: 1px solid #ddd;
                    text-align: center;
                }
                
                .receipt_btn {
                    position: absolute;
                    padding: 5px;
                    margin: 15px;
                }
                
                body {
                    display: block !important;
                }
                
                .hide_show_btn {
                    padding: 2px;
                    background: #6c757d;
                    color: white;
                    font-size: 13px;
                    margin-left: 10px !important;
                    font-weight: bold;
                    float: left;
                    margin-bottom: 5px;
                }
                
                .reminder-button {
                    width: 50px;
                    height: 25px;
                    float: right;
                    margin-top: 20px;
                    margin-right: 5px;
                }
                
                .reminder-message {
                    width: 100%;
                    height: 50%;
                    resize: none;
                    -webkit-box-sizing: border-box;
                    /* <=iOS4, <= Android  2.3 */
                    -moz-box-sizing: border-box;
                    /* FF1+ */
                    box-sizing: border-box;
                    /* Chrome, IE8, Opera, Safari 5.1*/
                }
                
                .ui-widget-content {
                    background: #ffffff !important;
                }
                
                #PaymentPaymentMethodId {
                    width: 155px;
                }
                
                .reminder-email-table {
                    width: 100%;
                    text-align: left;
                    font-weight: bolder;
                    height: 115px;
                }
                
                .reminder-email-table td {
                    padding-left: 25px;
                }
                
                .reminder-email-table tr {
                    padding-top: 10px;
                }
                /* The Modal (background) */
                
                .modal {
                    display: none;
                    /* Hidden by default */
                    position: fixed;
                    /* Stay in place */
                    z-index: 1;
                    /* Sit on top */
                    padding-top: 100px;
                    /* Location of the box */
                    left: 0;
                    top: 0;
                    width: 100%;
                    /* Full width */
                    height: 100%;
                    /* Full height */
                    overflow: auto;
                    /* Enable scroll if needed */
                    background-color: rgb(0, 0, 0);
                    /* Fallback color */
                    background-color: rgba(0, 0, 0, 0.4);
                    /* Black w/ opacity */
                }
                
                .reminder-modal {
                    display: none;
                    /* Hidden by default */
                    position: absolute;
                    /* Stay in place */
                    z-index: 1;
                    /* Sit on top */
                    padding-top: 100px;
                    /* Location of the box */
                    left: 0;
                    top: 0;
                    width: 100%;
                    /* Full width */
                    height: 100%;
                    /* Full height */
                    overflow: auto;
                    /* Enable scroll if needed */
                    background-color: rgb(0, 0, 0);
                    /* Fallback color */
                    background-color: rgba(0, 0, 0, 0.4);
                    /* Black w/ opacity */
                }
                /* Modal Content */
                
                .modal-content {
                    background-color: #fefefe;
                    margin: auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 30%;
                }
                /* Modal Content */
                
                .reminder-modal-content {
                    background-color: #fefefe;
                    /*margin: auto;*/
                    margin: 200px 200px 100px 200px;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 55%;
                    height: 40%;
                }
                
                .call_current {
                    background-color: #008000 !important;
                    border: 1px solid #008000 !important;
                }
                /* The Close Button */
                
                .close {
                    color: #aaaaaa;
                    float: right;
                    font-size: 28px;
                    font-weight: bold;
                }
                
                .close:hover,
                .close:focus {
                    color: #000;
                    text-decoration: none;
                    cursor: pointer;
                }
                
                #notes_table {
                    border: 1px solid #ffffff;
                    border-collapse: collapse;
                }
                
                #previous_notes td {
                    padding: 3px;
                }
                
                #previous_notes .odd_row {
                    background-color: #cccccc;
                }
                
                #OrderEstimator {
                    border: none;
                    background: none;
                }
                
                .urgency_td {
                    width: 20px;
                }
                
                .message_td {
                    width: 300px;
                }
                
                .hide {
                    display: none;
                }
                
                select {
                    width: auto;
                }
                
                input[type=text] {
                    width: 200px;
                }
                
                .btncls {
                    background-color: #CCC;
                    width: 60px;
                    height: 25px;
                    color: #000;
                    font-weight: bold;
                }
                
                p#confbtn {
                    padding: 5px;
                    vertical-align: middle;
                    text-align: center;
                }
                
                p#msgbx {
                    font-size: 14px;
                    padding: 5px;
                }
                
                .emlcls {
                    width: 50%;
                    background-color: #CCC;
                    padding: 20px;
                    font-size: 14px;
                }
                
                table.dialler-scroll tbody,
                table.dialler-scroll thead {
                    display: block;
                }
                
                table.dialler-scroll tbody {
                    height: 100px;
                    overflow-y: auto;
                    overflow-x: hidden;
                }
                
                table.dialler-scroll tr {
                    width: 100%;
                }
                
                .fa-phone {
                    font-size: 9px;
                    border-radius: 20%;
                    border: 1px solid black;
                    padding: 2px;
                    background-color: black;
                    color: white;
                    cursor: pointer;
                }
                
                #scw {
                    z-index: 9999;
                }
                
                .current-selected-button {
                    border: 2px solid black;
                }
                
                .current-call-mode-selected-button {
                    border: 2px solid rgb(165, 253, 93);
                    background: rgb(165, 253, 93);
                }
            </style>

            <?php
function get_data($url)
		{
		$ch = curl_init();
		$timeout = 5;
		curl_setopt($ch,CURLOPT_URL,$url);
		curl_setopt($ch,CURLOPT_RETURNTRANSFER,1);
		curl_setopt($ch,CURLOPT_CONNECTTIMEOUT,$timeout);
		$data = curl_exec($ch);
		curl_close($ch);
		return $data;
	}

?>

                <!-- Trigger/Open The Modal -->
                <!-- The Modal -->
                <div id="myModal" class="modal">
                    <!-- Modal content -->
                    <div class="modal-content">
                        <span class="close" onclick="hideme()">&times;</span>
                        <p id="msgbx"></p>
                        <p id="confbtn">
                            <b><span style="font-size: 12px">Email</span></b><input type="checkbox" checked name="resendEmail" id="resendEmail" value="1">
                            <b><span style="font-size: 12px">Text</span></b><input type="checkbox" checked name="resendText" id="resendText" value="1">
                            <input type="button" name="yes" value="Yes" onclick="clickYes()" class="btncls">
                            <input type="button" name="no" value="No" onclick="clickNo()" class="btncls">
                        </p>
                        <!--<p id="conffinal" style="display:none;">
    	<input type="button" name="ok" value="Ok" onclick="clickOk()" class="btncls">
    </p>-->
                    </div>
                </div>

                <div id="invoiceMessageModal" class="modal">
                    <!-- Modal content -->
                    <div class="modal-content">
                        <span class="close" onclick="hideInvoiceBox()">&times;</span>
                        <p id="msgbx1"></p>
                        <p id="confbtn">
                            <!--   <b><span style="font-size: 12px">Email</span></b><input type="checkbox" checked name="resendEmail" id="resendEmail" value="1">
        <b><span style="font-size: 12px">Text</span></b><input type="checkbox" checked name="resendText" id="resendText" value="1"> -->
                            <input type="button" name="yes" value="Yes" onclick="invoiceYes()" class="btncls">
                            <input type="button" name="no" value="No" onclick="invoiceNo()" class="btncls">
                        </p>
                        <!--<p id="conffinal" style="display:none;">
    	<input type="button" name="ok" value="Ok" onclick="clickOk()" class="btncls">
    </p>-->
                    </div>
                </div>

                <!-- Loki: show invoice exist message -->
                <div id="invoiceModal" class="modal">
                    <!-- Modal content -->
                    <div class="modal-content">
                        <span class="close" onclick="hideInvoice()">&times;</span>
                        <p id="invoiceMsgbx"></p>
                        <p id="confbtn">
                            <input type="button" name="yes" value="Yes" onclick="invoiceClickYes()" class="btncls">
                            <input type="button" name="no" value="No" onclick="invoiceClickNo()" class="btncls">
                        </p>
                        <!--<p id="conffinal" style="display:none;">
    	<input type="button" name="ok" value="Ok" onclick="clickOk()" class="btncls">
    </p>-->
                    </div>
                </div>
                <script>
                    function parse_query_string(query) {
                        var vars = query.split("&");
                        var query_string = {};
                        for (var i = 0; i < vars.length; i++) {
                            var pair = vars[i].split("=");
                            var key = decodeURIComponent(pair[0]);
                            var value = decodeURIComponent(pair[1]);
                            // If first entry with this name
                            if (typeof query_string[key] === "undefined") {
                                query_string[key] = decodeURIComponent(value);
                                // If second entry with this name
                            } else if (typeof query_string[key] === "string") {
                                var arr = [query_string[key], decodeURIComponent(value)];
                                query_string[key] = arr;
                                // If third or later entry with this name
                            } else {
                                query_string[key].push(decodeURIComponent(value));
                            }
                        }
                        return query_string;
                    }

                    var query = window.location.search.substring(1);
                    var qs = parse_query_string(query);


                    var get_preview = qs.get_preview;

                    if (get_preview == 1) {

                        var parent = document.getElementById("invoiceModal");
                        parent.style.display = "block";
                        var child = parent.querySelector('.modal-content');

                        parent.style.backgroundColor = "black";





                        child.innerHTML = "please wait generating preview";




                    }
                </script>
                <!-- #Loki Show reminder email popup  -->
                <div id="reminderEmail" class="reminder-modal">
                    <!-- <body> -->
                    <div class="reminder-modal-content">
                        <input type="hidden" id="reminder-type-val" name="reminderType">
                        <input type="hidden" id="hide_modal" name="hide_modal">
                        <h3>Reminder E-mail</h3>
                        <table class="reminder-email-table">
                            <tr>
                                <td>Reminder:
                                    <select id="reminder-months">
						<option value="11">11 Months</option>
					 	<option value="23">23 Months</option>
					  	<option value="6">6 Months</option>
					  	<option value="4">4 Months</option>
					  	<option value="1">Use Calender</option>
					</select>
                                </td>
                                <td>
                                    <span>Date:</span><input class="emboss" type="text" id="reminder-date" name="reminderDate" style="width: 85px; cursor: hand; cursor: pointer;" onclick="scwShow(this,event);" onkeydown="return false;" value="<?=$this->data['Order']['job_date']?>">

                                </td>
                                <td>
                                    <span>Do Not Contact:</span><input type="Checkbox" class="reminder-email-type" id="doNotSend" name="doNotSend" value="3">
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <span>Email:</span><input type="Checkbox" checked id="reminder-type-email" name="reminder-type-email">
                                    <input type="text" style="width: 50%;" id="reminder_email_id" name="reminder_email_id" value="<?=$this->data['Customer']['email']?>">
                                </td>
                                <td colspan="2" rowspan="3">
                                    <span>Note:</span><textarea class="reminder-message" id="reminder-message" name="message"></textarea>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <span>Text:</span><input type="Checkbox" checked id="reminder-type-sms" name="reminder-type-sms">
                                    <input type="text" id="reminder_text_num" name="reminder_text_num" value="<?=$this->data['Customer']['cell_phone']?>">
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <span>Callback:</span><input type="Checkbox" id="reminder-callback" name="reminder-callback">
                                    <input type="text" id="reminder_callback_num" name="reminder_callback_num" value="<?=$this->data['Customer']['cell_phone']?>">
                                </td>
                            </tr>
                        </table>
                        <input type="button" style="float: left;width: 100;" class="reminder-button" id="quick_reminder" name="Quick Reminder" value="Quick Reminder" onclick="createMessage();">
                        <input type="button" class="reminder-button" id="save-reminder-email" name="OK" value="OK">
                        <input type="button" class="reminder-button" name="cancel" value="Cancel" onclick="hideInvoiceReview();">
                    </div>
                    <!-- </body> -->
                </div>



                <!-- #Loki Show reminder sms popup  -->
                <div id="reminderSms" style="display: none">
                    <table>
                        <tr>
                            <td>
                                <!-- <input type="text" name="sms"> -->
                                <textarea id="messageVal" style="width: 300px;height: 100px;"></textarea>
                            </td>
                        </tr>
                    </table>
                    <input type="button" name="OK" value="Send" style="padding: 5px;margin-top: 5px;" onclick="SendSms()">
                    <input type="button" name="cancel" value="Cancel" onclick="hideSmsBox();" style="padding: 5px;margin-top: 5px;">
                </div>
                <div id="reviewText" style="display: none">

                    <textarea class="emailVal" id="emailVal1" style="width: 300px;height: 100px;"></textarea>
                    <input type="button" name="OK" value="Send" style="padding: 5px;margin-top: 5px;" onclick="SendReviewText()">
                    <input type="button" name="cancel" value="Cancel" onclick="hideReviewTextBox();" style="padding: 5px;margin-top: 5px;">
                </div>
                <div id="permitTemp" style="display: none">
                    <textarea class="emailVal" id="permitData" style="width: 300px;height: 100px;"></textarea>
                    <input type="button" name="OK" value="Send" style="padding: 5px;margin-top: 5px;" id="sendPermit">
                    <input type="button" name="cancel" value="Cancel" onclick="hidePermitBox();" style="padding: 5px;margin-top: 5px;">
                </div>
                <div id="sendImageBox" style="display: none">
                    <p>Do you want to show preview?</p>
                    <input type="button" name="Yes" value="Yes" style="padding: 1px;margin-top: 5px;" id="showMailPreview">
                    <input type="button" name="No" value="No" id="sendInstallImage" style="padding: 1px;margin-top: 5px;">
                </div>

                <div id="reviewEmail" style="display: none">

                    <textarea class="emailVal" id="reviewEmailVal1" style="width: 300px;height: 100px;"></textarea>
                    <input type="button" name="OK" value="Send" style="padding: 5px;margin-top: 5px;" onclick="sendReviewEmail()">
                    <input type="button" name="cancel" value="Cancel" onclick="hideReviewEmailBox();" style="padding: 5px;margin-top: 5px;">
                </div>
                <div id="sendSeparateEmail" style="display: none;">
                    <textarea class="emailVal" id="emailVal2" style="width: 500px;height: 300px;display: block;"></textarea>
                    <input type="button" name="OK" value="Send" style="padding: 5px;margin-top: 5px;" onclick="sendSeparateEmail()">
                    <input type="button" name="cancel" value="Cancel" onclick="hideEmailBox();" style="padding: 5px;margin-top: 5px;">
                </div>
                <div id="open_source_password" style="display: none;">
                    <input type="password" name="sourcePassword" id="sourcePassword">
                    <input type="button" name="OK" value="Submit" style="padding: 5px;margin-top: 5px;" onclick="checkSourcePassword()">
                    <input type="button" name="OK" value="Close" style="padding: 5px;margin-top: 5px;" onclick="closeSourcePassword()">
                    <!--         <input type="button"  name="cancel" value="Cancel" onclick="hidePasswordBox();" style="padding: 5px;margin-top: 5px;">
 --></div>
                <div id="cc_pass_box" style="display: none;">
                    <input type="password" name="ccPassword" id="ccPassword">
                    <input type="button" name="OK" value="Submit" style="padding: 5px;margin-top: 5px;" onclick="checkCCPassword()">
                </div>
                <div id="new_cc_pass_box" style="display: none;">
                    <input type="password" name="newccPassword" id="newccPassword">
                    <input type="button" name="OK" value="Submit" style="padding: 5px;margin-top: 5px;" onclick="newCheckCCPassword()">
                </div>

                <div id="user_message_box" style="display: none;"></div>
                <div id="job_timing_box" style="display: none;"></div>
                <!-- The Modal -->
                <div id="myModalNew" class="modal">
                    <!-- Modal content -->
                    <div class="modal-content">
                        <span class="close" onclick="hideMyModal()">&times;</span>
                        <p id="msgbx"></p>
                        <p id="confbtn">
                            <table>
                                <tr>
                                    <td class="special_section ">
                                        <input type="radio" id="emailinvoice" class="radioBtnClass" name="donetechby" value="1" checked="checked"> Email Invoice
                                    </td>
                                </tr>
                                <!-- <tr>
				<td class="special_section ">
					<input type="radio" id="emailInterviews" class="radioBtnClass" name="donetechby" value="2">
					Email Invoice/Review links
				</td>
			</tr> -->
                                <!-- <tr>
				<td class="special_section ">
					<input type="radio" id="emailNoInterviews" class="radioBtnClass" name="donetechby" value="3">
					Don't Send Invoice
				</td>
			</tr> -->
                                <tr>
                                    <td class="special_section">
                                        <input type="button" onclick="verification_type(<?=$this->data[" Order "]["id "]?>);" name="orderbytech" value="Save">
                                        <input type="hidden" id="current_order_date" value="<?=$this->data[" Order "]["booking_date "]?>">
                                        <input type="button" onClick="hideMyModal()" name="orderbytech" value="Back">
                                    </td>
                                </tr>
                            </table>
                        </p>

                    </div>
                </div>

                <?php //echo phpinfo();
$id=$this->data['Order']['id'];
$customer_id=$this->data['Customer']['id'];
$booking_id=$_REQUEST['booking_id'];
if(isset($_REQUEST['from_booking'])){
	 $action = BASE_URL."/orders/editBooking?order_id=$id&customer_id=$customer_id&from_booking=1&booking_id=$booking_id";
}
else {
	$action = BASE_URL."/orders/editBooking?order_id=$id&customer_id=$customer_id";
}
 ?>

                <form name="editBookingform" id="editBookingform_new" action="<?= $action ?>" method="post" enctype="multipart/form-data">
                    <!-- This tag creates our form tag -->
                    <!-- Set booking from campaing value -->
                    <input type="hidden" id="mainOrderId" value="<?= $this->data['Order']['id']; ?>">
                    <input type="hidden" id="fromFollowup" name="followup_val" value="0">
                    <input type="hidden" id="is_source1_val" name="is_source1_val" value="<?=$isSourceVal?>">
                    <input type="hidden" id="is_max_distance" name="is_max_distance" value="0">
                    <input type="hidden" id="resendEmailVal" name="data[Order][resendEmailVal]" value="1">
                    <input type="hidden" id="resendTextVal" name="data[Order][resendTextVal]" value="1">
                    <input type="hidden" name="currentUrl" id="currentUrl" value="<?=$currentUrl?>">
                    <input type="hidden" name="showDefault" id="show-default" value="">
                    <input type="hidden" name="campaingId" id="CuscampaingId" value="<?= $campaingId ?>">
                    <input type="hidden" name="send_cancalled_email" id="send_cancalled_email" value="0">
                    <input type="hidden" name="from_tech" id="from_tech" value="<?= $from_tech?>">
                    <input type="hidden" name="oldOrderId" id="oldOrderId" value="<?= $oldOrderId?>">
                    <input type="hidden" name="oldOrderType" id="oldOrderType" value="<?= $oldOrderType?>">
                    <input type="hidden" name="techOrderId" id="techOrderId" value="<?= $techOrderId?>">
                    <input type="hidden" name="recordingName" id="recordingName" value="" />
                    <input type="hidden" name="havetoprint" id="havetoprint" value="0" />
                    <input type="hidden" id="NumberOfItems" value="<?=$num_items;?>">
                    <input type="hidden" name="data[Order][order_status_id]" id="OrderOrderStatusId" value="<?php echo $this->data['Order']['order_status_id'];?>" />
                    <input type="hidden" name="sendestimate" id="sendestimate" value="0" />
                    <input type="hidden" name="preViewEstimate" id="preViewEstimate" value="0" />
                    <input type="hidden" name="sendMailOnEstimate" id="sendMailOnEstimate" value="1" />
                    <input type="hidden" name="onetime_box_id" id="onetime_box_id" />
                    <input type="hidden" name="is_order_id" id="is_order_id" value="<?= $is_order_id; ?>" />
                    <input type="hidden" name="installation_open" id="installation_open" value="0" />
                    <input type="hidden" name="orderInvoiceExist" id="orderInvoiceExist" value="0" />
                    <input type="hidden" name="orderInvoiceExist" id="removeItemList" value="" />
                    <input type="hidden" name="showPreview" id="showPreview" value="<?=$showPreview ?>" />
                    <input type="hidden" name="orderTypeId" id="orderTypeId" value="<?=$orderTypeId ?>" />
                    <input type="hidden" name="partRequest" id="partRequest" value="<?=$partRequest ?>" />
                    <input type="hidden" name="SendInvoiceAgain" id="SendInvoiceAgain" value="0" />
                    <input type="hidden" name="data[Order][show_card]" id="OrderShowCard" value="<?php echo $this->data['Order']['showCard'];?>" />
                    <input type="hidden" name="invoiceAnsVal" id="invoiceAnsVal" value="0">
                    <input type="hidden" name="reviewAnsVal" id="reviewAnsVal" value="0">
                    <input type="hidden" name="stickerAnsVal" id="stickerAnsVal" value="0">

                    <?php if(!isset($this->data["Order"]["id"]) && $this->data["Order"]["id"]==""){?>
                    <input type="hidden" id="SendMailAgain" name="SendMailAgain" value="1">
                    <?php }else{ ?>
                    <input type="hidden" id="SendMailAgain" name="SendMailAgain">
                    <?php }?>

                    <table id="MainTable" style="width:100%; height:90%;">
                        <tr>
                            <td colspan=3>
                                <div>
                                    <?php if($_SESSION['user']['role_id'] == 1 && $estimate_page == 1) {?>
                                    <div class="tabtrigger <?=$tab1?>" id="trigger1" onclick="openTab(1);">Booking Info</div>
                                    <div class="tabtrigger <?=$tab13?>" id="trigger13" onclick="openTab(13);">Image</div>
                                    <?php } else {?>
                                    <div class="tabtrigger <?=$tab1?>" id="trigger1" onclick="openTab(1);">Booking Info</div>
                                    <?php if ($_SESSION['user']['role_id'] == 6||$_SESSION['user']['role_id'] == 3) {?>
                                    <div class="tabtrigger <?=$tab10?>" id="trigger10" onclick="openTab(10);">Recordings</div>
                                    <?php }?>
                                    <div class="tabtrigger <?=$tab3?>" id="trigger3" onclick="openTab(3);">Calls History</div>
                                    <?php if ($_SESSION['user']['role_id'] == 6||$_SESSION['user']['role_id'] == 3) {?>
                                    <div class="tabtrigger <?=$tab7?>" id="trigger7" onclick="openTab(7);">Dialer</div>
                                    <?php }?>
                                    <?php if ($_SESSION['user']['role_id'] == 6||$_SESSION['user']['role_id'] == 3) {?>
                                    <div class="tabtrigger <?=$tab11?>" id="trigger11" onclick="openTab(11);">Email History</div>
                                    <?php }?>
                                    <?php if (!isset($_GET['hotlist'])) {?>
                                    <!--<div class="tabtrigger" id="trigger4" onclick="openTab(4);">Feedback</div>-->
                                    <?php if ($_SESSION['user']['role_id'] == 6||$_SESSION['user']['role_id'] == 13) {?>
                                    <!--<div class="tabtrigger" id="trigger8" onclick="openTab(8);">Financing</div>-->
                                    <div class="tabtrigger tabOff" id="trigger5" onclick="openTab(5);">Changes</div>
                                    <?php }?>
                                    <div class="tabtrigger tabOff" id="trigger6" onclick="createMessage();">Remind</div>
                                    <?php }?>
                                    <div class="tabtrigger tabOff" id="trigger6" onclick="showFeedback();">FeedBack</div>
                                    <?php if ($_SESSION['user']['role_id'] == 6||$_SESSION['user']['role_id'] == 3) {?>
                                    <div class="tabtrigger <?=$tab13?>" id="trigger13" onclick="openTab(13);">Image/Permit</div>

                                    <div class="tabtrigger <?=$tab15?>" id="trigger15" onclick="openTab(15);">Follow-Up</div>
                                    <?php
    	$get_url=(parse_url($_SERVER['REQUEST_URI']));
		$url12="scheduleView/?".$get_url['query'];
     if($_REQUEST['from_calender']==1 && ($common->getLoggedUserRoleID()!=3) && $common->getLoggedUserRoleID()!=9  ){ ?>
                                        <div style="width:150px;" class="tabtrigger"><a href="<?php echo $url12 ?>">Back To Schedule</a></div>
                                        <?php } ?>
                                        <!-- <div class="tabtrigger <?=$tab16?>" id="trigger16" onclick="openTab(16);">Payment</div> -->
                                        <?php }?>
                                        <?php }?>
                                </div>
                            </td>
                        </tr>
                        <tr style="border-left: 2px solid #F5F5F5;border-right: 2px solid #A7A6AA;border-bottom: 2px solid #A7A6AA;background: #EBE9ED;">
                            <td style="width:260px;text-align:left;vertical-align:top">
                                <!-- <input type="button" value="Change customer" onclick="showClients()"/> -->

                                <div class="frame-wrap">
                                    <div class="frame-header-left"></div>
                                    <div class="frame-header-title">Customer's information</div>
                                    <div class="frame-header-right"></div>
                                    <div><b>Address: </b><a href="<?=$HtmlAssist->getOrderGoogleMap($this->data['Customer'])?>" target="_blank"><img src="<?=ROOT_URL?>/app/webroot/img/icon-vsm-globe.png" style="border: 0px; width: 15px; height: 15px; vertical-align: middle;"></a></div>
                                    <div class="frame-body" style="clear: both;">
                                        <input type="hidden" name="data[Order][address_id]" id="address_id" value="<?= $this->data['Order']['address_id']?>">
                                        <?php echo $html->hidden('Customer/id')?>
                                        <table>
                                            <!--  <tr>
                    <td align="right"><b>Address:</b></td>
                    <td><a href="<?=$HtmlAssist->getOrderGoogleMap($this->data['Customer'])?>" target="_blank"><img src="<?=ROOT_URL?>/app/webroot/img/icon-vsm-globe.png" style="border: 0px; width: 15px; height: 15px; vertical-align: middle;"></a>
                    </td>
                </tr> -->
                                            <tr>
                                                <td align="right">Cell Phone*:</td>
                                                <td>
                                                    <?php
																					if(isset($_REQUEST['phone']) && (!isset($_REQUEST['customer_id']) || $_REQUEST['customer_id']=="" )){  ?>
                                                        <?php echo $html->input('Customer/cell_phone',array("value"=>$_REQUEST['phone'], 'style' => 'width: 140px;', 'num_type' => '1')); ?><br/>

                                                        <?php		}
																					else { ?>
                                                            <?php echo $html->input('Customer/cell_phone',array("value"=>$common->displayPhone($html->tagValue('Customer/cell_phone')), 'style' => 'width: 140px;', 'num_type' => '1')); ?><br/>
                                                            <?php		}
																					?>
                                                                <span class="fa fa-phone call_icon" onclick="call_cell_phone();" aria-hidden="true"></span>
                                                                <span class="fa fa-comments" style="font-size: 17px; color:green;" onclick="showSmsBox();" aria-hidden="true"></span>
                                                                <?php echo $html->tagErrorMsg('Customer/cell_phone','Please enter in a cell phone for this customer.'); ?>
                                                                <span class="fa fa-commenting-o openReviewBox" style='font-size:17px' aria-hidden="true" title="Review Text" onclick="showReviewTextBox();"></span>
                                                </td>

                                            </tr>
                                            <tr>
                                                <td></td>
                                                <td>
                                                    <!-- <a href="javascript:void(0)" id="dial2" class="green" onclick=call('dial2','hangup2')>Dial</a>  -->
                                                    <a href="javascript:void(0)" id="hangup2" class="red" onclick="hangup('dial2','hangup2')">Hang Up</a></td>
                                            </tr>
                                            <tr>
                                                <td align="right">Home Phone:</td>
                                                <td>
                                                    <?php echo $html->input('Customer/phone',array("value"=>$common->displayPhone($html->tagValue('Customer/phone')), 'style' => 'width: 145px;', 'num_type' => '2')); ?><br>
                                                    <span class="fa fa-phone call_icon" onclick="call_phone();" aria-hidden="true"></span>
                                                    <?php echo $html->tagErrorMsg('Order/CustomerPhone','Please enter in a phone for this customer.') ?>
                                                    <!-- <span class="fa fa-envelope openMailBox" style="font-size: 15px; color:#3c8dbc;" aria-hidden="true"></span> -->
                                                    <span class='fa fa-envelope-open-o openReviewMailBox' style='font-size:15px' aria-hidden="true" title="Review Email"></span>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td></td>
                                                <td>
                                                    <!-- <a href="javascript:void(0)" id="dial" class="green" onclick=call('dial','hangup')>Dial</a> -->
                                                    <a href="javascript:void(0)" id="hangup" class="red" onclick="hangup('dial','hangup')">Hang Up</a></td>
                                            </tr>
                                            <tr>
                                                <td align="right">First Name:</td>
                                                <td>
                                                    <?php
					if(isset($_REQUEST['first_name']) && (!isset($_REQUEST['customer_id']) || $_REQUEST['customer_id']=="" )){  ?>
                                                        <?php echo $html->input('Customer/first_name', array("value"=>$_REQUEST['first_name'],'style' => 'width: 140px;')); ?>
                                                        <?php	} else { ?>
                                                            <?php echo $html->input('Customer/first_name', array('style' => 'width: 140px;')); ?>

                                                            <?php	} ?>
                                                                <?php echo $html->tagErrorMsg('Customer/first_name','Please enter in a first name for this customer.') ?>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td align="right">Last Name:</td>
                                                <td>
                                                    <?php
																					if(isset($_REQUEST['last_name']) && (!isset($_REQUEST['customer_id']) || $_REQUEST['customer_id']=="" )){  ?>
                                                        <?php echo $html->input('Customer/last_name', array("value"=>$_REQUEST['last_name'],'style' => 'width: 140px;')); ?>
                                                        <?php	} else { ?>
                                                            <?php echo $html->input('Customer/last_name', array('style' => 'width: 140px;')); ?>

                                                            <?php	} ?>

                                                                <?php echo $html->tagErrorMsg('Customer/last_name','Please enter in a last name for this customer.') ?>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td align="right">E-Mail:</td>
                                                <td>

                                                    <?php
																					if(isset($_REQUEST['email']) && (!isset($_REQUEST['customer_id']) || $_REQUEST['customer_id']=="" )){  ?>
                                                        <?php echo $html->input('Customer/email', array("value"=>$_REQUEST['email'],"onchange"=>"if (this.value != '') document.getElementById('maillink').innerHTML='<a href=\"#\" onclick=\"newWindow(\\'./sendMail?email='+this.value+'\\',\\'\\',480,350,\\'resize=no\\');\">E-Mail Customer</a>';", "id"=>"emailinput", 'style' => 'width: 140px;')); ?>

                                                        <?php	} else { ?>
                                                            <?php echo $html->input('Customer/email', array("onchange"=>"if (this.value != '') document.getElementById('maillink').innerHTML='<a href=\"#\" onclick=\"newWindow(\\'./sendMail?email='+this.value+'\\',\\'\\',480,350,\\'resize=no\\');\">E-Mail Customer</a>';", "id"=>"emailinput", 'style' => 'width: 140px;')); ?>


                                                            <?php	} ?>

                                                                <!-- l-comment -->
                                                                <!--  <span class="fa fa-envelope openMailBox" style="font-size: 15px; color:#3c8dbc;" aria-hidden="true"></span> -->
                                                                <?php echo $html->tagErrorMsg('Order/CustomerEmail1','Please enter in an email for this customer.') ?>
                                                                <?php echo $html->tagErrorMsg('Order/CustomerEmail2','Please enter in a valid email for this customer.') ?>
                                                </td>
                                            </tr>

                                            <tr>
                                                <td align="right">Apt Number:</td>
                                                <td>
                                                    <?php echo $html->input('Customer/address_unit', array('style' => 'width: 75px;')); ?>

                                                </td>
                                            </tr>
                                            <tr>
                                                <td align="right">Buzz:</td>
                                                <td>
                                                    <?php echo $html->input('Customer/buzz', array('style' => 'width: 50px;')); ?>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td></td>
                                                <td>
                                                    <input type="button" name="add_new_address" value="New" id="add_new_address" style="padding: 2px;width: 25%;">
                                                </td>
                                            </tr>
                                            <tr>
                                                <td align="right">Street number:</td>
                                                <td>
                                                    <?php
										if(isset($_REQUEST['street']) && (!isset($_REQUEST['customer_id']) || $_REQUEST['customer_id']=="" )){ ?>
                                                        <?php echo $html->input('Customer/address_street_number',array("value"=>$_REQUEST['street'],'style' => 'width: 140px;')); ?>
                                                        <?php 	}
										else { ?>
                                                        <?php echo $html->input('Customer/address_street_number',array('style' => 'width: 120px;')); ?>
                                                        <?php	}

										?>

                                                            <?php //echo $html->input('Customer/address_street_number', array('style' => 'width: 120px;')); ?>

                                                </td>
                                            </tr>
                                            <tr>
                                                <td align="right">Street Name:</td>
                                                <td>
                                                    <?php
										if(isset($_REQUEST['route']) && (!isset($_REQUEST['customer_id']) || $_REQUEST['customer_id']=="" )){ ?>
                                                        <?php echo $html->input('Customer/address_street',array("value"=>$_REQUEST['route'],'style' => 'width: 140px;')); ?>
                                                        <?php 	}
										else { ?>
                                                        <?php echo $html->input('Customer/address_street',array('style' => 'width: 120px;')); ?>
                                                        <?php	}

										?>
                                                            <?php //echo $html->input('Customer/address_street', array('style' => 'width: 120px;')); ?>

                                                </td>
                                            </tr>
                                            <tr>
                                                <td align="right">City:</td>
                                                <td>
                                                    <?php
							if(isset($_REQUEST['city']) && (!isset($_REQUEST['customer_id']) || $_REQUEST['customer_id']=="" )){
							echo $html->selectTag('Customer/city', $allCities, $_REQUEST['city']);


							}
							else {
								echo $html->selectTag('Customer/city', $allCities, $this->data['Customer']['city']);

							}
							?>

                                                        <?php foreach($cities_with_id as $key => $cid) { ?>
                                                        <input type="hidden" id="<?php echo $cid['name'] ?>" value="<?php echo $key ?>" />
                                                        <?php } ?>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td align="right">Postal Code:</td>
                                                <td>
                                                    <!-- <?php echo $html->input('Customer/postal_code',array("value"=>"11", 'style' => 'width: 140px;')); ?> -->
                                                    <?php
										if(isset($_REQUEST['postal_code']) && (!isset($_REQUEST['customer_id']) || $_REQUEST['customer_id']=="" )){ ?>
                                                        <?php echo $html->input('Customer/postal_code',array("value"=>$_REQUEST['postal_code'],'style' => 'width: 140px;')); ?>
                                                        <?php 	}
										else { ?>
                                                        <?php echo $html->input('Customer/postal_code',array('style' => 'width: 140px;')); ?>
                                                        <?php	}

										?>

                                                            <?php echo $html->tagErrorMsg('Customer/postal_code','Please enter in a postal code for this customer.') ?>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td align="right">Business Phone:</td>
                                                <td>
                                                    <?php echo $html->input('Customer/business_phone',array("value"=>$common->displayPhone($html->tagValue('Customer/business_phone')), 'style' => 'width: 140px;')); ?>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td align="right">Member Card:</td>
                                                <td>
                                                    <?php echo $html->input('Customer/card_number', array('style' => 'width: 140px;')); ?>
                                                </td>
                                            </tr>
                                            <?php if($_SESSION['user']['role_id'] != 1 || $estimate_page != 1) {?>
                                            <tr>
                                                <td align="right">Exp. Date:</td>
                                                <td>
                                                    <?php
						if ($this->data["Customer"]["card_exp"]=='0000-00-00')
							$this->data["Customer"]["card_exp"]='';
						if (!empty($this->data["Customer"]["card_exp"]))
							$this->data["Customer"]["card_exp"]=date( 'd M Y', strtotime($this->data["Customer"]["card_exp"]) );
					?>
                                                        <input type="text" id="data[Customer][card_exp]" name="data[Customer][card_exp]" class="emboss" style="width: 85px; cursor: hand; cursor: pointer;" readonly="1" onclick="scwShow(this,event);" onkeydown="return false;" value="<?=$this->data[" Customer
                                                            "]["card_exp "]?>">
                                                </td>
                                            </tr>
                                            <tr>
                                                <td align="right">Next Service:</td>
                                                <td>
                                                    <?php
						if ($this->data["Customer"]["next_service"]=='0000-00-00')
							$this->data["Customer"]["next_service"]='';
						if (!empty($this->data["Customer"]["next_service"]))
							$this->data["Customer"]["next_service"]=date( 'd M Y', strtotime($this->data["Customer"]["next_service"]) );
					?>
                                                        <input type="text" id="data[Customer][next_service]" name="data[Customer][next_service]" class="emboss" style="width: 85px; cursor: hand; cursor: pointer;" readonly="1" onclick="scwShow(this,event);" onkeydown="return false;" value="<?=$this->data[" Customer
                                                            "]["next_service "]?>">
                                                </td>
                                            </tr>
                                            <?php }?>
                                            <tr>
                                                <td align="right">Text/Email Reminder:</td>
                                                <td>
                                                    <?php
                        if ($this->data["Order"]["reminder_date"]=='0000-00-00')
                            $this->data["Order"]["reminder_date"]='';
                        if (!empty($this->data["Order"]["reminder_date"]))
                            $this->data["Order"]["reminder_date"]=date( 'd M Y', strtotime($this->data["Order"]["reminder_date"]) );
                    ?>
                                                        <input type="text" id="data[Order][reminder_date]" name="data[Order][reminder_date]" class="emboss" style="width: 85px; cursor: hand; cursor: pointer;" readonly="1" onclick="scwShow(this,event);" onkeydown="return false;" value="<?=$this->data[" Order
                                                            "]["reminder_date "]?>">
                                                        <input type="button" id="dns_reminder_btn" name="Save" value="DNS" oid="<?=$this->data[" Order "]["id "]?>">
                                                </td>
                                            </tr>
                                            <tr>
                                                <td align="right">CallBack:</td>
                                                <td>
                                                    <?php
                        if($cusCallbackDate['call_result_id'] == 3){
                            $callbackRes = 'Do Not Call'; ?>
                                                        <input type="text" id="data[Order][callback]" name="data[Order][callback]" style="width: 85px; cursor: hand; cursor: pointer;color:red;" readonly="1" value="<?=$callbackRes?>">
                                                        <?php }


                        else {

                            if ($cusCallbackDate['callback_date'] == '0000-00-00')
                                $callbackRes='';
                            if (!empty($cusCallbackDate['callback_date']))
                                $callbackRes = date('d M Y', strtotime($cusCallbackDate['callback_date'])); ?>
                                                        <input type="text" id="data[Order][callback]" name="data[Order][callback]" class="emboss" style="width: 85px; cursor: hand; cursor: pointer;" readonly="1" onclick="scwShow(this,event);" onkeydown="return false;" value="<?=$callbackRes?>">
                                                        <?php }  ?>


                                                        <input type="button" id="callback_user_btn" name="Save" value="Set" style="" onclick="showCallBack(0);">
                                                        <input type="button" id="dnc_callback_btn" name="Save" value="DNC" str="3">
                                                </td>
                                            </tr>
                                            <tr>
                                                <td align="center" colspan="2">
                                                    <div id="maillink"></div>
                                                    <script language="JavaScript">
                                                        document.getElementById('emailinput').onchange();
                                                    </script>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style="color:#065AB0">Common notes:</td>
                                                <td colspan=2 style="text-align:right"><span style="color:#065AB0;cursor:pointer" onclick="showEditUserInfo()">Edit</span>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td colspan=2>
                                                    <table class="historytable" width="100%" id="note_table" name="note_table">
                                                        <tr style="display:none" style="background: #9EE871;height:15px;">
                                                            <th>Date</th>
                                                            <th>Created By</th>
                                                        </tr>
                                                        <tr style="display:none" style="background: #9EE871;height:15px;">
                                                            <th colspan=2>Note</th>
                                                        </tr>
                                                        <tr>
                                                            <td colspan="2" style="background: black; height: 2px;"></td>
                                                        </tr>
                                                        <?
							$counter = 0;
							foreach ($customer_notes as $c_note)
							{
								$counter++;
								echo '<tr style="background-color:#F8F7F9;" height="20">';
								echo "<td><b>".date('d-M-y H:i:s', strtotime($c_note['note_date']))."</b></td>";
								echo "<td><b>".$c_note['created_by']."</b></td></tr>";
								echo "<tr style='color:#0000b0;'><td colspan=2>".htmlspecialchars($c_note['note'])."</td>";
								echo '</tr>';
								echo "<tr><td colspan='2' style=\"background: #AAAAAA; height: 2px;\"></td></tr>";
							}
						?>
                                                    </table>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td colspan=2>
                                                    <!--	Common note: <br/>-->
                                                    <?php echo $html->textarea('txt_customer_note', array('rows' => 3, 'cols' => 35)); ?>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td colspan=2>
                                                    <table>
                                                        <tr>
                                                            <?php if(!empty($this->data['Order']['id'])){?>
                                                            <td>
                                                                <input type="button" value="Add Note" style="border-color: #72BF44 #72BF44 #72BF44 #72BF44;" onclick="javascript:AddCustomerNote();" />
                                                            </td>
                                                            <?php } else {?>
                                                            <td></td>
                                                            <?php } ?>
                                                        </tr>
                                                    </table>
                                                </td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                                <div>Addresses:</div> <br/>
                                <?php foreach ($allAddresses as $key => $value) {?>
                                <div>

                                    <table class="customerAddresses" address-id="<?=$value['id'];?>" style="background: <?php echo ($value['id'] == $this->data['Order']['address_id'] ? '#00ff00' : '#989696')?>">
                                        <tr>
                                            <td>Unit:</td>
                                            <td class="address_unit">
                                                <?= $value['address_unit']?>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>Street number:</td>
                                            <td class="address_street_number">
                                                <?= $value['address_street_number']?>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>Street:</td>
                                            <td class="address_street">
                                                <?= $value['address_street']?>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>City:</td>
                                            <td class="city">
                                                <?= $value['city']?>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>Postal Code:</td>
                                            <td class="postal_code">
                                                <?= $value['postal_code']?>
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                                <?php } ?>
                            </td>
                            <td style="text-align:left;vertical-align:top">
                                <table id="tabA1" style="display:<?=$page1?>">
                                    <tr>
                                        <td>
                                            <?php if($_SESSION['user']['role_id'] != 1 || $estimate_page != 1) {?>
                                            <table cellspacing=0 cellpadding=0>
                                                <tr>
                                                    <td class="special_section" id="show-new-booking" onclick="location.href='./editBooking?customer_id=<?=$this->data['Customer']['id']?>&order_id=0';">
                                                        <u style="color:blue">New booking</u>
                                                    </td>
                                                    <td class="special_section" id="OpenHistoryText">
                                                        <a href="<?php echo BASE_URL ?>/orders/editBooking?customer_id=<?=$this->data['Customer']['id']?>&job_truck=&job_time_beg=&job_date=<?php echo urlencode(date('d M Y'));?>&job_technician1_id=0&job_technician2_id=0&from_tech_page=1&show_preview=1&estimate=1"
                                                            style="color:blue">New Estimate</a>
                                                        <img id="JobHistoryWorking" style="display:none" src="<?=ROOT_URL?>/app/webroot/img/wait30trans.gif" />
                                                    </td>
                                                    <td class="special_section" id="OpenHistoryText" onclick="OpenJobsHistory()">
                                                        <u style="color:blue">Show history</u>
                                                        <img id="JobHistoryWorking" style="display:none" src="<?=ROOT_URL?>/app/webroot/img/wait30trans.gif" />
                                                    </td>
                                                    <td class="special_section" id="CloseHistoryText" onclick="CloseJobsHistory()" style="display:none">
                                                        <u style="color:blue">Hide history</u>
                                                    </td>

                                                    <td class="special_section" onclick="CheckWithSchedule()">
                                                        <u style="color:blue;cursor:pointer">Show Schedule</u>
                                                    </td>
                                                    <td class="special_section" onclick="CheckWithTimeslot()">
                                                        <u style="color:blue;cursor:pointer">Timeslots</u>
                                                    </td>

                                                    <style>
                                                        a.print {
                                                            color: #00F;
                                                            text-decoration: none;
                                                            background-color: #FFF;
                                                            border: 1px solid #69F;
                                                            display: inline-block;
                                                            border-radius: 2px;
                                                            padding: 2px;
                                                        }
                                                    </style>
                                                    <td class="special_section" style="cursor:auto;">
                                                        <img src="<?=ROOT_URL?>/app/webroot/img/icon-vsm-printer.png" style="vertical-align:middle; float:left; margin-right:3px;" /> Print
                                                        <select name="print_r" id="print_r" onchange="invoiceprint(<?=$this->data[" Order "]["id "]?>);">
                    	<option></option>
                    	<option value="invoiceprint">Complete</option>
                    	<option value="invoiceprintnototal">No Total</option>
                    	<option value="invoiceprintblank">Blank</option>
                    	<option value="invoiceTabletPrint">Questions On</option>
                    	<!-- <option value="estimateTabletPrint">Estimate Template</option> -->
                    </select>
                                                    </td>


                                                    <?php if ($_SESSION['user']['role_id'] == 6) {?>
                                                    <td class="special_section">
                                                        <input type="button" value="Email Invoice" onclick="emailInvoice(<?=$this->data[" Order "]["id "]?>);" name="invoice-email">
                                                        <?php }?>
                                                    </td>
                                                </tr>
                                            </table>
                                            <?php }?>
                                            <table id="JobHistory" class="special_section" style="display:none;" cellspacing=0 cellpadding=0>
                                                <tr>
                                                    <td style="clear: both;background:#FFFFEE;"></td>
                                                </tr>
                                            </table>
                                            <?php if (isset($_GET['order_id'])||isset($_GET['job_truck'])) {?>
                                            <?php if ($common->getLoggedUserRoleID() == "6" || $common->getLoggedUserRoleID() == "1" ) {

  if($_SESSION['user']['role_id'] != 1 || $estimate_page != 1) {?>
                                            <table id="ApplianceOrder" class="special_section" style="width:100%; <?=$show_app_order?>">
                                                <tr>
                                                    <td colspan=2><u><b>Appliance order</b></u></td>
                                                    <td colspan=5>Supplier:<br/>
                                                        <?php echo $html->selectTag('Order/app_ordered_supplier_id', $allSuppliers, $this->data['Order']['app_ordered_supplier_id'], array('onchange'=>'ChangeSupplier(this)'));?>
                                                        <button id='select_supplier' onclick="ShowSelectSupply();return false;">Choose</button>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td colspan="2"></td>

                                                </tr>
                                                <tr>
                                                    <td colspan="2"></td>
                                                    <td>Qoute #:</td>
                                                    <td colspan="5">
                                                        <?php echo $html->input('Order/app_po_number', array('style' => 'width: 100px;')); ?>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td colspan="2"></td>
                                                    <td>Total Invoice</td>
                                                    <td>
                                                        <?php echo $html->input('Order/total_invoice_amount', array('style' => 'width: 100px;')); ?>
                                                    </td>
                                                    <td colspan="3">
                                                        <?php if(!empty($this->data['Order']['invoice_image'])) {
                $invoiceUploadDisplay1 = 'display:none;';
                $invoiceImageDisplay1 = 'display:block;';
            ?>
                                                        <?php } else {
                $invoiceUploadDisplay1 = 'display:block;';
                $invoiceImageDisplay1 = 'display:none;';
            ?>
                                                        <?php } ?>
                                                        <input type="hidden" name="orderInvoiceImage" id="orderInvoiceImage" value="<?=$this->data['Order']['invoice_image'];?>">
                                                        <div id="invoice_order_image" style="<?php echo $invoiceImageDisplay1?>">
                                                            <div style="position: relative; padding:0;">

                                                                <span style="position:absolute;"><img style="height: 15px;width: 12px;" class="delete-invoice-image" src="<?=ROOT_URL?>/app/webroot/img/cross-icon.jpeg" image-name="<?=$this->data['Order']['invoice_image']?>"></span>
                                                                <img class="show-pdf-image" src="<?=ROOT_URL?>/app/webroot/img/doc_pdf.png" data-doc_lnk="<?php echo '/acesys/app/webroot/purchase-invoice-images/'.$this->data['Order']['invoice_image'];?>" style="height: 70px;width: 70px;">
                                                            </div>
                                                        </div>
                                                        <div id="invoice_order_upload" style="<?php echo $invoiceUploadDisplay1?>">
                                                            <!-- <img id="pre-image_photo3" class="pre-image_photo3 invoice-openImg" src="#" alt="your image" /> -->
                                                            <img id="pre-image-pdf" class="show-pdf-image" src="<?=ROOT_URL?>/app/webroot/img/doc_pdf.png" data-doc_lnk="" alt="your image" style="display: none;" />
                                                            <div class="cls-acecare-td-adjust" style="width: 70px; padding: 3px;">
                                                                <label for="invoice_image" style="background: lightgrey;">Attach</label>
                                                                <input type="file" name="invoice_image" id="invoice_image" class="disply_preview_image" data-ct="photo3" style="width: 70px;">
                                                            </div>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td colspan="4">
                                                        <!-- <input type="button" id="generate_purchase_order" name="order" value="<?=($this->data['Order']['purchase_order_status']== 1) ? 'Purchased ':'Purchase'?>" style="margin-top: 5px; padding: 5px;" /> -->
                                                    </td>
                                                    <td>Supplier Info:</td>
                                                    <input type="hidden" name="data[Order][purchase_supplier_info]" id="purchase_supplier_info" value="<?=$this->data['Order']['purchase_supplier_info']?>">
                                                    <td colspan="2" id="SupplierInfo" style="color:#004993">
                                                        <?=$this->data['Order']['purchase_supplier_info']?>
                                                    </td>
                                                    <input type="hidden" name="supplier_name" id="purchase_supplier_name" value="<?=$this->data['Supplier']['name']?>">
                                                </tr>

                                                <tr>
                                                    <td>Invoice No#:</td>
                                                    <td><input type="text" name="data[Order][invoice_id]" id="invoiceId" value="<?=$this->data['Order']['invoice_id']?>"></td>
                                                    <td>Pick up by:</td>
                                                    <td>
                                                        <?php echo $html->selectTag('Order/app_ordered_pickup_person', $allTechnician, $this->data['Order']['app_ordered_pickup_person']);?>
                                                    </td>
                                                    <td>Sub Total:</td>
                                                    <td colspan="2"><input type="text" disabled name="invoiceSubTotal" id="invoiceSubTotal" value=""></td>
                                                </tr>
                                                <tr>
                                                    <td>Order date:</td>
                                                    <td>
                                                        <?php echo $html->input('Order/app_ordered_date', array('style' => 'width: 85px; cursor: hand; cursor: pointer;', 'onclick' => 'scwShow(this,event);', 'onkeydown' => 'return false;'));?>
                                                    </td>
                                                    <td>Pick up date:</td>
                                                    <td>
                                                        <?php echo $html->input('Order/app_ordered_pickup_date', array('style' => 'width: 85px; cursor: hand; cursor: pointer;', 'onclick' => 'scwShow(this,event);', 'onkeydown' => 'return false;'));?>
                                                    </td>
                                                    <td>Gst:</td>
                                                    <td colspan="2"><input type="text" disabled name="invoiceGst" id="invoiceGst" value=""></td>
                                                </tr>
                                                <tr>
                                                    <td>Ordered by:</td>
                                                    <td colspan="3">
                                                        <?php echo $html->selectTag('Order/app_ordered_by', $booking_sources, $this->data['Order']['app_ordered_by']);?>
                                                    </td>
                                                    <td>Pst:</td>
                                                    <td colspan="2"><input type="text" disabled name="invoicePst" id="invoicePst" value=""></td>
                                                </tr>
                                                <tr>
                                                    <td colspan="4"></td>
                                                    <td>Total:</td>
                                                    <td><input type="text" disabled name="invoiceTotal" id="invoiceTotal" value=""></td>

                                                    <?php if(!empty($this->data['Order']['id'])){?>
                                                    <td>
                                                        <input type="submit" id="save_one_time_item" name="OK" value="Save" style="margin-top: 5px; padding: 5px;" />
                                                    </td>
                                                    <?php } else {?>
                                                    <td></td>
                                                    <?php } ?>
                                                </tr>
                                                <!-- <tr>
        <td colspan="5"></td>

    </tr> -->
                                            </table>
                                            <input type="hidden" name="data[NumberOfPermits]" id="NumberOfPermits" value="<?=count($this->data['Permits'])?>">
                                            <table id="PermitsSection" class="special_section" style=" width:100%; background-color:#EEEEFF;<?=$show_permits?>">
                                                <tr>
                                                    <td colspan=2><a href="<?=BASE_URL;?>/orders/permit?city=<?=$this->data['Customer']['city']?>" target="_blank">Permit application</a></td>
                                                    <td>Permit #:</td>
                                                    <td>
                                                        <?php echo $html->input('Order/permit_number', array('style' => 'width: 100px;')); ?>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>Application date:</td>
                                                    <td>
                                                        <?php echo $html->input('Order/permit_applied_date', array('style' => 'width: 85px; cursor: hand; cursor: pointer;', 'onclick' => 'scwShow(this,event);', 'onkeydown' => 'return false;'));?>
                                                    </td>
                                                    <td>Applied by:</td>
                                                    <td>
                                                        <?php echo $html->selectTag('Order/permit_applied_user', $booking_sources, $this->data['Order']['permit_applied_user']);?>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>Application method:</td>
                                                    <td>
                                                        <?php echo $html->selectTag('Order/permit_applied_method', $allPermitMethods, $this->data['Order']['permit_applied_method']);?>
                                                    </td>
                                                    <td>Application status:</td>
                                                    <td>
                                                        <?php echo $html->selectTag('Order/permit_result', $allPermitStates, $this->data['Order']['permit_result']);?>
                                                        <?php echo $html->checkbox('Order/permit_inspection', "Home Inspector"); ?> Home Inspector
                                                    </td>
                                                </tr>
                                            </table>
                                            <?php
}
}
?>
                                                <div class="frame-wrap">
                                                    <div class="frame-header-left"></div>
                                                    <?php if($_SESSION['user']['role_id'] != 1 || $estimate_page != 1) {?>
                                                    <div class="frame-header-title">
                                                        <table width=100%>
                                                            <tr>
                                                                <td width=450px style="font: 12px Verdana">Scheduling</td>
                                                                <td style="text-align:right;font: 12px Verdana;color:#000088">Ref #
                                                                    <?php echo $this->data['Order']['order_number'];?>
                                                                </td>
                                                            </tr>
                                                        </table>
                                                    </div>
                                                    <?php }?>
                                                    <input type="hidden" id="po_number" name="poNumber" value="<?php echo $this->data['Order']['order_number'];?>">
                                                    <div class="frame-header-right"></div>
                                                    <div class="frame-body" style="clear: both;">
                                                        <?php echo $html->hidden('Order/id')?>
                                                        <?php echo $html->hidden('Order/customer_id')?>
                                                        <?php echo $html->hidden('Order/booking_date')?>
                                                        <table>
                                                            <tr>
                                                                <td colspan="2"></td>
                                                                <td align="right">Job Date:</td>
                                                                <td>
                                                                    <?php
                    // Disables the job date control for telemarketers for the existing jobs
                    $Enbl=true;
                    if (($this->data['Order']['id'])&&
                        (($this->data['Order']['order_status_id']==1)||
                         ($this->data['Order']['order_status_id']==2)||
                         ($this->data['Order']['order_status_id']==5)))
                    {
                        if (($common->getLoggedUserRoleID() == "9") || ($common->getLoggedUserRoleID() == "13"))
                        {
                            $Enbl=false;
                        }
                    }
                    if ($Enbl)
                    {
                        echo $html->input('Order/job_date', array('style' => 'width: 85px; cursor: hand; cursor: pointer;', 'onclick' => 'scwShow(this,event);', 'onkeydown' => 'return false;'));
						echo $html->tagErrorMsg('Order/job_date','Please enter in a correct date for this job.');
                    }
                    else
                        echo $html->input('Order/job_date', array('style' => 'width: 85px; cursor: hand; cursor: pointer;', 'onkeydown' => 'return false;'));
                    ?>
                                                                </td>
                                                            </tr>
                                                            <tr>
                                                                <td align="right">Job Type:</td>
                                                                <td colspan="">
                                                                    <input type="button" name="Service" class="change_service" btn-val="1" value="Service">
                                                                    <input type="button" name="installation" class="change_service" btn-val="2" value="Installation">
                                                                    <input type="button" btn-val="5" class="change_service" name="Repair" value="Repair">
                                                                    <input type="button" btn-val="4" class="change_service" name="Cleaning" value="Cleaning">
                                                                    <input type="button" btn-val="3" class="change_service" name="Other" value="Other">
                                                                </td>
                                                                <!-- <td></td> -->
                                                                <?php if($_SESSION['user']['role_id'] != 1 || $estimate_page != 1) {?>
                                                                <td class="<?= $class ?>" align="right">Truck #:</td>
                                                                <td class="<?= $class ?>">
                                                                    <select name="data[Order][job_truck]" id="OrderJobTruck">
							<option value="">&nbsp;</option>
							<?php
							foreach ($job_trucks as $key => $value  ){
								if(($_GET['estimate']==1 || $_GET['fromEstimate']==1 ) && $key==40){
									$selected="selected";
								}
								else {
								$selected = ($this->data['Order']['job_truck'] == $key) ? 'selected' : '';
								}
								if(isset($_REQUEST['job_truck']) && (!isset($_REQUEST['order_id']) || $_REQUEST['order_id']==0 ) && $key==$_REQUEST['job_truck'] ){
									$selectd1="selected";
								}
								else {
									$selectd1="";
								}
								?>
							<option value="<?= $key ?>" <?= $selected." ".$selectd1 ?>><?= $value ?></option>

							<?php }
							?>
							</select>
                                                                    <?php //echo $html->selectTag('Order/job_truck', $job_trucks, ($this->params['url']['job_truck'] ? $this->params['url']['job_truck'] : $this->data['Order']['job_truck'])); ?>
                                                                    <?php echo $html->tagErrorMsg('Order/job_truck','Please enter the truck number.'); ?>
                                                                </td>
                                                                <?php }?>
                                                            </tr>
                                                            <?php if($_SESSION['user']['role_id'] != 1 || $estimate_page != 1) {?>
                                                            <tr>
                                                                <td class="<?= $class ?>" colspan="3" align="right">Shift</td>
                                                                <td class="<?= $class ?>">
                                                                    <select id="OrderJobShift" name="data[Order][job_shift]">
                            <option value="0">--</option>
                            <option value="1">AM</option>
                            <option value="2">PM</option>
                        </select>
                                                                </td>
                                                            </tr>
                                                            <tr>
                                                                <td align="right"></td>
                                                                <td>
                                                                    <?php
                    // $disabled = array("onchange" => "JobTypeChange()","onMouseOut"=>"this.size=1" ,"onMouseOver"=>"this.size=this.length");
                    $disabled = array("onclick" => "JobTypeChange()");
                    if( $_GET['fromjobcheck'] == "1" ) {
                          $disabled = array('disabled'=>'1');
                    }
                    echo $html->selectTag('Order/order_type_id', $job_types, $this->data['Order']['order_type_id'],$disabled);
                    ?>
                                                                </td>
                                                                <!-- <td></td> -->
                                                                <td class="<?= $class ?>" align="right">Schedule:</td>
                                                                <?php if (($common->getLoggedUserRoleID() == "9") || ($common->getLoggedUserRoleID() == "13")) { ?>
                                                                <td class="<?= $class ?>">
                                                                    <select id="OrderJobTimeBegHour" name="data[Order][job_time_beg_hour]">
	                    <option value="">&nbsp;</option>
	                    <option value="08"> 8 AM</option>
	                    <option value="09"> 9 AM</option>
	                    <option selected="selected" value="10">10 AM</option>
	                    <option value="11">11 AM</option>
	                    <option value="12">12 PM</option>
	                    <option value="13"> 1 PM</option>
	                    <option value="14"> 2 PM</option>
	                    <option value="15"> 3 PM</option>
	                    <option value="16"> 4 PM</option>
	                    </select>
                                                                    <span class="<?= $class;?>">&nbsp; to &nbsp;</span>
                                                                    <select id="OrderJobTimeEndHour" name="data[Order][job_time_end_hour]">
	                    <option value="">&nbsp;</option>
	                    <option value="08"> 8 AM</option>
	                    <option value="09"> 9 AM</option>
	                    <option selected="selected" value="10">10 AM</option>
	                    <option value="11">11 AM</option>
	                    <option value="12">12 PM</option>
	                    <option value="13"> 1 PM</option>
	                    <option value="14"> 2 PM</option>
	                    <option value="15"> 3 PM</option>
	                    <option value="16"> 4 PM</option>
	                    </select>
                                                                </td>
                                                                <?php } else { ?>
                                                                <td>
                                                                    <?php echo $html->hourOptionTag('Order/job_time_beg',null, 1,$job_start_new); ?>
                                                                    <span class="<?= $class;?>">&nbsp; to &nbsp;</span>
                                                                    <?php echo $html->hourOptionTag('Order/job_time_end', null, 1,$job_end_new); ?>
                                                                </td>
                                                                <?php } ?>
                                                            </tr>
                                                            <tr id="PreviousSection" style="display:none">
                                                                <td align="right">Previous job:</td>
                                                                <td colspan=3><b id="OrderJobEstimateText"><?=$job_estimate_text;?></b>
                                                                    <input type="hidden" name="data[Order][job_estimate_id]" id="OrderJobEstimateId" value="<?=$this->data['Order']['job_estimate_id'];?>" />
                                                                    <input type="button" value="Change" onclick="showChangePrevious()" /></td>
                                                            </tr>
                                                            <tr id="OpenQuestionsText" style="cursor:pointer;">
                                                                <?php if($this->data['Order']['order_status_id'] == 5) { ?>
                                                                <td align="right" onclick="OpenQuestions(2)">
                                                                    <img id="QuestionsWorking2" style="display:none" src="<?=ROOT_URL?>/app/webroot/img/wait30trans.gif" />
                                                                    <img src="<?=ROOT_URL?>/app/webroot/img/icon-sm-requested-bookings.png" />
                                                                </td>
                                                                <td onclick="OpenQuestions(2)">Questions</td>
                                                                <?php $ttt = '';
                        if( ($common->getLoggedUserRoleID() == "13" ) || ($common->getLoggedUserRoleID() == "3" ) || ($common->getLoggedUserRoleID() == "9" )) $ttt = 'display:none';?>
                                                                <td align="right" onclick="OpenQuestions(1)" style="<?=$ttt?>">
                                                                    <img id="QuestionsWorking1" style="display:none" src="<?=ROOT_URL?>/app/webroot/img/wait30trans.gif" />
                                                                    <img src="<?=ROOT_URL?>/app/webroot/img/icon-sm-requested-bookings.png" />
                                                                </td>
                                                                <td onclick="OpenQuestions(1)" style="<?=$ttt?>">Tech questions section</td>
                                                                <?php } else { ?>
                                                                <td align="right" onclick="OpenQuestions(0)">
                                                                    <img id="QuestionsWorking0" style="display:none" src="<?=ROOT_URL?>/app/webroot/img/wait30trans.gif" />
                                                                    <img src="<?=ROOT_URL?>/app/webroot/img/icon-sm-requested-bookings.png" />
                                                                </td>
                                                                <td onclick="OpenQuestions(0)">Office questions section</td>
                                                                <?php $ttt = '';
						if( ($common->getLoggedUserRoleID() == "13" ) || ($common->getLoggedUserRoleID() == "3" ) || ($common->getLoggedUserRoleID() == "9" )) $ttt = 'display:none';?>
                                                                <td align="right" onclick="OpenQuestions(1)" style="<?=$ttt?>">
                                                                    <img id="QuestionsWorking1" style="display:none" src="<?=ROOT_URL?>/app/webroot/img/wait30trans.gif" />
                                                                    <img src="<?=ROOT_URL?>/app/webroot/img/icon-sm-requested-bookings.png" />
                                                                </td>
                                                                <td onclick="OpenQuestions(1)" style="<?=$ttt?>">Tech questions section</td>
                                                                <?php }//END if($this->data['Order']['order_status_id'] == 5) ?>
                                                            </tr>
                                                            <tr class="special_section" id="CloseQuestionsText" onclick="CloseQuestions()" style="cursor:pointer;display:none">
                                                                <td align="right"><img src="<?=ROOT_URL?>/app/webroot/img/icon-sm-requested-bookings.png" /></td>
                                                                <td colspan=4>Close questions section</td>
                                                            </tr>
                                                            <tr>
                                                                <td id="JobDetails0" colspan=5 style="cursor:pointer;display:none">
                                                                    <?=CurrentQuestionsTextOffice;?>
                                                                </td>
                                                            </tr>
                                                            <tr>
                                                                <td id="JobDetails1" colspan=5 style="cursor:pointer;display:none">
                                                                    <?=CurrentQuestionsTextTech;?>
                                                                </td>
                                                            </tr>
                                                            <tr>
                                                                <td id="JobDetails2" colspan=5 style="cursor:pointer;display:none"></td>
                                                            </tr>
                                                            <tr class="visible">
                                                                <td colspan=3><span>Created: <b><?=$created_date;?>&nbsp; by&nbsp;<?=$created_by;?></b></span></td>
                                                            </tr>
                                                            <tr class="visible">
                                                                <td colspan=3>Last modified: <b><?=$modified_date;?>&nbsp; by&nbsp;<?=$modified_by;?></b></td>
                                                            </tr>
                                                            <tr class="<?= $class ?>">
                                                                <td align="right">Source 1</td>
                                                                <td>
                                                                    <?php
                    if( ($common->getLoggedUserRoleID() != "3" ) && ($common->getLoggedUserRoleID() != "9" )) {
                          echo $html->selectTag('Order/booking_source_id', $booking_sources, $this->data['Order']['booking_source_id']);
                    }
                    else
                    {
                          echo $html->selectTag('Order/booking_source_id', $booking_sources, $this->data['Order']['booking_source_id'], array('style' => 'display: none;'));
                          echo '<b>'.$booking_sources[$this->data['Order']['booking_source_id']].'</b>';
                    }


                    ?>
                                                                        <?php echo $html->tagErrorMsg('Order/booking_source_id','Please select the source for this order.') ?>
                                                                </td>
                                                                <td class="<?= $class ?>" align="right">Tech 1:</td>
                                                                <td class="<?= $class ?>">
                                                                    <?php echo $html->selectTag('Order/job_technician1_id',$allTechnician,$this->data['Order']['job_technician1_id']);?>
                                                                    <?php echo $html->tagErrorMsg('Order/job_technician1_id','Please enter technician1.') ?>
                                                                </td>
                                                            </tr>
                                                            <tr class="<?= $class ?>">
                                                                <td align="right">&nbsp;&nbsp;</td>
                                                                <td>
                                                                    &nbsp;&nbsp;
                                                                </td>


                                                                <td class="<?= $class ?>" align="right">Rating:</td>
                                                                <td class="<?= $class ?>">
                                                                    <input type="hidden" name="rating" id="rating" value="">
                                                                    <div class='rating-stars text-center'>
                                                                        <?php
																					$office_rating = $this->data['Order']['office_rating'];
																					?>
                                                                            <ul id='stars' style="border:none;">
                                                                                <?php
																									for ($x = 1; $x <= 5; $x++) {
																										if($x<=$office_rating){
																											$class="selected11";
																										}
																										else {
																											$class="";
																										}
																										?>
                                                                                    <li class="star <?= $class?>" data-value='<?= $x ?>'>
                                                                                        <i class='fa fa-star fa-fw'></i>
                                                                                    </li>

                                                                                    <?php } ?>


                                                                            </ul>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                            <tr class="<?= $class ?>">
                                                                <td align="right">Source 2:</td>
                                                                <td>
                                                                    <?php echo $html->selectTag('Order/booking_source2_id', $booking_sources, $this->data['Order']['booking_source2_id']); ?>
                                                                </td>
                                                                <?php if ($_SESSION['user']['role_id'] == 6 || $_SESSION['user']['role_id'] == 1) {?>
                                                                <td align="right">Comm. type:</td>
                                                                <td>
                                                                    <?php echo $html->selectTag('Order/t1_method', $comm_roles, $this->data['Order']['t1_method']); ?>
                                                                </td>
                                                                <?php }?>
                                                            </tr>
                                                            <tr class="<?= $class ?>" class="hide-data">
                                                                <td align="right">Camp Source:</td>
                                                                <td>
                                                                    <?php echo '<b>'.$booking_sources[$this->data['Order']['camp_source']].'</b>'?></td>
                                                                <td></td>
                                                                <td></td>
                                                            </tr>
                                                            <tr class="<?= $class ?>">
                                                                <td align="right">Verified by:</td>
                                                                <td>
                                                                    <?php
						if ($_SESSION['user']['role_id'] == 6||$_SESSION['user']['role_id'] == 13)
						{
							echo $html->selectTag('Order/verified_by_id',$verificators, $this->data['Order']['verified_by_id']);
						}
						else
						{
							echo $html->selectTag('Order/verified_by_id', $verificators, $this->data['Order']['verified_by_id'], array('style' => 'display: none;'));
							echo '<b>'.$verificators[$this->data['Order']['verified_by_id']].'</b>';
						}
						?>
                                                                </td>
                                                                <?php if ($_SESSION['user']['role_id'] == 6) {?>
                                                                <td align="right">Commission:</td>
                                                                <td>
                                                                    <b>$<?=$tech1_comm?></b>
                                                                    <a href="<?=$tech1_comm_link?>">Commission page</a>
                                                                </td>
                                                                <?php }?>
                                                            </tr>
                                                            <tr class="<?= $class ?>">
                                                                <td align="right">Spoke to:</td>
                                                                <td>
                                                                    <?php echo $html->input('Order/sSpokeTo', array('style' => 'width: 150px;')); ?>
                                                                </td>
                                                                <td align="right">Tech 2:</td>
                                                                <td>
                                                                    <?php echo $html->selectTag('Order/job_technician2_id',$allTechnician,$technician2_id, array("onchange" => "TechHelpSel(this);"));?>
                                                                    <?php echo $html->tagErrorMsg('Order/job_technician2_id','Please enter technician2.') ?>
                                                                </td>
                                                            </tr>
                                                            <tr class="<?= $class ?>">
                                                                <td align="right">
                                                                    <?php if ($_SESSION['user']['role_id'] == 6||$_SESSION['user']['role_id'] == 13 || $_SESSION['user']['role_id'] == 1) echo 'Confirmation:';?>
                                                                </td>
                                                                <td>
                                                                    <?php
						if ($_SESSION['user']['role_id'] == 6||$_SESSION['user']['role_id'] == 13 || $_SESSION['user']['role_id'] == 1)
						{
							echo $html->selectTag('Order/order_substatus_id', $sub_status, $this->data['Order']['order_substatus_id'], array("onchange" => "onSubstatusChange(this);"));
							echo $html->tagErrorMsg('Order/order_substatus_id','Please enter confirmation status.');
						}
                    ?>
                                                                </td>
                                                                <?php if ($_SESSION['user']['role_id'] == 6 || $_SESSION['user']['role_id'] == 1) {?>
                                                                <td align="right">Comm. type:</td>
                                                                <td>
                                                                    <?php echo $html->selectTag('Order/t2_method', $comm_roles, $this->data['Order']['t2_method']); ?>
                                                                </td>
                                                                <?php }?>
                                                            </tr>
                                                            <!-- add campaing drop down -->
                                                            <tr class="<?= $class ?>">
                                                                <td align="right" class="hide-data">
                                                                    <?php if ($_SESSION['user']['role_id'] == 6||$_SESSION['user']['role_id'] == 13 || $_SESSION['user']['role_id'] == 1) echo 'Campaing:';?>
                                                                </td>
                                                                <td class="hide-data">
                                                                    <?php
						if ($_SESSION['user']['role_id'] == 6||$_SESSION['user']['role_id'] == 13 || $_SESSION['user']['role_id'] == 1 || $_SESSION['user']['role_id'] == 3 )
						{?>
                                                                        <select name="data[Order][order_campaing_id]" id="campaing-select">
							<option value=""></option>
								<?php foreach($campaing_list as $list) {?>
									<option value = "<?php echo $list['id']; ?>" data-camp-city="<?php echo $list['camp_city']; ?>" <?php echo ($list['id'] == $this->data['Order']['o_campaign_id'])? 'selected' : ''; ?> ><?php echo $list['camp_name']?></option>
								<?php } ?>
						</select>
                                                                        <?php } ?>
                                                                </td>
                                                                <?php if ($_SESSION['user']['role_id'] == 6) {?>

                                                                <td align="right" colspan="3">Commission:</td>
                                                                <td>
                                                                    <b>$<?=$tech2_comm?></b>
                                                                    <a href="<?=$tech2_comm_link?>">Commission page</a>
                                                                </td>
                                                                <?php }?>
                                                            </tr>
                                                            <?php }?>
                                                            <tr class="<?= $class ?>">
                                                                <td align="right">Paying By:</td>
                                                                <td>

                                                                    <?php if ($_SESSION['user']['role_id'] == 6 || $_SESSION['user']['role_id'] == 3 || $_SESSION['user']['role_id'] == 1) {?>
                                                                    <select id="PaymentPaymentMethodId" name="data[Order][payment_method_type]">
                			<option value="0">--</option>
		              		 <?php foreach($payment_types as $method) {
									if(isset($_GET['estimate']) &&  $method['id']==11 ){
										$selected="selected";
									}
									else {
                                        $selected = ($this->data['Order']['payment_method_type'] == $key) ? 'selected' : '';

									}
									?>

		                    <option value="<?=$method['id']?>" <?php echo $this->data['Order']['payment_method_type'] == $method['id']? 'selected' : '';?> <?php echo $selected; ?> show-picture="<?=$method['show_picture']?>"><? echo $method['name']?></option>
				               <?php }?>
				            </select>
                                                                    <?php }?>
                                                                </td>
                                                            </tr>
                                                            <?php if($_SESSION['user']['role_id'] == 1 && $estimate_page == 1) {?>
                                                            <!--  <?php if($this->data['Order']['id'] == ''){
                        $DisTbl = 'display:none';
                    }?> -->
                                                            <!--  <tr>
                        <td colspan="4">
                            <table id="customerCreditInfo">
                                <tr>
                                    <td>Name:</td>
                                    <td><input type="text" name="data[Customer][credit_card_name]" value="<?= $this->data['Customer']['credit_card_name']?>" id="creditCardName1"></td>
                                    <td>Card:</td>
                                    <?php if($this->data['Customer']['id'] == ''){?>
                                    <td><input type="text" name="data[Customer][credit_card_number]" value="<?= $this->data['Customer']['credit_card_number']?>" id="creditCardNum1"></td>
                                    <?php } else {?>
                                        <td><input type="text" name="data[Customer][credit_card_number1]" value="<?= $this->data['Customer']['credit_card_number']?>" id="creditCardNum1"></td>
                                    <?php } ?>
                                    <td><input type="button" class="cardBtn" name="useOldCard" value="Use this card" id="useOldCard"></td>
                                </tr>
                                <tr>
                                    <td>Exp:</td>
                                    <td>
                                        <select name="data[Customer][card_exp_month]" id="cardExpMonth1">
                                         <option <? echo ($this->data['Customer']['card_exp_month'] == "00") ? 'selected' : ''; ?> value="00">--</option>
                                        <option <? echo ($this->data['Customer']['card_exp_month'] == "01") ? 'selected' : ''; ?> value="01">01</option>
                                        <option <? echo ($this->data['Customer']['card_exp_month'] == "02") ? 'selected' : ''; ?> value="02">02</option>
                                        <option <? echo ($this->data['Customer']['card_exp_month'] == "03") ? 'selected' : ''; ?> value="03">03</option>
                                        <option <? echo ($this->data['Customer']['card_exp_month'] == "04") ? 'selected' : ''; ?> value="04">04</option>
                                        <option <? echo ($this->data['Customer']['card_exp_month'] == "05") ? 'selected' : ''; ?> value="05">05</option>
                                        <option <? echo ($this->data['Customer']['card_exp_month'] == "06") ? 'selected' : ''; ?> value="06">06</option>
                                        <option <? echo ($this->data['Customer']['card_exp_month'] == "07") ? 'selected' : ''; ?> value="07">07</option>
                                        <option <? echo ($this->data['Customer']['card_exp_month'] == "08") ? 'selected' : ''; ?> value="08">08</option>
                                        <option <? echo ($this->data['Customer']['card_exp_month'] == "09") ? 'selected' : ''; ?> value="09">09</option>
                                        <option <? echo ($this->data['Customer']['card_exp_month'] == "10") ? 'selected' : ''; ?> value="10">10</option>
                                        <option <? echo ($this->data['Customer']['card_exp_month'] == "11") ? 'selected' : ''; ?> value="11">11</option>
                                        <option <? echo ($this->data['Customer']['card_exp_month'] == "12") ? 'selected' : ''; ?> value="12">12</option>
                                </select>
                                <select  name="data[Customer][card_exp_year]" id="cardExpYear1">
                                     <option value="0">--</option>
                                    <?php for($i = 20; $i <= 45; $i++){?>
                                        <option <? echo ($this->data['Customer']['card_exp_year'] == $i) ? 'selected' : ''; ?> value="<?=$i?>"><?php echo $i;?></option>
                                    <?php } ?>
                                </select>(MM/YY)
                                    </td>
                                    <td>Cvv:</td>
                                    <td><input type="text" name="data[Customer][card_cvv]" value="<?= $this->data['Customer']['card_cvv']?>" id="creditCardCvv1"></td>
                                    <td><input type="button" class="cardBtn" name="useNewCard" value="New" id="useNewCard"></td>
                                </tr>
                                <tr>
                                    <td colspan="4"></td>
                                    <td><input type="button" class="cardBtn" name="saveCard" value="Save" id="saveCard"></td>
                                </tr>
                            </table>
                        </td>
                    </tr> -->
                                                            <tr>
                                                                <!-- <td align="right"><?php if ($_SESSION['user']['role_id'] == 6||$_SESSION['user']['role_id'] == 13 || $_SESSION['user']['role_id'] == 1) echo 'Do not send email reminder:';?></td>
                    <td>
                    <?php
						if ($_SESSION['user']['role_id'] == 6||$_SESSION['user']['role_id'] == 13 || $_SESSION['user']['role_id'] == 1 || $_SESSION['user']['role_id'] == 3 )
						{?>
							<input type="hidden" id="reminderMail" name="data[Order][reminderMail]" value="0">
							<input type="checkbox"<?php if ($this->data['Order']['reminderMail'] == 1) echo "checked"; ?> name="data[Order][reminderMail]" value="1" style="margin-left: 10px;">
						<?php } ?>
                    </td> -->
                                                                <?php }?>
                                                                <?php if ($_SESSION['user']['role_id'] == 6 || $_SESSION['user']['role_id'] == 1) {?>
                                                                <td colspan="2">
                                                                    <span>Preview Estimate:</span><img style="width: 33px;position: relative;top: 10px" onclick="showestimateSubmit()" src="<?=ROOT_URL?>/app/webroot/img/icon-lg-all-bookings.png" />
                                                                    <?php if($_SESSION['user']['role_id'] != 1 || $estimate_page != 1) {?>
                                                                    <span id="LastCallHistory" style="margin: 0px 0px 0px 15px;"></span>
                                                                    <?php }?>
                                                                </td>

                                                                <?php }?>
                                                                <?php if($_SESSION['user']['role_id'] != 1 || $estimate_page != 1) {?>
                                                                <?php if ($_SESSION['user']['role_id'] == 6) {?>
                                                                <td align="right">&nbsp;&nbsp;Tech time in:</td>
                                                                <td>
                                                                    <?php echo $html->hourOptionTag('Order/fact_job_beg', null, 1); ?> :
                                                                    <?php echo $html->minuteOptionTag('Order/fact_job_beg', null, 0); ?>
                                                                    <!--&nbsp;Parts warranty:-->
                                                                    <?php //echo $html->input('Order/parts_warranty', array('style' => 'width: 70px; cursor: hand; cursor: pointer;'));?>
                                                                </td>
                                                                <?php } ?>

                                                                <input type="hidden" name="data[Order][tech_percentage]" id="tech_percentage" value="<?=$this->data['Order']['tech_percentage']?>">
                                                                <input type="hidden" name="data[Order][tech_percentage_type]" id="tech_percentage_type" value="<?=$this->data['Order']['tech_percentage_type']?>">
                                                                <input type="hidden" name="data[Order][markup_percentage]" id="markup_percentage" value="
                    <?=$this->data['Order']['markup_percentage']?>">
                                                                <input type="hidden" name="data[Order][markup_percentage_type]" id="markup_percentage_type" value="<?=$this->data['Order']['markup_percentage_type']?>">
                                                            </tr>
                                                            <!-- loki -->
                                                            <tr>
                                                                <!-- <td align="right"><?php if ($_SESSION['user']['role_id'] == 6||$_SESSION['user']['role_id'] == 13 || $_SESSION['user']['role_id'] == 1) echo '<b>Purchase:</b>';?></td> -->
                                                                <!--  <td>
                    <?php
						if ($_SESSION['user']['role_id'] == 6||$_SESSION['user']['role_id'] == 13 || $_SESSION['user']['role_id'] == 1 || $_SESSION['user']['role_id'] == 3 )
						{?>
							<input type="checkbox" name="showPurchase" value="1" style="margin-left: 10px;" id="show-purchase">
						<?php } ?>
                    </td> -->
                                                                <?php if ($_SESSION['user']['role_id'] == 6) {?>
                                                                <td colspan="2">
                                                                    <?php echo $html->input('Order/estimate_page', array('type' => 'checkbox', 'value' => '1')); ?> Show Estimate Page
                                                                </td>
                                                                <td align="right">Tech time out:</td>
                                                                <td>
                                                                    <?php echo $html->hourOptionTag('Order/fact_job_end', null, 1); ?> :
                                                                    <?php echo $html->minuteOptionTag('Order/fact_job_end', null, 0); ?>

                                                                </td>
                                                                <?php } ?>

                                                            </tr>
                                                            <tr>
                                                                <?php if($_SESSION['user']['role_id'] != 1 || $estimate_page != 1) {?>
                                                                <td class="<?= $class ?>" colspan="3" align="right" style="color:#3a5ab3;font-weight: bolder;">Duration:</td>
                                                                <td class="<?= $class ?>" style="color:#3a5ab3;font-weight: bolder;">
                                                                    <?php echo gmdate("H:i:s", $this->data['Order']['stop_duration']); ?>
                                                                </td>
                                                                <?php }?>
                                                            </tr>

                                                            <tr id="notifiedBy" style="<?php if ($this->data['Order']['order_substatus_id'] != 4) echo " display:none; "; ?>">
                                                                <td align="right">Notified by:</td>
                                                                <td>
                                                                    <?php
						if ($_SESSION['user']['role_id'] == 6)
						{
							echo $html->selectTag('Order/notified_by_id',$verificators, $this->data['Order']['notified_by_id']);
						}
						else
						{
							echo $html->selectTag('Order/notified_by_id', $verificators, $this->data['Order']['notified_by_id'], array('style' => 'display: none;'));
							//echo '<b>'.$verificators[$this->data['Order']['verified_by_id']].'</b>';
						}
						?>
                                                                </td>
                                                                <td>Time:</td>
                                                                <td>
                                                                    <input style="width:100px;" type="text" alt="time" name="data[Order][notified_when]" value="<?=($this->data['Order']['notified_when'])?date(" H:i ",strtotime($this->data['Order']['notified_when'])):date("H:i ")?>"/>
                                                                </td>
                                                            </tr>

                                                            <tr>
                                                                <td></td>
                                                                <td></td>
                                                                <td>


                                                                </td>
                                                                <td>

                                                                </td>
                                                            </tr>
                                                            <?php }?>

                                                            <input type="hidden" id="referred_by_name" value="" readonly>
                                                            <input type="hidden" id="referred_by_existing_userid" name="data[Customer][referred_by_existing_userid]" value="">

                                                            <input type="hidden" id="ref_card_number" value="" readonly>

                                                            <tr>
                                                                <td colspan=4 id="CurrentItems" style="vertical-align:top">
                                                                    <table>
                                                                        <tr>
                                                                            <td>
                                                                                <!--<input type="button" value="Add booked Items" onclick="showAddItems(0)" />-->
                                                                                <span><i class="fa fa-plus showTechTable" style="font-size:12px; float: left;padding: 3px;"></i></span>
                                                                                <input style="width:initial;" type="button" value="Items" id="addBookedItems" />
                                                                                <div style="width:50px;" class="loading_indicator" id="book_loading"></div>
                                                                                <input style="width:initial;" type="button" value="Close Items" id="closeBookedItems" />
                                                                                <a style="display:none;" id="addBookedItemsList" title="View Items in a List"></a>
                                                                                <a style="display:none;" id="addBookedItemsTree" title="View Items in a Tree"></a>

                                                                                <input autocomplete="off" class='ajax_item_name' data-class="0" />
                                                                                <a id="add_item_0" class="add_item_button" style="display: none;" href='javascript:add_unknown_item(0);'>Add to Inventory</a>

                                                                                <table id='ajax_item_results_0'>
                                                                                    <thead>
                                                                                        <tr>

                                                                                            <input type="hidden" id="installation_item_val" name="data[Order][installation_item_val]" value="<?= $this->data['Order']['installation_item_val']?>">
                                                                                            <?php if($_SESSION['user']['role_id'] != 1 || $estimate_page != 1) {?>
                                                                                            <input type="button" name="addPurchaseItem" class="addPurchaseItem" table-no="0" value="New Item">
                                                                                            <input type="button" name="installation_item" value="Installation Item" class="installation_item" style="margin-left: 5px;">
                                                                                            <input type="button" id="generate_purchase_order" name="order" value="<?=($this->data['Order']['purchase_order_status']== 1) ? 'Purchased ':'Purchase'?>" style="margin-left: 5px;" />
                                                                                            <input type="button" id="transfer_order_item" name="Transfer" value="Transfer" style="margin-left: 5px;" />
                                                                                            <input type="button" name="add_item" value="Add" class="add_selected_items" item-class="0" style="margin-left: 5%;">
                                                                                            <input type="button" name="delete_item" value="Remove" class="delete_selected_items" style="margin-left: 5px;">
                                                                                            <?php }?>
                                                                                        </tr>
                                                                                        <tr>
                                                                                            <th><b>Name</b></th>
                                                                                            <th><b>Model</b></th>
                                                                                            <th><b>Sku</b></th>
                                                                                            <th><b>Price</b></th>
                                                                                            <th style="display:none;"><b>Item Id</b></th>
                                                                                            <th><b>Purchase Price</b></th>
                                                                                            <th style="display:none;"><b>Category Id</b></th>
                                                                                            <!-- <th><b>Warehouse</b></th> -->
                                                                                            <th><b>image</b></th>
                                                                                            <?php foreach ($inventoryTechnician as $tech => $value): ?>
                                                                                            <th><b><?php echo $value['short_name'] ?></b></th>
                                                                                            <?php endforeach ?>

                                                                                            <th><b>Add/Remove</b></th>
                                                                                        </tr>
                                                                                    </thead>
                                                                                    <tbody>
                                                                                    </tbody>

                                                                                </table>
                                                                                <div class="clear_this"></div>
                                                                                <div id="item_selector0" style="background:#f8f8f8;border:1px solid #333333;display:none;"></div>
                                                                                <div id="MainItemsTable">
                                                                                    <table id="CurrentItemsTable" cellspacing=0 colspacing=0 class="inResultsBooking">
                                                                                        <!--<tr onclick="showAddItems(0)" style="cursor:hand;">-->
                                                                                        <tr>
                                                                                            <th align=left>Item</th>
                                                                                            <th class="order_warehouse_quantity" style="width:20px">Whs</th>
                                                                                            <th class="order_warehouse_quantity" style="width:20px">Tech</th>
                                                                                            <th style="width:30px">Part No.</th>
                                                                                            <th style="width:30px">Item Qty</th>
                                                                                            <th style="width:50px">Price</th>
                                                                                            <th style="width:50px;color:red;">Disc</th>
                                                                                            <th style="width:50px">Add</th>
                                                                                            <th style="width:50px">Prch</th>
                                                                                            <th style="width:50px">Sum</th>
                                                                                            <th class="order_item_status" style="width:20px;">Order</th>
                                                                                            <th style="width:20px;background: #b7b2b2"></th>
                                                                                            <th style="width:50px;background: #b7b2b2">Tech</th>
                                                                                            <th style="width:50px;background: #b7b2b2">Adjt</th>
                                                                                        </tr>
                                                                                        <?php echo $booked_items; ?>
                                                                                        <tr>
                                                                                            <td id="NewItems" class="newitem" colspan=7 style="display:none"></td>
                                                                                        </tr>
                                                                                    </table>
                                                                                </div>
                                                                            </td>
                                                                        </tr>
                                                                        <tr>
                                                                            <td id="CurrentItemsTotal1" style="vertical-align:top; float:right;"></td>
                                                                        </tr>
                                                                        <tr id='ajax_item_result_template_0' style='display:none'>
                                                                            <td class='name_0'>Result</td>
                                                                            <td class='model_0'></td>
                                                                            <td class='sku_0'></td>
                                                                            <td class='price_0'></td>
                                                                            <td style="display:none;" class='item_id_0'></td>
                                                                            <td class='purchase_price_0'></td>
                                                                            <td style="display:none;" class='category_id_0'></td>
                                                                            <!-- <td class='warehouse_0'></td> -->
                                                                            <?php foreach ($inventoryTechnician as $tech => $value): ?>
                                                                            <td class='warehouse_<?=$value[' id ']?>_0'></td>
                                                                            <?php endforeach ?>
                                                                            <td class='remove_item_0'></td>

                                                                            <td class='brand_0' style='display:none'></td>
                                                                            <td class='sub_category_id_0' style='display:none'></td>
                                                                        </tr>
                                                                        <tr height=10px>
                                                                            <td></td>
                                                                        </tr>
                                                                        <?php
							//Telemarketers can not see technicians part
							if (($common->getLoggedUserRoleID() != "3")
								&&($common->getLoggedUserRoleID() != "9"))
							{
							?>
                                                                            <tr>
                                                                                <td class="techTable" style="vertical-align:top; display:none">
                                                                                    <!--<input type="button" value="Add Technician Sales" onclick="showAddItems(1)" />-->
                                                                                    <input style="width:initial;" type="button" value="Items" id="addTechnicianSales" />
                                                                                    <div style="width:50px;" class="loading_indicator" id="tech_loading"></div>
                                                                                    <input style="width:initial;" type="button" value="Close Items" id="closeTechnicianSales" />
                                                                                    <a style="display:none" id="addTechnicianSalesList" title="View Items in a List"></a>
                                                                                    <a style="display:none" id="addTechnicianSalesTree" title="View Items in a Tree"></a>
                                                                                    <input autocomplete="off" class='ajax_item_name' data-class="1" />
                                                                                    <a id="add_item_1" class="add_item_button" style="display: none;" href='javascript:add_unknown_item(1);'>Add to Inventory</a>
                                                                                    <table id='ajax_item_results_1'>
                                                                                        <thead>
                                                                                            <tr>
                                                                                                <?php if($_SESSION['user']['role_id'] != 1 || $estimate_page != 1) {?>
                                                                                                <input type="button" name="addPurchaseItem" class="addPurchaseItem" table-no="1" value="New Item">
                                                                                                <input type="button" name="add_item" value="Add" class="add_selected_items" style="margin-left: 42%" item-class="1">
                                                                                                <input type="button" name="delete_item" value="Remove" class="delete_selected_items" style="margin-left: 5px;">
                                                                                                <?php }?>
                                                                                            </tr>
                                                                                            <tr>
                                                                                                <th><b>Name</b></th>
                                                                                                <th><b>Model</b></th>
                                                                                                <th><b>Sku</b></th>
                                                                                                <th><b>Price</b></th>
                                                                                                <th style="display:none;"><b>Item Id</b></th>
                                                                                                <th><b>Purchase Price</b></th>
                                                                                                <th style="display:none;"><b>Category Id</b></th>
                                                                                                <th><b>War</b></th>
                                                                                                <?php foreach ($inventoryTechnician as $tech => $value): ?>
                                                                                                <th><b><?php echo $value['short_name'] ?></b></th>
                                                                                                <?php endforeach ?>
                                                                                                <th><b>Add/Remove</b></th>
                                                                                            </tr>
                                                                                        </thead>
                                                                                        <tbody></tbody>
                                                                                    </table>
                                                                                    <div class="clear_this"></div>
                                                                                    <div id="item_selector1" style="background:#f8f8f8;border:1px solid #333333;display:none;"></div>
                                                                                    <table id="CurrentItemsTableTech" cellspacing=0 colspacing=0 class="inResultsBooking">
                                                                                        <!--<tr onclick="showAddItems(1)" style="cursor:hand;background:#ffdddd">-->
                                                                                        <tr>
                                                                                            <th style="background:#ffdddd" align=left>Item</th>
                                                                                            <th class="order_warehouse_quantity" style="width:20px;background:#ffdddd;">Whs</th>
                                                                                            <th class="order_warehouse_quantity" style="width:20px;background:#ffdddd;">Tech</th>
                                                                                            <th style="width:30px ;background:#ffdddd">Part No.</th>
                                                                                            <th style="width:30px;background:#ffdddd">Item Qty</th>
                                                                                            <th style="width:50px;background:#ffdddd">Price</th>
                                                                                            <th style="width:50px;background:#ffdddd;color:red;">Disc</th>
                                                                                            <th style="width:50px;background:#ffdddd">Add</th>
                                                                                            <th style="width:50px;background:#ffdddd">Prch</th>
                                                                                            <th style="width:50px;background:#ffdddd">Sum</th>
                                                                                            <th class="order_item_status" style="width:20px;background:#ffdddd;">Order</th>
                                                                                            <th style="width:20px;background: #b7b2b2;"></th>
                                                                                            <th style="width:50px;background: #b7b2b2;">Tech</th>
                                                                                            <th style="width:50px;background: #b7b2b2;">Adjt</th>



                                                                                        </tr>
                                                                                        <tr id='ajax_item_result_template_1' style='display:none'>
                                                                                            <td class='name_1'>Result</td>
                                                                                            <td class='model_1'></td>
                                                                                            <td class='sku_1'></td>
                                                                                            <td class='price_1'></td>
                                                                                            <td style="display:none;" class='item_id_1'></td>
                                                                                            <td class='purchase_price_1'></td>
                                                                                            <td style="display:none;" class='category_id_1'></td>
                                                                                            <!-- <td class='warehouse_1'></td> -->
                                                                                            <?php foreach ($inventoryTechnician as $tech => $value): ?>
                                                                                            <td class='warehouse_<?=$value[' id ']?>_1'></td>
                                                                                            <?php endforeach ?>
                                                                                            <td class='remove_item_1'></td>
                                                                                            <td class='brand_1' style='display:none'></td>
                                                                                            <td class='sub_category_id_1' style='display:none'></td>
                                                                                        </tr>
                                                                                        <?php echo $tech_items; ?>
                                                                                        <tr>
                                                                                            <td id="NewItemsTech" class="newitem" colspan=7 style="display:none"></td>
                                                                                        </tr>
                                                                                    </table>
                                                                                </td>
                                                                            </tr>
                                                                            <tr>
                                                                                <td id="CurrentItemsTotal2" style="vertical-align:top; float:right; display:none"></td>
                                                                            </tr>
                                                                            <?php } ?>
                                                                    </table>
                                                                </td>
                                                            </tr>
                                                            <?php if($_SESSION['user']['role_id'] != 1 || $estimate_page != 1) {?>
                                                            <tr>
                                                                <td colspan=3 style="vertical-align:top">
                                                                    <div>
                                                                        <table id="notes_table">
                                                                            <tbody id="previous_notes">
                                                                                <?php foreach($notes as $note) { ?>
                                                                                <tr class="<?php echo $note['row_class'] ?>">
                                                                                    <td class="note_type <?php echo $note['note_type_name'] ?>" title="<?php echo $note['author_name'] ?> <?php echo $note['note_date'] ?>">
                                                                                        <?php echo $note['note_type_name'] ?>
                                                                                    </td>
                                                                                    <td class="note_urgency <?php echo $note['urgency_name'] ?>"><img src="<?php echo ROOT_URL ?>/app/webroot/img<?php echo $note['urgency_image'] ?>" title="<?php echo $note['urgency_name'] ?>" /></td>
                                                                                    <td class="note_message">
                                                                                        <?php echo $note['message'] ?>
                                                                                    </td>
                                                                                </tr>
                                                                                <?php } //END foreach notes ?>
                                                                            </tbody>


                                                                        </table>
                                                                        <table class="<?= $class ?>">
                                                                            <tbody>
                                                                                <tr>
                                                                                    <td colspan="2" class="urgency_td" style="display: none;">
                                                                                        <select name="data[Note][urgency_id]" id="NoteUrgencyId">
                                            <option value="1">Update</option>
                                            <option value="2">Issue</option>
                                            <option value="3">Solution</option>
                                            <option value="4">Approved</option>
                                        </select>
                                                                                    </td>
                                                                                    <?php
																																								$admin_notes1="";
																																								$admin_notes2="";
																																								$admin_notes3="";
																																								if(!empty($_REQUEST['job_type'])){
																																								$admin_notes1="Job Type:".$_REQUEST['job_type']."\n";
																																								}
																																								if(!empty($_REQUEST['message'])){
																																							$admin_notes2="Message:".$_REQUEST['message']."\n";
																																								}
																																								if(!empty($_REQUEST['coupon'])){
																																							$admin_notes3="Coupon:".$_REQUEST['coupon']."\n";;
																																								}

																																								?>
                                                                                        <td class="message_td" colspan="2"><strong> Admin Notes:</strong>
                                                                                            <?php echo $html->textarea('Note/message', array("value"=>$admin_notes1.$admin_notes3.$admin_notes2,'style' => "width:80%; height: 60px;")); ?>
                                                                                        </td>
                                                                                        <td><strong>Customer Invoice Notes:</strong>
                                                                                            <textarea style="width:86%; height: 60px;" name="data[Order][job_notes]" value="<?=$this->data['Order']['job_notes']?>"><?=$this->data['Order']['job_notes']?></textarea>
                                                                                        </td>
                                                                                </tr>
                                                                            </tbody>
                                                                        </table>
                                                                        <!-- <img src="<?php echo ROOT_URL."/app/webroot/img/order_signatures/".$this->data['Order']['id'] ?>.png"  /> -->
                                                                    </div>
                                                                    <div>
                                                                        <!--  <strong>Invoice Notes</strong>
                            <textarea style="width:86%; height: 60px;" name="data[Order][job_notes]" value="<?=$this->data['Order']['job_notes']?>"><?=$this->data['Order']['job_notes']?></textarea> -->
                                                                        <!-- <textarea style="width:86%; height: 60px;" name="data[Order][job_tech_notes]" value="<?=$this->data['Order']['job_tech_notes']?>"><?=$this->data['Order']['job_tech_notes']?></textarea> -->
                                                                    </div>
                                                                    <div>
                                                                        <strong class="<?= $class ?>">Techs Comment</strong>
                                                                        <!--  <textarea style="width:86%; height: 60px;" name="data[Order][job_tech_notes]" value="<?=$this->data['Order']['job_tech_notes']?>"><?=$this->data['Order']['job_tech_notes']?></textarea> -->
                                                                        <p>
                                                                            <?=$this->data['Order']['job_tech_notes']?>
                                                                        </p>
                                                                    </div>
                                                                    <table>
                                                                        <!-- loki comment -->
                                                                        <!-- <?php if ($_SESSION['user']['role_id'] == 6) {?>
							<tr>
								<td>&nbsp;&nbsp;Tech time in:
								<?php echo $html->hourOptionTag('Order/fact_job_beg', null, 1); ?>
								:
								<?php echo $html->minuteOptionTag('Order/fact_job_beg', null, 0); ?>
								<?php //echo $html->input('Order/parts_warranty', array('style' => 'width: 70px; cursor: hand; cursor: pointer;'));?>
								</td>
							</tr>
							<tr>
								<td>Tech time out:
								<?php echo $html->hourOptionTag('Order/fact_job_end', null, 1); ?>
								:
								<?php echo $html->minuteOptionTag('Order/fact_job_end', null, 0); ?>

								</td>
							</tr>
							<?php }?> -->
                                                                        <!-- <?php if ($_SESSION['user']['role_id'] == 6) {?>
							<tr>
								<td>
	                	    		<span>Preview Estimate:</span><img  style="width: 33px;position: relative;top: 10px" onclick="showestimateSubmit()" src="<?=ROOT_URL?>/app/webroot/img/icon-lg-all-bookings.png"/>
	                	    		<span id ="LastCallHistory" style="margin: 0px 0px 0px 15px;"></span>
								</td>
							</tr>
							<?php }?> -->

                                                                    </table>
                                                                </td>
                                                                <!-- loki commneted start -->
                                                                <td style="vertical-align:top">
                                                                    <table>
                                                                        <tr>
                                                                            <td id="CurrentItemsTotal" style="vertical-align:top;"></td>
                                                                        </tr>
                                                                        <input type="hidden" id="current_item_total" name="data[Order][current_item_total]">
                                                                    </table>
                                                                    <!-- <?php if ($_SESSION['user']['role_id'] == 6) {?>
												<table id="PaymentsSection" class="special_section" width=100%>
												<tr><td colspan=2>
																		<a id='add_payment_link' href='#'
																		onclick='$("#addnewform").show();$("#add_payment_link").hide();$("#cancel_payment_link").show();'>
																		Customer paid</a>
																		<a id='cancel_payment_link' href='#' style='display:none'
																		onclick='$("#addnewform").hide();$("#add_payment_link").show();$("#cancel_payment_link").hide();'>
																		Cancel</a>
																		<table id='addnewform' style='display:none'>
																		<tr>
																				<td>
																				<select id="method" onchange='ShowAN(this)'>
                                                                                    <option value="0">--</option>
																				<?php
																				foreach ($payment_methods as $id => $name)
																						echo "<option value='$id'>$name</option>";
																				?>
																				</select>
																				</td>
																				<td>
																						<input style="width:85px" id="amount" value=""/>
																				</td>
																				<td style="display:none;">
																						Auth #:<input style="width:85px;" id="auth_number" value=""/>
																				</td>
																				<td>
																						<input type='button' value='Save' onclick='SavePayment();'/>
																				</td>
																		</tr>
																		</table>
												</td></tr>
												<tr><td colspan=2 id='PaymentsDetails'></td></tr>
												</table>
												<?php } else {?>
												<table>
												  <tr>
														<td>Pay By:<br/>
														<?php echo $html->selectTag('Order/customer_payment_method_id', $payment_methods, $this->data['Order']['customer_payment_method_id']);?>
														</td>
												  </tr> -->
                                                                </td>
                                                                <!-- loki commneted end -->
                                                                <!-- <td></td> -->
                                                            </tr>
                                                            <?php }?>
                                                        </table>
                                                        <?php }?>
                                        </td>
                                    </tr>
                                    <!--             <tr class="visible">
					<td colspan="3" style="vertical-align:top">

				    </td>
					 <td>
					 	<span>Payment photo:</span>
					 	<?php

					 		if(isset($invoice_image_path) && !empty($invoice_image_path)){
						 		$imgPath =  '/acesys/app/webroot/payment-images/'.$invoice_image_path;
                                $uploadDisplay = 'display:none;';
                                $imageDisplay = 'display:block;'; ?>
						 	<?php }else{
                                $uploadDisplay = 'display:block;';
                                $imageDisplay = 'display:none;';?> <?php } ?>


                               <div id="order_paymnet_picture" style="<?php echo $imageDisplay?>">
                                    <div id="img-enlarge" title="Photo">
                                      <img class="rotate-image" src="<?php echo $imgPath; ?>" style="width:100%;">
                                      <?php echo $this->element('image_rotate'); ?>
                                      <button class="w3-btn"> <a href="#" onclick="this.href ='<?php echo $imgPath;?>'" download>Download</a> </button>
                                    </div>

                                    <div  style="position: relative; padding:0; width: 30px;">
                                        <span style="position:absolute;right: 0;"><img style="height: 15px;width: 12px;" id="delete-image" src="<?=ROOT_URL?>/app/webroot/img/cross-icon.jpeg" image-name="<?php echo $invoice_image_path; ?>"></span>
                                        <img id="openImg" class="img" src="<?php echo $imgPath; ?>" style="max-height: 100px; max-width: 100%; height: 50px; width: 50px;">
                                        <input type="button" class="receipt_btn" name="payment_receipt" id="payment_receipt" value="Email">
                                    </div>
                               </div>
						 	    <div id="upload_payment_picture" style="<?php echo $uploadDisplay?>">
                                    <img id="pre-image_photo1" class="pre-image_payment invoice-openImg" src="#" alt="your image" />
                                    <div  class="acecare-td-adjust" >
                                        <label for="Fileinput" >Upload</label>
                                        <input type="file" name="uploadFile" id="Fileinput" class="disply_preview" data-ct="payment">
                                    </div>
                                </div>

					 </td>
				</tr>   -->

                                    <?php if($_SESSION['user']['role_id'] != 1 || $estimate_page != 1) {?>
                                    <tr>
                                        <td colspan="4">
                                            <div>
                                                <strong class="<?= $class ?>">Payment</strong>
                                            </div>
                                        </td>
                                    </tr>
                                    <div>
                                        <strong>Payment</strong>

                                    </div>
                                    <?php }?>
                                    <tr class="<?= $class ?>">
                                        <?php if($_SESSION['user']['role_id'] != 1 || $estimate_page != 1) {?>
                                        <td colspan="4">
                                            <?php $lastkey = end(array_keys($this->data['CreditcardPaymentDetails'])); ?>
                                            <input type="hidden" name="payment_status" id="payment_status" value="<?php echo $this->data['CreditcardPaymentDetails'][$lastkey]['payment_status'];?>" />
                                            <?php if($this->data['CreditcardPaymentDetails'][$lastkey]['payment_status'] == 1){
                                        $payState = 'Approved';
                                        $paycolor = 'Green';
                                    } else if($this->data['CreditcardPaymentDetails'][$lastkey]['payment_status'] == 2){
                                        $paycolor = 'Red';
                                        $payState = 'Declined';
                                    }else if($this->data['CreditcardPaymentDetails'][$lastkey]['payment_status'] == 3){
                                        $payState = 'Authorization';
                                        $paycolor = 'Green';
                                    }else if($this->data['CreditcardPaymentDetails'][$lastkey]['payment_status'] == 4){
                                        $paycolor = 'Red';
                                        $payState = 'Not Authorized';
                                    }
                                    else{
                                        $paycolor = $color_status;
                                        $payState = $paid_status;
                                    }
                                ?>
                                            <table id="customerCreditInfo">
                                                <tr>
                                                    <td><b>Paid By</b></td>
                                                    <td>
                                                        <?php echo $html->selectTag('Order/paid_by', $payment_methods, $this->data['Payment']['payment_method']);?>
                                                    </td>
                                                    <td>Status:</td>
                                                    <td><span id="transaction_status" style="color: <?php echo $paycolor?>; font-weight: bold;"><?php echo $payState?></span></td>

                                                </tr>
                                                <tr>
                                                    <td>Name:</td>
                                                    <td><input type="text" name="data[Customer][credit_card_name]" value="<?= $this->data['Customer']['credit_card_name']?>" id="creditCardName1"></td>
                                                    <td>Auth:</td>
                                                    <td> <span id="transaction_auth"><?php echo $this->data['CreditcardPaymentDetails'][$lastkey]['auth_code'];?></span></td>
                                                </tr>
                                                <tr>
                                                    <td>Card:</td>
                                                    <?php if($this->data['Customer']['id'] == ''){?>
                                                    <td><input type="text" name="data[Customer][credit_card_number]" value="<?= $this->data['Customer']['credit_card_number']?>" id="creditCardNum1"></td>
                                                    <?php } else {?>
                                                    <td><input type="text" name="data[Customer][credit_card_number1]" value="<?= $this->data['Customer']['credit_card_number']?>" id="creditCardNum1"></td>
                                                    <?php } ?>
                                                    <td>Total Paid: </td>
                                                    <td><span id="transaction_amount"><?php echo $this->data['CreditcardPaymentDetails'][$lastkey]['amount'];?></span></td>
                                                </tr>
                                                <tr>
                                                    <td><b>Exp:</b></td>
                                                    <td>
                                                        <select name="data[Customer][card_exp_month]" id="cardExpMonth1">
                                         <option <? echo ($this->data['Customer']['card_exp_month'] == "00") ? 'selected' : ''; ?> value="00">--</option>
                                        <option <? echo ($this->data['Customer']['card_exp_month'] == "01") ? 'selected' : ''; ?> value="01">01</option>
                                        <option <? echo ($this->data['Customer']['card_exp_month'] == "02") ? 'selected' : ''; ?> value="02">02</option>
                                        <option <? echo ($this->data['Customer']['card_exp_month'] == "03") ? 'selected' : ''; ?> value="03">03</option>
                                        <option <? echo ($this->data['Customer']['card_exp_month'] == "04") ? 'selected' : ''; ?> value="04">04</option>
                                        <option <? echo ($this->data['Customer']['card_exp_month'] == "05") ? 'selected' : ''; ?> value="05">05</option>
                                        <option <? echo ($this->data['Customer']['card_exp_month'] == "06") ? 'selected' : ''; ?> value="06">06</option>
                                        <option <? echo ($this->data['Customer']['card_exp_month'] == "07") ? 'selected' : ''; ?> value="07">07</option>
                                        <option <? echo ($this->data['Customer']['card_exp_month'] == "08") ? 'selected' : ''; ?> value="08">08</option>
                                        <option <? echo ($this->data['Customer']['card_exp_month'] == "09") ? 'selected' : ''; ?> value="09">09</option>
                                        <option <? echo ($this->data['Customer']['card_exp_month'] == "10") ? 'selected' : ''; ?> value="10">10</option>
                                        <option <? echo ($this->data['Customer']['card_exp_month'] == "11") ? 'selected' : ''; ?> value="11">11</option>
                                        <option <? echo ($this->data['Customer']['card_exp_month'] == "12") ? 'selected' : ''; ?> value="12">12</option>
                                </select>
                                                        <select name="data[Customer][card_exp_year]" id="cardExpYear1">
                                     <option value="0">--</option>
                                    <?php for($i = 20; $i <= 45; $i++){?>
                                        <option <? echo ($this->data['Customer']['card_exp_year'] == $i) ? 'selected' : ''; ?> value="<?=$i?>"><?php echo $i;?></option>
                                    <?php } ?>
                                </select>(MM/YY) &nbsp <b>Cvv:</b> <input type="text" name="data[Customer][card_cvv]" value="<?= $this->data['Customer']['card_cvv']?>" id="creditCardCvv1">
                                                    </td>
                                                    <td>Sale Amount:</td>
                                                    <td><input type="text" name="saleAmount" id="saleAmount"></td>
                                                </tr>
                                                <tr>
                                                    <!-- <td colspan="4"></td> -->
                                                    <td class="tdpadding1"><input type="button" class="cardBtn" name="useOldCard" value="Use this card" id="useOldCard"></td>
                                                    <td class="tdpadding1"><input type="button" class="cardBtn" name="useNewCard" value="New Card" id="useNewCard"> &nbsp <input type="button" class="cardBtn" name="saveCard" value="Save" id="saveCard"></td>
                                                    <!-- <td class="tdpadding1"><input type="button" class="cardBtn" name="saveCard" value="Save" id="saveCard"></td> -->
                                                    <td colspan="3" class="tdpadding1"></td>

                                                    <td class="tdpadding1">
                                                        <input type="button" <?php echo ($this->data['Order']['payment_status'] == 1) ? 'disabled' : '' ?> name="preAuth" id="preAuthTrans" value="Pre-Authz"> &nbsp
                                                        <input type="button" <?php echo ($this->data['Order']['payment_status'] == 1) ? 'disabled' : '' ?> name="cardTransaction" id="cardTransaction" value="Charge">
                                                    </td>
                                                </tr>
                                            </table>
                                        </td>
                                        <?php }?>
                                    </tr>
                                    <?php if($_SESSION['user']['role_id'] != 1 || $estimate_page != 1) {?>
                                    <tr class="<?= $class ?>">
                                        <td colspan="2"></td>

                                        <td class="tdpadding1" align="right">
                                            <?php
                                        if(isset($invoice_image_path) && !empty($invoice_image_path)){
                                            $imgPath =  '/acesys/app/webroot/payment-images/'.$invoice_image_path;
                                            $uploadDisplay = 'display:none;';
                                            $imageDisplay = 'display:block;'; ?>
                                                <?php }else{
                                            $uploadDisplay = 'display:block;';
                                            $imageDisplay = 'display:none;';?>
                                                <?php } ?>

                                                <div id="order_paymnet_picture" style="<?php echo $imageDisplay?>">
                                                    <div id="img-enlarge" title="Photo">
                                                        <img class="rotate-image" src="<?php echo $imgPath; ?>" style="width:100%;">
                                                        <?php echo $this->element('image_rotate'); ?>
                                                        <button class="w3-btn"> <a href="#" onclick="this.href ='<?php echo $imgPath;?>'" download>Download</a> </button>
                                                    </div>

                                                    <div style="position: relative; padding:0; width: 30px;">
                                                        <span style="position:absolute;right: 0;"><img style="height: 15px;width: 12px;" id="delete-image" src="<?=ROOT_URL?>/app/webroot/img/cross-icon.jpeg" image-name="<?php echo $invoice_image_path; ?>"></span>
                                                        <img id="openImg" class="img" src="<?php echo $imgPath; ?>" style="max-height: 100px; max-width: 100%; height: 50px; width: 50px;">
                                                    </div>

                                                </div>
                                                <div id="upload_payment_picture" style="<?php echo $uploadDisplay?>">
                                                    <img id="pre-image_photo1" class="pre-image_payment invoice-openImg" src="#" alt="your image" />
                                                    <div class="acecare-td-adjust" style="width: 33%">
                                                        <label for="Fileinput" style="background: #8e8e8e">Upload Image</label>
                                                        <input type="file" name="uploadFile" id="Fileinput" class="disply_preview" data-ct="payment">
                                                    </div>
                                                </div>
                                        </td>
                                        <td class="tdpadding1" align="left"><input type="button" name="payImage" value="Save Image" id="savePayImage"></td>
                                    </tr>
                                    <?php }?>
                                </table>

                                <br/>
                                <!--&nbsp;<b><u>If Cancelled, Put the Reason:</u></b> <?php //echo $html->selectTag('Order/cancellation_reason', $cancellationReasons);?> -->
                                <div style="float: left; text-align: left;">
                                    <br/>

                                    <input type="hidden" name="reschedulerequest" id="reschedulerequest" value="0">
                                    <?php
				// Accountants have no permission to save orders
					$ShowSave = true;
					if ($common->getLoggedUserRoleID() == "4") $ShowSave = false;
					//Telemarketers have no rigts to save done or cancelled by office documents
					if (($common->getLoggedUserRoleID() == "13")||($common->getLoggedUserRoleID() == "3")||($common->getLoggedUserRoleID() == "9"))
					{
						if ($this->data['Order']['order_status_id']=="5")
							$ShowSave = false;
						else
							$ShowSave = true;
					}
					/*if ($ShowSave)
					{
						echo $html->submit("Save", array("class" => "buttons","onclick" => "ValidateFields(); return false;" ));
						echo "&nbsp;&nbsp;&nbsp;";
						echo $html->submit("Save & Send", array("class" => "buttons","onclick" => "javascript:document.getElementById('havetoprint').value=1;ValidateFields(); return false;" ));
					}*/
					?>
                                        <?php if($ShowSave) { ?>
                                        <?php if($this->data['Order']['id'] != 0) {

					?>

                                        <?php if ($common->getLoggedUserRoleID() == 1) {?>

                                        <input type="button" value="Preview Estimate" onclick="showestimateSubmit()" class="buttons">

                                        <input type="button" id="mailbut" send-estmt="<?= $this->data['Order']['estimate_sent']?>" frm-estmt="<?=$from_estimate?>" value="Send Estimate" onclick="sendEmail(<?php echo $this->data['Order']['id'] ?>)" class="buttons">
                                        <input type="button" value="Save" onclick="javascript:document.getElementById('havetoprint').value=1;ValidateFields(); return false;" class="buttons">
                                        <?php } else { ?>

                                        <input type="button" value="Save" onclick="javascript:document.getElementById('havetoprint').value=1;ValidateFields(); return false;" class="buttons">


                                        <input type="button" id="mailbut" send-estmt="<?= $this->data['Order']['estimate_sent']?>" frm-estmt="<?=$from_estimate?>" value="Send Estimate" onclick="sendEmail(<?php echo $this->data['Order']['id'] ?>)" class="buttons">
                                        <?php } ?>
                                        <input type="button" value="Booked" onclick="ValidateFields(1);" class="buttons">
                                        <input type="button" value="Reminder" onclick="showInvoiceReview(1);" class="buttons">

                                        <?php if ($common->getLoggedUserRoleID() == 6) { ?>
                                        <input type="button" value="Cancelled" onclick="javascript:document.getElementById('havetoprint').value=3;ValidateFields(3);" class="buttons">
                                        <?php if($this->data['Order']['order_status_id'] == 5) { ?>
                                        <input type="button" value="Done by Tech" style="color:#666;" disabled="disabled" class="buttons">
                                        <?php } else { ?>
                                        <input type="button" value="Done by Tech" onclick="ValidateFields(5);" class="buttons">
                                        <?php } ?>
                                        <input type="button" value="Estimate Reminder" onclick="showEstimateReminder(<?= $this->data['Order']['order_number'];?>);" class="buttons"> &nbsp;&nbsp;&nbsp;
                                        <input type="button" value="Exit" onclick="history.go(-1);" class="buttons">
                                        <?php } ?>
                                        <?php } else {
						 if ($common->getLoggedUserRoleID() == 1 && $showPreview == 1){
								echo '<input type="button"  class="buttons" value="Preview Estimate" onclick="showestimateSubmit()" >';

								echo "&nbsp;&nbsp;&nbsp;";

								echo '<input type="button"  class="buttons" value="Send Estimate" onclick="sendEmail('.$this->data['Order']['id'].')" >';

								echo "&nbsp;&nbsp;&nbsp;";

								echo $html->submit("Save", array("class" => "buttons","onclick" => "javascript:document.getElementById('havetoprint').value=1;ValidateFields(1,1); return false;" ));
								?>
                                        <!-- <input type="button" value="Exit" onclick="location.href='<?=BASE_URL?>/orders/invoiceTablet'" class="buttons"> -->
                                        <input type="button" value="Exit" onclick="history.go(-1);" class="buttons">
                                        <?}
							else if($common->getLoggedUserRoleID() == 1) {
								echo $html->submit("Save", array("class" => "buttons","onclick" => "javascript:document.getElementById('havetoprint').value=1;ValidateFields(1,1); return false;" ));
								echo '&nbsp;&nbsp;&nbsp;<input type="button" value="Exit" onclick="history.go(-1);" class="buttons">';
							}
							else {
								echo $html->submit("Save", array("class" => "buttons","onclick" => "javascript:document.getElementById('havetoprint').value=1;ValidateFields(1,1); return false;" ));

								echo "&nbsp;&nbsp;&nbsp;";

								echo '<input type="button"  class="buttons" value="Send Estimate" onclick="sendEmail('.$this->data['Order']['id'].')" >';
                echo "&nbsp;&nbsp;&nbsp;";
                echo '<input type="button"  class="buttons" value="Save to Organiser" onclick="saveorgniser()" >';
								echo '&nbsp;&nbsp;&nbsp;<input type="button" value="Exit" onclick="history.go(-1);" class="buttons">';
							}
						} ?>
                                            <?php } ?>
                                            <!--  &nbsp;&nbsp;&nbsp;<input type="button" value="Exit" onclick="history.go(-1);" class="buttons">
 -->


                                            <br/>
                                </div>
                                </div>
                                </div>
                                <?php } ?>
                                <?php
				if(!empty($this->data['Order']['id']) && $common->getLoggedUserRoleID() == 3 ){ ?>


                                    <?php 	}
			else { ?>
                            </td>
                        </tr>
                    </table>
                    <?php	}
				?>


                        <div id="tabA3" style="display:<?=$page3?>">
                            <!-- Calls history -->
                            <div class="frame-wrap">
                                <div class="frame-header-left"></div>
                                <div class="frame-header-title">Calls history</div>
                                <div class="frame-header-right"></div>
                                <div class="frame-body" style="clear: both;">
                                    <div id="CallHistory"></div>
                                    <div></div>
                                    <div id="TotalJobHistory"></div>
                                </div>
                                <!--frame-body-->
                            </div>
                            <!--frame-wrap-->
                        </div>
                        <?php
   if($common->getLoggedUserRoleID()!=3){
$display="display:none";
   }
   else {
       $display="";
   }
   ?>
                            <div id="tabA7" style="display:<?=$page7?>; width:100%">
                                <!-- Calls history -->
                                <div class="dialer-sec">
                                    <table cellspacing=0 cellpadding=0>
                                        <tr>
                                            <td class="special_section" id="show-new-booking" onclick="location.href='./editBooking?customer_id=<?=$this->data['Customer']['id']?>&order_id=0';">
                                                <u style="color:blue">New booking</u>
                                            </td>
                                            <td class="special_section" id="OpenHistoryText">
                                                <a href="<?php echo BASE_URL ?>/orders/editBooking?customer_id=<?=$this->data['Customer']['id']?>&job_truck=&job_time_beg=&job_date=<?php echo urlencode(date('d M Y'));?>&job_technician1_id=0&job_technician2_id=0&from_tech_page=1&show_preview=1&estimate=1"
                                                    style="color:blue">New Estimate</a>
                                                <img id="JobHistoryWorking" style="display:none" src="<?=ROOT_URL?>/app/webroot/img/wait30trans.gif" />
                                            </td>
                                            <td class="special_section" id="OpenHistoryText" onclick="OpenJobsHistory()">
                                                <u style="color:blue">Show history</u>
                                                <img id="JobHistoryWorking11" style="display:none" src="<?=ROOT_URL?>/app/webroot/img/wait30trans.gif" />
                                            </td>
                                            <td class="special_section" id="CloseHistoryText" onclick="CloseJobsHistory()" style="display:none">
                                                <u style="color:blue">Hide history</u>
                                            </td>

                                            <td class="special_section" onclick="CheckWithSchedule()">
                                                <u style="color:blue;cursor:pointer">Show Schedule</u>
                                            </td>
                                            <td class="special_section" onclick="CheckWithTimeslot()">
                                                <u style="color:blue;cursor:pointer">Timeslots</u>
                                            </td>
                                            <style>
                                                a.print {
                                                    color: #00F;
                                                    text-decoration: none;
                                                    background-color: #FFF;
                                                    border: 1px solid #69F;
                                                    display: inline-block;
                                                    border-radius: 2px;
                                                    padding: 2px;
                                                }
                                            </style>
                                            <td class="special_section" style="cursor:auto;">
                                                <img src="<?=ROOT_URL?>/app/webroot/img/icon-vsm-printer.png" style="vertical-align:middle; float:left; margin-right:3px;" /> Print
                                                <select name="print_r" id="print_r" onchange="invoiceprint(<?=$this->data[" Order "]["id "]?>);">
                    	<option></option>
                    	<option value="invoiceprint">Complete</option>
                    	<option value="invoiceprintnototal">No Total</option>
                    	<option value="invoiceprintblank">Blank</option>
                    	<option value="invoiceTabletPrint">Questions On</option>
                    	<!-- <option value="estimateTabletPrint">Estimate Template</option> -->
                    </select>
                                            </td>


                                            <?php if ($_SESSION['user']['role_id'] == 6) {?>
                                            <td class="special_section">
                                                <input type="button" value="Email Invoice" onclick="emailInvoice(<?=$this->data[" Order "]["id "]?>);" name="invoice-email">
                                                <?php }?>
                                            </td>
                                        </tr>
                                    </table>
                                    <table id="Dialler-Job-History123456" class="special_section123456" style="display:none;width: 100%;" cellspacing=0 cellpadding=0>
                                        <!-- <tr>
					  <td style="clear: both;background:#FFFFEE;"></td>
					</tr> -->
                                    </table>
                                    <div class="" style="padding-bottom:10px;border-bottom: 1px solid black;<?= $display ?>">
                                        <form name="tele_form" id="tele_form">
                                            <input type="hidden" name="booking_cus_id" id="booking_cus_id" value="<?= $_REQUEST['customer_id']; ?>">
                                            <input type="hidden" name="sc_from" id="sc_from" value="<?= date('Y-m-d') ?>">
                                            <input type="hidden" name="max_time" id="choose_time" value="<?= $max_time ?>">
                                            <input type="hidden" name="max_km" id="choose_km" value="<?= $max_km ?>">
                                            <input type="hidden" name="sc_to" id="sc_to" value="<?= date('Y-m-d', strtotime('+6 days')); ?>"> zip:
                                            <input type="text" name="postal_code" id="postal_code" value="" style="width:130px;border-radius: 10px;
    background: none;

    padding: 2px;"> AM/PM:
                                            <select class="emboss" style="width:100px;" id="sc_period">
         <option value=""></option>
         <option value="am">AM</option>
         <option value="pm">PM</option>
        </select> Service:
                                            <select class="map_services emboss">

				<?php
foreach ($allTypes as $v => $k):
?>
<?php
if($k=='AC'){
 $k="Repair";
}
if($k=='Furnace'){
 $k="Service";
}
if($v==1){
$selected="selected";
}
else {
    $selected="";
}

?>
<option value="<?= $v?>"<?php echo $selected ?>><?=$k ?></option>


<?php endforeach; ?>

				</select>
                                            <span style="width:54px;cursor:pointer" class="btn btn-wht search_schedule123">Search</span>
                                        </form>
                                    </div>
                                    <div class="dialer-hdr clearfix">
                                        <a href="0javascript:void(0)" class="pitch-icon">pitch</a>
                                        <div style="text-align: right;">
                                            <a style="<?= $display; ?>" href="javascript:void(0)" onclick="CheckWithScheduleAdmin()" class=" btn btn-wht">All route</a>
                                            <a style="<?= $display; ?>" href="javascript:void(0)" onclick="CheckWithSchedule()" class=" btn btn-wht">Single</a>

                                        </div>
                                    </div>
                                    <div id="myModal123" class="modal1">

                                        <!-- Modal content -->
                                        <div class="modal-content1">
                                            <div class="modal-header1">
                                                <span class="close">&times;</span>
                                                <h2>Schedule</h2>
                                            </div>
                                            <div class="modal-body">
                                                please wait fetching results
                                                <div class="schedule">


                                                </div>
                                            </div>

                                        </div>

                                    </div>

                                    <div class="dailer-txt">
                                        <textarea class="form-control" placeholder="Message"><?php echo $pitch?></textarea>
                                    </div>
                                    <!-- end dailer-txt-->
                                    <div class="dialer-ctn">
                                        <div class="work-ctn clearfix">
                                            <h2 class="title"><span>Last Work</span> </h2>
                                            <div class="dialer-left">
                                                <div class="dialer-tbl">
                                                    <table id="Dialler-Job-History" class="special_section" style="display:none;width: 100%;" cellspacing=0 cellpadding=0>
                                                        <!-- <tr>
					  <td style="clear: both;background:#FFFFEE;"></td>
					</tr> -->
                                                    </table>
                                                </div>
                                            </div>
                                            <!--end dialer-left-->
                                            <div class="dialer-right">
                                                <div class="dialer-book">
                                                    <ul>
                                                        <li><a onclick="location.href='./editBooking?customer_id=<?=$this->data['Customer']['id']?>&order_id=0&is_dialer=1';" class="btn btn-yellow answer_reply select-button" id="new_booking" clr="1">Book </a></li>
                                                        <li><a onclick="showCallBack(0)" class="btn btn-yellow answer_reply select-button" clr="2">Call Back </a></li>
                                                        <li><a href="javascript:void(0)" class="btn btn-teal answer_reply select-button" clr="6">Answer Machine </a></li>
                                                        <li><a href="javascript:void(0)" class="btn btn-teal btn-teal-r answer_reply select-button" clr="7">Not In Service </a></li>
                                                        <li><a href="javascript:void(0)" class="btn btn-teal answer_reply select-button" clr="11">Busy </a></li>
                                                        <li><a href="javascript:void(0)" class="btn btn-teal btn-teal-r answer_reply select-button" clr="3">Do not call </a></li>
                                                        <!-- <li><a href="javascript:void(0)" class="btn btn-teal">Not Intrested </a></li> -->
                                                        <li>
                                                            <select class="btn btn-teal select-button" id="dialer-call-result">
							  <option value="">Not Interested</option>
							  <option value="4">3 Month</option>
							  <option value="8">6 Month</option>
							  <option value="9">9 Month</option>
							</select>
                                                        </li>

                                                        <input type="hidden" value="<?php echo $orderNo; ?>" id="orderNo">
                                                        <input type="hidden" value="<?php echo $is_booking; ?>" id="answer_reply">
                                                        <li class="sub-w100"><a onclick="SaveDialerCallRecord()" class="btn btn-navy">Submit</a></li>
                                                    </ul>
                                                    <div class="dialer-book-ftr clearfix">
                                                        <a href="javascript:void(0)" onclick="showHotListData('p')" class="btn btn-blue btn-bk">Back </a>
                                                        <a onclick="showHotListData('n')" class="btn btn-blue btn-nxt call_next_user">Next </a>
                                                    </div>
                                                    <!--end dialer-book-ftr-->
                                                </div>
                                                <!--end dialer-book-->
                                            </div>
                                            <!--end dialer-right-->
                                        </div>
                                        <!--end work-ctn-->
                                        <div class="call-ctn clearfix">
                                            <h2 class="title"><span>Last Call</span> </h2>
                                            <div class="dialer-left">
                                                <div class="dialer-tbl" style="width: 525px;height: 105px;" id="Dialler-Call-History"></div>
                                            </div>
                                            <!--end dialer-left-->
                                        </div>
                                        <!--end work-ctn-->
                                    </div>
                                    <!--end dialer-ctn-->
                                    <div class="dialer-ftr clearfix">
                                        <div class="ftr-left">
                                            <a href="javascript:void(0)" onclick="setcallmode(1)" class="btn btn-wht select-call-mode-button">Pause </a>
                                            <a href="javascript:void(0)" onclick="setcallmode(2)" class="btn btn-wht select-call-mode-button">Manual </a>
                                            <a href="javascript:void(0)" onclick="setcallmode(3)" class="btn btn-wht select-call-mode-button">Auto </a>
                                        </div>

                                        <div class="ftr-right">
                                            <div class="num-fild"><input type="text" id="direct-call" class="form-control" placeholder="Type number" /></div>

                                            <div class="call-fild">
                                                <a href="javascript:void(0)" onclick="directPlaceCall();" class="fa fa-phone"> </a>
                                                <span id="end_current_call_span">
						<a href="javascript:void(0)" id="end_current_call" class="fa fa-times"> </a>
					</span>
                                                <a href="javascript:void(0)" onclick="callTransfer();" class="fa fa-phone-square"> </a>
                                                <a href="javascript:void(0)" onclick="callRecord();" class="fa fa-microphone"> </a>
                                            </div>
                                        </div>
                                    </div>
                                    <!--end dialer-ftr-->
                                    <div id="CallActivityDiv"></div>
                                    <div id="APIMessageLog"></div>
                                </div>
                                <!--end dialer-sec-->
                            </div>
                            <div id="tabA11" style="display:<?=$page11?>; width:100%">
                                <div>
                                    <h1>Email History</h1>
                                </div>
                                <div>
                                    <input type="button" class="hide_show_btn" name="showEmail" value="Show History" id="showEmailHistory" onclick="showHideEmail(1);" />
                                    <input type="button" class="hide_show_btn" name="hideEmail" value="Hide History" id="hideEmailHistory" onclick="showHideEmail(2);" />
                                    <input type="button" style="float: right;" class="hide_show_btn" name="deleteAll" value="Hide Email" id="deleteAll" />
                                </div>
                                <!-- <br> -->
                                <div style="width:10px">
                                    <h3>Sent</h3>
                                </div>
                                <div id="sent_email">
                                    <table class="tab11-table">
                                        <tr>
                                            <th>Sent On</th>
                                            <th>Status</th>
                                            <th>Subject</th>
                                            <!-- <th>Job type</th> -->
                                            <th>Message</th>
                                            <th><input id="markAll" type="checkbox" name="delete_all" />Hide All</th>
                                        </tr>
                                        <?php
			 foreach($emailLogs as $log) { ?>
                                            <tr>
                                                <td><b><?php echo $log['sent_date'] ?></b></td>
                                                <?php if (1 == $log['delivery_status']) {
				 		echo '<td style="color:green"><b>Sent</b></td>';
				 	} elseif (("" != $log['delivery_status'])) {
				 		echo '<td style="color:red"><b>Failed</b></td>';
				 	}
				 	else{
				 		echo '<td></td>';
				 	}
				 	?>
                                                <td>
                                                    <?php echo $log['subject'] ?>
                                                </td>
                                                <!-- <td><?php echo $log['job_type_name'] ?></td> -->
                                                <input type="hidden" name="button_type" id="button_type" value="2" />

                                                <textarea class="log_content" style="display:none" id="log_content_<?=$log['id']?>"><?=$log['message']?></textarea>
                                                <!-- <input type="textarea"> -->
                                                <td><input type="button" class="viewContents" name="viewContents" value="View Content" content_id="<?=$log['id']?>"></td>
                                                <td><input type="checkbox" class="delete_email" name="markCheck[]" value="<?=$log['id']?>"></td>
                                            </tr>
                                            <? }?>
                                    </table>
                                </div>
                                <div>
                                    <h3>Received</h3>
                                </div>
                                <div>
                                    <table class="tab11-table">
                                        <tr>
                                            <th>Received Date</th>
                                            <th>Subject</th>
                                            <th>Message</th>
                                        </tr>
                                        <?php
			 foreach($receivedLogs as $log) { ?>
                                            <tr>
                                                <td><b><?php echo $log['mail_date'] ?></b></td>
                                                <td>
                                                    <?php echo $log['subject'] ?>
                                                </td>
                                                <textarea style="display:none" id="received_log_content_<?=$log['id']?>"><?=$log['body']?></textarea>
                                                <!-- <input type="textarea"> -->
                                                <td><input type="button" class="receiveViewContents" name="receiveViewContents" value="View Content" content_id="<?=$log['id']?>"></td>
                                            </tr>
                                            <? }?>
                                    </table>
                                </div>
                            </div>
                            <div id="tabA10" style="display:<?=$page10?>; width:100%">
                                <table class="recording">
                                    <tr>
                                        <th>Date</th>
                                        <th>Time</th>
                                        <th>File</th>
                                    </tr>


                                    <?php
	 //print_r($recordings);
		 foreach($callRecordings as $recording) {
		 	 $recName = $recording["media_name"];
//			 $chunks = str_split($recName, 2);
////Convert array to string.  Each element separated by the given separator.
//$result = implode(':', $chunks);

$result = substr($recName, 0, 4);

$result1 = substr($recName, 4, 4);

$result2 = substr($recName, 8, 6);

$chunks1 = str_split($result1, 2);
//Convert array to string.  Each element separated by the given separator.
$result3 = implode('-', $chunks1);

$chunks2 = str_split($result2, 2);
//Convert array to string.  Each element separated by the given separator.
$result4 = implode(':', $chunks2);

$result5 = implode('/',$chunks1); ?>

                                        <tr>
                                            <td>
                                                <?= $result."/".$result5 ?>
                                            </td>
                                            <td>
                                                <?= $result4 ?>
                                            </td>
                                            <td><audio controls><source src="<?php echo  ADUIO_REC_PATH.$recName ?>" type="audio/wav"></audio></td>
                                        </tr>


                                        <?php


		 	 //echo '<tr><td href="javascript:void(0)"><span>'.$result2.'</span><audio controls><source src="'.ADUIO_REC_PATH.$recName.'" type="audio/wav"></audio></td></tr>';
		  }?>
                                </table>
                            </div>
                            <div id="tabA13" style="display:<?=$page13?>; width:100%">


                                <?php
																$get_counter=0;
																foreach($new_images as $images){
																$get_images = explode(',',$images[1]);
																$get_ids = explode(',',$new_images_id[$get_counter][0]);
																$name="";
																if(empty($images[2])){
																$date="";
																}
																else {
																$date=$images[2];
																}
																$image_id = $images[0];
																?>
                                    <div class="images_div">
                                        <input type="text" value="<?= $images[3] ?>" class="save_label">
                                        <input type="date" value="<?= $date ?>" class="save_date">
                                        <br>

                                        <?php
																	$id_counter=0;
																	foreach($get_images as $images1){

																	$year = substr($images1, 0, 4);
        $mon = substr($images1, 4, 2);
        $day = substr($images1, 6, 2);
        $name = $year.'/'.$mon.'/'.$day.'/'.$images1;
								$ext = pathinfo($images1, PATHINFO_EXTENSION);
								if($ext=='pdf'){ ?>
                                            <span style="position:absolute;"><img style="height: 15px;width: 12px;" class="delete-purchase-image" src="<?=ROOT_URL?>/app/webroot/img/cross-icon.jpeg" image-name="<?php echo $name; ?>" image-id="<?php echo $get_ids[$id_counter]; ?>"></span>
                                            <a href="<?php echo ROOT_URL.'/upload_photos/'.$name;?>" target="_blank"><img style="cursor: pointer;height: 100px;width: 70px;" id="" class="" src="<?php echo ROOT_URL.'/app/webroot/images/pdf.jpg';?>"></a>
                                            <input type="checkbox" name="emailImage[]" class="installImages" value="<?php echo $name;?>">
                                            <?php		}
								else { ?>
                                                <span style="position:absolute;"><img style="height: 15px;width: 12px;" class="delete-purchase-image" src="<?=ROOT_URL?>/app/webroot/img/cross-icon.jpeg" image-name="<?php echo $name; ?>" image-id="<?php echo $get_ids[$id_counter]; ?>"></span>
                                                <img id="" class="invoice-openImg order-images" src="<?php echo ROOT_URL.'/upload_photos/'.$name;?>">
                                                <input type="checkbox" name="emailImage[]" class="installImages" value="<?php echo $name;?>">
                                                <?php	}

																	?>






                                                    <?php
																$image_id++;
																$id_counter++;
																} ?>

                                                        <button data-customer="<?= $images[4] ?>" data-date="<?= $date ?>" class="save_order_images">save</button>

                                    </div>
                                    <?php
															$get_counter++;
															}

																?>
                                        <!--<table style="width:100%" class="imagesTable">
        <tr>
    <th>image</th>
    <th>ref no</th>
    <th>date</th>
		<th>type</th>
  </tr>


         <?php foreach ($allImages as $key => $value) {

            ?>
						<tr>

            <td>
                <div style="position: relative; padding:0;">
                   <?php if($value['extension'] == 'pdf') {?>
                       <span style="position:absolute;"><img style="height: 15px;width: 12px;" class="delete-invoice-image" src="<?=ROOT_URL?>/app/webroot/img/cross-icon.jpeg" image-name="<?=$value['image_name'];?>"></span>
                          <img class="show-pdf-image" src="<?=ROOT_URL?>/app/webroot/img/doc_pdf.png" data-doc_lnk="<?php echo '/acesys/upload_photos/'.$value['image_name'];?>" style="height: 70px;width: 70px;"  >
                    <?php } else {?>
                       <span style="position:absolute;"><img style="height: 15px;width: 12px;" class="delete-purchase-image" src="<?=ROOT_URL?>/app/webroot/img/cross-icon.jpeg" image-name="<?php echo $value['image_name']; ?>" image-id="<?php echo $value['id']; ?>">
                       </span>
                        <img id="" class="invoice-openImg order-images" src="<?php echo ROOT_URL.'/upload_photos/'.$value['image_name'];?>">

										<?php } ?>
                </div>
                <input type="checkbox" name="emailImage[]" class="installImages" value="<?php echo $value['image_name'];?>">
            </td>

						<td><?= $value1;  ?></td>
						<td><?= $get_date;  ?></td>
						<td><?= $value['type'];  ?></td>


        <?php } ?>

    </table>-->


                                        &nbsp;<b><i>Date:</i></b>&nbsp;<input type="date" name="dates_images" id="dates_images" value="<?php echo date('Y-m-d'); ?>">
                                        <br><br> &nbsp;
                                        <b><i>Notes:</i></b>&nbsp;<input style="width:400px;" type="text" name="label_images" id="label_images">

                                        <table style="width:100%" class="imagesTable">

                                            <tr>
                                                <td>
                                                    <img id="pre-image-pdf" class="show-pdf-image" src="<?=ROOT_URL?>/app/webroot/img/doc_pdf.png" data-doc_lnk="" alt="your image" style="display: none;" />
                                                    <div class="cls-acecare-td-adjust">
                                                        <label for="sortpicture1">Upload</label>
                                                        <input type="file" name="sortpic1[]" id="sortpicture1" class="disply_preview_image" data-ct="photo1">
                                                    </div>
                                                    <!-- <img id="pre-image_photo1" class="pre-image_photo1 invoice-openImg" src="#" alt="your image" /> -->
                                                    <!-- <div class="cls-acecare-td-adjust">
                        <label for="sortpicture1" >Upload</label>
                        <input type="file" name="sortpic1[]" id="sortpicture1" class="disply_preview_image" data-ct="photo1">
                    </div> -->
                                                </td>
                                                <td>
                                                    <img id="pre-image-pdf" class="show-pdf-image" src="<?=ROOT_URL?>/app/webroot/img/doc_pdf.png" data-doc_lnk="" alt="your image" style="display: none;" />
                                                    <div class="cls-acecare-td-adjust">
                                                        <label for="sortpicture2">Upload</label>
                                                        <input type="file" name="sortpic1[]" id="sortpicture2" class="disply_preview_image" data-ct="photo2">
                                                    </div>
                                                </td>
                                                <td>
                                                    <img id="pre-image-pdf" class="show-pdf-image" src="<?=ROOT_URL?>/app/webroot/img/doc_pdf.png" data-doc_lnk="" alt="your image" style="display: none;" />
                                                    <div class="cls-acecare-td-adjust">
                                                        <label for="sortpicture3">Upload</label>
                                                        <input type="file" name="sortpic1[]" id="sortpicture3" class="disply_preview_image" data-ct="photo3">
                                                    </div>
                                                </td>
                                                <td>
                                                    <img id="pre-image-pdf" class="show-pdf-image" src="<?=ROOT_URL?>/app/webroot/img/doc_pdf.png" data-doc_lnk="" alt="your image" style="display: none;" />
                                                    <div class="cls-acecare-td-adjust">
                                                        <label for="sortpicture4">Upload</label>
                                                        <input type="file" name="sortpic1[]" id="sortpicture4" class="disply_preview_image" data-ct="photo4">
                                                    </div>
                                                </td>
                                                <td>
                                                    <img id="pre-image-pdf" class="show-pdf-image" src="<?=ROOT_URL?>/app/webroot/img/doc_pdf.png" data-doc_lnk="" alt="your image" style="display: none;" />
                                                    <div class="cls-acecare-td-adjust">
                                                        <label for="sortpicture5">Upload</label>
                                                        <input type="file" name="sortpic1[]" id="sortpicture5" class="disply_preview_image" data-ct="photo5">
                                                    </div>
                                                </td>
                                            </tr>

                                            <tr style="text-align: center;">
                                                <!-- <td colspan="2"><span>Permit Number:</span><input type="text" name="permitNum" id="permitNum" value="<?=$this->data['Order']['permit_number']?>"></td> -->
                                                <td colspan="4"></td>
                                                <td><input type="button" name="saveImage" id="saveImages" value="Save" style="padding: 5px;background: white;"></td>
                                            </tr>
                                            <tr>
                                                <td colspan="5">
                                                    <table id="PermitsSection" class="special_section" style=" width:100%; background-color:#EEEEFF;<?=$show_permits?>">
                                                        <tr>
                                                            <td colspan=2><a href="<?=BASE_URL;?>/orders/permit?city=<?=$this->data['Customer']['city']?>" target="_blank">Permit application</a></td>
                                                            <td>Permit #:</td>
                                                            <td>
                                                                <input type="text" name="data[Order][permitNum1]" id="permitNum" value="<?=$this->data['Order']['permit_number']?>">
                                                                <!-- <?php echo $html->input('Order/permit_number1', array('style' => 'width: 100px;')); ?> -->
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td>Application date:</td>
                                                            <td>
                                                                <input name="data[Order][permit_applied_date1]" style="width: 85px; cursor: hand; cursor: pointer;" onclick="scwShow(this,event);" onkeydown="return false;" value="<?=$this->data['Order']['permit_applied_date']?>" type="text" id="OrderPermitAppliedDate1">

                                                                <!-- <?php echo $html->input('Order/permit_applied_date1', array('style' => 'width: 85px; cursor: hand; cursor: pointer;', 'onclick' => 'scwShow(this,event);', 'onkeydown' => 'return false;'));?> -->
                                                            </td>
                                                            <td>Applied by:</td>
                                                            <td>
                                                                <?php echo $html->selectTag('Order/permit_applied_user1', $booking_sources, $this->data['Order']['permit_applied_user']);?>
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td>Application method:</td>
                                                            <td>
                                                                <?php echo $html->selectTag('Order/permit_applied_method1', $allPermitMethods, $this->data['Order']['permit_applied_method']);?>
                                                            </td>
                                                            <td>Application status:</td>
                                                            <td>
                                                                <?php echo $html->selectTag('Order/permit_result1', $allPermitStates, $this->data['Order']['permit_result']);?>
                                                            </td>
                                                            <td>
                                                                <input type="button" value="Save" id="savePermitInfo" style="padding: 5px;background: white;">
                                                            </td>
                                                        </tr>
                                                    </table>
                                                </td>
                                            </tr>
                                            <tr style="outline: 1px solid black;background: white;text-align: center;">
                                                <td class="tdpadding"><span>Email to:</span>
                                                    <input type="text" name="officerEmail" id="officerEmail">
                                                </td>
                                                <td colspan="2" class="tdpadding">
                                                    <span>Pictures Only</span>&nbsp<input type="checkbox" chkVal="1" class="permitChk" name="pictures only" id="picturesOnly">
                                                    <span>New Permit</span>&nbsp<input type="checkbox" chkVal="2" class="permitChk" name="newPermit" id="newPermit">
                                                    <span>Failed Permit</span>&nbsp<input type="checkbox" chkVal="3" class="permitChk" name="failedPermit" id="failedPermit">
                                                </td>
                                                <td class="tdpadding">
                                                    <input type="button" name="previewPermit" id="previewPermit" value="Preview">
                                                </td>
                                                <td class="tdpadding"><input type="button" value="Send" id="sendImageToOfficer"></td>
                                            </tr>
                                            <!--  <tr>
            <td colspan="3"></td>

        </tr> -->
                                        </table>
                            </div>
                            <div id="tabA5" style="display:none">
                                <!-- Changes history -->
                                <div class="frame-wrap">
                                    <div class="frame-header-left"></div>
                                    <div class="frame-header-title">Changes history</div>
                                    <div class="frame-header-right"></div>
                                    <div class="frame-body" style="clear: both;">
                                        <table>
                                            <tr>
                                                <td>Created:</td>
                                                <td><b><?=$created_date;?></b></td>
                                                <td><b>by&nbsp;<?=$created_by;?></b></td>
                                            </tr>
                                            <tr>
                                                <td>Last modified:</td>
                                                <td><b><?=$modified_date;?></b></td>
                                                <td><b>by&nbsp;<?=$modified_by;?></b></td>
                                            </tr>
                                        </table><br/>
                                        <div id="ChangesHistory"></div>
                                    </div>
                                    <!--frame-body-->
                                    <div>
                                        <input type="button" value="Print" onclick="window.open('<?=BASE_URL?>/orders/printView?id=<?=$this->data[" Order "]["id "]?>');return false;" class="buttons" />
                                        <input type="hidden" name="reschedulerequest1" id="reschedulerequest" value="0" />
                                        <!-- And finally, the submit button-->
                                        <?php
					// Accountants have no permission to save orders
					$ShowSave = true;
					if ($common->getLoggedUserRoleID() == "4") $ShowSave = false;
					//Telemarketers have no rigts to save done or cancelled by office documents
					if (($common->getLoggedUserRoleID() == "13")||($common->getLoggedUserRoleID() == "3")||($common->getLoggedUserRoleID() == "9"))
					{
						if ($this->data['Order']['order_status_id']=="5")
							$ShowSave = false;
						else
							$ShowSave = true;
					}
					if ($ShowSave)
					{
						echo $html->submit("Save & Send", array("class" => "buttons","onclick" => "javascript:document.getElementById('havetoprint').value=1;ValidateFields(); return false;" ));
						echo $html->submit("Estimate", array("class" => "buttons","onclick" => "ValidateFields(8); return false;" ));
					}
					?>
                                            &nbsp;&nbsp;&nbsp;<input type="button" value="Exit" onclick="history.go(-1);" class="buttons">
                                    </div>
                                </div>
                                <!--frame-wrap-->
                            </div>
                            <div id="tabA15" style="display:none">
                                <div class="header" style="width:100%">
                                    <table style="margin-right: 25%;margin-top: 2%;">
                                        <tr>
                                            <td style="padding-bottom: 5%;">Service type:</td>
                                            <td style="padding-bottom: 5%;">
                                                <?=$this->data['Type']['name']?>
                                            </td>
                                        </tr>
                                        <tr>
                                            <?php
                    $subtotal1 = 0;
                    foreach ($this->data['BookingItem'] as $key => $value) {
                        $subtotal1 += ($value['price'] * $value['quantity']) - $value['discount'] + $value['addition'];
                    }
                    $tax1 = round($subtotal1*0.05,2);

                    $total1 = $subtotal1 + $tax1;

                 ?>
                                                <td style="padding-bottom: 5%;"><strong>Invoice total:</strong></td>
                                                <td style="padding-bottom: 5%;">
                                                    <?php echo $HtmlAssist->prPrice($total1); ?>
                                                </td>
                                        </tr>
                                        <tr>
                                            <td style="padding-bottom: 5%;">Payment Type:</td>
                                            <td id="payment_type" style="padding-bottom: 5%;">
                                                <?=$this->data['OrderPaymentMethod']['name']?>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style="padding-bottom: 5%;"><strong>Paid Amount:</strong></td>
                                            <td id="paid_amount" style="padding-bottom: 5%;">
                                                <?=$this->data['Payment']['paid_amount']?>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style="padding-bottom: 5%;">Tech name 1:</td>
                                            <td style="padding-bottom: 5%;">
                                                <?=$this->data['Technician1']['first_name'].' '.$this->data['Technician1']['last_name']?>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style="padding-bottom: 5%;">Tech name 2:</td>
                                            <td style="padding-bottom: 5%;">
                                                <?=$this->data['Technician2']['name']?>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <a href="#" style="color: blue;" onclick="window.open('<?=BASE_URL?>/orders/invoiceTabletPrint?order_id=<?=$this->data[" Order "]["id "]?>&type=office');">Invoice</a>
                                            </td>
                                            <td>
                                                <input type="button" style="padding: 5px" name="email_invoice" id="sendReviewEmail" value="Email Invoice">
                                            </td>
                                        </tr>
                                    </table>
                                    <div class="call_book_div">
                                        Call to Book :
                                        <br>
                                        <textarea name="call_to_book" rows="15" cols="30" id="call_to_book" value="<? echo $this->data['Order']['call_to_book']; ?>"><? echo $this->data['Order']['call_to_book']; ?></textarea>

                                    </div>
                                    <div class="call_book_div">
                                        Send estimate :
                                        <br>
                                        <textarea name="send_estimate" rows="15" cols="30" id="send_estimate" value="<? echo $this->data['Order']['send_estimate']; ?>"><? echo $this->data['Order']['send_estimate']; ?></textarea>

                                    </div>
                                    <div class="call_book_div">
                                        Order Parts :
                                        <br>
                                        <textarea name="order_part" rows="15" cols="30" id="order_part" value="<? echo $this->data['Order']['order_part']; ?>"><? echo $this->data['Order']['order_part']; ?></textarea>

                                    </div>
                                    <div class="call_book_div">
                                        Notes for office only:
                                        <br>
                                        <textarea name="job_tech_notes" rows="15" cols="30" id="job_tech_notes" value="<? echo $this->data['Order']['job_tech_notes']; ?>"><? echo $this->data['Order']['job_tech_notes']; ?></textarea>

                                    </div>
                                    <div style="padding:15px;">
                                        Notes for customer-prints on invoice:
                                        <br>
                                        <textarea name="job_notes" style="width:42%" rows="15" cols="30" id="job_notes" value="<? echo $this->data['Order']['job_notes']; ?>"><? echo $this->data['Order']['job_notes']; ?></textarea>

                                    </div>
                                </div>

                                <div style="margin-top: 2%;width:700px">
                                    <p><b>Did you get a 5 star review?</b>

                                        <input type="checkbox" <?php echo ($this->data['Order']['review_answer'] == 1 ?'checked' : '') ?> name="review_answer" class= "review_answer" value="1">Yes <input type="checkbox" <?php echo ($this->data['Order']['review_answer']
                                        == 2 ?'checked' : '') ?> class= "review_answer" name="review_answer" value="2"> No
                                    </p>
                                    <p><b>Did Customer view their invoice with you?</b>
                                        <input type="checkbox" <?php echo ($this->data['Order']['invoice_answer'] == 1 ?'checked' : '') ?> name="invoice_answer" class= "invoice_answer" value="1">Yes <input type="checkbox" <?php echo ($this->data['Order']['invoice_answer']
                                        == 2 ?'checked' : '') ?> class= "invoice_answer" name="invoice_answer" value="2"> No
                                    </p>
                                    <p><b>Did you leave a sticker on customers furnace or boiler?</b>
                                        <input type="checkbox" <?php echo ($this->data['Order']['leave_sticker'] == 1 ?'checked' : '') ?> name="leave_sticker" class= "leave_sticker" value="1">Yes <input type="checkbox" <?php echo ($this->data['Order']['leave_sticker']
                                        == 2 ?'checked' : '') ?> class= "leave_sticker" name="leave_sticker" value="2"> No
                                    </p>
                                </div>
                                <table id="questions_template">
                                    <tr>
                                        <th>#</th>
                                        <th>Questions</th>
                                        <th>Responses</th>
                                        <th>Tech Comment</th>
                                        <th>Admin Comment
                                        </th>
                                        <th>Suggestions</th>
                                        <th>Decisions</th>
                                    </tr>
                                    <?php $row = ""; $index = 1;?>
                                    <?php foreach($questions as $question_id => $question) { ?>
                                    <?php $row = $index++%2==0?"even_row":"";?>
                                    <?php if($question['type'] == 'dropdown') { ?>
                                    <tr>
                                        <td class="<?php echo $row ?>">
                                            <?php echo $question['rank'] ?>
                                        </td>
                                        <td class="<?php echo $row ?>">
                                            <?php echo $question['value'] ?>
                                        </td>
                                        <td class="<?php echo $row ?>">
                                            <?php if(count($responses[$question_id]) > 0) { ?>
                                            <input type="hidden" class="question_id" value="<?php echo $question_id ?>" />
                                            <select class="responses1 rank<?php echo $question['rank'] ?> required" name="data[Template][<?php echo $question_id ?>][response_id]">
                    <option value="">?</option>
                    <?php foreach($responses[$question_id] as $response_id => $response) { ?>
                    <?php $is_selected = isset($working_answers[$question_id]['response_id'])&&$response_id==$working_answers[$question_id]['response_id']?'selected="selected"':isset($carried_answers[$question_id]['response_id'])&&$response_id==$carried_answers[$question_id]['response_id']?'selected="selected"':'' ?>

                    <option <?php echo $is_selected ?> value="<?php echo $response_id ?>"><?php echo $response['value'] ?></option>
                    <?php }//END foreach($responses[$question_id] as $response_id => $response) ?>
                </select>
                                            <?php }//END if ?>
                                        </td>
                                        <td class="error_indicator <?php echo $row ?>">
                                            <?php if(count($techresponses[$question_id]) > 0) { ?>
                                            <input type="hidden" class="question_id" value="<?php echo $question_id ?>" />
                                            <select class="text_response1 rank<?php echo $question['rank'] ?> required" name="data[Template][<?php echo $question_id ?>][text_id]" style="width: 150px">
                            <option value="">?</option>
                            <?php foreach($techresponses[$question_id] as $techresponse_id => $techresponse) { ?>
                            <?php $is_selected = isset($working_answers[$question_id]['text_id'])&&$techresponse_id==$working_answers[$question_id]['text_id']?'selected="selected"':isset($carried_answers[$question_id]['text_id'])&&$techresponse_id==$carried_answers[$question_id]['text_id']?'selected="selected"':'' ?>

                            <option <?php echo $is_selected ?> value="<?php echo $techresponse_id ?>"><?php echo $techresponse['value'] ?></option>
                            <?php }//END foreach($responses[$question_id] as $response_id => $response) ?>
                        </select>
                                            <?php }//END if ?>
                                        </td>
                                        <td class="error_indicator <?php echo $row ?>">
                                            <input type="hidden" class="question_id" value="<?php echo $question_id ?>" />
                                            <input type="text" class="admin_response rank<?php echo $question['rank'] ?> required" name="data[Template][<?php echo $question_id ?>][admin_response]" value="<?php echo isset($working_answers[$question_id]['admin_response'])?$working_answers[$question_id]['admin_response']:isset($carried_answers[$question_id]['admin_response'])?$carried_answers[$question_id]['admin_response']:'' ?>"
                                            />
                                        </td>
                                        <td class="<?php echo $row ?>">
                                            <?php if(count($responses[$question_id]) > 0) { ?>
                                            <?php foreach($responses[$question_id] as $response_id => $response) { ?>

                                            <?php if(count($suggestions[$response_id]) > 0) { ?>
                                            <input type="hidden" class="response_id" value="<?php echo $response_id ?>" />
                                            <?php
						if(isset($working_answers[$question_id]['suggestion_id']) && isset($working_answers[$question_id]['response_id']) && $response_id == $working_answers[$question_id]['response_id']) {
							$is_hidden = "";
							$is_disabled = "";
						} else {
							//$is_hidden = "hide";
							//$is_disabled = 'disabled="disabled"';
							if(isset($carried_answers[$question_id]['suggestion_id']) && isset($carried_answers[$question_id]['response_id']) && $response_id == $carried_answers[$question_id]['response_id']) {
								$is_hidden = "";
								$is_disabled = "";
							} else {
								$is_hidden = "hide";
								$is_disabled = 'disabled="disabled"';
							}
						}
					?>
                                                <select class="suggestions <?php echo $is_hidden ?> q<?php echo $question_id ?> required" id="r<?php echo $response_id ?>" name="data[Template][<?php echo $question_id ?>][suggestion_id]" <?php echo $is_disabled ?>>
                        <option value="">?</option>
                        <?php foreach($suggestions[$response_id] as $suggestion_id => $suggestion) { ?>
                        <?php $is_selected = isset($working_answers[$question_id]['suggestion_id'])&&$suggestion_id==$working_answers[$question_id]['suggestion_id']?'selected="selected"':isset($carried_answers[$question_id]['suggestion_id'])&&$suggestion_id==$carried_answers[$question_id]['suggestion_id']?'selected="selected"':'' ?>
                        <option <?php echo $is_selected ?> value="<?php echo $suggestion_id ?>"><?php echo $suggestion['value'] ?></option>
                        <?php }//END foreach($suggestions[$response_id] as $suggestion_id => $suggestion) ?>
                    </select>
                                                <?php }//END if ?>

                                                <?php }//END foreach($responses[$question_id] as $response_id => $response) ?>
                                                <?php }//END if ?>
                                        </td>
                                        <td class="<?php echo $row ?>">
                                            <?php if(count($responses[$question_id]) > 0) { ?>
                                            <?php foreach($responses[$question_id] as $response_id => $response) { ?>

                                            <?php if(count($suggestions[$response_id]) > 0) { ?>
                                            <?php foreach($suggestions[$response_id] as $suggestion_id => $suggestion) { ?>

                                            <?php if(count($decisions[$suggestion_id]) > 0) { ?>
                                            <input type="hidden" class="suggestion_id" value="<?php echo $suggestion_id ?>" />
                                            <?php
							if(isset($working_answers[$question_id]['decision_id']) && isset($working_answers[$question_id]['suggestion_id']) && $suggestion_id == $working_answers[$question_id]['suggestion_id']) {
								$is_hidden = "";
								$is_disabled = "";
							} else {
								//$is_hidden = "hide";
								//$is_disabled = 'disabled="disabled"';
								if(isset($carried_answers[$question_id]['decision_id']) && isset($carried_answers[$question_id]['suggestion_id']) && $suggestion_id == $carried_answers[$question_id]['suggestion_id']) {
									$is_hidden = "";
									$is_disabled = "";
								} else {
									$is_hidden = "hide";
									$is_disabled = 'disabled="disabled"';
								}
							}
						?>
                                                <select class="decisions <?php echo $is_hidden ?> q<?php echo $question_id ?> r<?php echo $response_id ?> required" id="s<?php echo $suggestion_id ?>" name="data[Template][<?php echo $question_id ?>][decision_id]" <?php echo $is_disabled ?>>
                            <option value="">?</option>
                            <?php foreach($decisions[$suggestion_id] as $decision_id => $decision) { ?>
                            <?php $is_selected = isset($working_answers[$question_id]['decision_id'])&&$decision_id==$working_answers[$question_id]['decision_id']?'selected="selected"':isset($carried_answers[$question_id]['decision_id'])&&$decision_id==$carried_answers[$question_id]['decision_id']?'selected="selected"':'' ?>
                            <option <?php echo $is_selected ?> value="<?php echo $decision_id ?>"><?php echo $decision['value'] ?></option>
                            <?php }//END foreach($decisions[$suggestion_id] as $decision_id => $decision) ?>
                        </select>
                                                <?php }//END if ?>

                                                <?php }//END foreach($suggestions[$response_id] as $suggestion_id => $suggestion) ?>
                                                <?php }//END if ?>

                                                <?php }//END foreach($responses[$question_id] as $response_id => $response) ?>
                                                <?php }//END if ?>

                                        </td>

                                    </tr>
                                    <?php }//END if($question['type'] == 'dropdown') ?>
                                    <?php if($question['type'] == 'text') { ?>
                                    <tr>
                                        <td class="<?php echo $row ?>">
                                            <?php echo $question['rank'] ?>
                                        </td>
                                        <td class="<?php echo $row ?>">
                                            <?php echo $question['value'] ?>
                                        </td>
                                        <td class="<?php echo $row ?>">
                                            <?php if(count($responses[$question_id]) > 0) { ?>
                                            <input type="hidden" class="question_id" value="<?php echo $question_id ?>" />
                                            <input type="text" class="text_response1 rank<?php echo $question['rank'] ?> required" name="data[Template][<?php echo $question_id ?>][response_text]" value="<?php echo isset($working_answers[$question_id]['response_text'])?$working_answers[$question_id]['response_text']:isset($carried_answers[$question_id]['response_text'])?$carried_answers[$question_id]['response_text']:'' ?>"
                                            />
                                            <div class="response_codes">
                                                <?php foreach($responses[$question_id] as $response_id => $response) { ?>
                                                <div class="code">
                                                    <input type="hidden" class="rank" value="<?php echo $question['rank'] ?>" />
                                                    <input type="hidden" class="id" value="<?php echo $response_id ?>" />
                                                    <input type="hidden" class="operation_id" value="<?php echo $response['operation_id'] ?>" />
                                                    <input type="hidden" class="which_id" value="<?php echo $response['which_id'] ?>" />
                                                    <input type="hidden" class="value" value="<?php echo $response['value'] ?>" />
                                                </div>
                                                <?php }//END foreach($responses[$question_id] as $response_id => $response) ?>
                                            </div>
                                            <?php }//END if ?>
                                        </td>
                                        <td class="error_indicator <?php echo $row ?>">
                                            <?php if(count($techresponses[$question_id]) > 0) { ?>
                                            <input type="hidden" class="question_id" value="<?php echo $question_id ?>" />
                                            <select class="text_response1 rank<?php echo $question['rank'] ?> required" name="data[Template][<?php echo $question_id ?>][text_id]" style="width: 150px">
                            <option value="">?</option>
                            <?php foreach($techresponses[$question_id] as $techresponse_id => $techresponse) { ?>
                            <?php $is_selected = isset($working_answers[$question_id]['text_id'])&&$techresponse_id==$working_answers[$question_id]['text_id']?'selected="selected"':isset($carried_answers[$question_id]['text_id'])&&$techresponse_id==$carried_answers[$question_id]['text_id']?'selected="selected"':'' ?>

                            <option <?php echo $is_selected ?> value="<?php echo $techresponse_id ?>"><?php echo $techresponse['value'] ?></option>
                            <?php }//END foreach($responses[$question_id] as $response_id => $response) ?>
                        </select>
                                            <?php }//END if ?>
                                        </td>
                                        <!--   <td class="error_indicator <?php echo $row ?>">
                     <input type="hidden" class="question_id" value="<?php echo $question_id ?>" />
                <input type="text" class="text_response1 rank<?php echo $question['rank'] ?> required" name="data[Template][<?php echo $question_id ?>][text_response]" value="<?php echo isset($working_answers[$question_id]['text_response'])?$working_answers[$question_id]['text_response']:isset($carried_answers[$question_id]['text_response'])?$carried_answers[$question_id]['text_response']:'' ?>" />
                </td>  -->
                                        <td class="error_indicator <?php echo $row ?>">
                                            <input type="hidden" class="question_id" value="<?php echo $question_id ?>" />
                                            <input type="text" class="text_response1 rank<?php echo $question['rank'] ?> required" name="data[Template][<?php echo $question_id ?>][admin_response]" value="<?php echo isset($working_answers[$question_id]['admin_response'])?$working_answers[$question_id]['admin_response']:isset($carried_answers[$question_id]['admin_response'])?$carried_answers[$question_id]['admin_response']:'' ?>"
                                            />
                                        </td>
                                        <td class="<?php echo $row ?>">
                                            <?php if(count($responses[$question_id]) > 0) { ?>
                                            <?php foreach($responses[$question_id] as $response_id => $response) { ?>

                                            <?php if(count($suggestions[$response_id]) > 0) { ?>
                                            <input type="hidden" class="response_id" value="<?php echo $response_id ?>" />
                                            <select class="suggestions hide q<?php echo $question_id ?> required" id="r<?php echo $response_id ?>" name="data[Template][<?php echo $question_id ?>][suggestion_id]" disabled="disabled">
                        <option value="">?</option>
                        <?php foreach($suggestions[$response_id] as $suggestion_id => $suggestion) { ?>
                        <?php $is_selected = isset($working_answers[$question_id]['suggestion_id'])&&$suggestion_id==$working_answers[$question_id]['suggestion_id']?'selected="selected"':isset($carried_answers[$question_id]['suggestion_id'])&&$suggestion_id==$carried_answers[$question_id]['suggestion_id']?'selected="selected"':'' ?>
                        <option <?php echo $is_selected ?> value="<?php echo $suggestion_id ?>"><?php echo $suggestion['value'] ?></option>
                        <?php }//END foreach($suggestions[$response_id] as $suggestion_id => $suggestion) ?>
                    </select>
                                            <?php }//END if ?>

                                            <?php }//END foreach($responses[$question_id] as $response_id => $response) ?>
                                            <?php }//END if ?>
                                        </td>
                                        <td class="<?php echo $row ?>">
                                            <?php if(count($responses[$question_id]) > 0) { ?>
                                            <?php foreach($responses[$question_id] as $response_id => $response) { ?>

                                            <?php if(count($suggestions[$response_id]) > 0) { ?>
                                            <?php foreach($suggestions[$response_id] as $suggestion_id => $suggestion) { ?>

                                            <?php if(count($decisions[$suggestion_id]) > 0) { ?>
                                            <input type="hidden" class="suggestion_id" value="<?php echo $suggestion_id ?>" />
                                            <select class="decisions hide q<?php echo $question_id ?> r<?php echo $response_id ?> required" id="s<?php echo $suggestion_id ?>" name="data[Template][<?php echo $question_id ?>][decision_id]" disabled="disabled">
                            <option value="">?</option>
                            <?php foreach($decisions[$suggestion_id] as $decision_id => $decision) { ?>
                            <?php $is_selected = isset($working_answers[$question_id]['decision_id'])&&$decision_id==$working_answers[$question_id]['decision_id']?'selected="selected"':isset($carried_answers[$question_id]['decision_id'])&&$decision_id==$carried_answers[$question_id]['decision_id']?'selected="selected"':'' ?>
                            <option <?php echo $is_selected ?> value="<?php echo $decision_id ?>"><?php echo $decision['value'] ?></option>
                            <?php }//END foreach($decisions[$suggestion_id] as $decision_id => $decision) ?>
                        </select>
                                            <?php }//END if ?>

                                            <?php }//END foreach($suggestions[$response_id] as $suggestion_id => $suggestion) ?>
                                            <?php }//END if ?>
                                            <?php }//END foreach($responses[$question_id] as $response_id => $response) ?>
                                            <?php }//END if ?>
                                        </td>

                                    </tr>
                                    <?php }//END if($question['type'] == 'text') ?>
                                    <?php }//END foreach($questions as $question_id => $question) ?>
                                </table>

                                <input type="button" id="save_answer" name="Save" value="Save" style="margin-top: 10px;padding: 5px;width: 15%;">
                                <input type="button" id="callback_btn" name="Save" value="CallBack" style="margin-top: 10px;padding: 5px;width: 15%;" onclick="showCallBack(1);">
                                <input type="button" id="new_book_btn" name="Book" value="BookAgain" style="margin-top: 10px;padding: 5px;width: 15%;" onclick="location.href='./editBooking?customer_id=<?=$this->data['Customer']['id']?>&order_id=0&is_dialer=1';">
                                <!-- <div>Callback Reason: <textarea id="followup-callback-note" value="" rows="15" cols="60"></textarea></div> -->
                                <!-- <form action="<?=BASE_URL;?>/settings/subCatImageUpload" class="dropzone"></form> -->
                            </div>
                            <!-- 	<div id="tabA16" style="display:none">
        <div id="masterDiv">
        <table style="border-spacing: 10px;">
            <tr>
                <td align="left">Status:</td>
                <td><input type="text" name="methodStatus" value="<?=$this->data['OrderPaymentMethod']['name'] ?>"></td>
                <td>&nbsp&nbsp Picture:</td>
                <td align="left">
                      <?php
                    if(isset($invoice_image_path) && !empty($invoice_image_path)){
                        $imgPath =  '/acesys/app/webroot/payment-images/'.$invoice_image_path;
                        $uploadDisplay = 'display:none;';
                        $imageDisplay = 'display:block;'; ?>
                    <?php }else{
                        $uploadDisplay = 'display:block;';
                        $imageDisplay = 'display:none;';?> <?php } ?>

                   <div id="order_paymnet_picture" style="<?php echo $imageDisplay?>">
                        <div id="img-enlarge" title="Photo">
                          <img class="rotate-image" src="<?php echo $imgPath; ?>" style="width:100%;">
                          <?php echo $this->element('image_rotate'); ?>
                          <button class="w3-btn"> <a href="#" onclick="this.href ='<?php echo $imgPath;?>'" download>Download</a> </button>
                        </div>

                        <div  style="position: relative; padding:0; width: 30px;">
                            <span style="position:absolute;right: 0;"><img style="height: 15px;width: 12px;" id="delete-image" src="<?=ROOT_URL?>/app/webroot/img/cross-icon.jpeg" image-name="<?php echo $invoice_image_path; ?>"></span>
                            <img id="openImg" class="img" src="<?php echo $imgPath; ?>" style="max-height: 100px; max-width: 100%; height: 50px; width: 50px;">

                        </div>

                    </div>
                    <div id="upload_payment_picture" style="<?php echo $uploadDisplay?>">
                        <img id="pre-image_photo1" class="pre-image_payment invoice-openImg" src="#" alt="your image" />
                        <div  class="acecare-td-adjust" >
                            <label for="Fileinput" >Upload</label>
                            <input type="file" name="uploadFile" id="Fileinput" class="disply_preview" data-ct="payment">
                        </div>
                    </div>
                </td>
                <td>
                   &nbsp&nbsp <input type="button" name="payImage" value="Save Image" id="savePayImage">
                </td>
            </tr>
        </table>
        </div>
        <div class="header creditCardDiv">
            <table class="creditCardTbl">
                <tr>
                    <td>Name:</td>
                    <td>
                        <?php if(empty($this->data['Customer']['credit_card_name'])){?>
                        <input type="text" name="creditName" id="creditName" value="<?= $this->data['Customer']['first_name'].' '.$this->data['Customer']['last_name']?>">
                        <?php } else{ ?>
                            <input type="text" name="creditName" id="creditName" value="<?= $this->data['Customer']['credit_card_name']?>">
                        <?php } ?>
                    </td>
                </tr>
                <tr>
                    <td>Card Number:</td>
                    <td><input type="text" name="creditCardNum" id="creditCardNum" value="<? echo $this->data['Customer']['credit_card_number']?>"></td>
                </tr>
                <tr>
                    <td>Expiration Date:</td>
                    <td><select id="cardExpMonth">
                         <option <? echo ($this->data['Customer']['card_exp_month'] == "00") ? 'selected' : ''; ?> value="00">--</option>
                        <option <? echo ($this->data['Customer']['card_exp_month'] == "01") ? 'selected' : ''; ?> value="01">01</option>
                        <option <? echo ($this->data['Customer']['card_exp_month'] == "02") ? 'selected' : ''; ?> value="02">02</option>
                        <option <? echo ($this->data['Customer']['card_exp_month'] == "03") ? 'selected' : ''; ?> value="03">03</option>
                        <option <? echo ($this->data['Customer']['card_exp_month'] == "04") ? 'selected' : ''; ?> value="04">04</option>
                        <option <? echo ($this->data['Customer']['card_exp_month'] == "05") ? 'selected' : ''; ?> value="05">05</option>
                        <option <? echo ($this->data['Customer']['card_exp_month'] == "06") ? 'selected' : ''; ?> value="06">06</option>
                        <option <? echo ($this->data['Customer']['card_exp_month'] == "07") ? 'selected' : ''; ?> value="07">07</option>
                        <option <? echo ($this->data['Customer']['card_exp_month'] == "08") ? 'selected' : ''; ?> value="08">08</option>
                        <option <? echo ($this->data['Customer']['card_exp_month'] == "09") ? 'selected' : ''; ?> value="09">09</option>
                        <option <? echo ($this->data['Customer']['card_exp_month'] == "10") ? 'selected' : ''; ?> value="10">10</option>
                        <option <? echo ($this->data['Customer']['card_exp_month'] == "11") ? 'selected' : ''; ?> value="11">11</option>
                        <option <? echo ($this->data['Customer']['card_exp_month'] == "12") ? 'selected' : ''; ?> value="12">12</option>
                    </select>
                    <select id="cardExpYear">
                         <option value="0">--</option>
                        <?php for($i = 20; $i <= 45; $i++){?>
                            <option <? echo ($this->data['Customer']['card_exp_year'] == $i) ? 'selected' : ''; ?> value="<?=$i?>"><?php echo $i;?></option>
                        <?php } ?>
                    </select>(MM/YY)
                    </td>
                </tr>
                <tr>
                    <td>Cvv:</td>
                    <td><input type="text" name="creditCvv" id="creditCvv" value="<? echo $this->data['Customer']['card_cvv'] ?>"></td>
                </tr>
                <tr>
                    <td>Sale Amount:</td>
                    <td><input type="text" name="saleAmount" id="saleAmount"></td>
                </tr>
                <tr>
                    <td>
                        <input type="button" name="saveCardInfo" id="saveCardInfo" value="Save">
                    </td>
                    <td><input type="button" name="view" value="view" id="showCreditcardInfo"></td>
                </tr>
            </table>
            <?php $lastkey = end(array_keys($this->data['CreditcardPaymentDetails'])); ?>
            <table class="cardStatusTbl">
                <tr>
                    <?php if($this->data['CreditcardPaymentDetails'][$lastkey]['payment_status'] == 1){
                        $payState = 'Approved';
                        $paycolor = 'Green';
                    } else if($this->data['CreditcardPaymentDetails'][$lastkey]['payment_status'] == 2){
                        $paycolor = 'Red';
                        $payState = 'Declined';
                    }else{
                        $paycolor = 'blue';
                        $payState = 'Not Done';
                    }
                ?>
                    <td>Payment Status: </td>
                    <td><span id="transaction_status" style="color: <?php echo $paycolor?>"><?php echo $payState?></span></td>
                </tr>
                <tr>
                    <td>Amount: </td>
                    <td><span id="transaction_amount"><?php echo $this->data['CreditcardPaymentDetails'][$lastkey]['amount'];?></span></td>
                </tr>
                <tr>
                    <td>Authorization: </td>
                    <td><span id="transaction_auth"><?php echo $this->data['CreditcardPaymentDetails'][$lastkey]['auth_code'];?></span></td>
                </tr>
                <tr>
                    <td>Date: </td>
                    <td><span id="transaction_date"><?php echo $this->data['CreditcardPaymentDetails'][$lastkey]['payment_date'];?></span></td>
                </tr>
            </table>
        </div>
        <input type="button" <?php echo ($this->data['Order']['payment_status'] == 1) ? 'disabled' : '' ?> name="cardTransaction" id="cardTransaction" value="Charge">
    </div> -->

                            </div>
                            </div>
                            </td>
                            </tr>
                            </table>
                            <div id="installation_item_append" style="display: none">
                            </div>
                            <input type="hidden" id="installation_notes_copy" name="data[Order][installation_notes]">
                            <div class="installation_item_box" title="Item" style="display: none">
                                <div id="installation_item_form">
                                    <table id="installation_item_table" class="inResultsBooking" style="width: 100%;">
                                        <thead>
                                            <tr>
                                                <th onclick="sortTable(0)" style="cursor: pointer;">Name</th>
                                                <th>Warehouse</th>
                                                <th onclick="sortTable(2)" style="cursor: pointer;">Default</th>
                                                <th>Tech</th>
                                                <th>Remaining</th>
                                                <th>Price</th>
                                                <th>Missing</th>
                                                <th>Sum</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                        </tbody>
                                        <!-- <tr>
				<td colspan="2"></td>
				<td>Total</td>
				<td><span class="installationTotal"></span></td>
			</tr> -->
                                    </table>
                                </div>
                                <div class="installationTotal"></div>
                                <span><b>Notes:</b></span><textarea class="ins_text" id="installation_notes" name="data[Order][installation_notes]"><?= $this->data['Order']['installation_notes'] ?></textarea>
                                <input type="button" id="saveInstallationItem" name="saveInstallationItem" value="Save">
                            </div>
                            <?php echo "Order ID: ".$this->data['Order']['id']?>
                            <?php echo " Customer ID: ".$this->data['Customer']['id']?>
                            <? echo $html->hiddenTag('rurl', $this->params['url']['rurl']); ?>
                                <?php //print_r($this->data['Order']) ?>
                                <!--<input type="button" onclick="alert(document.getElementById('CustomerId').value);" value="test customer" />-->
                                <input type="hidden" name="from_dialer" id="from_dialer" value="<?= $from_dialer?>" />
                                <input type="hidden" id="order_id" name="order_id" value="<?= $this->data['Order']['id']; ?>">
                </form>
                <div id="reminderEstimate" class="reminder-modal">
                    <!-- <body> -->
                    <div class="reminder-modal-content">
                        <h5>Your estimate was sent successfully.</h5>
                        <div style="margin-top: 10px; font-size: 12px;">
                            <span>Do you want to set a callback date?</span>&nbsp;&nbsp;
                            <span><b>Yes</b>&nbsp;<input type="checkbox" id="isCallback"></span>&nbsp;&nbsp;
                            <span><b>Callback Date:</b></span><input class="emboss" type="text" id="reminder-date1" name="reminderDate" style="width: 85px; cursor: hand; cursor: pointer;" onclick="scwShow(this,event);" onkeydown="return false;" value="<?=date('d M Y')?>">
                        </div>
                        <div style="font-size: 12px; font-weight: bolder;margin-top: 5px;">
                            <span>Note:</span><textarea style="height:30%;" class="reminder-message" id="reminder-message1" name="message" rows="4" cols="5"></textarea>
                        </div>
                        <input type="button" class="reminder-button" id="save-reminder-callback" name="OK" value="OK">
                    </div>
                    <!-- </body> -->
                </div>
                <div id="dialer_callback" style="display: none">
                    <!-- Modal content -->
                    <!-- <div class="modal-content"> -->
                    <!-- <span class="close">&times;</span> -->
                    <table>
                        <tr>
                            <td>Callback Date:</td>
                            <td>
                                <?php echo $html->input('CallRecord/callback_date', array('style' => 'width: 85px; cursor: hand; cursor: pointer;', 'onclick' => 'scwShow(this,event);', 'onkeydown' => 'return false;')); ?>
                                <?php echo $html->tagErrorMsg('CallRecord/callback_date','Please enter in a correct date for the callback.') ?>
                            </td>
                            <td>
                                <?php  if (($_SESSION['user']['role_id'] != 3)&&($_SESSION['user']['role_id'] != 9)) { ?> Call Date:
                                <?php } ?>
                            </td>
                            <td>
                                <?php  if (($_SESSION['user']['role_id'] != 3)&&($_SESSION['user']['role_id'] != 9)) { ?>
                                <?php echo $html->input('CallRecord/call_date', array('style' => 'width: 85px; cursor: hand; cursor: pointer;', 'onclick' => 'scwShow(this,event);', 'onkeydown' => 'return false;')); ?>
                                <?php echo $html->tagErrorMsg('CallRecord/call_date','Please enter in a correct date for the last call.') ?>
                                <?php } else { ?>
                                <?php echo $html->hidden('CallRecord/call_date'); ?>
                                <?php echo $html->input('CallRecord/call_date_disp', array('style' => 'width: 85px; cursor: hand; cursor: pointer;', 'disabled'=>'disabled', 'value'=>$this->data['CallRecord']['call_date'])); ?>
                                <?php } ?>
                            </td>
                        </tr>
                        <tr>
                            <td>Callback Time:</td>
                            <td>
                                <?php echo $html->hourOptionTag('CallRecord/callback_time', null, 1);/* . " : " . $html->minuteOptionTag('CallRecord/callback_time'); */?>
                                <input type="hidden" name="data[CallRecord][callback_time_min]" value="00" />
                            </td>
                            <td>
                                <?php  if (($_SESSION['user']['role_id'] != 3)&&($_SESSION['user']['role_id'] != 9)) { ?> Call Result:
                                <?php } ?>
                            </td>
                            <td>
                                <select id='CallRecordCallResultId' name="data['CallRecord']['call_result_id']">

					<option value=""></option>

					<?php
					foreach($call_results as $k => $v) {
						if($k != 10){
							echo '<option value="'.$k.'"'.( $k === 2 ? ' selected' : '').'>'.$v.'</option>';
						}
					}
					?>
					&nbsp;&nbsp;

				</select>
                            </td>
                        </tr>
                        <tr>
                            <td>Callback User:</td>
                            <td>
                                <?php echo $html->selectTag('CallRecord/callback_user_id', $booking_sources, $this->data['CallRecord']['callback_user_id']);?>
                                <?php echo $html->tagErrorMsg('CallRecord/callback_user_id','Please select the telemarketer who will call back.') ?>
                            </td>
                            <td>
                                <?php  if (($_SESSION['user']['role_id'] != 3)&&($_SESSION['user']['role_id'] != 9)) { ?> Called User:
                                <?php } ?>
                            </td>
                            <td>
                                <?php  if (($_SESSION['user']['role_id'] != 3)&&($_SESSION['user']['role_id'] != 9)) { ?>
                                <?php echo $html->selectTag('CallRecord/call_user_id', $booking_sources, $this->data['CallRecord']['call_user_id']);?>
                                <?php echo $html->tagErrorMsg('CallRecord/call_user_id','Please select the telemarketer who is responsible for this call.') ?>
                                <?php } else { ?>
                                <?php echo $html->hidden('CallRecord/call_user_id'); ?>
                                <?php echo $html->selectTag('CallRecord/call_user_id_disp', $booking_sources, $this->data['CallRecord']['call_user_id'], array('disabled'=>'disabled'));?>
                                <?php } ?>
                            </td>
                        </tr>
                        <tr>
                            <td colspan=4>
                                Call Notes: <br/>
                                <?php echo $html->textarea('CallRecord/call_note', array('style' => "width:400px; height: 50px;")); ?>
                                <?php echo $html->tagErrorMsg('CallRecord/call_note','Please enter the notes.') ?>
                            </td>
                        </tr>
                        <tr>
                            <td colspan=3>
                                <input type="button" value="Submit" onclick="javascript:SaveCallRecord();" class="buttons" />
                                <!-- <input type="button" value="Refresh" onclick="javascript:ShowCallHistory();" class="buttons"/> -->
                                <!-- <input type="button" value="Exit" onclick="history.go(-1);" class="buttons"> -->
                            </td>
                        </tr>
                    </table>
                    <!-- </div>   -->
                </div>
                <div id="editUserInfo">
                    <table>
                        <tr>
                            <td><b>Cell Phone:</b>
                            </td>
                            <td><input style="width:180px; font-size: 14px;" type="text" id="edit_cell_phone" name="editcellphone" value="<?=$this->data['Customer']['cell_phone']?>" />
                            </td>
                        </tr>

                        <tr>
                            <td><b>Phone:</b>
                            </td>
                            <td><input style="width:180px; font-size: 14px;" type="text" id="editphone" name="editphone" value="<?=$this->data['Customer']['phone']?>" />
                            </td>
                        </tr>
                        <tr>
                            <td><b>First Name:</b></td>
                            <td><input style="width:180px; font-size: 14px;" id="editFirstName" type="text" name="editFirstName" value="<?=$this->data['Customer']['first_name']?>" /></td>
                        </tr>
                        <tr>
                            <td><b>Last Name:</b></td>
                            <td><input style="width:180px; font-size: 14px;" id="editLastName" type="text" name="editLastName" value="<?=$this->data['Customer']['last_name']?>" /></td>
                        </tr>
                        <tr>
                            <td><b>Email:</b></td>
                            <td><input style="width:180px; font-size: 14px;" id="editEmail" type="text" name="editEmail" value="<?=$this->data['Customer']['email']?>" /></td>
                        </tr>
                        <tr>
                            <tr>
                                <td><b>Street Number:</b></td>
                                <td><input style="width:180px; font-size: 14px;" id="street_no" type="text" name="street_no" value="<?=$this->data['Customer']['address_street_number']?>" /></td>
                            </tr>
                            <tr>
                                <td><b>Street Name:</b></td>
                                <td><input style="width:180px; font-size: 14px;" id="street_name" type="text" name="street_name" value="<?=$this->data['Customer']['address_street']?>" /></td>
                            </tr>
                            <tr>
                                <td><b>City:</b></td>
                                <td>
                                    <?php echo $html->selectTag('city123', $allCities, $this->data['Customer']['city']); ?>

                                </td>
                            </tr>
                            <tr>
                                <!-- <td><b>Postal Code:</b></td> -->
                                <td><input style="width:180px; font-size: 14px;" id="postal_code123456" type="hidden" name="postal_code" value="<?=$this->data['Customer']['postal_code']?>" /></td>
                            </tr>

                            <td>
                                <input type="button" value="Submit" onclick="javascript:editUserInfo();" class="buttons" style="padding: 5px;margin-top: 5px;" />
                            </td>
                        </tr>
                        <!-- <input type="submit" value="submit"/> -->
                    </table>
                </div>
                <input type="hidden" id="ConnectionStatus" />
                <input type="hidden" id="currentCallNum" />
                <div class="invoice-img-enlarge" title="Photo" style="display: none">
                    <img src="" class="rotate-image" style="width:100%;">
                    <?php echo $this->element('image_rotate'); ?>
                    <button class="w3-btn"> <a href="#" onclick="this.href =" download>Download</a> </button>
                </div>
                <div class="invoice-pdf-enlarge" title="Photo" style="display: none">
                    <div id="doc-modal" style="width: 100%, height:100%"></div>
                </div>

                <div class="show_email_content" style="display: none, background-color: #ffffff">
                </div>
                <div class="show_sms_content" style="display: none, background-color: #ffffff">
                </div>
                <!-- Loki: Change markup and tech percent -->
                <div class="percentageBox" style="display: none, background-color: #ffffff">
                    <table class="percentTable">
                        <tr>
                            <td>
                                <input type="hidden" name="percentageItem" id="percentageItem">
                                <span><b>Mark up %:</b></span><input type="text" name="add_markup_percentage" id="add_markup_percentage" onchange="techMarkupChanges(this);" style="width: 25%;" value="<?php echo ($this->data['Order']['markup_percentage_type'] == 1) ? $this->data['Order']['markup_percentage'] :'' ?>"
                                    cal-type="markup" markupType="1">
                            </td>

                            <td>
                                <span><b>Tech %:</b></span><input type="text" name="add_tech_percentage" id="add_tech_percentage" onchange="techMarkupChanges(this);" style="width: 25%;" value="<?php echo ($this->data['Order']['tech_percentage_type'] == 1) ? $this->data['Order']['tech_percentage'] :'' ?>"
                                    cal-type="tech" purchaseType="1">
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <span><b>Mark-up $:</b></span><input type="text" name="add_markup_amount" id="add_markup_amount" onchange="techMarkupChanges(this);" style="width: 25%;" value="<?php echo ($this->data['Order']['markup_percentage_type'] == 2) ? $this->data['Order']['markup_percentage'] : '' ?>"
                                    cal-type="markup" markupType="2">
                            </td>

                            <td>
                                <span><b>Tech $:</b></span><input type="text" name="add_tech_amount" id="add_tech_amount" onchange="techMarkupChanges(this);" style="width: 25%;" value="<?php echo ($this->data['Order']['tech_percentage_type'] == 2) ? $this->data['Order']['tech_percentage'] : '' ?>"
                                    cal-type="tech" purchaseType="2">
                            </td>
                        </tr>
                        <tr>
                            <td colspan="2">
                                <input type="button" id="savePercentage" name="savePercentage" value="Save" style="padding: 3px;">
                            </td>
                        </tr>
                    </table>
                </div>
                <div id="myModal2" class="modal2">

                    <!-- Modal content -->
                    <div class="modal-content2">
                        <!-- <span class="close" onclick="close()">&times;</span>
                        <p>Some text in the Modal..</p>-->
                        <h5>postal code:</h5><input type="text" name="postal_code" id="postal_code123" value="<?= $_REQUEST['postal_code']; ?>">
                        <br><br>
                        <h5>Address:</h5><input type="text" onFocus="geolocate();" name="get_postal_code123" id="get_postal_code123" value="<?= $address; ?>">
                        <input type="hidden" name="sc_from" id="sc_from" value="<?= date('Y-m-d') ?>">
                        <input type="hidden" name="sc_to" id="sc_to" value="<?= date('Y-m-d', strtotime('+5 days')); ?>">
                        <br><br>
                        <h5>Job Type:</h5>
                        <select class="map_services123">
 <?php
 foreach($users123 as $user){
    if($user['name']=="Furnace"){
       $user['name']="Service";
    }
    if($user['name']=="AC"){
        $user['name']="Repair";
    }
    ?>
   <option value="<?=$user['id'] ?>"><?=$user['name'] ?></option>
<?php  }
 ?>

</select>
                        <br><br>
                        <span onclick="myFunction()" style="border: 2px solid black;padding: 5px;cursor: pointer;" id="form_submit">Submit</span>
                    </div>

                </div>
                <div id="reminderEmail" class="reminder-modal">
                    <div class="reminder-modal-content">
                        <input type="hidden" id="reminder-type-val" name="reminderType">
                        <input type="hidden" id="hide_modal" name="hide_modal">
                        <h3>Reminder Estimate</h3>
                        <table class="reminder-email-table">
                            <tr>
                                <td>
                                    <span>Callback Date:</span><input class="emboss" type="text" id="reminder-date" name="reminderDate" style="width: 85px; cursor: hand; cursor: pointer;" onclick="scwShow(this,event);" onkeydown="return false;" value="<?=date('d M Y')?>">
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <span>Note:</span><textarea class="reminder-message" id="reminder-message" name="message" rows="4" cols="30"></textarea>
                                </td>
                            </tr>
                        </table>
                        <input type="button" class="reminder-button" id="save-reminder-email" name="OK" value="OK">
                        <input type="button" class="reminder-button" name="cancel" value="Cancel" onclick="hideInvoiceReview();">
                    </div>
                </div>
                <script>
                    $(".showTechTable").live('click', function() {
                        $(".techTable").toggle();
                        // $("#CurrentItemsTotal2").toggle();

                    });
                    // openReviewBox
                    $(function() {
                        $("#reviewText").dialog({
                            modal: true,
                            autoOpen: false,
                            title: "Send Email",
                            autoOpen: false,
                            width: 700,
                            height: 500,
                        });
                        $('.openReviewBox').live('click', function() {
                            $.ajax({
                                url: '<?=BASE_URL?>/settings/getReviewTextContent',
                                dataType: 'json',
                                type: 'GET',
                                success: function(data) {
                                    if (tinymce.get("emailVal1")) {
                                        tinymce.remove('#emailVal1');
                                    }
                                    $('#emailVal1').val(data.msgBody);
                                    setTimeout(() => {
                                        addTinyMCE("#emailVal1");
                                    }, 10);
                                    $("#reviewText").dialog("open");
                                }
                            });
                        });
                    });
                    $('.permitChk').live("change", function() {
                        var $cur = $(this);
                        var $val = $(this).val();
                        if ($cur.is(":checked")) {
                            $('.permitChk').attr('checked', false);
                            $cur.attr('checked', true);
                        }
                    });

                    $(function() {
                        $("#permitTemp").dialog({
                            modal: true,
                            autoOpen: false,
                            title: "Send Email",
                            autoOpen: false,
                            width: 700,
                            height: 500,
                        });
                        $('#previewPermit').live('click', function() {
                            var count = 0;
                            var officerEmail = $('#officerEmail').val();
                            var permitNum = $('#permitNum').val();
                            var orderId = $('#OrderId').val();
                            $(".installImages").each(function() {
                                if ($(this).is(":checked")) {
                                    count++
                                }
                            });
                            if (count <= 0) {
                                alert('Please select atleast one image');
                            }
                            var permitVal = 0;
                            $(".permitChk").each(function() {
                                if ($(this).is(":checked")) {
                                    permitVal = $(this).attr("chkval");
                                }
                            });
                            if (permitVal < 2) {
                                alert("No preview available.");
                                return false;
                            }
                            if (officerEmail == '') {
                                alert("Please add Officer email address.");
                                return false;
                            }
                            $.ajax({
                                url: '<?=BASE_URL?>/orders/getPermitContent',
                                data: {
                                    orderId: orderId,
                                    permitNum: permitNum,
                                    permitVal: permitVal
                                },
                                dataType: 'json',
                                type: 'GET',
                                success: function(data) {
                                    if (tinymce.get("permitData")) {
                                        tinymce.remove('#permitData');
                                    }
                                    $('#permitData').val(data.msgBody);
                                    setTimeout(() => {
                                        addTinyMCE("#permitData");
                                    }, 10);
                                    $("#permitTemp").dialog("open");
                                }
                            });
                        });
                    });

                    $('#sendInstallImage').live('click', function(e) {
                        var permitVal = 0;
                        $(".permitChk").each(function() {
                            if ($(this).is(":checked")) {
                                permitVal = $(this).attr("chkval");
                            }
                        });
                        e.preventDefault();
                        var officerEmail = $('#officerEmail').val();
                        if (officerEmail == '') {
                            alert("Please add Officer email address.");
                            return false;
                        }
                        var formdata = new FormData($("#editBookingform_new")[0]);
                        formdata.append('permitVal', permitVal);
                        formdata.append('officerEmail', officerEmail);
                        var xhr = new XMLHttpRequest();
                        xhr.open('POST', "<?=BASE_URL;?>/orders/sendInstallImage", true);
                        xhr.onload = function(data) {
                            var response = JSON.parse(xhr.response);
                            if (response.res == 1) {
                                $("#sendImageBox").dialog("close");
                                alert('Images sent successfully.');
                            } else {
                                alert('Something went wrong in uploading file.');
                            }
                        };

                        xhr.send(formdata);
                    });

                    $(function() {
                        $("#sendImageBox").dialog({
                            modal: true,
                            autoOpen: false,
                            title: "Send Email",
                            autoOpen: false,
                            width: 200,
                            height: 150,
                        });
                        $('#sendImageToOfficer').live('click', function() {
                            var count = 0;
                            var officerEmail = $('#officerEmail').val();
                            $(".installImages").each(function() {
                                if ($(this).is(":checked")) {
                                    count++
                                }
                            });
                            if (count > 0) {
                                if (officerEmail == '') {
                                    alert("Please add Officer email address.");
                                    return false;
                                }
                                $("#sendImageBox").dialog("open");
                            } else {
                                alert('Please select atleast one image');
                            }
                        });
                    });


                    $(function() {
                        $("#sendSeparateEmail").dialog({
                            modal: true,
                            autoOpen: false,
                            title: "Send Email",
                            autoOpen: false,
                            width: 700,
                            height: 500,
                        });
                        $('.openMailBox').live('click', function() {
                            if (tinymce.get("emailVal2")) {
                                tinymce.remove('#emailVal2');
                            }
                            $('#emailVal2').val('Write Here');
                            setTimeout(() => {
                                addTinyMCE("#emailVal2");
                            }, 10);
                            $("#sendSeparateEmail").dialog("open");
                        });
                    });
                    $(function() {
                        $("#reviewEmail").dialog({
                            modal: true,
                            autoOpen: false,
                            title: "Send Email",
                            autoOpen: false,
                            width: 700,
                            height: 500,
                        });
                        $('.openReviewMailBox').live('click', function() {
                            $.ajax({
                                url: '<?=BASE_URL?>/settings/getReviewTextContent',
                                dataType: 'json',
                                type: 'GET',
                                success: function(data) {
                                    if (tinymce.get("reviewEmailVal1")) {
                                        tinymce.remove('#reviewEmailVal1');
                                    }
                                    $('#reviewEmailVal1').val(data.msgBody);
                                    setTimeout(() => {
                                        addTinyMCE("#reviewEmailVal1");
                                    }, 10);
                                    $("#reviewEmail").dialog("open");
                                }
                            });
                        });
                    });

                    $(function() {
                        $("#reminderSms").dialog({
                            modal: true,
                            autoOpen: false,
                            title: "Send SMS",
                            autoOpen: false,
                            width: 350,
                            height: 200,
                        });
                    });
                    $(function() {
                        $("#img-enlarge").dialog({
                            modal: true,
                            autoOpen: false,
                            title: "Photo",
                            autoOpen: false,
                            width: 900,
                            height: 764,
                        });
                        $("#openImg").click(function() {
                            $('#img-enlarge').dialog('open');
                        });
                    });
                    $(function() {
                        $("#img-enlarge1").dialog({
                            modal: true,
                            autoOpen: false,
                            title: "Photo",
                            autoOpen: false,
                            width: 900,
                            height: 764,
                        });
                        $("#openImg1").click(function() {
                            $('#img-enlarge1').dialog('open');
                        });
                    });
                    $(function() {
                        $("#editUserInfo").dialog({
                            modal: true,
                            autoOpen: false,
                            title: "Edit Customer",
                            autoOpen: false,
                            width: 320,
                            height: 300,
                        });
                    });

                    $(function() {
                        $(".invoice-img-enlarge").dialog({
                            modal: true,
                            autoOpen: false,
                            title: "Photo",
                            autoOpen: false,
                            width: 900,
                            height: 764,
                        });
                        $(".invoice-openImg").live("click", function() {
                            var imgPath = $(this).attr('src');
                            $('.invoice-img-enlarge img').attr('src', imgPath);
                            $('.invoice-img-enlarge a').attr('href', imgPath);
                            $('.invoice-img-enlarge').dialog('open');
                        });
                    });

                    $(function() {
                        $(".invoice-pdf-enlarge").dialog({
                            modal: true,
                            autoOpen: false,
                            title: "Photo",
                            autoOpen: false,
                            width: 900,
                            height: 764,
                        });

                        $(".show-pdf-image").live("click", function(e) {
                            e.preventDefault();
                            var imgPath = $(this).attr('data-doc_lnk');
                            if (imgPath !== undefined) {
                                var docFrame = '<iframe width="100%" height="100%" src="' + imgPath + '" frameborder="0" scrolling="no" id="myFrame" ></iframe>';
                                $('#doc-modal').html('');
                                $('#doc-modal').append(docFrame);
                                $('#doc-modal').load(docFrame);
                            } else {
                                $('#doc-modal').html('Sorry some error found');
                            }
                            $('.invoice-pdf-enlarge').dialog('open');
                        });
                    });
                    $(function() {
                        $(".percentageBox").dialog({
                            modal: true,
                            autoOpen: false,
                            title: "Percentage",
                            autoOpen: false,
                            width: 300,
                            height: 200,

                        });
                        $(".tech_purchase_check").live("click", function(e) {
                            // e.preventDefault();
                            var itemNum = $(this).parents('tr').attr('id');
                            var techPercent = $('#' + itemNum).children('td').children('.item_tech_percent').val();
                            var techType = $('#' + itemNum).children('td').children('.item_tech_percent_type').val();
                            var markupPercent = $('#' + itemNum).children('td').children('.item_markup_percent').val();
                            var markupType = $('#' + itemNum).children('td').children('.item_markup_percent_type').val();
                            if (techType == 1) {
                                $("#add_tech_percentage").val(techPercent);
                                $("#add_tech_amount").val('');
                            } else if (techType == 2) {
                                $("#add_tech_amount").val(techPercent);
                                $("#add_tech_percentage").val('');
                            }
                            if (markupType == 1) {
                                $("#add_markup_percentage").val(markupPercent);
                                $("#add_markup_amount").val('');
                            } else if (markupType == 2) {
                                $("#add_markup_amount").val(markupPercent);
                                $("#add_markup_percentage").val('');
                            }
                            $("#percentageItem").val(itemNum);
                            $('.percentageBox').dialog('open');
                        });
                    });

                    function showHotListData(ctype) {
                        if ("p" == ctype) {
                            javascript: parent.frame_browser.document.getElementsByClassName('active_user')[0].previousElementSibling.click();
                        }
                        else {
                            javascript: parent.frame_browser.document.getElementsByClassName('active_user')[0].nextElementSibling.click();
                        }
                    }

                    function setcallmode(mode) {
                        window.parent.frame_browser.document.getElementById("call_mode").value = mode;
                    }

                    function call(dial_id, hangup_id) {
                        if (dial_id == 'dial') var phone = $('#CustomerPhone').val();
                        else if (dial_id == 'dial2') var phone = $('#CustomerCellPhone').val();

                        if (phone != '') {
                            $.ajax({
                                type: "POST",
                                data: 'source=test&user=ALIACE&pass=Dguk7vKS9wQX&function=external_dial&agent_user=ACE1&value=' + phone + '&phone_code=1&search=YES&preview=NO&focus=NO',
                                //data: 'source=test&user=ALIACE&pass=Dguk7vKS9wQX&function=external_dial&agent_user=ACE1&value=9865471230&phone_code=1&search=YES&preview=NO&focus=NO',
                                url: "/acesys/vicidial/call.php",
                                cache: false,
                                success: function(d) {
                                    $('#' + dial_id).hide();
                                    $('#' + hangup_id).show();

                                    console.log(d);
                                },
                                error: function(d) {
                                    console.log(d);
                                }
                            });
                        }
                    }

                    /*A - Answering Machine, B - Busy, CALLBK - Call Back *, DC - Disconnected Number, DEC - Declined Sale, DNC - DO NOT CALL, N - No Answer, NI - Not Interested, NP - No Pitch No Price, SALE - Sale Made, WRNBR - Wrong Number, XFER - Call Transferred*/

                    function hangup(dial_id, hangup_id) {
                        $.ajax({
                            type: "POST",
                            //data: 'source=test&user=ALIACE&pass=Dguk7vKS9wQX&function1=external_pause&function2=external_hangup&function3=external_status&agent_user=ACE1&value1=PAUSE&value2=1&value3=A',
                            data: 'source=test&user=ALIACE&pass=Dguk7vKS9wQX&function1=external_pause&function2=external_hangup&function3=external_status&agent_user=<?=$_SESSION['
                            user ']['
                            vicidial_userid '];?>&value1=PAUSE&value2=1&value3=A',
                            url: "/acesys/vicidial/hangup.php",
                            cache: false,
                            success: function(d) {
                                $('#' + dial_id).show();
                                $('#' + hangup_id).hide();
                                console.log(d);
                            },
                            error: function(d) {
                                console.log(d);
                            }
                        });
                    }


                    function sendEmail(order_id) {
                        var data = order_id;
                        if (order_id != undefined) {
                            var email = document.getElementById('emailinput').value;
                            $.ajax({
                                url: '<?=BASE_URL?>/orders/sendMailEstimate/',
                                type: 'POST',
                                data: {
                                    'order_id': data,
                                    'email': email
                                },
                                success: function(data) {
                                    res = JSON.parse(data);
                                    if (res.res == "OK") {
                                        document.getElementById("mailbut").value = "Estimate Sent";
                                        $('#isCallback').attr('checked', false);
                                        showEstimateReminder(data);
                                        // alert("Estimate sent successfully");
                                    }
                                }
                            });
                        } else {
                            alert("Please create estimate first !! ");
                        }
                    }
                    $('.item_option1').live('click', function() {
                        if ($(this).is(":checked")) {
                            var item_id = $(this).parent().prev().closest('td').children('.reminders').val();
                            var test = item_id.split(',');
                            $.each(test, function(key, value) {
                                if (value > 0) {
                                    $.ajax({
                                        url: '<?=BASE_URL?>/iv_items/getItemDetails/',
                                        type: 'get',
                                        data: {
                                            'item_id': value,
                                        },
                                        success: function(data) {
                                            res = JSON.parse(data);
                                            if (res) {
                                                addItem(res.id, res.name, res.selling_price, 0, res.category_id, res.supplier_price, res.model, '', res.model,
                                                    res.brand, res.sku, 1, '', '', res.supplier, res.sub_category_id);
                                            }
                                        }
                                    });
                                }
                            });
                        }
                    });

                    $('.item_option2').live('click', function() {
                        if ($(this).is(":checked")) {
                            var item_id = $(this).parent().prev().prev().closest('td').children('.reminders').val();
                            var test = item_id.split(',');
                            $.each(test, function(key, value) {
                                if (value > 0) {
                                    $.ajax({
                                        url: '<?=BASE_URL?>/iv_items/getItemDetails/',
                                        type: 'get',
                                        data: {
                                            'item_id': value,
                                        },
                                        success: function(data) {
                                            res = JSON.parse(data);
                                            if (res) {
                                                addItem(res.id, res.name, res.selling_price, 1, res.category_id, res.supplier_price, res.model, '', res.model,
                                                    res.brand, res.sku, 1, '', '', res.supplier, res.sub_category_id);
                                            }
                                        }
                                    });
                                }
                            });
                        }
                    });
                </script>
                <style>
                    @media only screen and (max-width: 1024px) {
                        .creditCardDiv {
                            width: 100%;
                        }
                        #showCreditcardInfo {
                            width: 20%;
                        }
                    }
                    
                    #preAuthTrans {
                        padding: 3px;
                    }
                    
                    .tdpadding {
                        padding-bottom: 5px;
                    }
                    
                    .permitChk {
                        margin-right: 2%;
                    }
                    
                    #permitNum {
                        padding: 5px;
                    }
                    
                    #previewPermit {
                        padding: 5px;
                    }
                    
                    #customerCreditInfo {
                        background-color: #ffffff;
                        /*display: none;*/
                        width: 100%;
                    }
                    
                    .tdpadding1 {
                        padding-top: 2%;
                    }
                    
                    .cardBtn {
                        padding: 3px;
                    }
                    
                    #officerEmail {
                        padding: 5px;
                    }
                    
                    #sendImageToOfficer {
                        padding: 5px;
                    }
                    
                    #savePayImage {
                        padding: 3px;
                    }
                    
                    #saveCreditImage {
                        padding: 5px;
                        margin-top: 10px;
                    }
                    
                    #dnc_callback_btn {
                        color: red;
                    }
                    
                    #dns_reminder_btn {
                        color: red;
                    }
                    
                    #questions_template {
                        border: 1px solid #CCC;
                        border-collapse: collapse;
                        margin-top: 4%;
                    }
                    
                    #questions_template th {
                        background-color: #ccc;
                        padding: 7px;
                    }
                    
                    #questions_template .even_row {
                        background-color: #eee;
                    }
                    
                    #questions_template td {
                        padding: 2px;
                    }
                    
                    .creditCardTbl {
                        float: left;
                    }
                    
                    .creditCardTbl td {
                        padding: 4%;
                    }
                    
                    .cardStatusTbl {
                        float: right;
                        margin-right: 10%;
                        border: 1px solid black;
                        margin-top: 2%;
                    }
                    
                    .cardStatusTbl td {
                        padding: 5%;
                    }
                    
                    .creditCardTbl td input {
                        height: 25px;
                    }
                    
                    .creditCardDiv {
                        /*    margin: 20% 0 0 4%;
*/
                        margin: 0% 0 0 4%;
                        border: 2px solid grey;
                        height: 300px
                    }
                    
                    #masterDiv {
                        margin: 10% 0 2% 6%;
                    }
                    
                    .creditCardUprDiv {
                        margin: 1% 0 0 4%;
                    }
                    
                    #showCreditcardInfo {
                        padding: 5px;
                        /*width: 6%;*/
                        float: right;
                    }
                    
                    #cardTransaction {
                        /*margin: 1% 0 0 45%;*/
                        padding: 3px;
                    }
                    
                    #saveCardInfo {
                        margin: 0 0 0 5%;
                        padding: 5px;
                    }
                    
                    .ins_text {
                        margin: 5px;
                        width: 743px;
                        height: 197px;
                    }
                    
                    .t-input {
                        width: 100% !important;
                        height: 22px;
                    }
                    
                    .installationTotal {
                        float: right;
                    }
                    
                    #saveInstallationItem {
                        margin-top: 10px;
                        padding: 5px;
                    }
                    
                    .image-section {
                        position: relative;
                        padding: 0;
                    }
                    
                    .order-images {
                        cursor: pointer;
                        height: 100px;
                        width: 70px;
                    }
                    
                    .customerAddresses {
                        border: 1px solid black;
                        width: 65%;
                        cursor: pointer;
                        background-color: #989696;
                        margin-top: 2%;
                    }
                    
                    #one_time_item_table td {
                        padding: 3px;
                    }
                    
                    .percentTable td {
                        padding-top: 20px;
                    }
                    
                    .add_item_button {
                        font: bold 11px Arial;
                        text-decoration: none;
                        background-color: #EEEEEE;
                        color: #333333;
                        padding: 2px 6px 2px 6px;
                        border-top: 1px solid #CCCCCC;
                        border-right: 1px solid #333333;
                        border-bottom: 1px solid #333333;
                        border-left: 1px solid #CCCCCC;
                    }
                    
                    .hide-data {
                        display: none;
                    }
                    
                    .edit_info {
                        padding: 6px;
                        background: #000040;
                        color: white;
                        font-size: 13px;
                        margin-left: 10px !important;
                        font-weight: bold;
                    }
                    
                    .tab11-table {
                        border-collapse: collapse;
                        width: 100%;
                        text-align: center;
                        /*border: 1px solid black;*/
                    }
                    
                    .imagesTable td {
                        padding-top: 20px;
                    }
                    
                    .tab11-table td,
                    .tab11-table th {
                        border: 1px solid black;
                        font-size: 12px;
                        padding: 5px;
                    }
                    
                    .green {
                        background: #4CAF50;
                        padding: 2px 10px;
                        color: #fff;
                        text-decoration: none;
                        display: block;
                        width: 18px;
                    }
                    
                    .red {
                        background: red;
                        padding: 2px 10px;
                        color: #fff;
                        text-decoration: none;
                        display: none;
                        width: 38px;
                    }
                    /** Custom css for change position of button lable*/
                    
                    .cls-acecare-td-adjust {
                        position: relative;
                        height: 16;
                        width: 99px;
                        /* padding: 1; */
                        margin: 2px 0px 4px 0px;
                    }
                    
                    .acecare-td-adjust {
                        position: relative;
                        height: 20px;
                        width: 50px;
                    }
                    
                    .acecare-td-adjust>input[type="file"],
                    .cls-acecare-td-adjust>input[type="file"] {
                        position: absoulte;
                        opacity: 0;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0
                    }
                    
                    .acecare-td-adjust>label,
                    .cls-acecare-td-adjust>label {
                        position: absolute;
                        top: 0;
                        right: 0;
                        left: 0;
                        bottom: 0;
                        background-color: white;
                        color: #000;
                        border-radius: 5px;
                        line-height: 20px;
                        text-align: center;
                        cursor: pointer
                    }
                    
                    #DetailsTable th {
                        background-color: #0A304E;
                        padding: 7px;
                        color: #fff;
                    }
                    
                    #DetailsTable {
                        border: 1px solid #000;
                        border-collapse: collapse;
                        background: #fff;
                    }
                    
                    #DetailsTable .even_row {
                        background-color: #dcf1ef;
                    }
                    
                    #DetailsTable td {
                        padding: 2px;
                    }
                    
                    [class^="pre-image_"] {
                        display: none;
                    }
                </style>
                <script>
                    $('.save_order_images').live('click', function(e) {
                        e.preventDefault();
                        var getparent = $(this).parent();
                        var label = getparent.find('.save_label').val();
                        var newdate = getparent.find('.save_date').val();
                        var customer = $(this).attr('data-customer');
                        var date = $(this).attr('data-date');
                        console.log(date + " " + customer + " " + newdate + " " + label);

                        $.ajax({
                            url: "<?php echo BASE_URL ?>/technicians/uploadimages",
                            type: "post",
                            dataType: "json",
                            data: {
                                customer: customer,
                                date: date,
                                newdate: newdate,
                                label: label
                            },
                            success: function(data) {
                                //location.reload(true);
                                alert('updated succesfully');
                            },
                            error: function(jqXHR, exception) {

                                //location.reload(true);
                                // Your error handling logic here..
                                alert('updated succesfully');
                            },
                        });

                    });
                </script>
                <script>
                    var base_url = "<?=ROOT_URL;?>";
                </script>

                <script>
                    $('.search_schedule123').live('click', function() {
                        //var form_ser = $('#editBookingform_new').serialize();
                        var postal_code = $('#postal_code').val();
                        var period = $('#sc_period').val();
                        var service = $('.map_services').val();
                        var sc_from = $('#sc_from').val();

                        var sc_to = $('#sc_to').val();
                        var choose_time = $('#choose_time').val();
                        var choose_km = $('#choose_km').val();
                        var booking_cus_id = $('#booking_cus_id').val();
                        //?currentOrdId=&schedule_mode=&route_type=&truck_num=0&ffromdate=22+Jan+2021&sc_from=2021-01-22&sc_to=2021-01-27
                        //&p_code=4453+Dawson+Street%2C+Burnaby%2C+BC%2C+Canada&street_number=4453&route=Dawson+Street
                        //&sc_address=4453+Dawson+Street&postal_code=V5C4B8&city=BURNABY&trucks=&map_services=4&sc_period=
                        //&choose_time=480&choose_km=480
                        //?currentOrdId=&sc_from=2021-01-22&sc_to=2021-01-27&map_services=4
                        //var get_url="&postal_code="+postal_code+"&period="+period+"&map_services="+service+"&sc_from="+sc_from+"&sc_to"+sc_to+"&choose_time="+choose_time+"&choose_km="+choose_km;
                        var get_url = "&sc_from=" + sc_from + "&sc_to=" + sc_to + "&map_services=" + service + "&postal_code=" + postal_code + "&choose_time=" + choose_time + "&choose_km=" + choose_km + "&customer_id=" + booking_cus_id + "&first_page=1&time_slot=1";
                        url = "<?=ROOT_URL;?>/index.php/technicians/calender/?currentOrdId=" + get_url;
                        newwindow = window.open(url, 'name', 'height=350,width=800,top=250, left=600');
                        if (window.focus) {
                            newwindow.focus();
                        }


                    });
                    $(document).ready(function() {
                        var get_postal = $('#CustomerPostalCode').val();

                        $('#postal_code').val(get_postal);
                    });

                    function myFunction() {
                        $('#myModal2').hide();
                        var postal_code = $('#postal_code123').val();

                        if (postal_code == "") {
                            alert('post code can not be empty');
                            return false;
                        }
                        var sc_from = $('#sc_from').val();
                        var sc_to = $('#sc_to').val();
                        var service = $('.map_services123').val();
                        var booking_cus_id = $('#CustomerId').val();
                        var get_url = "&sc_from=" + sc_from + "&sc_to=" + sc_to + "&map_services=" + service + "&postal_code=" + postal_code + "&customer_id=" + booking_cus_id + "&first_page=1&time_slot=1";
                        url = "<?=ROOT_URL;?>/index.php/technicians/calender/?currentOrdId=" + get_url;
                        newwindow = window.open(url, 'name', 'height=350,width=800,top=250, left=600');
                    }
                    $('#postal_code123').val($('#CustomerPostalCode').val());

                    $('#get_postal_code123').val($('#CustomerAddressStreetNumber').val() + " " + $('#CustomerAddressStreet').val());

                    function close() {
                        alert('ok');
                    }
                    jQuery(document).ready(function($) {


                        $('#stars li').live('mouseover', function() {
                            var onStar = parseInt($(this).data('value'), 10); // The star currently mouse on

                            // Now highlight all the stars that's not after the current hovered star
                            $(this).parent().children('li.star').each(function(e) {
                                if (e < onStar) {
                                    $(this).addClass('hover');
                                } else {
                                    $(this).removeClass('hover');
                                }
                            });

                        }).live('mouseout', function() {
                            $(this).parent().children('li.star').each(function(e) {
                                $(this).removeClass('hover');
                            });
                        });


                        /* 2. Action to perform on click */
                        $('#stars li').live('click', function() {
                            var onStar = parseInt($(this).data('value'), 10); // The star currently selected
                            var stars = $(this).parent().children('li.star');

                            for (i = 0; i < stars.length; i++) {
                                $(stars[i]).removeClass('selected11');
                            }

                            for (i = 0; i < onStar; i++) {
                                $(stars[i]).addClass('selected11');
                            }

                            var ratingValue = parseInt($('#stars li.selected11').last().data('value'), 10);
                            $("#rating").val(ratingValue);
                        });
                    });
                </script>
                <script>
                    function parse_query_string(query) {
                        var vars = query.split("&");
                        var query_string = {};
                        for (var i = 0; i < vars.length; i++) {
                            var pair = vars[i].split("=");
                            var key = decodeURIComponent(pair[0]);
                            var value = decodeURIComponent(pair[1]);
                            // If first entry with this name
                            if (typeof query_string[key] === "undefined") {
                                query_string[key] = decodeURIComponent(value);
                                // If second entry with this name
                            } else if (typeof query_string[key] === "string") {
                                var arr = [query_string[key], decodeURIComponent(value)];
                                query_string[key] = arr;
                                // If third or later entry with this name
                            } else {
                                query_string[key].push(decodeURIComponent(value));
                            }
                        }
                        return query_string;
                    }

                    var query = window.location.search.substring(1);
                    var qs = parse_query_string(query);


                    var get_preview = qs.get_preview;

                    if (get_preview == 1) {
                        document.getElementById('preViewEstimate').value = 0;
                        document.getElementById('sendMailOnEstimate').value = 0;
                        var status = ValidateFields(1);

                    }
                </script>