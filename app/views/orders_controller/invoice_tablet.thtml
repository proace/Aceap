<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Invoice</title>
<meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="<?=ROOT_URL;?>/app/webroot/js/jquery-1.5.1.min.js"></script>
<script type="text/javascript" src="<?=ROOT_URL;?>/app/webroot/js/jquery-ui-1.8.21.custom.min.js"></script>
<script type="text/javascript" src="<?=ROOT_URL;?>/app/webroot/js/invoice_tablet.js"></script>
<script type="text/javascript" src="<?=ROOT_URL;?>/app/webroot/js/eff_calculator.js"></script>	
<link rel="stylesheet" type="text/css" media="all" href="<?=ROOT_URL;?>/app/webroot/css/ui-smooth/jquery-ui-1.8.21.custom.css" />
<link rel="stylesheet" type="text/css" media="all" href="<?=ROOT_URL;?>/app/webroot/css/invoice_tablet.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.2.0/dropzone.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.2.0/dropzone.css" rel="stylesheet" type="text/css">
<!-- <script type="text/javascript">  
  $(document).ready(function(){
    
  });
</script> -->
<style type="text/css">
  #job_list li {
    margin-top: 2%;
  }

  .sourceLi{
    margin-top: 12%;
  }
  .calButton{
        margin: 1% 0 0 7%;
        padding: 5px;
        font-weight: bold;
  }
  .clearCal{
        margin: 1% 0 0 1%;
        padding: 5px;
        font-weight: bold;
  }

  .image-comm{
    /*margin:10% 0 0 20%;*/
    margin: 10px 0 0 16px;
  }
    .borderLine{
        border-bottom: 1px ridge #777;
    }
#invoice {
    margin-left: 120px;
}
.no-close .ui-dialog-titlebar-close {
  display: none;
}
 .button {
    width: 21px;
    height: 12px;
    background: #F7B647;
    padding: 10px;
    text-align: center;
    border-radius: 5px;
    color: white;
    font-weight: bold;

}
.dropbtn {
  /*background-color: #4CAF50;*/
  /*background-color: #999999;*/
  /*color: white;*/
  color: #999999;
  padding: 8px;
  /*font-size: 14px;*/
  font-size: 100%;
  border: none;
  background: #333333;
  color: #999999;
  font-family: Arial, Helvetica, sans-serif;
  font-weight: bold;
  margin-left: 7px;
}

.dropdown {
  position: relative;
  display: inline-block;
}

.dropdown-content {
  display: none;
  position: absolute;
  margin-left: 100px;
  background-color: #f1f1f1;
  min-width: 160px;
  box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
  z-index: 1;
  /*background: #333333;*/
  color:#999999;
}

.dropdown-content a {
  color: black;
  /*color:#ffffff;*/
  padding: 12px 16px;
  text-decoration: none;
  display: block;
}

.dropdown-content a:hover {background-color: #ddd;}

/*.dropdown:hover .dropdown-content {display: block;}*/

/*.dropdown:hover .dropbtn {background-color: #3e8e41;}*/
.dropdown:hover .dropbtn {background-color: #333333;}
#nav a div{
    margin-top: 70%;
}
#nav .buttons {
    height: 80px;
    border-bottom: 0;
    width: 93px;
}

.show-child{
  cursor: pointer;
}
@media only screen and (max-width: 799px) {
 /*ul#job_list li{
  display:block;
  width:100%;
 }*/
 .ui-dialog{
  left:10% !important;
  top:10% !important;
  
 }
 
}
.image_get{
 
 margin-top:0 !important;
 margin-left:-12px;
 cursor:pointer;
}
.camera_div1{
 width: 50% !important;
    float: left;
    display: block;
    margin-top:0px !important;
 
}
.camera_div1 i{
 font-size:1.5em;
 color:lightgreen;
 
}
.camera_div{
 width: 50% !important;
    float: left;
    display: inline-block;
    margin-top:0px !important;
 
}
.job div{

     position: absolute;
    width: 100%;
    text-align: center;
    margin-top: 61px;
    color: #333;
}

</style>
<body>   
<input type='hidden' id='postArray'>
<input type='hidden' id='oId'>
<input type='hidden' id='destoId'>
<input type='hidden' id='reachTime'>

<ul id="nav">
    <!-- <li><a id="jobs_link" class="buttons"><div>Jobs</div></a></li>  -->     
    <li class="borderLine"><a id="jobs_link" href="<?php echo BASE_URL;?>/orders/invoiceTablet" class="buttons" class="buttons"><div>Jobs</div></a></li>
    <li class="borderLine"><a href="<?php echo BASE_URL;?>/pages/main" id="home_link" class="buttons"><div>ACESYS</div></a></li>
     <li class="borderLine"><a href="<?php echo BASE_URL ?>/orders/editBooking?customer_id=&job_truck=&job_time_beg=&job_date=<?php echo urlencode(date('d M Y'));?>&job_technician1_id=0&job_technician2_id=0&from_tech_page=1&show_preview=0"  id="new_link" class="buttons"><div>New Booking</div></a></li>
     
    <li class="borderLine" >
        <div class="dropdown">
          <img class="image-comm show-child" src="<?=ROOT_URL?>/app/webroot/img/invoice48x48.png">
            <div class="dropbtn show-child">Estimate</div>
            <!-- <button class="dropbtn" >Estimate</button> -->
            <div class="dropdown-content">
               <a href="<?php echo BASE_URL ?>/orders/editBooking?customer_id=&job_truck=&job_time_beg=&job_date=<?php echo urlencode(date('d M Y'));?>&job_technician1_id=<?=$common->getLoggedUserID();?>&job_technician2_id=0&from_tech_page=4&part_request=1&estimate=1">Part Estimate</a>
                <a href="<?php echo BASE_URL ?>/orders/editBooking?customer_id=&job_truck=&job_time_beg=&job_date=<?php echo urlencode(date('d M Y'));?>&job_technician1_id=0&job_technician2_id=0&from_tech_page=1&show_preview=1&estimate=1">New Estimate</a>
                <a href="<?php echo BASE_URL;?>/orders/invoiceTabletNewBooking">Existing Client</a>
                <a href="<?php echo BASE_URL;?>/reports/estimates?fromTech=1">Estimate History</a>
            </div>
        </div>
    </li>
    
    <!-- <li><a href="<?php echo BASE_URL;?>/orders/invoiceTabletNewBooking"  id="new_link" class="buttons"><div>Estimate</div></a></li> -->
    
      <!-- <li><a href="<?=BASE_URL?>/inventories/editDoc?type=1&fromTech=1&rurl=<?=urlencode('supplies?'.$_SERVER['QUERY_STRING'])?>"  id="purchase_image" class="buttons"><div>Purchase</div></a></li> -->

      <li class="borderLine">
          <div class="dropdown">
            <img class="image-comm show-child" src="<?=ROOT_URL?>/app/webroot/img/icon-lg-price.png">
            <div class="dropbtn show-child">Inventory </br> and Purchase</div>
          <!-- <button class="dropbtn"></button> -->
          <div class="dropdown-content">
            <a href="<?=BASE_URL?>/inventories/getTechItems">Truck and Office Inventory</a>
            <!-- <a href="<?=BASE_URL?>/inventories/requests">Part Request</a> -->
            <a href="<?=BASE_URL?>/suppliers">Supplier</a>
            <a href="<?=BASE_URL?>/inventories/editDoc?type=1&fromTech=1&rurl=<?=urlencode('supplies?'.$_SERVER['QUERY_STRING'])?>">Purchase</a>
            <!-- <a href="#">Purchase</a> -->
            <a href="<?=BASE_URL?>/inventories/supplies">Part History</a>
            <a href="<?=BASE_URL?>/Commissions/techPurchase">Tech Purchase</a>
          </div>
        </div>
      </li>

       <li class="borderLine"><a href="<?php echo BASE_URL ?>/settings/showTrainingCategory"  id="training_link" class="buttons"><div>Tech Support</div></a></li>
        <li class="borderLine"><a href="<?php echo BASE_URL ?>/settings/showTechTrainingCategory"  id="training_link1" class="buttons"><div>Tech Training</div></a></li>
    <!-- <li><a href="<?php echo BASE_URL;?>/inventories/techInventory" id="new_inventory_link" class="buttons" style="text-align: center;text-decoration: none;"><i class="fa fa-truck" aria-hidden="true" style="font-size: 60px;color: #ccc;"></i>
<br/>Inventory</a></li> -->
  <!--   <li><a id="calc_link" class="buttons"><div>Eff Calculator</div></a></li>
    <li><a id="preview_link" class="buttons" href="http://69.31.184.162:81/acesys/PrinterShare-6.0.0.apk"><div>PrinterShare 6</div></a></li> -->
    <!--<li><a id="new_link" class="buttons" onclick="alert('Under construction. Please use a blank estimate paper for now.')"><div>New Booking</div></a></li>--> 
    <!--<li><a id="messages_link" class="buttons"><div>Messages</div></a></li>-->
</ul>
<!--<div id="messages_div">
<div id="messages_prev"></div>
<textarea wrap="hard" id="messages_reply"></textarea><input type="button" id="messages_send" value="SEND" />
</div>-->
<!-- <input type="button" class="calButton" name="calculation" value="calculation" onclick="getFinalDistance();" >
<input type="button" value="Clear" class="clearCal" onclick="clearSelectjob();"></td> -->
<div id="invoice">
	<ul id="job_list">
    <!-- <li style="margin-top: 12%;">Current Location: <input type="text" name="source_code" id="source_code" ></li> -->
    	<?php foreach($jobs as $val => $job) { ?>
        <?php if($job['Order']['order_status_id'] == 5) $url = BASE_URL."/orders/invoiceTabletPayment?order_id=".$job['Order']['id']."" ?>
        <?php if($job['Order']['order_status_id'] == 3) $url = "#" ?>
        <?php if($job['Order']['order_status_id'] == 1) $url = BASE_URL."/orders/invoiceTabletOverview?order_id=".$job['Order']['id'] ?>
    	<li class="getDistance" cusPostCode="<?=$job['Order']['postal_code']?>" cusCity="<?=$job['Order']['city']?>" cusOrdNum="<?=$job['Order']['order_number']?>" cusOrdId="<?=$job['Order']['id']?>" ordStatus="<?=$job['Order']['order_status_id']?>" estimatePage="<?=$job['Order']['estimate_page']?>">
        <!--  <a href="<?php echo ($job['Order']['tech_visible'] == '0'?'#':$url) ?>" class="job status<?php echo $job['Order']['order_status_id'] ?>"> -->
           <div class="job status<?php echo $job['Order']['order_status_id'] ?>">
           <!-- <a href="#" class="job status<?php echo $job['Order']['order_status_id'] ?>"> -->
          	<span><?php echo $job['Customer']['first_name'] ?> <?php echo $job['Customer']['last_name'] ?> <?php echo $job['Order']['job_time_beg'] ?> <?php echo $job['Order']['job_time_end'] ?></span>            
            <div>
            <small class=""><?php echo $source1[$val] ?></small><br>
               <!-- <input type='checkbox' class='getDistance' onclick="getDistance(this,'<?=$job['Customer']['postal_code']?>',<?=$job['Order']['order_number']?>,'<?=$job['Customer']['city']?>')">  -->
              <div class="camera_div"><?php echo $job['Order']['order_number'] ?></div>
               <div class="camera_div1"><span class="image_get" data-order="<?= $job['Order']['id'] ?>" data-type="<?= $job['Order']['order_type_id'] ?>"><i class="fa fa-camera"></i></span>
            </div>
            </div>
           
            </div>
          <!-- </a>         -->
          
        </li>
     
        
        <?php } ?>
    </ul>
</div>
<div id="calc_dialog">
<table>
	<tr>
    	<td>
        	<h3>Yearly Cost</h3>
        	<table>
            	<tr>
                	<td colspan="3"><div class="number_display" id="cost">0</div></td>
                </tr>
                <tr>
                	<td><input type="button" value="7" class="calc_digits"></td>
                    <td><input type="button" value="8" class="calc_digits"></td>
                    <td><input type="button" value="9" class="calc_digits"></td>
                </tr>
                <tr>
                	<td><input type="button" value="4" class="calc_digits"></td>
                    <td><input type="button" value="5" class="calc_digits"></td>
                    <td><input type="button" value="6" class="calc_digits"></td>
                </tr>
                <tr>
                	<td><input type="button" value="1" class="calc_digits"></td>
                    <td><input type="button" value="2" class="calc_digits"></td>
                    <td><input type="button" value="3" class="calc_digits"></td>
                </tr>
                <tr>
                	<td><input type="button" value="0" class="calc_digits"></td>
                    <!--<td><input type="button" value="." class="calc_dot"></td>-->
                    <td colspan="2" class="right"><input type="button" value="clear" class="calc_clear"></td>
                </tr>
            </table>
            <h3>Old Furnace %</h3>
        	<table>
            	<tr>
                	<td><div class="number_display" id="old_eff">0</div></td>
                </tr>
                <tr>
                	<td><input type="button" value="60" class="calc_percent"></td>
                </tr>
                <tr>
                    <td><input type="button" value="70" class="calc_percent"></td>
                </tr>
                <tr>
                    <td><input type="button" value="80" class="calc_percent"></td>
                </tr>
                                
            </table>
        </td>
        <td style="position:relative">
        	<div id="old_scale">Old<div id="old_cost"></div></div>
            <div id="old_label">Existing</div>
            <div id="new1_scale">92%<div id="new1_cost"></div></div>
            <div id="new1_label">High Efficiency</div>
            <div id="new2_scale">95%<div id="new2_cost"></div></div>
            <div id="new2_label">Highest Efficiency</div>
        </td>
    </tr>
</table>
</div>
<div id= "show-dialog" style="display: none; text-align: center;">
   <div><span> You can not access your jobs until you complete your commission page.</span>
    <br><br><br>
    <span>Click here to complete <br>
    Your commission page<span>
    <br><br><br></div>
    <div style="text-align: center">
    <!-- <a  class="button" href="http://hvacproz.ca/acesys/index.php/commissions/calculateCommissions?<?=$URL?>" target="">GO</a></div> -->
    <a  class="button" href="<?=BASE_URL?>/commissions/calculateCommissions?<?=$URL?>" target="">GO</a></div>
</div>
<div id="showDistance" style="display: none">
  <textarea  id="customer_message" rows="15" cols="50"></textarea>
  <div style="margin-top: 5%">  
    <table>
      <tr>  
        <td>
          <input type="button" name="not_send_text" id="not_send_text" value="Do Not Send a Text">
        </td>
      </tr>
      <tr>
        <td>
          <input style="" type="button" name="send_text" id="send_text" value="Send a Text To Customer">
        </td>
      </tr>
      <tr>
        <td>
          <input style="" type="button" name="open_workSheet" id="open_workSheet" value="Open Worksheet">
        </td>
      </tr>
    </table>
  </div>
</div>
<script type="text/javascript">
$(document).ready(function()
{
      $("#showDistance").dialog({
            modal: false,
            top:(parseInt(jQuery(window).height()))/2,
            autoOpen: false,
            title: "Result",
            autoOpen: false,
            width: 450,
            height: 400,
            draggable: false,
            position:'center',
            // position: { my: "right top", at: "right top" }
        });

       <?php if($isShow == 1) {?>
        $("#invoice").hide();
        $("#show-dialog").dialog({
            modal: true,
            autoOpen: true,
            title: "Commission",
            width: 500,
            height: 200,
            dialogClass: "no-close",
            color:"yellow"
        });
        <?php }?>   

        $("#open_workSheet").live("click", function(){
            var oId = $("#destoId").val();
            $("#showDistance").dialog("close");
            window.location.href = "<?=BASE_URL?>/orders/invoiceTabletOverview?order_id="+oId;
        });
    $(".show-child").live("click",function(e){

        var callEvent = e.target;
       if($(callEvent).is("div")) {
        $(this).next('.dropdown-content').toggle("slide");
       }else if ($(callEvent).is("img")){
          $(this).next().next('.dropdown-content').toggle("slide");
       }
    });
    $("#not_send_text").live("click", function(){
        $("#showDistance").dialog("close");
    });

    $("#send_text").live("click", function(){
        var msg = $('#customer_message').val();
        // var id = $('#oId').val();
        var id = $('#destoId').val();
        var reachTime = $('#reachTime').val();
         $.ajax({
                url:"<?=BASE_URL;?>/orders/sendTimeReminderText",
                dataType:"json",
                type:"POST",
                data:{msg:msg,id:id,reachTime:reachTime,notify:1},
                success:function(result){ 
                    // res = JSON.parse(result);
                    if(result.res == 1){ 
                      $("#showDistance").dialog("close");  
                      window.location.href = "<?=BASE_URL?>/orders/invoiceTabletOverview?order_id="+id;               
                    }
                 }
            });
        $("#showDistance").dialog("close");
    });

    $("#not_send_text").live("click", function(){
        var msg = $('#customer_message').val();
        // var id = $('#oId').val();
        var id = $('#destoId').val();
        var reachTime = $('#reachTime').val();
         $.ajax({
                url:"<?=BASE_URL;?>/orders/sendTimeReminderText",
                dataType:"json",
                type:"POST",
                data:{msg:msg,id:id,reachTime:reachTime,notify:2},
                success:function(result){ 
                    // res = JSON.parse(result);
                    if(result.res == 1){ 
                      $("#showDistance").dialog("close");  
                      window.location.href = "<?=BASE_URL?>/orders/invoiceTabletOverview?order_id="+id;               
                    }
                 }
            });
        $("#showDistance").dialog("close");
    });
    $('span.image_get').live('click',function(e){
     var orderId = $(this).attr('data-order');
     var orderType = $(this).attr('data-type');
 e.preventDefault();
 //alert('ok');
 localStorage.setItem("fronFirstPage", "1");
 let curr_height = window.innerHeight/1.1;
 let curr_width = window.innerWidth/1.2;
 window.open('techLastPage2?order_id='+orderId+'&order_type_id='+orderType+'', 'test', "height="+curr_height+",width="+curr_width+"");
 
 
 return false;
 
 });

    $(".getDistance").live("click", function(){
        var dstPost = $(this).attr("cusPostCode");
        var dstCity = $(this).attr("cusCity");
        var dstId = $(this).attr("cusOrdNum");
        var dstStatus = $(this).attr("ordStatus");
        var dstOrd = $(this).attr("cusOrdId");
        var prevAdd = $(this).prev();

        var srcPost = prevAdd.attr("cusPostCode");
        var srcCity = prevAdd.attr("cusCity");
        var srcId = prevAdd.attr("cusOrdNum");
        var srcStatus = prevAdd.attr("ordStatus");
        var srcOrd = prevAdd.attr("cusOrdId");

        var estimatePage = $(this).attr("estimatePage");

        if(srcId != '' && srcId != undefined && srcStatus == 5)
        {
           if(dstStatus == 1){
              $("#destoId").val(dstOrd);
              var newArr = {};
              // newArr[orderNum] = postalCode.substring(0, 3)+','+city;
              newArr["'"+srcId+"'"] = srcPost.substring(0, 3)+' '+srcPost.substring(3)+','+srcCity;
              newArr["'"+dstId+"'"] = dstPost.substring(0, 3)+' '+dstPost.substring(3)+','+dstCity;
              $("#postArray").val(JSON.stringify(newArr));
               var distanceArray = $("#postArray").val();
               var decodeArr = JSON.parse(distanceArray);
               var arrLength =   Object.keys(decodeArr).length;
               var sourcePoint =   $("#source_code").val();
              $.ajax({
                  url:"<?=BASE_URL;?>/orders/getTechFinaldistance",
                  dataType:"html",
                  type:"POST",
                  data:{postalArray:decodeArr,sourcePoint:sourcePoint},
                  success:function(result){ 
                      res = JSON.parse(result);
                       $('#showDistance').dialog("open");
                       $('#customer_message').val(res.res);
                       $('#oId').val(res.oid);
                       $('#reachTime').val(res.reachTime);
                      // $('#showDistance').html(res.res).dialog("open");
                   }
              });
          } else if(dstStatus == 5){
              window.location.href = "<?=BASE_URL?>/orders/invoiceTabletPayment?order_id="+dstOrd;
          }
        }else {
            if(dstStatus == 5){
              window.location.href = "<?=BASE_URL?>/orders/invoiceTabletPayment?order_id="+dstOrd;
            }else if(dstStatus == 1){
                if(estimatePage == 1) {
                  window.location.href = "<?=BASE_URL?>/orders/editBooking?customer_id=&order_id="+dstOrd;
                } else {
                  window.location.href = "<?=BASE_URL?>/orders/invoiceTabletOverview?order_id="+dstOrd;
                }
            }
        }

        // console.log("prev",prevAdd);
    });

});
 function getDistance(el, postalCode, orderNum, city)
 {
    if($(el).is(":checked")){
         var postVal = $("#postArray").val();  
         if(postVal)
         {
            var decodeArr = JSON.parse(postVal);
            // decodeArr[orderNum] = postalCode.substring(0, 3)+','+city;
            decodeArr["'"+orderNum+"'"] = postalCode.substring(0, 3)+' '+postalCode.substring(3)+','+city;
            $("#postArray").val(JSON.stringify(decodeArr));
         } else {
            var newArr = {};
            // newArr[orderNum] = postalCode.substring(0, 3)+','+city;
            newArr["'"+orderNum+"'"] = postalCode.substring(0, 3)+' '+postalCode.substring(3)+','+city;
            $("#postArray").val(JSON.stringify(newArr));
         }
    }
    else
    {
        var postVal = $("#postArray").val();
        var decodeArr = JSON.parse(postVal);
        delete decodeArr["'"+orderNum+"'"];
        $("#postArray").val(JSON.stringify(decodeArr));
    }
 }
 function getFinalDistance()
{
    var distanceArray = $("#postArray").val();
   
    if(distanceArray == '' || distanceArray == null || typeof distanceArray == "undefined")
    {
        alert("Please select jobs.");
    } 
    var decodeArr = JSON.parse(distanceArray);
    var arrLength =   Object.keys(decodeArr).length;
    var sourcePoint =   $("#source_code").val();
    if(arrLength >= 2){
        if(decodeArr)
        {
            $.ajax({
                url:"<?=BASE_URL;?>/orders/getTechFinaldistance",
                dataType:"html",
                type:"POST",
                data:{postalArray:decodeArr,sourcePoint:sourcePoint},
                success:function(result){ 
                    res = JSON.parse(result);
                     $('#showDistance').dialog("open");
                     $('#customer_message').val(res.res);
                     $('#oId').val(res.oid);
                     $('#reachTime').val(res.reachTime);
                    // $('#showDistance').html(res.res).dialog("open");
                 }
            });
        }
    } else {
        alert("Please select atleast two jobs.");
    }
}
 function clearSelectjob() {
    $('.getDistance:checkbox').removeAttr('checked');
    $("#postArray").val('');
}

</script>
<?php echo $this->element('tech_footer'); ?>
</body>
</html>