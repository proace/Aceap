<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Untitled Document</title>
</head>

<body>
<a href="<?=BASE_URL;?>/commissions/techList/">Commission Settings</a>

<link type="text/css" href="<?=ROOT_URL;?>/app/webroot/css/overcast/jquery-ui-1.8.4.custom.css" rel="stylesheet" />	
<script type="text/javascript" src="<?=ROOT_URL;?>/app/webroot/js/jquery-ui-1.8.4.custom.min.js"></script>

<script>
function SelectTech(techId)
{
	if(techId > 0){
		submit2 = document.getElementById("submit2");
		if(submit2 != null){
			ftechid = document.getElementById("ftechid");
			if(ftechid){
				//alert(ftechid.options[2].value);
				for (var i=0; i<ftechid.options.length; i++){ //loop through all form elements
					if(ftechid.options[i].value == techId){
						ftechid.options[i].selected = true;
						break; 
					}
				} 

				submit2.click();
			}
		}
	}
}
function GoChangeCommission(){
	var TechId=document.getElementById("ftechid").value;
	top.frames['main_view'].location.href='<? echo $html->url("/commissions/editTech/"); ?>'+TechId+'?rurl=<?=urlencode($this->params['controller'].'/'.$this->params['action'].'?'.$_SERVER['QUERY_STRING'])?>';
}
function MarkVerified(job_id,data_in,element){
  if (element.checked){
				$.get("<?=BASE_URL;?>/commissions/setVerified",
					{order_id:job_id,
					 tech_num:data_in.tech_num,
					 booking_comm:data_in.booking_comm,
					 sales_job_comm:data_in.sales_job_comm,
					 sales_appl_comm:data_in.sales_appl_comm,
					 redo_penalty:data_in.redo_penalty,
					 driving_comm:data_in.driving_comm,
					 helper_ded:data_in.helper_ded,
					 adjustment:data_in.adjustment,
					 total_comm:data_in.total_comm
					},
					function(data){document.forms['viewform'].submit();});
	}
	else
				$.get("<?=BASE_URL;?>/commissions/setUnVerified",
					{order_id:job_id,
					 tech_num:data_in.tech_num},
					function(data){document.forms['viewform'].submit();});
}
function Adjust(job_id,data_in,element){
  val = element.value;
	$.get("<?=BASE_URL;?>/commissions/setVerified",
		{order_id:job_id,
		 tech_num:data_in.tech_num,
 		 booking_comm:data_in.booking_comm,
		 sales_job_comm:data_in.sales_job_comm,
		 sales_appl_comm:data_in.sales_appl_comm,
		 redo_penalty:data_in.redo_penalty,
     driving_comm:data_in.driving_comm,
		 helper_ded:data_in.helper_ded,
		 adjustment:val,
		 total_comm:data_in.total_comm
	  },
	  function(data){document.forms['viewform'].submit();});
}
function ChangeTechMethod(job_id,element,tech){
  $.get("<?=BASE_URL;?>/commissions/saveTechMethod",
  	{order_id:job_id,method:element.value,tech_num:tech},
	  function(data){document.forms['viewform'].submit();});
}
function ShowDetails(job_id, item_type){
  $.get("<?=BASE_URL;?>/orders/getItems",
  	{order_id:job_id,items_type:item_type,enable_actions:0},
	  function(data){ 
				$("#dialog_items").html(data);
				$("#dialog").dialog({ height: 300, width: 450 });
  });
}
function ShowMessages(job_id, message_to){
  if (message_to!=11) 
  var answer = window.showModalDialog("<?=BASE_URL?>/messages/ShowMessages?job_id="+job_id+"&to_user_id="+message_to,'', 
  "dialogWidth:600px; dialogHeight:350px; dialogLeft:300px; dialogTop:200px;");
	else
  var answer = window.showModalDialog("<?=BASE_URL?>/messages/ShowMessages?job_id="+job_id,'', 
  "dialogWidth:600px; dialogHeight:350px; dialogLeft:300px; dialogTop:200px;");
}
</script>

<style type="text/css">
	.inactive{
		color: #868686 !important;
	}
	.active{
		font-weight:bold;
	}
	.notready{
		color: #f80e01 !important;
	}
	td.inactive.notready{
		color: #ffaaa6 !important;
	}
	.results th{
		color:black;
		border-left:1px solid #9f9f9f;
		border-bottom:1px solid #9f9f9f;
	}

#return {
	display:block;
	color:#ff6633;
	background-color:#333333;
	padding:3px;
	position:relative;
	left:-10px;
	top:-10px;
	font-size:140%;
}
</style>
<?php if($ismobile == 1) { ?>
	<a href="<?php echo BASE_URL ?>/pages/mobileMenu" id="return">Back to Main</a>
<?php } ?>
<div id="dialog" title="Details" style="display:none;">
  <table id="CurrentItemsTable" cellspacing=0 colspacing=0 class="inResultsBooking">
		<thead>
		<tr>
			<th align=left><b>Booked items</b></th>
			<th style="width:30px">Qty</th>
			<th style="width:50px">Price</th>
            <th style="width:50px">Dis</th>
			<th style="width:55px">Adj</th>
			<th style="width:55px">Prch</th>
			<th style="width:55px">Sum</th>
            <th>&nbsp;</th>
            <th>&nbsp;</th>
		</tr>
		</thead>
		<tbody id="dialog_items">
    </tbody>
  </table>
</div>

<form method="GET" action="<?= $PHP_SELF?>" name="viewform" id="viewform">
<input type="hidden" name="action" value="view" >
<input type="hidden" name="order" value="<?=$_GET['order']?>">
<input type="hidden" name="sort" value="<?=$_GET['sort']?>">
<input type="hidden" name="currentPage" value="<?=$_GET['currentPage']?>">

<table width="100%" border="0" cellspacing="3" cellpadding="0">
	<tr>
		<td class="sectionTitle" colspan=3>Technicians' Commissions</td>
	</tr>
	<tr>
		<td>Technician:</td>
		<td colspan=2>
		<select name="ftechid" <?=($loggedUserIsTech == "1" ? "disabled='disabled'" : "")?> id="ftechid">
			<option value="-1">-=All=-</option>
			<? 
			foreach($allTechnician as $k => $v) {
				echo '<option value="'.$k.'"'.( $k == $techid ? ' selected' : '').'>'.$v.'</option>';
			}
			?>
		</select>
		<!-- We could have only one selected user and only one selected commission_type per job -->
		<input type="hidden" name="comm_oper" id="comm_oper" value="<?=$comm_oper?>" /> <!--edit;cancel;save -->
		<input type="hidden" name="techId" id="techId" value="<?=$techid?>" />
		<input type="hidden" name="selected_job" id="selected_job" value="<?=$selected_job?>" />
		<input type="hidden" name="selected_commission_type" id="selected_commission_type" value="<?=$selected_commission_type?>" />

		<?php if ($common->getLoggedUserRoleID() == "6"){?>
			<input type="button" onclick="GoChangeCommission()" value="Change Commission"/>
		<?php }?>
		</td>
		<td>Type: 
			<select name="job_option" id="job_option" onchange="document.viewform.cur_ref.value=''; document.viewform.submit();">
				<option value=1 <? if ($job_option==1) echo 'selected=1';?>>Jobs</option>
				<option value=2 <? if ($job_option==2) echo 'selected=1';?>>Bookings</option>
				<option value=3 <? if ($job_option==3) echo 'selected=1';?>>Canceled</option>
      </select>
		</td>
	</tr>
	<tr>
		<td>Date: </td>
		<td>
			<input type="button" value="&lt;&lt;" class="buttons" onclick="document.viewform.ffromdate.value='<?=$prev_fdate?>'; document.viewform.cur_ref.value=''; document.viewform.submit();" style="font-size: 8pt;">
			&nbsp;&nbsp;
			<input type="text" name="ffromdate" class="emboss" style="width: 85px; cursor: hand; cursor: pointer;" readonly="1" onclick="document.viewform.cur_ref.value=''; scwShow(this,event);" onkeydown="return false;" value="<?=$fdate?>">
			&nbsp;&nbsp;
			<input type="button" value="&gt;&gt;" class="buttons" onclick="document.viewform.ffromdate.value='<?=$next_tdate?>'; document.viewform.cur_ref.value=''; document.viewform.submit();" style="font-size: 8pt;">
		</td>
		<td colspan=2>REF #: 
			<input name="cur_ref" id="cur_ref" type="text" value="<?=$cur_ref?>" style="font-size: 8pt;">
		<input type="submit" name="submit2" onclick="return SearchRecords();" id="submit2" value="Update" class="buttons">
		</td>			
	</tr>
</table>
</form>
<!--<div style="overflow: auto; height: 390px;">-->
<table class="results" cellpadding="3" cellspacing="0" style="border-style: solid;border-width:1px;">
    <tr style="height:25px;">
        <th rowspan=2 width="60" style="background-color:#ffffff;border-left:0px">Date</th>        
        <th rowspan=2 width="60" style="background-color:#ffffff;">Job</th> 
             
        <th rowspan=2 width="100" style="background-color:#ffffff;">Tech / Source</th>
        <th rowspan=2 style="background-color:#ffffff;">Commission type</th>

        <th rowspan=2 width="60" style="background-color:#caffca;">Booking</th>

        <th rowspan=2 width="60" style="background-color:#caffff;">Extra Sales</th>
        <th colspan=2 width="60" style="background-color:#53ffff;">Sales Comm</th>

   <!--     <th rowspan=2 width="60" style="background-color:#C5BE97;">Time Payable</th>-->
        <th rowspan=2 width="60" style="background-color:#80ff80;">Booking Paid</th>
        <th rowspan=2 width="60" style="background-color:#c0c0c0;">Driving</th>

				<th colspan=2 width="60" style="background-color:#ff7d7d;">Deductions</th>
        
        <th rowspan=2 colspan=2 width="100" style="background-color:#ffff80;">Adjustment</th>
        <th rowspan=2 width="60" style="background-color:#ffff80;">Total Comm</th>
        
				<th rowspan=2 width="16" style="background-color:#ffff80;"><?='<img src="'.ROOT_URL.'/app/webroot/img/icon-vsm-check.png">'?></th>
    </tr>
    <tr style="height:25px;">
        <th width="60" style="background-color:#53ffff;">jobs</th>
        <th width="60" style="background-color:#53ffff;">appli ances</th>
				<th width="50" style="background-color:#ff7d7d;">Redo</th>
				<th width="50" style="background-color:#ff7d7d;">Helper</th>
    </tr>
		
<?php
	$r = 1;
	$total_sum = 0;
	$approved_sum = 0;
	foreach ($orders as $obj):
		$class = 'cell'.(++$r%2);
		$comm_calculated_class='color:red;';
		if($obj['user_commissions_saved'] == 1) $comm_calculated_class='color:green;';
		$rows_persons = $obj['comm'];
		$local_class = '';
		$name_class = '';
		if ($obj['order_status_id']!='5') $name_class = 'notready';
		$disable_inputs = '';
		$disable_tech = array();
		$disable_tech[1] = false;
		$disable_tech[2] = false;
		$disable_tech[3] = false;
		$disable_tech[4] = false;
		$message_to = 0;
		
		if (($_SESSION['user']['id'] != 44851)&&($_SESSION['user']['id'] != 52249)
		  &&($_SESSION['user']['id'] != 58613)&&($_SESSION['user']['id'] != 68476))
		{
			if ($obj['job_technician1_id']!=$_SESSION['user']['id']) $disable_tech[1] = true;
			if ($obj['job_technician2_id']!=$_SESSION['user']['id']) $disable_tech[2] = true;
			if ($obj['booking_source_id']!=$_SESSION['user']['id']) $disable_tech[3] = true;
			if ($obj['booking_source2_id']!=$_SESSION['user']['id']) $disable_tech[4] = true;
			$disable_inputs = 'disabled';
			$message_to = 11;
		}
?>
    <tr class="<?= $class ?>">
        <td rowspan=4 style="cursor:pointer;border-left:0px">
			<?php
			if ($common->getLoggedUserRoleID() == "1") $method = 'techBooking'; else $method = 'editBooking';
			echo $html->link($obj['job_date'],'/orders/'.$method.'?order_id='.$obj['id'].'&rurl='.urlencode($this->params['controller'].'/'.$this->params['action'].'?'.$_SERVER['QUERY_STRING']),array("title"=>"Booking date: ".date("Y-m-d",strtotime($obj['job_date']))."  Job date:". date("Y-m-d",strtotime($obj['job_date']))));
			?>
		</td>        
        <td rowspan=2 align="center" title="<?="Booking date: ".date("Y-m-d",strtotime($obj['job_date']))."  Job date:". date("Y-m-d",strtotime($obj['job_date']))?>">&nbsp;
        	<?php echo $html->link($obj['order_number'],'/orders/'.$method.'?order_id='.$obj['id'].'&rurl='.urlencode($this->params['controller'].'/'.$this->params['action'].'?'.$_SERVER['QUERY_STRING']),array("title"=>"Booking date: ".date("Y-m-d",strtotime($obj['job_date']))."  Job date:". date("Y-m-d",strtotime($obj['job_date'])))); ?>
        	<br/><font color="<?=($obj['order_status_id']==5) ? 'green' : 'red'?>"><b><?=$obj['order_status']?></b></font>
        </td>
        
			<?php
			if ($techid)
				if ($techid==$obj['job_technician1_id'])
				{
					$local_class = 'active';
					//Add total only for the done jobs
					$total_sum = $total_sum + $rows_persons[1]['total_comm'];
					if ($rows_persons[1]['verified'])
						$approved_sum = $approved_sum + $rows_persons[1]['total_comm'];
				}
			else $local_class = 'inactive';
			?>
        <td class="<?=$local_class?>" onclick="javascript:SelectTech(<?php echo $obj['job_technician1_id']; ?>);" style="cursor:pointer;">
			&nbsp;<?php echo $obj['tech1_name']; ?>
		</td>
		<td>
			<?php 
			if ($disable_inputs) echo '&nbsp;'.$comm_roles[$rows_persons[1]['commission_type']];
			else echo $html->selectTag('commtype['.$obj['id'].'][1]', $comm_roles, $rows_persons[1]['commission_type'], array('onchange'=>'ChangeTechMethod('.$obj['id'].',this,1)'));
			?>
		</td>
        
        <td rowspan=4 align="right" onclick="ShowDetails(<?=$obj['id']?>, 0)">
			<a href="#"><?=$HtmlAssist->prPrice($obj['total'][0]) ?></a>
		</td>

        <td rowspan=4 align="right" onclick="ShowDetails(<?=$obj['id']?>, 1)">
								<a href="#"><?=$HtmlAssist->prPrice($obj['total'][1]) ?></a>
				</td>
				<td class="<?=$name_class?> <?=$local_class?>" align="right"><?=($rows_persons[1]['sales_job_comm']==0||$disable_tech[1])?'':$HtmlAssist->prPrice($rows_persons[1]['sales_job_comm'])?>&nbsp;</td>
				<td class="<?=$name_class?> <?=$local_class?>" align="right"><?=($rows_persons[1]['sales_appl_comm']==0||$disable_tech[1])?'':$HtmlAssist->prPrice($rows_persons[1]['sales_appl_comm'])?>&nbsp;</td>
				<td class="<?=$name_class?> <?=$local_class?>" align="right"><?=($rows_persons[1]['booking_comm']==0||$disable_tech[1])?'':$HtmlAssist->prPrice($rows_persons[1]['booking_comm'])?>&nbsp;</td>
				<td class="<?=$name_class?> <?=$local_class?>" align="right"><?=($rows_persons[1]['driving_comm']==0||$disable_tech[1])?'':$HtmlAssist->prPrice($rows_persons[1]['driving_comm']) ?>&nbsp;</td>
        
				<td class="<?=$name_class?> <?=$local_class?>" align="right"><?=($rows_persons[1]['redo_penalty']==0||$disable_tech[1])?'':$HtmlAssist->prPrice($rows_persons[1]['redo_penalty'])?>&nbsp;</td>
				<td class="<?=$name_class?> <?=$local_class?>" align="right"><?=($rows_persons[1]['helper_ded']==0||$disable_tech[1])?'':$HtmlAssist->prPrice($rows_persons[1]['helper_ded'])?>&nbsp;</td>

				<td>
				  <?php
					if ($rows_persons[1]['verified']&&!$disable_tech[1]) {
					if ($disable_inputs) echo '&nbsp;<b>'.$rows_persons[1]['adjustment'].'</b>';
					else echo '<input type="text" style="width:40" value="'.$rows_persons[1]['adjustment'].'" onchange=\'Adjust('.$obj['id'].','.json_encode($rows_persons[1]).',this);\'/>';
					 }else{ ?>
					  &nbsp;
					<?php } ?>
				</td>
        <td <? if ($message_to) echo 'rowspan=4';?> align="center" valign="top">
								<? if ($obj['tech1_name']) { ?>
								<img src="<?=ROOT_URL;?>/app/webroot/img/icon-vsm-edit.png" onclick="ShowMessages(<?=$obj['id']?>,<?=($message_to)?$message_to:$rows_persons[1]['id']?>)"/>
								<? } else {?>
								&nbsp;
								<? }?>
				</td>
				<td class="<?=$name_class?> <?=$local_class?>" align="right"><?=($rows_persons[1]['total_comm']==0||$disable_tech[1])?'':$HtmlAssist->prPrice($rows_persons[1]['total_comm']) ?>&nbsp;</td>
				
				<td>
				  <input type="checkbox" <?=$disable_inputs?> <?=$rows_persons[1]['verified']?> onclick='MarkVerified(<?=$obj['id']?>,<? echo json_encode($rows_persons[1]);?>,this);'/>
				</td>
    </tr>
    <tr class="<?=$class?>">
				<?php
								if ($techid)
												if ($techid==$obj['job_technician2_id'])
												{
																$local_class = ' active';
																$total_sum = $total_sum + $rows_persons[2]['total_comm'];
																if ($rows_persons[2]['verified'])
																				$approved_sum = $approved_sum + $rows_persons[2]['total_comm'];
												}
												else $local_class = 'inactive';
				?> 
				<td class="<?=$local_class?>" onclick="javascript:SelectTech(<?php echo $obj['job_technician2_id']; ?>);" style="cursor:pointer;">
				  &nbsp;<?php echo $obj['tech2_name']; ?>
				</td>
				<td>
				  <?php 
					if ($disable_inputs) echo '&nbsp;'.$comm_roles[$rows_persons[2]['commission_type']];
					else echo $html->selectTag('commtype['.$obj['id'].'][2]', $comm_roles, $rows_persons[2]['commission_type'], array('onchange'=>'ChangeTechMethod('.$obj['id'].',this,2)'));
					?>
				</td>
				
				<td class="<?=$name_class?> <?=$local_class?>" align="right"><?=($rows_persons[2]['sales_job_comm']==0||$disable_tech[2])?'':$HtmlAssist->prPrice($rows_persons[2]['sales_job_comm'])?>&nbsp;</td>
				<td class="<?=$name_class?> <?=$local_class?>" align="right"><?=($rows_persons[2]['sales_appl_comm']==0||$disable_tech[2])?'':$HtmlAssist->prPrice($rows_persons[2]['sales_appl_comm'])?>&nbsp;</td>
				<td class="<?=$name_class?> <?=$local_class?>" align="right"><?=($rows_persons[2]['booking_comm']==0||$disable_tech[2])?'':$HtmlAssist->prPrice($rows_persons[2]['booking_comm'])?>&nbsp;</td>
				<td class="<?=$name_class?> <?=$local_class?>" align="right"><?=($rows_persons[2]['driving_comm']==0||$disable_tech[2])?'':$HtmlAssist->prPrice($rows_persons[2]['driving_comm']) ?>&nbsp;</td>
				<td class="<?=$name_class?> <?=$local_class?>" align="right"><?=($rows_persons[2]['redo_penalty']==0||$disable_tech[2])?'':$HtmlAssist->prPrice($rows_persons[2]['redo_penalty'])?>&nbsp;</td>
				<td class="<?=$name_class?> <?=$local_class?>" align="right"><?=($rows_persons[2]['helper_ded']==0||$disable_tech[2])?'':$HtmlAssist->prPrice($rows_persons[2]['helper_ded'])?>&nbsp;</td>

				<td>
				  <?php
					if ($rows_persons[2]['verified']&&!$disable_tech[2]) {
					if ($disable_inputs) echo '&nbsp;<b>'.$rows_persons[2]['adjustment'].'</b>';
					else echo '<input type="text" style="width:40" value="'.$rows_persons[2]['adjustment'].'" onchange=\'Adjust('.$obj['id'].','.json_encode($rows_persons[2]).',this);\'/>';
					}else{ ?>
					  &nbsp;
					<?php } ?>
				</td>
        <? if (!$message_to) {?>
				<td align="center" valign="top">
								<? if ($obj['tech2_name']) { ?>
								<img src="<?=ROOT_URL;?>/app/webroot/img/icon-vsm-edit.png" onclick="ShowMessages(<?=$obj['id']?>,<?=$rows_persons[2]['id']?>)"/>
								<? } else {?>
								&nbsp;
								<? }?>
				</td>
				<? }?>
        <td class="<?=$name_class?> <?=$local_class?>" align="right"><?=($rows_persons[2]['total_comm']==0||$disable_tech[2])?'':$HtmlAssist->prPrice($rows_persons[2]['total_comm']) ?>&nbsp;</td>
				
				<td>
				  <input type="checkbox" <?=$disable_inputs?> <?=$rows_persons[2]['verified']?> onclick='MarkVerified(<?=$obj['id']?>,<? echo json_encode($rows_persons[2]);?>,this);'/>
				</td>
    </tr>
    <tr class="<?= $class ?>">
        <td rowspan=2 align="center"><b><?php echo $obj['order_type']; ?></b></td>
				
				<?php
								if ($techid)
												if ($techid==$obj['booking_source_id'])
												{
																$local_class = ' active';
																$total_sum = $total_sum + $rows_persons[3]['total_comm'];
																if ($rows_persons[3]['verified'])
																				$approved_sum = $approved_sum + $rows_persons[3]['total_comm'];
												}
												else  $local_class = 'inactive';
				?> 
		    <td class="<?=$local_class?>" onclick="javascript:SelectTech(<?php echo $obj['booking_source_id']; ?>);" style="cursor:pointer;">
				  &nbsp;<?php echo $obj['source_name']; ?>
				</td>
				<td>&nbsp;</td>
				
				<td class="<?=$name_class?> <?=$local_class?>" align="right"><?=($rows_persons[3]['sales_job_comm']==0||$disable_tech[3])?'':$HtmlAssist->prPrice($rows_persons[3]['sales_job_comm'])?>&nbsp;</td>
				<td class="<?=$name_class?> <?=$local_class?>" align="right"><?=($rows_persons[3]['sales_appl_comm']==0||$disable_tech[3])?'':$HtmlAssist->prPrice($rows_persons[3]['sales_appl_comm'])?>&nbsp;</td>
				<td class="<?=$name_class?> <?=$local_class?>" align="right"><?=($rows_persons[3]['booking_comm']==0||$disable_tech[3])?'':$HtmlAssist->prPrice($rows_persons[3]['booking_comm'])?>&nbsp;</td>
				<td class="<?=$name_class?> <?=$local_class?>" align="right"><?=($rows_persons[3]['driving_comm']==0||$disable_tech[3])?'':$HtmlAssist->prPrice($rows_persons[3]['driving_comm']) ?>&nbsp;</td>
				<td class="<?=$name_class?> <?=$local_class?>" align="right"><?=($rows_persons[3]['redo_penalty']==0||$disable_tech[3])?'':$HtmlAssist->prPrice($rows_persons[3]['redo_penalty'])?>&nbsp;</td>
				<td class="<?=$name_class?> <?=$local_class?>" align="right"><?=($rows_persons[3]['helper_ded']==0||$disable_tech[3])?'':$HtmlAssist->prPrice($rows_persons[3]['helper_ded'])?>&nbsp;</td>
				
				<td>
				  <?php
					if ($rows_persons[3]['verified']&&!$disable_tech[3]) {
					if ($disable_inputs) echo '&nbsp;<b>'.$rows_persons[3]['adjustment'].'</b>';
					else echo '<input type="text" style="width:40" value="'.$rows_persons[3]['adjustment'].'" onchange=\'Adjust('.$obj['id'].','.json_encode($rows_persons[3]).',this);\'/>';
					}else{ ?>
					  &nbsp;
					<?php } ?>
				</td>
        <? if (!$message_to) {?>
				<td align="center" valign="top">
								<? if ($obj['source_name']) { ?>
								<img src="<?=ROOT_URL;?>/app/webroot/img/icon-vsm-edit.png" onclick="ShowMessages(<?=$obj['id']?>,<?=$rows_persons[3]['id']?>)"/>
								<? } else {?>
								&nbsp;
								<? }?>
				</td>
				<? }?>
        <td class="<?=$name_class?> <?=$local_class?>" align="right"><?=($rows_persons[3]['total_comm']==0||$disable_tech[3])?'':$HtmlAssist->prPrice($rows_persons[3]['total_comm']) ?>&nbsp;</td>
				
				<td>
				  <input type="checkbox" <?=$disable_inputs?> <?=$rows_persons[3]['verified']?> onclick='MarkVerified(<?=$obj['id']?>,<? echo json_encode($rows_persons[3]);?>,this);'/>
				</td>
    </tr>
    <tr class="<?= $class ?>">
				<?php
								if ($techid)
												if ($techid==$obj['booking_source2_id'])
												{
																$local_class = ' active';
																$total_sum = $total_sum + $rows_persons[4]['total_comm'];
																if ($rows_persons[4]['verified'])
																				$approved_sum = $approved_sum + $rows_persons[4]['total_comm'];
												}
												else $local_class = 'inactive';
				?> 
		    <td class="<?=$local_class?>" onclick="javascript:SelectTech(<?php echo $obj['booking_source2_id']; ?>);" style="cursor:pointer;">
				  &nbsp;<?php echo $obj['source2_name']; ?>
				</td>
				<td>&nbsp;</td>
				
				<td class="<?=$name_class?> <?=$local_class?>" align="right"><?=($rows_persons[4]['sales_job_comm']==0||$disable_tech[4])?'':$HtmlAssist->prPrice($rows_persons[4]['sales_job_comm'])?>&nbsp;</td>
				<td class="<?=$name_class?> <?=$local_class?>" align="right"><?=($rows_persons[4]['sales_appl_comm']==0||$disable_tech[4])?'':$HtmlAssist->prPrice($rows_persons[4]['sales_appl_comm'])?>&nbsp;</td>
				<td class="<?=$name_class?> <?=$local_class?>" align="right"><?=($rows_persons[4]['booking_comm']==0||$disable_tech[4])?'':$HtmlAssist->prPrice($rows_persons[4]['booking_comm'])?>&nbsp;</td>
				<td class="<?=$name_class?> <?=$local_class?>" align="right"><?=($rows_persons[4]['driving_comm']==0||$disable_tech[4])?'':$HtmlAssist->prPrice($rows_persons[4]['driving_comm']) ?>&nbsp;</td>
				<td class="<?=$name_class?> <?=$local_class?>" align="right"><?=($rows_persons[4]['redo_penalty']==0||$disable_tech[4])?'':$HtmlAssist->prPrice($rows_persons[4]['redo_penalty'])?>&nbsp;</td>
				<td class="<?=$name_class?> <?=$local_class?>" align="right"><?=($rows_persons[4]['helper_ded']==0||$disable_tech[4])?'':$HtmlAssist->prPrice($rows_persons[4]['helper_ded'])?>&nbsp;</td>
				
				<td>
				  <?php
					if ($rows_persons[4]['verified']&&!$disable_tech[4]) {
					if ($disable_inputs) echo '&nbsp;<b>'.$rows_persons[4]['adjustment'].'</b>';
					else echo '<input type="text" style="width:40" value="'.$rows_persons[4]['adjustment'].'" onchange=\'Adjust('.$obj['id'].','.json_encode($rows_persons[4]).',this);\'/>';
					}else{ ?>
					  &nbsp;
					<?php } ?>
				</td>
        <? if (!$message_to) {?>
				<td align="center" valign="top">
								<? if ($obj['source2_name']) { ?>
								<img src="<?=ROOT_URL;?>/app/webroot/img/icon-vsm-edit.png" onclick="ShowMessages(<?=$obj['id']?>,<?=$rows_persons[4]['id']?>)"/>
								<? } else {?>
								&nbsp;
								<? }?>
				</td>
				<? }?>
        <td class="<?=$name_class?> <?=$local_class?>" align="right"><?=($rows_persons[4]['total_comm']==0||$disable_tech[4])?'':$HtmlAssist->prPrice($rows_persons[4]['total_comm']) ?>&nbsp;</td>
				
				<td>
				  <input type="checkbox" <?=$disable_inputs?> <?=$rows_persons[4]['verified']?> onclick='MarkVerified(<?=$obj['id']?>,<? echo json_encode($rows_persons[4]);?>,this);'/>
				</td>
    </tr>
<?php endforeach; ?>
<?php if ($techid) {?>
    <tr>
				<td colspan=10 style="border-top:1px solid #9f9f9f;">&nbsp;</td>
				<td align="right" style="border-top:1px solid #9f9f9f;"><b>Total:</b></td>
				<td align="right" style="border-top:1px solid #9f9f9f;"><b><?php echo $HtmlAssist->prPrice($total_sum);?></b></td>
				<td colspan=3 align="right" style="border-top:1px solid #9f9f9f;"><b>Approved by office:</b></td>
				<td align="right" style="border-top:1px solid #9f9f9f;"><b><?php echo $HtmlAssist->prPrice($approved_sum);?></b></td>
				</td>
    </tr>
<?php }?>
</table>
<table width="100%">
<tr>
	<td width="100%" align="center">
		<?php echo $html->link('<<','/commissions/calculateCommissions?page='.$previousPage.'&ffromdate='.$fdate.'&ftodate='.$tdate.'&ftechid='.$techid.'&fjoboption='.$joboption) ?>
		&nbsp;
		<?php echo $html->link('>>','/commissions/calculateCommissions?page='.$nextPage.'&ffromdate='.$fdate.'&ftodate='.$tdate.'&ftechid='.$techid.'&fjoboption='.$joboption) ?>
	</td>
</tr>
</table>
</body>
</html>