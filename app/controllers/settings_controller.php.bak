<? //error_reporting(E_ALL);

class SettingsController extends AppController
{
	var $name = "SettingsController";
	var $uses = array('Setting','User');

		
	function edit()
	{
		//If we have no data, then we need to provide the data to the user for editing
		if (empty($this->data['Setting']))
		{
			$this->data = $this->Setting->find(array("title" => $_GET['title']));
		}
		else if (!empty($this->data['Setting']))
		{
			//Validate & Validate
			if ($this->Setting->save($this->data['Setting']))
			{
				//Forward user where they need to be - if this is a single action per view
				if ($this->data['rurl'][0])
					$this->redirect($this->data['rurl'][0]);
				else
					$this->redirect(BASE_URL.'/orders/scheduleView');
				exit();
			}
		}
	}
	
	function editNewsletter(){
		
		if (empty($this->data['Setting']))
		{
			$this->data = $this->Setting->find(array("title" => $_GET['title']));
		}
		else if (!empty($this->data['Setting']))
		{
			//Validate & Validate
			if ($this->Setting->save($this->data['Setting']))
			{
				//ToDo: Send email to all users or to specific email

				//Get E-mail Settings
				$settings = $this->Setting->find(array('title'=>'email_fromaddress'));
				$from_address = $settings['Setting']['valuetxt'];
				
				$settings = $this->Setting->find(array('title'=>'email_fromname'));
				$from_name = $settings['Setting']['valuetxt'];
		
				$settings = $this->Setting->find(array('title'=>'email_template_custom'));
				$template = $settings['Setting']['valuetxt'];
		
				$template_subject = 'Ace Services Ltd';

				//define the headers we want passed. Note that they are separated with \r\n
				//$headers = "From: webmaster@example.com\r\nReply-To: webmaster@example.com";
				$headers = "From: ".$from_address."\n";
				//add boundary string and mime type specification
				$headers .= "Content-Type: text/html; charset=iso-8859-1\n" ;				
				
				$msg = $template;
				if($_POST['sent_to'] == 1){
					//echo $_POST['email'];
					if( ($_POST['email']!='') && $this->check_email($_POST['email']) ){
						$msg = str_replace('{first_name}', email, $msg);
						$msg = str_replace('{last_name}', '', $msg);
						$res = mail($_POST['email'], $template_subject, $msg, $headers);
					}
				}
				else
				{
					set_time_limit(36000);
					//sent to all users
					//load all active users
					$db =& ConnectionManager::getDataSource($this->User->useDbConfig);
					$result = $db->_execute(
						  "SELECT u.id, u.first_name, u.last_name, u.email FROM ace_rp_users u
							WHERE u.is_active=1 and u.callresult!=4 and u.email is not null
						  and u.email not in ('','ace_123@live.ca','ace-123@live.ca','NO EMAIL','N/A','cb@acecare.ca','NONE',
						  'ace_123@livenation.ca','N A','a','ACE_123@LIVE.COM','ace_123@live.com','ACE_!23@LIVE.CA','NA')
							and exists (select * from ace_rp_orders o where o.customer_id=u.id) ");
					
					$st = array();
					while ($row = mysql_fetch_array($result))
					{
						if($this->check_email($row['email']))
						{
							$msg_temp = $msg;
							$msg_temp = str_replace('{first_name}', $row['first_name'], $msg);
							$msg_temp = str_replace('{last_name}', $row['last_name'], $msg);							
							$st[] = array('email'=>$row['email'],'body'=>$msg_temp);
						}
					}
					
					$cnt = 0;
					foreach ($st as $cur)
					{
						$res = mail($cur['email'], $template_subject, $cur['body'], $headers);
						$cnt++;
					}

					set_time_limit(30);
					$this->flash($cnt.' emails have been sent.','/settings/editNewsletter?title=email_template_custom');
				}
				
			}
		}
	}

	function editCoupon(){
		
		if (empty($this->data['Setting']))
		{
			$this->data = $this->Setting->find(array("title" => $_GET['title']));
		}
		else if (!empty($this->data['Setting']))
		{
			//Validate & Validate
			if ($this->Setting->save($this->data['Setting']))
			{
				//ToDo: Send email to all users or to specific email

				//Get E-mail Settings
				$settings = $this->Setting->find(array('title'=>'email_fromaddress'));
				$from_address = $settings['Setting']['valuetxt'];
				
				$settings = $this->Setting->find(array('title'=>'email_fromname'));
				$from_name = $settings['Setting']['valuetxt'];
		
				$settings = $this->Setting->find(array('title'=>'coupon_template'));
				$template = $settings['Setting']['valuetxt'];
		
				$template_subject = 'Ace Services Ltd';

				//define the headers we want passed. Note that they are separated with \r\n
				//$headers = "From: webmaster@example.com\r\nReply-To: webmaster@example.com";
				$headers = "From: ".$from_address."\n";
				//add boundary string and mime type specification
				$headers .= "Content-Type: text/html; charset=iso-8859-1\n" ;				
				
				$msg = $template;
				if($_POST['sent_to'] == 1){
					//echo $_POST['email'];
					if( ($_POST['email']!='') && $this->check_email($_POST['email']) ){
						$msg = str_replace('{first_name}', email, $msg);
						$msg = str_replace('{last_name}', '', $msg);
						$res = mail($_POST['email'], $template_subject, $msg, $headers);
					}
				}
				else
				{
					set_time_limit(36000);
					//sent to all users
					//load all active users
					$db =& ConnectionManager::getDataSource($this->User->useDbConfig);
					$result = $db->_execute(
						  "SELECT u.id, u.first_name, u.last_name, u.email FROM ace_rp_users u
							WHERE u.is_active=1 and u.callresult!=4 and u.email is not null
						  and u.email not in ('','ace_123@live.ca','ace-123@live.ca','NO EMAIL','N/A','cb@acecare.ca','NONE',
						  'ace_123@livenation.ca','N A','a','ACE_123@LIVE.COM','ace_123@live.com','ACE_!23@LIVE.CA','NA')
							and exists (select * from ace_rp_orders o where o.customer_id=u.id) ");
					
					$st = array();
					while ($row = mysql_fetch_array($result))
					{
						if($this->check_email($row['email']))
						{
							$msg_temp = $msg;
							$msg_temp = str_replace('{first_name}', $row['first_name'], $msg);
							$msg_temp = str_replace('{last_name}', $row['last_name'], $msg);							
							$st[] = array('email'=>$row['email'],'body'=>$msg_temp);
						}
					}
					
					$cnt = 0;
					foreach ($st as $cur)
					{
						$res = mail($cur['email'], $template_subject, $cur['body'], $headers);
						$cnt++;
					}

					set_time_limit(30);
					$this->flash($cnt.' emails have been sent.','/settings/editCoupon?title=coupon_template');
				}
				
			}
		}
	}	
	
	function check_email($email) {
	    if( (preg_match('/(@.*@)|(\.\.)|(@\.)|(\.@)|(^\.)/', $email)) ||
	        (preg_match('/^.+\@(\[?)[a-zA-Z0-9\-\.]+\.([a-zA-Z]{2,3}|[0-9]{1,3})(\]?)$/',$email)) ) {
				
	    	return true;
			}
	    else{
	    	return false;
		}
	}
	
	
	
}
?>
